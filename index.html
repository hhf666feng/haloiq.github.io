<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="description" content="Halo Framework是将DDD，洋葱架构，整洁架构，读写分离架构有机整合一起，基于业务身份+扩展点的设计思想， 采用应用内部流程编排的方式形成可复用的业务资产库。最终架构落地达到业务与业务隔离，业务与平台隔离， 管理域与运行域分开，帮助企业快速落地业务中台.">
<meta name="keywords" content="DDD, CQRS, 扩展点, 业务身份, 能力">
<title>Halo Reference Documentation</title>
<link rel="stylesheet" href="styles/halo.css">
<link rel="stylesheet" href="styles/coderay-asciidoctor.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Halo Reference Documentation</h1>
<div class="details">
<span id="revnumber">version: 2.0.0.REALESE</span>
<br><span id="revremark">Copyright (c) 2019-2044 xujin (http://xujin.org)</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">目录</div>
<ul class="sectlevel1">
<li><a href="#preface">I 前言</a></li>
<li><a href="#release_notes">II Release Note</a></li>
<li><a href="#Halo-introduction">III Halo Ecology</a>
<ul class="sectlevel1">
<li><a href="#halo-what">1. 什么是光环(Halo)</a></li>
<li><a href="#Halo-target">2. Halo生态目标</a></li>
<li><a href="#halo-postition">3. Halo对产品生命周期的支持</a></li>
<li><a href="#halo-system">4. Halo生态系统</a></li>
<li><a href="#Halo-team">5. Halo Team</a></li>
<li><a href="#product-support">6. Product Support</a></li>
</ul>
</li>
<li><a href="#halo-fastentry">IV Halo 快速入门</a>
<ul class="sectlevel1">
<li><a href="#halo-dev-env">7. Halo开发环境</a>
<ul class="sectlevel2">
<li><a href="#_halo版本说明">7.1. Halo版本说明</a></li>
<li><a href="#halo-app-type">7.2. Halo应用类型</a></li>
<li><a href="#halo-Release-Note">7.3. Halo Release Note</a>
<ul class="sectlevel3">
<li><a href="#_halo_2_0_0_release">7.3.1. Halo 2.0.0.RELEASE</a></li>
<li><a href="#_halo_1_2_0_release">7.3.2. Halo 1.2.0.RELEASE</a></li>
<li><a href="#_halo_1_1_0_release">7.3.3. Halo 1.1.0.Release</a></li>
<li><a href="#_halo_1_0_1_release">7.3.4. Halo 1.0.1.Release</a></li>
<li><a href="#_halo_1_0_0_release">7.3.5. Halo 1.0.0.Release</a></li>
</ul>
</li>
<li><a href="#_maven依赖引入">7.4. maven依赖引入</a></li>
<li><a href="#halo-starter-list">7.5. Halo Starter列表</a></li>
<li><a href="#halo-dev-starter">7.6. Halo Starter说明</a></li>
</ul>
</li>
<li><a href="#dev-command">8. 使用命令</a>
<ul class="sectlevel2">
<li><a href="#create-command-object">8.1. 编写命令对象</a></li>
<li><a href="#create-command">8.2. 编写命令执行器</a></li>
<li><a href="#create-command">8.3. 发送命令</a></li>
</ul>
</li>
<li><a href="#use-ext">9. 扩展快速入门</a>
<ul class="sectlevel2">
<li><a href="#create-ext">9.1. 编写一个扩展点</a>
<ul class="sectlevel3">
<li><a href="#create-ext">9.1.1. 编写一个扩展</a></li>
</ul>
</li>
<li><a href="#call-ext">9.2. 调用执行扩展</a></li>
</ul>
</li>
<li><a href="#_创建流程">10. 创建流程</a></li>
<li><a href="#_halo_ddd使用">11. Halo DDD使用</a></li>
<li><a href="#_halo_qa">12. Halo QA</a></li>
<li><a href="#Halo-IDEA-Plugin">13. Halo ToolKit</a>
<ul class="sectlevel2">
<li><a href="#halo-idea-function">13.1. IDEA Plugin 功能</a></li>
<li><a href="#install-halo-idea">13.2. 安装IDEA Plugin</a></li>
</ul>
</li>
<li><a href="#use-halo-idea">14. 快速使用IDEA插件</a>
<ul class="sectlevel2">
<li><a href="#halo-Settings">14.1. Halo Settings</a>
<ul class="sectlevel3">
<li><a href="#_halo_server设置">14.1.1. Halo Server设置</a></li>
<li><a href="#_halo_config设置">14.1.2. Halo Config设置</a></li>
<li><a href="#_data_source设置">14.1.3. Data Source设置</a></li>
</ul>
</li>
<li><a href="#new-halo-prject">14.2. 创建 Halo Project</a></li>
<li><a href="#line-marker">14.3. 行标记功能</a>
<ul class="sectlevel3">
<li><a href="#_domain行标记修改">14.3.1. @Domain行标记修改</a></li>
</ul>
</li>
<li><a href="#right-click-function">14.4. 增强右键功能</a>
<ul class="sectlevel3">
<li><a href="#create-controller">14.4.1. 创建Controller</a></li>
<li><a href="#create-do">14.4.2. 创建Data Object(数据对象)</a></li>
<li><a href="#create-mapper">14.4.3. 创建Mapper</a></li>
<li><a href="#create-cmo">14.4.4. 创建Command Object(命令对象)</a></li>
<li><a href="#create-handler">14.4.5. 创建(Command Handler)命令执行器</a></li>
<li><a href="#create-phase">14.4.6. 创建阶段</a></li>
<li><a href="#create-step">14.4.7. 创建步骤</a></li>
<li><a href="#create-appservice">14.4.8. 创建应用服务</a></li>
<li><a href="#create-flow">14.4.9. 创建Flow流程定义</a></li>
<li><a href="#create-flow-prossor">14.4.10. 创建节点执行器</a></li>
<li><a href="#create-extp">14.4.11. 创建Extension Point(扩展点）</a></li>
<li><a href="#create-ext">14.4.12. 创建Extension（扩展）</a></li>
<li><a href="#create-event-object">14.4.13. 创建Event Object(事件对象)</a></li>
<li><a href="#create-event-handler">14.4.14. 创建 Event Handler(事件处理器)</a></li>
<li><a href="#create-entity">14.4.15. 创建实体</a></li>
<li><a href="#create-vo">14.4.16. 创建值对象</a></li>
<li><a href="#create-ds">14.4.17. 创建Domain Service(领域服务)</a></li>
<li><a href="#create-factory">14.4.18. 创建工厂</a></li>
<li><a href="#create-respory">14.4.19. 创建资源库</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-framework">V Halo Framework</a>
<ul class="sectlevel1">
<li><a href="#halo-overview">15. Halo Framework概述</a></li>
<li><a href="#_halo_framework设计">16. Halo Framework设计</a>
<ul class="sectlevel2">
<li><a href="#_halo_framework设计思想">16.1. Halo Framework设计思想</a></li>
<li><a href="#halo-design">16.2. Halo Framework架构设计</a></li>
<li><a href="#halo-cqrs">16.3. Halo CQRS 2.0设计</a></li>
<li><a href="#halo-jpfx">16.4. Halo竞品分析</a></li>
</ul>
</li>
<li><a href="#halo-cqrs">17. Halo CQRS</a>
<ul class="sectlevel2">
<li><a href="#halo-cqrs-gs">17.1. CQRS概述</a>
<ul class="sectlevel3">
<li><a href="#what-is-cqrs">17.1.1. 什么是CQRS</a></li>
</ul>
</li>
<li><a href="#_halo中cqrs的实现">17.2. Halo中CQRS的实现</a></li>
<li><a href="#cqrs-command">17.3. Command命令</a>
<ul class="sectlevel3">
<li><a href="#command-fl">17.3.1. Command的分类</a></li>
</ul>
</li>
<li><a href="#command-ljq">17.4. Command拦截器</a>
<ul class="sectlevel3">
<li><a href="#_命令拦截器filter">17.4.1. 命令拦截器Filter</a></li>
</ul>
</li>
<li><a href="#command-object">17.5. Command对象</a>
<ul class="sectlevel3">
<li><a href="#what-is-cmo">17.5.1. 什么是Command对象</a></li>
</ul>
</li>
<li><a href="#what-is-command-bus">17.6. Command Bus</a>
<ul class="sectlevel3">
<li><a href="#_command_bus发送命令对象">17.6.1. Command Bus发送命令对象</a></li>
<li><a href="#_command_bus发送命令执行器">17.6.2. Command Bus发送命令执行器</a></li>
</ul>
</li>
<li><a href="#what-is-command-exe">17.7. Command执行器</a>
<ul class="sectlevel3">
<li><a href="#with-parameter-command-handler">17.7.1. 有入参的Command执行器</a></li>
<li><a href="#without-parameter-command-handler">17.7.2. 无入参的Command执行器</a></li>
</ul>
</li>
<li><a href="#_command执行结果">17.8. Command执行结果</a></li>
<li><a href="#cqrs-event">17.9. Event</a>
<ul class="sectlevel3">
<li><a href="#cqrs-event-bus">17.9.1. Event Bus</a></li>
<li><a href="#_同步事件处理">17.9.2. 同步事件处理</a></li>
<li><a href="#_异步事件处理">17.9.3. 异步事件处理</a></li>
<li><a href="#cqrs-event-object">17.9.4. Event对象</a></li>
<li><a href="#cqrs-event-exe">17.9.5. Event处理器</a></li>
<li><a href="#_发送event事件到event_bus">17.9.6. 发送Event事件到Event Bus</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-ddd">18. Halo DDD</a>
<ul class="sectlevel2">
<li><a href="#_软件的复杂性应对之道">18.1. 软件的复杂性应对之道</a></li>
<li><a href="#_企业应用开发范式">18.2. 企业应用开发范式</a>
<ul class="sectlevel3">
<li><a href="#_问题域简介">18.2.1. 问题域简介</a></li>
<li><a href="#_数据库驱动范式">18.2.2. 数据库驱动范式</a></li>
</ul>
</li>
<li><a href="#_halo_ddd的目标">18.3. Halo DDD的目标</a></li>
<li><a href="#ddd">18.4. 领域驱动设计</a></li>
<li><a href="#halo-add-annotation">18.5. Halo DDD中的注解</a></li>
<li><a href="#_领域对象">18.6. 领域对象</a>
<ul class="sectlevel3">
<li><a href="#entity">18.6.1. 实体</a></li>
<li><a href="#value-object">18.6.2. 值对象</a></li>
</ul>
</li>
<li><a href="#jh-jhr">18.7. 聚合与聚合根</a></li>
<li><a href="#data-object">18.8. 数据对象</a></li>
<li><a href="#factory">18.9. 工厂</a></li>
<li><a href="#_防腐层">18.10. 防腐层</a></li>
<li><a href="#domain-service">18.11. 领域服务</a></li>
<li><a href="#app-service">18.12. 应用服务</a>
<ul class="sectlevel3">
<li><a href="#_应用服务分类">18.12.1. 应用服务分类</a></li>
<li><a href="#_phase和step">18.12.2. @Phase和@Step</a></li>
<li><a href="#_appservice">18.12.3. @AppService</a></li>
<li><a href="#_应用服务和领域服务的区别">18.12.4. 应用服务和领域服务的区别</a></li>
<li><a href="#_应用能力下沉">18.12.5. 应用能力下沉</a></li>
</ul>
</li>
<li><a href="#domian-ability">18.13. 领域能力</a></li>
<li><a href="#domian-repository">18.14. 资源库</a></li>
<li><a href="#halo-ddd-action">18.15. halo DDD实战</a>
<ul class="sectlevel3">
<li><a href="#_halo_ddd的模型采集">18.15.1. Halo DDD的模型采集</a></li>
<li><a href="#_ddd模型要素约定">18.15.2. DDD模型要素约定</a></li>
<li><a href="#_运用_halo_ddd改造系统">18.15.3. 运用 Halo DDD改造系统</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Halo-ext">19. Halo扩展点</a>
<ul class="sectlevel2">
<li><a href="#ext-bg">19.1. 扩展点出现背景</a>
<ul class="sectlevel3">
<li><a href="#_消灭if_else">19.1.1. 消灭if-else</a></li>
<li><a href="#_多实现执行">19.1.2. 多实现执行</a></li>
</ul>
</li>
<li><a href="#_扩展点">19.2. 扩展点</a></li>
<li><a href="#_扩展点设计">19.3. 扩展点设计</a>
<ul class="sectlevel3">
<li><a href="#_扩展点是什么">19.3.1. 扩展点是什么</a></li>
<li><a href="#_扩展是什么">19.3.2. 扩展是什么</a></li>
<li><a href="#_扩展点注解">19.3.3. 扩展点注解</a></li>
<li><a href="#_扩展注解">19.3.4. 扩展注解</a></li>
<li><a href="#_业务身份">19.3.5. 业务身份</a></li>
<li><a href="#halo-extract-bizCode">19.3.6. 提取业务身份</a></li>
<li><a href="#_减少扩展点数量">19.3.7. 减少扩展点数量</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_扩展点管理">20. 扩展点管理</a>
<ul class="sectlevel2">
<li><a href="#_扩展信息采集">20.1. 扩展信息采集</a></li>
</ul>
</li>
<li><a href="#halo-flow">21. 流程编排</a>
<ul class="sectlevel2">
<li><a href="#_业务场景">21.1. 业务场景</a>
<ul class="sectlevel3">
<li><a href="#_仓储出库场景">21.1.1. 仓储出库场景</a></li>
<li><a href="#_交易订单场景">21.1.2. 交易订单场景</a></li>
</ul>
</li>
<li><a href="#_流程编排">21.2. 流程编排</a></li>
<li><a href="#_流程编排的关键问题">21.3. 流程编排的关键问题</a></li>
<li><a href="#_流程编排设计">21.4. 流程编排设计</a>
<ul class="sectlevel3">
<li><a href="#_流程编排架构">21.4.1. 流程编排架构</a></li>
<li><a href="#halo-flow-define">21.4.2. 流程定义</a></li>
<li><a href="#_节点定义">21.4.3. 节点定义</a></li>
<li><a href="#_节点异常持久化">21.4.4. 节点异常持久化</a></li>
<li><a href="#_启动流程">21.4.5. 启动流程</a></li>
<li><a href="#_流程执行异常处理">21.4.6. 流程执行异常处理</a></li>
<li><a href="#_流程事务">21.4.7. 流程事务</a></li>
<li><a href="#_节点事务">21.4.8. 节点事务</a></li>
<li><a href="#halo-flow-multi-tx">21.4.9. 多数据源流程事务</a></li>
</ul>
</li>
<li><a href="#_流程编排信息采集">21.5. 流程编排信息采集</a>
<ul class="sectlevel3">
<li><a href="#_登录到中台可视化查看">21.5.1. 登录到中台可视化查看</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Layer-design">22. 分层设计</a>
<ul class="sectlevel2">
<li><a href="#_传统三层">22.1. 传统三层</a></li>
<li><a href="#_halo架构分层">22.2. Halo架构分层</a></li>
<li><a href="#soft-layer">22.3. Halo应用分层</a></li>
<li><a href="#_halo的组件视图">22.4. Halo的组件视图</a></li>
<li><a href="#_halo组件视图">22.5. Halo组件视图</a></li>
<li><a href="#_halo服务视图">22.6. Halo服务视图</a></li>
<li><a href="#layer-object">22.7. 分层对象</a></li>
<li><a href="#convertor-design">22.8. Convertor设计</a></li>
</ul>
</li>
<li><a href="#Halo-check">23. Halo Check</a>
<ul class="sectlevel2">
<li><a href="#Halo-codecheck-words">23.1. 名词解释</a></li>
<li><a href="#Halo-codecheck-checkstye">23.2. CheckStyle</a></li>
<li><a href="#Halo-codecheck-pmd">23.3. PMD</a></li>
<li><a href="#Halo-codecheck-use">23.4. 使用说明</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-admin">Halo Admin</a>
<ul class="sectlevel1">
<li><a href="#_中台登录">24. 中台登录</a></li>
<li><a href="#_中台可视化dashboard">25. 中台可视化DashBoard</a></li>
<li><a href="#_域管理">26. 域管理</a></li>
<li><a href="#_中台成熟度模型">27. 中台成熟度模型</a></li>
<li><a href="#_域服务">28. 域服务</a></li>
<li><a href="#_域能力">29. 域能力</a></li>
<li><a href="#_应用管理">30. 应用管理</a></li>
<li><a href="#_流程编排管理">31. 流程编排管理</a></li>
<li><a href="#_扩展管理">32. 扩展管理</a></li>
<li><a href="#_业务身份管理">33. 业务身份管理</a>
<ul class="sectlevel2">
<li><a href="#_业务流程与业务活动">33.1. 业务流程与业务活动</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-boot">VI Halo Boot</a>
<ul class="sectlevel1">
<li><a href="#what-is-starter">34. 什么是Starter</a></li>
<li><a href="#halo-boot-overview">35. Halo Boot概述</a></li>
<li><a href="#_halo_boot扩展">36. Halo Boot扩展</a>
<ul class="sectlevel2">
<li><a href="#_haloapplication注解">36.1. @HaloApplication注解</a></li>
</ul>
</li>
<li><a href="#_halo_parent介绍">37. Halo Parent介绍</a></li>
<li><a href="#halo-mybatis">38. Halo Mybatis</a>
<ul class="sectlevel2">
<li><a href="#_halo_mybatis的功能">38.1. Halo Mybatis的功能</a></li>
<li><a href="#halo-mybatis-hikariCP">38.2. Halo的默认内置HikariCP</a>
<ul class="sectlevel3">
<li><a href="#_查看hikaricp默认配置">38.2.1. 查看HikariCP默认配置</a></li>
<li><a href="#_halo中hikaricp的配置">38.2.2. Halo中HikariCP的配置</a></li>
</ul>
</li>
<li><a href="#halo-mybatis-hikariCP-multi">38.3. HikariCP多数据源配置</a></li>
<li><a href="#_halo提供的halobasemap">38.4. Halo提供的HaloBaseMap</a></li>
<li><a href="#_halo_mybatis的使用">38.5. Halo Mybatis的使用</a>
<ul class="sectlevel3">
<li><a href="#_maven引入">38.5.1. Maven引入</a></li>
<li><a href="#_演示代码">38.5.2. 演示代码</a></li>
</ul>
</li>
<li><a href="#_详细功能">38.6. 详细功能</a></li>
<li><a href="#_字段加密">38.7. 字段加密</a>
<ul class="sectlevel3">
<li><a href="#_配置">38.7.1. 配置</a></li>
<li><a href="#_代码">38.7.2. 代码</a></li>
</ul>
</li>
<li><a href="#_json对象字段">38.8. JSON对象字段</a>
<ul class="sectlevel3">
<li><a href="#_配置_2">38.8.1. 配置</a></li>
<li><a href="#_代码_2">38.8.2. 代码</a></li>
<li><a href="#_配置选项">38.8.3. 配置选项</a></li>
</ul>
</li>
<li><a href="#_通用枚举字段">38.9. 通用枚举字段</a>
<ul class="sectlevel3">
<li><a href="#_配置_3">38.9.1. 配置</a></li>
<li><a href="#_代码_3">38.9.2. 代码</a></li>
<li><a href="#_配置选项_2">38.9.3. 配置选项</a></li>
</ul>
</li>
<li><a href="#_mybatis空where_sql拦截">38.10. Mybatis空Where SQL拦截</a></li>
<li><a href="#_mybatis与tk_pagehelper">38.11. Mybatis与tK PageHelper</a></li>
<li><a href="#_mybatis_plus开启乐观锁">38.12. Mybatis Plus开启乐观锁</a></li>
</ul>
</li>
<li><a href="#halo-web">39. Halo Web</a>
<ul class="sectlevel2">
<li><a href="#halo-web-function">39.1. Halo Web功能</a></li>
<li><a href="#halo-web-use">39.2. Halo Web的使用</a>
<ul class="sectlevel3">
<li><a href="#halo-web-maven">39.2.1. Maven引入</a></li>
<li><a href="#halo-web-config">39.2.2. 配置使用</a></li>
</ul>
</li>
<li><a href="#_详细功能_2">39.3. 详细功能</a>
<ul class="sectlevel3">
<li><a href="#_restpathcontroller">39.3.1. @RestPathController</a></li>
<li><a href="#_接口统一返回">39.3.2. 接口统一返回</a></li>
<li><a href="#_跨域处理">39.3.3. 跨域处理</a></li>
<li><a href="#_全局异常">39.3.4. 全局异常</a></li>
<li><a href="#_开启404_not_found_处理">39.3.5. 开启404 Not Found 处理</a></li>
<li><a href="#_接口日志打印">39.3.6. 接口日志打印</a></li>
<li><a href="#_接口版本控制">39.3.7. 接口版本控制</a></li>
</ul>
</li>
<li><a href="#_halo_assert">39.4. Halo Assert</a>
<ul class="sectlevel3">
<li><a href="#_halo_assert的实现">39.4.1. Halo Assert的实现</a></li>
<li><a href="#_enum_和_halo_assert结合">39.4.2. Enum 和 Halo Assert结合</a></li>
<li><a href="#_统一404返回">39.4.3. 统一404返回</a></li>
<li><a href="#_使用halo_assert">39.4.4. 使用Halo Assert</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-swagger">40. Halo Swagger</a>
<ul class="sectlevel2">
<li><a href="#halo-swagger-function">40.1. Halo Swagger的功能</a></li>
<li><a href="#halo-swagger-use">40.2. Halo Swagger的使用</a>
<ul class="sectlevel3">
<li><a href="#halo-swagger-maven">40.2.1. Maven引入</a></li>
<li><a href="#halo-swagger-config">40.2.2. 配置使用</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-MapStruct">41. Halo MapStruct</a>
<ul class="sectlevel2">
<li><a href="#_什么是halo_mapstruct">41.1. 什么是Halo MapStruct</a></li>
<li><a href="#_halo_mapstruct的使用">41.2. halo MapStruct的使用</a>
<ul class="sectlevel3">
<li><a href="#_maven引入_2">41.2.1. Maven引入</a></li>
<li><a href="#_mapstruct使用">41.2.2. MapStruct使用</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_halo_excel">42. Halo Excel</a></li>
<li><a href="#halo-test">43. Halo Test</a>
<ul class="sectlevel2">
<li><a href="#halo-test-function">43.1. Halo Test的功能</a></li>
<li><a href="#halo-test-use">43.2. Halo Test的使用</a>
<ul class="sectlevel3">
<li><a href="#halo-Test-maven">43.2.1. Maven引入</a></li>
<li><a href="#halo-test-use">43.2.2. Halo Test使用</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-Mongodb">44. Halo MongoDB</a>
<ul class="sectlevel2">
<li><a href="#_什么是halo_mongodb">44.1. 什么是Halo MongoDB</a></li>
<li><a href="#_使用halo_mongodb">44.2. 使用Halo MongoDB</a>
<ul class="sectlevel3">
<li><a href="#_maven引入halo_mongodb">44.2.1. Maven引入Halo MongoDB</a></li>
<li><a href="#_在属性文件yml或properties配置halo_mongodb">44.2.2. 在属性文件yml或properties配置Halo MongoDB</a></li>
<li><a href="#_使用mongotemplate操作mongodb">44.2.3. 使用MongoTemplate操作MongoDB</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-es-6">45. Halo ElasticSearch 6.3.2</a>
<ul class="sectlevel2">
<li><a href="#_什么是halo_es_6">45.1. 什么是Halo ES 6</a></li>
<li><a href="#_使用halo_es_6">45.2. 使用Halo ES 6</a>
<ul class="sectlevel3">
<li><a href="#_maven引入halo_es_6">45.2.1. Maven引入Halo ES 6</a></li>
<li><a href="#_在yml文件中配置halo_es6">45.2.2. 在yml文件中配置Halo ES6</a></li>
<li><a href="#_使用haloestemplate操作es">45.2.3. 使用HaloEsTemplate操作ES</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-es-7">46. Halo ElasticSearch 7.2.1</a>
<ul class="sectlevel2">
<li><a href="#_什么是halo_es7">46.1. 什么是Halo ES7</a></li>
<li><a href="#_使用halo_es7">46.2. 使用Halo ES7</a>
<ul class="sectlevel3">
<li><a href="#_maven引入halo_es7">46.2.1. Maven引入Halo ES7</a></li>
<li><a href="#_在属性文件yml或properties配置halo_es">46.2.2. 在属性文件yml或properties配置Halo ES</a></li>
<li><a href="#_使用resthighlevelclient操作es7">46.2.3. 使用RestHighLevelClient操作ES7</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-job">47. Halo Job</a>
<ul class="sectlevel2">
<li><a href="#_halo_job的功能">47.1. Halo Job的功能</a></li>
<li><a href="#_halo_job的使用">47.2. halo job的使用</a>
<ul class="sectlevel3">
<li><a href="#_maven引入_3">47.2.1. Maven引入</a></li>
</ul>
</li>
<li><a href="#_halo_job的使用_2">47.3. halo job的使用</a>
<ul class="sectlevel3">
<li><a href="#_xxl_job可用环境">47.3.1. xxl-job可用环境</a></li>
<li><a href="#_修改xxl_job配置">47.3.2. 修改xxl-job配置</a></li>
<li><a href="#_定义job执行器">47.3.3. 定义Job执行器</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-alimq">48. Halo AliMQ</a>
<ul class="sectlevel2">
<li><a href="#_halo_alimq的功能">48.1. Halo AliMQ的功能</a></li>
<li><a href="#_rocketmq介绍">48.2. RocketMQ介绍</a></li>
<li><a href="#_halo_alimq的使用">48.3. Halo AliMQ的使用</a>
<ul class="sectlevel3">
<li><a href="#_maven引入_4">48.3.1. Maven引入</a></li>
<li><a href="#_配置_4">48.3.2. 配置</a></li>
<li><a href="#_使用">48.3.3. 使用</a>
<ul class="sectlevel4">
<li><a href="#_生产者">48.3.3.1. 生产者</a></li>
<li><a href="#_消费者">48.3.3.2. 消费者</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-redis">49. Halo Redis</a>
<ul class="sectlevel2">
<li><a href="#_halo_redis的功能">49.1. Halo Redis的功能</a></li>
<li><a href="#_redisson介绍">49.2. Redisson介绍</a></li>
<li><a href="#_halo_redis的使用">49.3. Halo Redis的使用</a>
<ul class="sectlevel3">
<li><a href="#_maven引入_5">49.3.1. Maven引入</a></li>
<li><a href="#_配置_5">49.3.2. 配置</a></li>
</ul>
</li>
<li><a href="#_halo_redis工具类">49.4. Halo Redis工具类</a>
<ul class="sectlevel3">
<li><a href="#_防重复提交验证器">49.4.1. 防重复提交验证器</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-apollo">50. Halo Apollo</a>
<ul class="sectlevel2">
<li><a href="#_什么是halo_apollo">50.1. 什么是Halo Apollo</a></li>
<li><a href="#_halo_apollo的功能">50.2. Halo Apollo的功能</a></li>
<li><a href="#_使用halo_apollo">50.3. 使用Halo Apollo</a>
<ul class="sectlevel3">
<li><a href="#_maven引入_6">50.3.1. Maven引入</a></li>
</ul>
</li>
<li><a href="#_halo_apollo的最佳实践">50.4. Halo Apollo的最佳实践</a></li>
</ul>
</li>
<li><a href="#halo-shiro">51. Halo Shiro</a>
<ul class="sectlevel2">
<li><a href="#_什么是halo_shiro">51.1. 什么是Halo Shiro</a></li>
<li><a href="#_halo_shiro的功能">51.2. Halo Shiro的功能</a></li>
<li><a href="#_使用halo_shiro">51.3. 使用Halo Shiro</a>
<ul class="sectlevel3">
<li><a href="#_maven引入_7">51.3.1. Maven引入</a></li>
</ul>
</li>
<li><a href="#_功能使用">51.4. 功能使用</a>
<ul class="sectlevel3">
<li><a href="#_对接ldap">51.4.1. 对接LDAP</a></li>
<li><a href="#_对接db通过用户名和密码">51.4.2. 对接DB(通过用户名和密码)</a></li>
<li><a href="#_关闭halo_shiro">51.4.3. 关闭Halo Shiro</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-influxDB">52. Halo influxDB</a>
<ul class="sectlevel2">
<li><a href="#_halo_influxdb的功能">52.1. Halo influxDB的功能</a></li>
<li><a href="#_halo_influxdb的使用">52.2. halo influxdb的使用</a>
<ul class="sectlevel3">
<li><a href="#_maven引入_8">52.2.1. Maven引入</a></li>
</ul>
</li>
<li><a href="#_halo_influxdb的使用_2">52.3. halo influxdb的使用</a>
<ul class="sectlevel3">
<li><a href="#_配置influxdb的连接信息">52.3.1. 配置influxdb的连接信息</a></li>
<li><a href="#_示例java使用代码">52.3.2. 示例Java使用代码</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-cloud">VII Halo Cloud</a>
<ul class="sectlevel1">
<li><a href="#halo-eureka">53. Halo Eureka</a>
<ul class="sectlevel2">
<li><a href="#_什么是halo_eureka">53.1. 什么是Halo Eureka</a></li>
<li><a href="#_使用halo_eureka">53.2. 使用Halo Eureka</a>
<ul class="sectlevel3">
<li><a href="#_maven引入_9">53.2.1. Maven引入</a></li>
</ul>
</li>
<li><a href="#_演示代码_2">53.3. 演示代码</a></li>
<li><a href="#_详细功能示例代码和测试用例">53.4. 详细功能示例代码和测试用例</a>
<ul class="sectlevel3">
<li><a href="#_默认配置">53.4.1. 默认配置</a></li>
<li><a href="#_屏蔽一些ip">53.4.2. 屏蔽一些IP</a></li>
<li><a href="#_清除路由">53.4.3. 清除路由</a></li>
<li><a href="#_负载均衡机制">53.4.4. 负载均衡机制</a></li>
<li><a href="#_指定本地ip测试">53.4.5. 指定本地IP测试</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#halo-feign">54. Halo Feign</a>
<ul class="sectlevel2">
<li><a href="#_halo_feign的功能">54.1. Halo Feign的功能</a></li>
<li><a href="#_halo_feign的使用">54.2. halo feign的使用</a></li>
<li><a href="#_使用feign开发二方包">54.3. 使用Feign开发二方包</a>
<ul class="sectlevel3">
<li><a href="#_halo封装的feign">54.3.1. Halo封装的Feign</a></li>
<li><a href="#_支持spring_cloud_finchley_sr3版本">54.3.2. 支持Spring Cloud Finchley.SR3版本</a></li>
<li><a href="#_支持spring_cloud_edgware_sr5版本">54.3.3. 支持Spring Cloud Edgware.SR5版本</a></li>
<li><a href="#_使用okhttpclient">54.3.4. 使用OkHttpClient</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#Halo-tools">VIII Tools</a>
<ul class="sectlevel1">
<li><a href="#halo-codegen">55. 代码生成器</a>
<ul class="sectlevel2">
<li><a href="#halo-codegen-arch">55.1. CodeGen架构</a></li>
</ul>
</li>
<li><a href="#_halo_plugin">56. Halo Plugin</a>
<ul class="sectlevel2">
<li><a href="#_halo_gradle_plugin">56.1. Halo Gradle Plugin</a>
<ul class="sectlevel3">
<li><a href="#_halo_reference_plugin">56.1.1. Halo Reference Plugin</a></li>
</ul>
</li>
<li><a href="#_halo_maven_plugin">56.2. Halo Maven Plugin</a></li>
</ul>
</li>
<li><a href="#Halo-standard">57. 开发规范</a>
<ul class="sectlevel2">
<li><a href="#return-value-speci">57.1. 返回值规范</a>
<ul class="sectlevel3">
<li><a href="#common-return-value">57.1.1. 常规返回约定</a></li>
<li><a href="#page-return-value">57.1.2. 分页返回约定</a></li>
</ul>
</li>
<li><a href="#log-speci">57.2. 日志规范</a>
<ul class="sectlevel3">
<li><a href="#_日志使用原则">57.2.1. 日志使用原则</a></li>
<li><a href="#_日志打点">57.2.2. 日志打点</a></li>
<li><a href="#_记日志场景">57.2.3. 记日志场景</a></li>
<li><a href="#_日志打印规范">57.2.4. 日志打印规范</a></li>
<li><a href="#_不同日志级别的使用">57.2.5. 不同日志级别的使用</a></li>
</ul>
</li>
<li><a href="#futakata-jar-speci">57.3. 二方包规范</a>
<ul class="sectlevel3">
<li><a href="#dev-futakata-jar">57.3.1. 二方包原则</a></li>
</ul>
</li>
<li><a href="#_错误码设计">57.4. 错误码设计</a>
<ul class="sectlevel3">
<li><a href="#_为什么需要错误码">57.4.1. 为什么需要错误码</a></li>
<li><a href="#_什么是错误码">57.4.2. 什么是错误码</a></li>
<li><a href="#_错误码规范">57.4.3. 错误码规范</a></li>
<li><a href="#_异常码使用建议">57.4.4. 异常码使用建议</a></li>
<li><a href="#feign-speci">57.4.5. Feign接口定义规范</a></li>
</ul>
</li>
<li><a href="#git-flow">57.5. Git Flow规范</a>
<ul class="sectlevel3">
<li><a href="#git-branch">57.5.1. 分支说明</a></li>
<li><a href="#master-to-feature">57.5.2. 从Master拉出Feature分支</a></li>
<li><a href="#feature-to-release">57.5.3. 通过合并特性分支，形成发布分支</a></li>
<li><a href="#release-to-master">57.5.4. 发布分支发布完毕之后，合并到主干</a></li>
<li><a href="#git-hotfix">57.5.5. Hotfix原则</a></li>
</ul>
</li>
<li><a href="#idea-setting">57.6. IDEA常用设置</a>
<ul class="sectlevel3">
<li><a href="#fix-import-package">57.6.1. 无效导入包自动整理设置</a></li>
<li><a href="#maven-setting">57.6.2. maven插件设置</a></li>
<li><a href="#p3c-install">57.6.3. Alibaba P3C插件安装</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="preface"><a class="anchor" href="#preface"></a><a class="link" href="#preface">I 前言</a></h2>
<div class="sectionbody">
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>本文档是Halo Reference Documentation提供了 Halo Framework设计和使用说明.Halo Framework是将DDD，洋葱架构，整洁架构，读写分离架构有机整合一起，基于业务身份+扩展点的设计思想，
采用应用内部流程编排的方式形成可复用的业务资产库。最终架构落地达到业务与业务隔离，业务与平台隔离，管理域与运行域分开，帮助企业快速落地业务中台。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Halo设计原则简单，即在高内聚，低耦合，可扩展，易理解的指导思想下，尽可能的贯彻面向对象的设计思想和领域驱动设计的原则。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Halo Framework的主要模块如下所示:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>halo-cqrs：读写分离架构-所有请求封装为命令对象，通过Command Bus分发到命令处理器执行，通过Event和Event Bus等实现读写分离。</p>
</li>
<li>
<p>halo-ddd: 根据领域驱动设计思想，自定义注解 <code>@Entity(实体)</code>，<code>@Factory(工厂)</code>, <code>@DomainService(领域服务)</code>, <code>@AggregateRoot(聚合根)</code>,<code>@AggregateRoot(聚合根)</code>,
<code>@UniqueIdentity(实体唯一标识)</code>,<code>@AggregatePart(聚合部件)</code>,<code>@ValueObject(值对象)</code>，<code>@DomainRepository(资源库)</code>，<code>@DomainAbility(域能力)</code> 等进行战术设计，落地DDD，实现 <code>业务与业务</code> 隔离。</p>
</li>
<li>
<p>Halo Admin: 中台可视化管控平台，全链路可视化视角，对业务资产进行可视化。</p>
</li>
<li>
<p>Halo Boot: 基于Spring Boot定制的Starter。包含Halo Basic,Halo Web，Halo Swagger，Halo ES6，Halo Job,Halo Test,Halo MyBatis等</p>
</li>
<li>
<p>Halo Extension：基于扩展点的设计思想，自定义 <code>@ExtensionPoint(扩展点注解)</code> 和 <code>@Extension(扩展注解)</code>, 实现 <code>平台和插件</code> 隔离。</p>
</li>
<li>
<p>Halo Flow: 基于流程编排思想，开发业务组件，编排应用内部已有业务资产，快速响应前台需求，久而久之形成大量可复用的业务组件库。</p>
</li>
<li>
<p>Halo ToolKit: 一款IDEA插件，只为加速Halo应用开发而生。</p>
</li>
<li>
<p>Halo Cloud: 对Spring Cloud进行封装增强，简化熟悉使用成本,提高开发效率。</p>
</li>
<li>
<p>Halo Codegen: 通过设计代码生成器, 快速生成最佳实践的基础代码和规范，提高开发效率和生产力，让业务开发人员专注于业务开发。</p>
</li>
<li>
<p>Halo Plugin: Halo生态体系中的Gradle或Maven插件。</p>
</li>
<li>
<p>Halo Studio: Halo Studio 基于开源的 IntelliJ Platform进行定制开发扩展，将Halo Toolkit内置其中增强,提供企业级IDE支持。</p>
</li>
<li>
<p>Halo Check:基于 <code>Git Hook</code> + <code>JGit</code> + <code>CheckStyle</code>+ <code>PMD</code> 对 <code>代码增量diff Check</code> 是否满足 <code>Halo Style</code>。该项目主要用于Git Commit提交的时候对代码进行检查。分为客户端和Gitlab服务端Check</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>总之,Halo Framework不仅仅只是 <code>一个框架</code>，<code>一个架构</code>，<code>一种思想</code>，更是一套 <code>可落地业务中台建设</code> 解决方案！</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="release_notes"><a class="anchor" href="#release_notes"></a><a class="link" href="#release_notes">II Release Note</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>关于Halo的Release Note可以访问<a href="#halo-Release-Note">Halo Release Note</a></p>
</div>
</div>
</div>
<h1 id="Halo-introduction" class="sect0"><a class="anchor" href="#Halo-introduction"></a><a class="link" href="#Halo-introduction">III Halo Ecology</a></h1>
<div class="sect1">
<h2 id="halo-what"><a class="anchor" href="#halo-what"></a><a class="link" href="#halo-what">1. 什么是光环(Halo)</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>光环(Halo)是一个企业IT架构生态,专注于解决 <strong>技术架构</strong>,<strong>业务架构</strong>,<strong>业务中台</strong>建设，如下图所示。而其中的Halo Framework是一款
<code>基于DDD+CQRS+扩展点+流程编排的应用框架</code>，致力于采用 <code>领域驱动</code> 的设计思想，规范控制程序员的随心所欲，
从而解决软件的复杂性问题。架构原则很简单，即在高内聚，低耦合，可扩展，易理解大的指导思想下，尽可能的贯彻OO的设计思想和原则，以降低开发
的复杂度, 提高开发人员的开发效率, 提升代码质量, 规范开发流程。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/qyitjg.jpg" alt="qyitjg" width="800">
</div>
<div class="title">Figure 1. 企业IT架构</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Halo生态涵盖了WEB, Rest Doc, Halo Boot，服务治理(Halo-Cloud), TDDD, Log, Code Generator等各方面的内容。</p>
</li>
<li>
<p>Halo Framework涵盖 <code>领域驱动设计(DDD)</code>,<code>读写分离架构(CQRS)</code>,<code>扩展点设计</code>,<code>应用内部流程编排</code> 等。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>开发人员可以利用Halo-codegen工具，根据设计好的数据库和表，自动生成Halo风格的项目代码。</p>
</div>
<div class="paragraph">
<p>目前Halo-codegen支持生成带有DDD应用的框架。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Halo-target"><a class="anchor" href="#Halo-target"></a><a class="link" href="#Halo-target">2. Halo生态目标</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Halo生态的目标如下左图所示，Halo Framework的目标如下右图所示。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/halo-all.jpg" alt="halo all" width="800">
</div>
<div class="title">Figure 2. Halo生态</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
开发人员只需要设计好数库表结构，就可以通过Halo-codegen工具自动
生成具有Halo风格的项目基础骨架和基础代码,然后开发人员通过Halo-DDD,
Halo-Extension,Halo-Flow去进行业务开发和建模即可。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-postition"><a class="anchor" href="#halo-postition"></a><a class="link" href="#halo-postition">3. Halo对产品生命周期的支持</a></h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/halo/halo-smzq.png" alt="halo smzq" width="800">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-system"><a class="anchor" href="#halo-system"></a><a class="link" href="#halo-system">4. Halo生态系统</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Halo生态主要包含以下几个大模块，如下所示</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Halo Framework: Halo Framework是Halo生态的核心框架，起到 <code>承上启下</code> 的作用，向上支撑业务开发，构建业务中台,向下整合适配基础设施。</p>
<div class="ulist">
<ul>
<li>
<p>Halo DDD: 领域驱动方式实现业务和业务隔离</p>
</li>
<li>
<p>Halo Flow: 对业务资产编排复用</p>
</li>
<li>
<p>Halo Extension: 以扩展点方式实现平台和插件隔离</p>
</li>
</ul>
</div>
</li>
<li>
<p>Halo Boot: Halo Boot是对Spring Boot的增强和扩展</p>
</li>
<li>
<p>Halo Cloud: Halo Cloud是对Spring Cloud的增强和扩展</p>
</li>
<li>
<p>开发工具</p>
</li>
<li>
<p>其它中间件
**</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/halo-module.png" alt="halo module" width="800">
</div>
<div class="title">Figure 3. Halo生态</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Halo-team"><a class="anchor" href="#Halo-team"></a><a class="link" href="#Halo-team">5. Halo Team</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>设计和构建统一的应用开发框架(Halo Framework)，通过代码生成器(Halo Codegen)提高应用开发效率和质量</p>
</li>
<li>
<p>建立统一的应用开发构建标准，为实现对应用的管理，监控和治理的自动化建立基础</p>
</li>
<li>
<p>打造业界牛逼的业务中台和应用框架，形成业务可复用的组件库和业务资产，快速响应产品的需求。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="product-support"><a class="anchor" href="#product-support"></a><a class="link" href="#product-support">6. Product Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Halo框架产品支持,可以扫描下面二维码加入钉钉群或者加微信如下所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/sp/dt_wx.png" alt="dt wx" width="800">
</div>
<div class="title">Figure 4. 二维码</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
进群后提供Maven私服Settings.xml文件,体验使用！
</td>
</tr>
</table>
</div>
</div>
</div>
<h1 id="halo-fastentry" class="sect0"><a class="anchor" href="#halo-fastentry"></a><a class="link" href="#halo-fastentry">IV Halo 快速入门</a></h1>
<div class="sect1">
<h2 id="halo-dev-env"><a class="anchor" href="#halo-dev-env"></a><a class="link" href="#halo-dev-env">7. Halo开发环境</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>使用Halo Framework开发应用要求JDK 1.8+,目前框架已经内置了Spring Boot,
Spring Cloud等基础框架.因此无需关心底层框架的版本和实现细节.</p>
</div>
<div class="sect2">
<h3 id="_halo版本说明"><a class="anchor" href="#_halo版本说明"></a><a class="link" href="#_halo版本说明">7.1. Halo版本说明</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Halo</th>
<th class="tableblock halign-left valign-top">Spring Cloud</th>
<th class="tableblock halign-left valign-top">Spring Boot</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.0.0.RELEASE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hoxton.SR5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.spring.io/spring-boot/docs/2.3.0.RELEASE/reference/htmlsingle/" target="_blank" rel="noopener">2.3.0.RELEASE</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">最新稳定版本</p></td>
</tr>
</tfoot>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
使用Halo Framework只需关心Halo的版本即可,无需关心Spring Boot或者Spring Cloud的版本,业务应用使用框架即可.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="halo-app-type"><a class="anchor" href="#halo-app-type"></a><a class="link" href="#halo-app-type">7.2. Halo应用类型</a></h3>
<div class="paragraph">
<p>Halo目前支持两种应用类型，如下表所示:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">应用类型</th>
<th class="tableblock halign-left valign-top">说明</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">中台应用</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">具有分层架构，适用于业务复杂，适合做成中台的系统</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">推荐使用</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">传统应用</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">传统三层(Controller,Service Dao)应用，适用于简单应用，定时任务应用，工具型应用，基础服务应用</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">只用Halo的Starter</p></td>
</tr>
</tfoot>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
不管什么类型额应用，都会被Halo Admin纳管，形成一个体系，统一开发模式。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="halo-Release-Note"><a class="anchor" href="#halo-Release-Note"></a><a class="link" href="#halo-Release-Note">7.3. Halo Release Note</a></h3>
<div class="sect3">
<h4 id="_halo_2_0_0_release"><a class="anchor" href="#_halo_2_0_0_release"></a><a class="link" href="#_halo_2_0_0_release">7.3.1. Halo 2.0.0.RELEASE</a></h4>
<div class="ulist">
<ul>
<li>
<p>Halo</p>
<div class="ulist">
<ul>
<li>
<p>@Command注解更新为@CmdHandler注解</p>
</li>
<li>
<p>增加Halo State Machine(基于Spring状态机进行定制增强开箱即用)</p>
</li>
<li>
<p>增加@AggregateRoot(聚合根),@AggregateRoot(聚合根), @UniqueIdentity(实体唯一标识),@AggregatePart(聚合部件)注解</p>
</li>
</ul>
</div>
</li>
<li>
<p>Halo Boot</p>
<div class="ulist">
<ul>
<li>
<p>升级Spring Boot版本为2.3.0.RELEASE</p>
</li>
<li>
<p>增加Halo InfluxDB</p>
</li>
<li>
<p>增加Halo Shiro</p>
</li>
<li>
<p>Halo Es7  Fix SocketTimeOut</p>
</li>
<li>
<p>halo Swagger支持GlobalOperationParameters</p>
</li>
<li>
<p>halo MongoDB支持多数据源支持</p>
</li>
<li>
<p>Halo Web增加断言结合全局异常处理器</p>
</li>
<li>
<p>Halo Web 404 Not Found异常处理</p>
</li>
<li>
<p>Halo MyBatis增加开启乐观锁</p>
</li>
<li>
<p>Halo Redis中的redisson-spring-data-21升级到版本为3.12.3</p>
</li>
</ul>
</div>
</li>
<li>
<p>Halo Cloud</p>
<div class="ulist">
<ul>
<li>
<p>Open Feign支持OKhttpClient支持</p>
</li>
<li>
<p>升级Spring Cloud版本为Hoxton.SR5</p>
</li>
<li>
<p>Fix Spring Cloud升级之后导致eureka Client应用返回值Json变Xml</p>
</li>
</ul>
</div>
</li>
<li>
<p>halo CodeGen支持新的Halo 2.0.0.RELEASE版本</p>
</li>
<li>
<p>halo ToolKit支持把代码模板抽取到远端管控</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_halo_1_2_0_release"><a class="anchor" href="#_halo_1_2_0_release"></a><a class="link" href="#_halo_1_2_0_release">7.3.2. Halo 1.2.0.RELEASE</a></h4>
<div class="ulist">
<ul>
<li>
<p>Halo Boot</p>
<div class="ulist">
<ul>
<li>
<p>Halo Mybatis支持空Where Sql拦截功能</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_halo_1_1_0_release"><a class="anchor" href="#_halo_1_1_0_release"></a><a class="link" href="#_halo_1_1_0_release">7.3.3. Halo 1.1.0.Release</a></h4>
<div class="ulist">
<ul>
<li>
<p>halo</p>
<div class="ulist">
<ul>
<li>
<p>增加无参命令支持</p>
</li>
<li>
<p>Halo打包式自动加入Halo框架版本，应用启动上报halo版本</p>
</li>
<li>
<p>应用启动check当前应用是否属于某个域,开发，测试，UAT环境-只做应用归属check，不做收集，Halo版本上报处理</p>
</li>
<li>
<p>fastJson升级为最新版本1.2.62</p>
</li>
<li>
<p>增加@AppService注解，用于应用层查询服务</p>
</li>
<li>
<p>增加黄金三步法@Phase和@Step注解</p>
</li>
<li>
<p>增加领域层@Port注解</p>
</li>
<li>
<p>增加基础设施层@Adapte注解</p>
</li>
</ul>
</div>
</li>
<li>
<p>Halo Boot</p>
<div class="ulist">
<ul>
<li>
<p>增加Halo Es6</p>
</li>
<li>
<p>增加Halo Es7</p>
</li>
<li>
<p>增加Halo alimq</p>
</li>
<li>
<p>增加halo mongodb</p>
</li>
<li>
<p>增加halo redis</p>
</li>
<li>
<p>重构整理halo Swagger</p>
</li>
<li>
<p>重构整理halo Web，增加打印日志注解</p>
</li>
<li>
<p>增加脱敏</p>
</li>
</ul>
</div>
</li>
<li>
<p>Halo Admin</p>
<div class="ulist">
<ul>
<li>
<p>菜单增加角色可配</p>
</li>
<li>
<p>结合数据字典-Halo版本分布动态报表</p>
</li>
<li>
<p>应用增加时-添加所选框架版本</p>
</li>
<li>
<p>收集域服务(@DomainService),域能力注解</p>
</li>
<li>
<p>中台成熟度模型-增加域服务和域能力两个指标</p>
</li>
<li>
<p>halo admin中无参的命令空类更新为无参的命令</p>
</li>
</ul>
</div>
</li>
<li>
<p>Halo Codegen</p>
<div class="ulist">
<ul>
<li>
<p>Halo Codegen支持选择所属业务域创建</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_halo_1_0_1_release"><a class="anchor" href="#_halo_1_0_1_release"></a><a class="link" href="#_halo_1_0_1_release">7.3.4. Halo 1.0.1.Release</a></h4>
<div class="ulist">
<ul>
<li>
<p>2019年9月9-Halo 1.0.1.RELEASE</p>
<div class="ulist">
<ul>
<li>
<p>Fix安全漏洞升级FastJSON版本为1.2.60</p>
</li>
<li>
<p>Halo web全局异常解析器增加HttpMediaTypeNotSupportedException和IllegalArgumentException统一异常处理</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_halo_1_0_0_release"><a class="anchor" href="#_halo_1_0_0_release"></a><a class="link" href="#_halo_1_0_0_release">7.3.5. Halo 1.0.0.Release</a></h4>
<div class="ulist">
<ul>
<li>
<p>2019年7月-Halo 1.0.0.RELEASE</p>
<div class="ulist">
<ul>
<li>
<p>Halo框架从0到1整体功能发布</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_maven依赖引入"><a class="anchor" href="#_maven依赖引入"></a><a class="link" href="#_maven依赖引入">7.4. maven依赖引入</a></h3>
<div class="paragraph">
<p>Halo Framework由统一的parent或dependencyManagement管理依赖,
引入到工程中有两种引入方式:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="halo-starter-list"><a class="anchor" href="#halo-starter-list"></a><a class="link" href="#halo-starter-list">7.5. Halo Starter列表</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">名称</th>
<th class="tableblock halign-left valign-top">描述</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-basic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">包含Halo Framework中的CQRS,DDD,扩展点功能</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问<a href="#halo-cqrs">Halo CQRS 2.0设计</a>,<a href="#halo-ddd">Halo DDD</a>,<a href="#Halo-ext">Halo扩展点</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-flow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">包含Halo Framework中的流程编排</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问<a href="#halo-flow">流程编排</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-eureka</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">对Eureka,Ribbon进行定制扩展</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问<a href="#halo-eureka">Halo Eureka</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-openfeign</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">对Open Feign进行定制扩展</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问<a href="#halo-feign">Halo Feign</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-mybatis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">对Mybatis,Mybatis Plus进行定制扩展</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问<a href="#halo-mybatis">Halo Mybatis</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-apollo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">对Apollo进行定制扩展封装</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问<a href="#halo-apollo">Halo Apollo</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-swagger</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">对Swagger进行定制扩展,实现开箱即用</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问 <a href="#halo-swagger">Halo Swagger</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-web</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">对Spring web封装增强和定制</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问 <a href="#halo-web">Halo Web</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-job</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">对xxl-job-core封装成Spring Boot Starter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问 <a href="#halo-job">Halo Job</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-alimq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">对阿里RocketMQ进行封装</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问 <a href="#halo-alimq">Halo AliMQ</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-redis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">支持Redisson，增加Redis工具类</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问 <a href="#halo-redis">Halo Redis</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-mongodb</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">对Spring Boot MongoDB封装增强和定制</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问 <a href="#halo-Mongodb">Halo MongoDB</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-es6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基于Elastic Search 6.3.2封装的Spring Boot Starter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问 <a href="#halo-es-6">Halo ElasticSearch 6.3.2</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-es7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基于Elastic Search 7.2.1封装的Spring Boot Starter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问 <a href="#halo-es-7">Halo ElasticSearch 7.2.1</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">对spring boot test封装定制</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问 <a href="#halo-test">Halo Test</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-shiro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">对Shiro+JWT进行扩展封装支持LDAP Realm和DB Realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问 <a href="#halo-shiro">Halo Shiro</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-influxdb</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">对influxdb-java进行封装比提供InfluxDBTemplate以及常用的操作</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问 <a href="#halo-influxDB">Halo influxDB</a></p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-mapstruct</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">对MapStruct封装定制</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多访问 <a href="#halo-MapStruct">Halo MapStruct</a></p></td>
</tr>
</tfoot>
</table>
</div>
<div class="sect2">
<h3 id="halo-dev-starter"><a class="anchor" href="#halo-dev-starter"></a><a class="link" href="#halo-dev-starter">7.6. Halo Starter说明</a></h3>
<div class="paragraph">
<p><strong>halo-starter-basic</strong>包含了CQRS,DDD,扩展点功能.需要如下maven依赖</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
     <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
     <span class="tag">&lt;artifactId&gt;</span>halo-starter-basic<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果需要使用流程编排的功能，需要引入halo-starter-flow,Maven依赖如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>halo-starter-flow<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Halo Framework的默认扫描包是Spring  Boot主入口程序的所在包以及子包，但是可以通过如下配置自定义命令，扩展点，命令拦截器等的扫描包，
配置如下yml文件所示</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">command-scan-packages</span>: <span class="string"><span class="content">org.xujin.halo.command</span></span>
  <span class="key">extension-scan-packages</span>: <span class="string"><span class="content">org.xujin.halo.extension</span></span>
  <span class="key">post-interceptor-scan-packages</span>: <span class="string"><span class="content">org.xujin.halo.interceptor</span></span>
  <span class="key">pre-interceptor-scan-packages</span>: <span class="string"><span class="content">org.xujin.halo.interceptor</span></span>
  <span class="key">custom-scan-package</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dev-command"><a class="anchor" href="#dev-command"></a><a class="link" href="#dev-command">8. 使用命令</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="create-command-object"><a class="anchor" href="#create-command-object"></a><a class="link" href="#create-command-object">8.1. 编写命令对象</a></h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Data</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AddAppCmd</span> <span class="directive">extends</span> CommonCommand {

    <span class="annotation">@ApiModelProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">应用ID</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> appId;

    <span class="annotation">@ApiModelProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">应用中文名</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@ApiModelProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">应用所有者</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> ownerName;

    <span class="annotation">@ApiModelProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">应用所有者ID</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">Integer</span> ownerId;

    <span class="annotation">@ApiModelProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">应用描述</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> description;

    <span class="annotation">@ApiModelProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">spring应用名称</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> springApplicationName;

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="create-command"><a class="anchor" href="#create-command"></a><a class="link" href="#create-command">8.2. 编写命令执行器</a></h3>
<div class="paragraph">
<p>下面是增加一个App的命令，代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AddAppCmdExe</span> <span class="directive">implements</span> CommandExecutorI&lt;ResultData&lt;<span class="predefined-type">Long</span>&gt;, AddAppCmd&gt;{ # <b class="conum">(1)</b>

    <span class="annotation">@Autowired</span>
    AppService appService; # <b class="conum">(2)</b>

    <span class="annotation">@Autowired</span>
    AppClientConvertor appClientConvertor; # <b class="conum">(3)</b>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ResultData&lt;<span class="predefined-type">Long</span>&gt; execute(AddAppCmd addAppCmd) {
        AppE appE = appClientConvertor.clientToEntity(addAppCmd);# <b class="conum">(4)</b>
        ResultData&lt;<span class="predefined-type">Long</span>&gt; resultData = ResultData.builder(<span class="predefined-constant">null</span>);
        <span class="keyword">if</span> (!check(appE, resultData)) {
            <span class="keyword">return</span> resultData;
        }
        <span class="keyword">try</span> {
            appE.save();
            resultData.setData(appE.getId());
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
            log.error(<span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">add app failed, appE=%s</span><span class="delimiter">&quot;</span></span>, appE), ex);
            resultData.setSuccess(<span class="predefined-constant">false</span>);
            resultData.setCode(<span class="integer">500</span>);
            resultData.setMsgContent(<span class="string"><span class="delimiter">&quot;</span><span class="content">添加失败</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="keyword">return</span> resultData;
    }

    <span class="directive">protected</span> <span class="type">boolean</span> check(AppE appE, ResultData&lt;<span class="predefined-type">Long</span>&gt; resultData) { #<b class="conum">(5)</b>
        <span class="keyword">try</span> {
            Preconditions.checkNotNull(appE, <span class="string"><span class="delimiter">&quot;</span><span class="content">appE不能为null</span><span class="delimiter">&quot;</span></span>);
            Preconditions.checkArgument(!appService.containsAppId(appE.getAppId()), <span class="string"><span class="delimiter">&quot;</span><span class="content">appId不能重复</span><span class="delimiter">&quot;</span></span>);
            Preconditions.checkArgument(StringUtils.isNotEmpty(appE.getAppId()), <span class="string"><span class="delimiter">&quot;</span><span class="content">appId不能为空</span><span class="delimiter">&quot;</span></span>);
            Preconditions.checkArgument(StringUtils.isNotEmpty(appE.getName()), <span class="string"><span class="delimiter">&quot;</span><span class="content">name不能为空</span><span class="delimiter">&quot;</span></span>);
            Preconditions.checkArgument(StringUtils.isNotEmpty(appE.getOwnerName()), <span class="string"><span class="delimiter">&quot;</span><span class="content">ownerName不能为空</span><span class="delimiter">&quot;</span></span>);
            Preconditions.checkNotNull(appE.getOwnerId(), <span class="string"><span class="delimiter">&quot;</span><span class="content">ownerId不能为空</span><span class="delimiter">&quot;</span></span>);
            Preconditions.checkArgument(StringUtils.isNotEmpty(appE.getDescription()), <span class="string"><span class="delimiter">&quot;</span><span class="content">description不能为空</span><span class="delimiter">&quot;</span></span>);
            Preconditions.checkArgument(StringUtils.isNotEmpty(appE.getSpringApplicationName()), <span class="string"><span class="delimiter">&quot;</span><span class="content">springApplicationName不能为空</span><span class="delimiter">&quot;</span></span>);
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
            resultData.setSuccess(<span class="predefined-constant">false</span>);
            resultData.setMsgContent(ex.getMessage());
            <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        }
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    }
}</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre>以下介绍命令执行器的注意事项：</pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>AddAppCmdExe需要实现CommandExecutorI接口，其中CommandExecutorI&lt;ResultData&lt;Long&gt;,
AddAppCmd&gt;的ResultData&lt;Long&gt;是命令返回的结果，AddAppCmd是命令对象。</p>
</li>
<li>
<p>appService是示例的领域服务</p>
</li>
<li>
<p>appClientConvertor是转换防腐层，从App层进入Domain层需要转换防腐。</p>
</li>
<li>
<p>把客户端对象转换为实体</p>
</li>
<li>
<p>验证传入的addAppCmd命令对象是否合法</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="create-command"><a class="anchor" href="#create-command"></a><a class="link" href="#create-command">8.3. 发送命令</a></h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Autowired</span>
<span class="directive">private</span> CommandBus commandBus; # <b class="conum">(1)</b>

<span class="annotation">@PostMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@ApiOperation</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">增加应用</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> ResultData&lt;<span class="predefined-type">Long</span>&gt; addApp(<span class="annotation">@RequestBody</span> AddAppCmd addAppCmd) {
   <span class="keyword">return</span> commandBus.send(addAppCmd); # <b class="conum">(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>在需要发送命令的地方，依赖注入CommandBus</p>
</li>
<li>
<p>commandBus.send发送命令对象</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="use-ext"><a class="anchor" href="#use-ext"></a><a class="link" href="#use-ext">9. 扩展快速入门</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="create-ext"><a class="anchor" href="#create-ext"></a><a class="link" href="#create-ext">9.1. 编写一个扩展点</a></h3>
<div class="paragraph">
<p>如下所示定义一个扩展点</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.xujin.halo.extension</span>;

<span class="keyword">import</span> <span class="include">org.xujin.halo.annotation.extension.ExtensionPoint</span>;

<span class="annotation">@ExtensionPoint</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">支付扩展点</span><span class="delimiter">&quot;</span></span>,  desc = <span class="string"><span class="delimiter">&quot;</span><span class="content">PayExtPt Desc</span><span class="delimiter">&quot;</span></span>) # <b class="conum">(1)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">PayExtPt</span> <span class="directive">extends</span> ExtensionPointI {

    <span class="directive">public</span> <span class="predefined-type">String</span> pay(<span class="predefined-type">Object</span> object);

    <span class="type">void</span> pay();

}</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre>以下介绍编写扩展点的注意事项：</pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>@ExtensionPoint是一个扩展点注解，其中name和desc为必填属性。</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="create-ext"><a class="anchor" href="#create-ext"></a><a class="link" href="#create-ext">9.1.1. 编写一个扩展</a></h4>
<div class="paragraph">
<p>如下所示实现PayExtPt接口,编写了两个扩展</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.xujin.halo.extension</span>;

<span class="keyword">import</span> <span class="include">org.xujin.halo.annotation.extension.Extension</span>;

<span class="comment">/**
 * 支付宝支付扩展
 * @author xujin
 */</span>
<span class="annotation">@Extension</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">支付包支付扩展</span><span class="delimiter">&quot;</span></span>, bizCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">com.pay.alipay</span><span class="delimiter">&quot;</span></span>,desc = <span class="string"><span class="delimiter">&quot;</span><span class="content">支付宝支付扩展</span><span class="delimiter">&quot;</span></span>) # <b class="conum">(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AliPayExtension</span> <span class="directive">implements</span> PayExtPt {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> pay(<span class="predefined-type">Object</span> object) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">支付包支付扩展</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> pay() {
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>其中的bizCode = "com.pay.alipay"是业务身份,业务身份之间用.隔开,一般来说是:一级业务身份.二级业务身份.三级业务身份</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.xujin.halo.extension</span>;

<span class="keyword">import</span> <span class="include">org.xujin.halo.annotation.extension.Extension</span>;

<span class="keyword">package</span> <span class="namespace">org.xujin.halo.extension</span>;

<span class="keyword">import</span> <span class="include">org.xujin.halo.annotation.extension.Extension</span>;

<span class="annotation">@Extension</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">微信支付扩展</span><span class="delimiter">&quot;</span></span>, bizCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">com.pay.weixinPay</span><span class="delimiter">&quot;</span></span>,desc = <span class="string"><span class="delimiter">&quot;</span><span class="content">微信支付扩展</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">WeiXinPayExtension</span> <span class="directive">implements</span> PayExtPt {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> pay(<span class="predefined-type">Object</span> object) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">微信支付扩展</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> pay() {
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="call-ext"><a class="anchor" href="#call-ext"></a><a class="link" href="#call-ext">9.2. 调用执行扩展</a></h3>
<div class="paragraph">
<p>下面的代码示例是在Controller中调用执行一个扩展点，示例代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RestController</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/admin/test</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">TestController</span> {

    <span class="comment">/**
     * 依赖注入扩展执行器
     */</span>
    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> ExtensionExecutor extensionExecutor; #<b class="conum">(1)</b>

    <span class="annotation">@GetMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/extensionExe</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> exeExtension() {
        <span class="predefined-type">Context</span> context = <span class="keyword">new</span> <span class="predefined-type">Context</span>();
        context.setBizCode(<span class="string"><span class="delimiter">&quot;</span><span class="content">com.pay.alipay</span><span class="delimiter">&quot;</span></span>); #<b class="conum">(2)</b>
        <span class="predefined-type">String</span> result=extensionExecutor.exeReturnValue(PayExtPt.class,context, extension -&gt; extension.pay(<span class="predefined-constant">null</span>)); #<b class="conum">(3)</b>
                      extensionExecutor.exeReturnVoid(PayExtPt.class,context,extension1 -&gt; extension1.pay()); #<b class="conum">(4)</b>
        <span class="keyword">return</span> result;
    }

}</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre>通过上述代码，介绍一下调用扩展点的注意事项</pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>表示通过@Autowired依赖注入ExtensionExecutor</p>
</li>
<li>
<p>表示通过context.setBizCode("com.pay.alipay")设置业务身份</p>
</li>
<li>
<p>表示通过extensionExecutor.execute执行扩展传入的参数分别是扩展点,上下文，函数式调用的扩展方法</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_创建流程"><a class="anchor" href="#_创建流程"></a><a class="link" href="#_创建流程">10. 创建流程</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>如何使用Halo Flow创建流程,具体使用请参考<a href="#halo-flow-define">流程定义</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_halo_ddd使用"><a class="anchor" href="#_halo_ddd使用"></a><a class="link" href="#_halo_ddd使用">11. Halo DDD使用</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>如何使用Halo DDD具体使用请参考<a href="#halo-ddd-action">halo DDD实战</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_halo_qa"><a class="anchor" href="#_halo_qa"></a><a class="link" href="#_halo_qa">12. Halo QA</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>1.如果出现如下的错误信息,即命令没有在CommandHub中找到</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">timestamp</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2019-05-29T02:20:46.054+0000</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>: <span class="integer">500</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Internal Server Error</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">class org.xujin.order.client.cmo.AddOrderCmd is not registered in CommandHub, please register first</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">path</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">/createOrder</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
原因:说明工程中有两个命令对象都叫AddOrderCmd，命令对象是不允许重复和复用，一个命令对应唯一的一个业务请求意图。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>2.ddd的编码方案是否适合每个中心，库存中心这样高并发更新的场景适合用ddd的编码方式吗？</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
ddd的编码方案，不一定适用某个中心，有时候写起来会比较别扭.如果是简单，传统的，一些服务没有必要。比如只有接口,Job,跑批的服务.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>3.按照ddd理论，repository获取和更新都是针对聚合根，但在一个聚合根里面嵌套了很多实体的情况下，这样保存和获取可能会存在性能问题，或者有很多麻烦（比如更新订单列表，在基础设施层需要判断哪些记录时新增的，哪些时修改的，哪些时删除的，很麻烦，更有三层嵌套的情况会更加复杂）</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
可以向基础设施层直接发送保存某个单条entity的命令，不按照聚合根维度save.如果是复杂的业务推荐的做法是领域服务调用实体或者值对象，完成自己的行为。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>4.ddd的开发模式来看，领域层的代码和非领域层的代码是否有必要分成由不同团队人员进行？如果是，是否有经验分享。你们在实施ddd的过程中，领域层的自动化测试是由什么角色承担？</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
领域层的代码和非领域层的代码可以分成不用的团队人员进行。比如应用层和基础设施层的人可以是1-3年或者1-2年的工程师去编写，领域层是是架构师或者3年以上的人处理
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>5.DomainService是必须有的吗？一个模块只有一个聚合根的时候，是否有必要有domainService，domainService 只能调用模块内的不同聚合根，还是可以调用其他模块的聚合根？</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
领域服务是按<strong>领域</strong>来划分，不是<strong>按聚合根</strong>来划分。
一般来说领域对象<strong>有自己的的行为和能力</strong>,可以<strong>自己处理的</strong>,则不需要通过Domain Service去处理.
Domain Service可以调用当前领域内的领域对象(也就是既可以调用实体也可以调用值对象)，但是不能访问或者调用其它领域的东西。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>6.领域对象可以直接持有repository吗?</p>
</div>
<div class="paragraph">
<p>可以直接持有,领域对象因为不是Spring Bean所以，可以把repository作为一个属性处理,如下代码所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="annotation">@AggregateRoot</span>
<span class="annotation">@Data</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerE</span> {

    <span class="annotation">@UniqueIdentity</span>
    <span class="directive">private</span> <span class="predefined-type">Long</span> customerId;

    <span class="directive">private</span> CustomerRepository customerRepository;

    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@DomainAbility</span>
    <span class="directive">public</span> <span class="type">void</span> save(){
        customerRepository.save(<span class="local-variable">this</span>);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>7.基础设施层除了保存领域对象以外可以做一些其它操作吗，比如更新某个实体的最后修改时间，其版本号这些?</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
基础设施层主要是提供整个应用的基础设施,比如和db，redis，mq，rpc和rest等打交道。
基础设施层没有实体,只有数据对象也就是DataObject,最终会变成数据对象进行更新。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>8.halo和cola有哪些显著的异同</p>
</div>
<div class="paragraph">
<p>Halo吸取了Cola和TMF的优点。最大的不同就是结合DDD和中台有自己的实现。</p>
</div>
<div class="paragraph">
<p>9.转换层和资源库层出现循环依赖处理?</p>
</div>
<div class="paragraph">
<p>Halo基于Spring Boot 2.0.8版本升级之后出现Spring依赖强校验循环依赖.</p>
</div>
<div class="paragraph">
<p>RuleFileConverter依赖RuleFileRepository</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">RuleFileConverter</span> <span class="directive">implements</span> ConverterI {

    <span class="annotation">@Autowired</span>
    RuleFileRepository ruleFileRepository;

    <span class="annotation">@Autowired</span>
    RuleItemRepository ruleItemRepository;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>而RuleFileRepository依赖RuleFileConverter</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@DomainRepository</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">RuleFileRepository</span> {

    <span class="annotation">@Autowired</span>
    <span class="annotation">@Lazy</span> <span class="comment">//启动延迟加载bean,调用时再去初始化</span>
    RuleFileConverter ruleFileConverter;

    <span class="annotation">@Autowired</span>
    RuleFileMapper ruleFileMapper;
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
@Lazy注解的功能是，在Spring 在启动的时候延迟加载这个bean，然后在即调用这个bean的时候再去初始化，
这样就避免了Spring循环引用的异常
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Halo-IDEA-Plugin"><a class="anchor" href="#Halo-IDEA-Plugin"></a><a class="link" href="#Halo-IDEA-Plugin">13. Halo ToolKit</a></h2>
<div class="sectionbody">
<div class="literalblock">
<div class="content">
<pre>Halo ToolKit是一个IDEA插件专为使用Halo Framework开发应用而生。</pre>
</div>
</div>
<div class="sect2">
<h3 id="halo-idea-function"><a class="anchor" href="#halo-idea-function"></a><a class="link" href="#halo-idea-function">13.1. IDEA Plugin 功能</a></h3>
<div class="paragraph">
<p>IDEA Plugin加速Halo 应用开发而生。目前主要包含如下功能:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1、支持向导式快速搭建中台应用和传统应用</p>
</li>
<li>
<p>2、在应用Spring Application启动入口程序中中点击@Domain前面的图标可快速维护应用和中台业务域的关系</p>
</li>
<li>
<p>3、Halo Setting中的Halo Server支持自定义代码生成器服务端和Halo Admin中台可视化服务端URL</p>
</li>
<li>
<p>4、Halo Setting中的Data Source支持对数据源进行管理</p>
</li>
<li>
<p>5、Halo Setting中的Halo Config支持对插件的功能进行关闭和打开</p>
</li>
<li>
<p>6、右键支持创建13种Java类，包括创建实体，域服务，流程，资源库，Controller等</p>
</li>
<li>
<p>7、右键创建数据对象支持选择数据库连接和向导式创建工程支持选择数据库连接</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="install-halo-idea"><a class="anchor" href="#install-halo-idea"></a><a class="link" href="#install-halo-idea">13.2. 安装IDEA Plugin</a></h3>
<div class="paragraph">
<p>1.打开IDEA在IDEA插件市场中，搜索Halo Tookit进行安装,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/halo-idea-install-1.png" alt="halo idea install 1" width="800">
</div>
<div class="title">Figure 5. Halo Toolkit安装图1</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/halo-idea-install-2.png" alt="halo idea install 2" width="800">
</div>
<div class="title">Figure 6. Halo Toolkit安装图2</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="use-halo-idea"><a class="anchor" href="#use-halo-idea"></a><a class="link" href="#use-halo-idea">14. 快速使用IDEA插件</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="halo-Settings"><a class="anchor" href="#halo-Settings"></a><a class="link" href="#halo-Settings">14.1. Halo Settings</a></h3>
<div class="sect3">
<h4 id="_halo_server设置"><a class="anchor" href="#_halo_server设置"></a><a class="link" href="#_halo_server设置">14.1.1. Halo Server设置</a></h4>
<div class="paragraph">
<p>Halo ToolKit支持自定义Halo框架对应的代码生成器服务端和Halo Admin可视化中台管控服务端，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/halo-set-1.png" alt="halo set 1" width="800">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>主要方便内网部署服务端和使用本地的服务端</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_halo_config设置"><a class="anchor" href="#_halo_config设置"></a><a class="link" href="#_halo_config设置">14.1.2. Halo Config设置</a></h4>
<div class="paragraph">
<p>Halo Config是一个Halo ToolKit提供的IDEA插件配置选项，目前支持是否开启行标记。如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/halo-set-2.png" alt="halo set 2" width="800">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_data_source设置"><a class="anchor" href="#_data_source设置"></a><a class="link" href="#_data_source设置">14.1.3. Data Source设置</a></h4>
<div class="paragraph">
<p>Halo ToolKit支持对Mysql数据库数据源的的增加，删除，测试连接的管理存储，方便在IDEA插件需要使用的地方直接选择即可，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/halo-set-3.png" alt="halo set 3" width="800">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/halo-set-4.png" alt="halo set 4" width="800">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="new-halo-prject"><a class="anchor" href="#new-halo-prject"></a><a class="link" href="#new-halo-prject">14.2. 创建 Halo Project</a></h3>
<div class="paragraph">
<p>1.选择Halo，开始创建Halo工程，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/create-1.png" alt="create 1" width="800">
</div>
<div class="title">Figure 7. Create Halo Project</div>
</div>
<div class="paragraph">
<p>2.填写工程的基本信息和模块信息，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/create-2.png" alt="create 2" width="800">
</div>
</div>
<div class="paragraph">
<p>3.如果需要通过数据库中的表生成MyBatis对应的Mapper和数据对象，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/create3-1.png" alt="create3 1" width="800">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>如果在Halo Reference维护了至少一个可用的数据库连接信息，在这里将出现可选的数据库连接，如上图所示,否则如下图所示</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/create-3.png" alt="create 3" width="800">
</div>
</div>
<div class="paragraph">
<p>4.设置工程的存储位置(无需设置直接Finish)，点击Finish完成</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/create-4.png" alt="create 4" width="800">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>创建完毕的Halo Project，IDEA插件自动会刷新工程的Jar依赖，刷新完毕之后，可以直接运行工程。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="line-marker"><a class="anchor" href="#line-marker"></a><a class="link" href="#line-marker">14.3. 行标记功能</a></h3>
<div class="sect3">
<h4 id="_domain行标记修改"><a class="anchor" href="#_domain行标记修改"></a><a class="link" href="#_domain行标记修改">14.3.1. @Domain行标记修改</a></h4>
<div class="paragraph">
<p>Halo框架所创建的应用需要管中台可视化纳管，因此当应用启动的时候会判断当前应用是否属于某个域，不属于某个域将停止启动，HaloTools提供一个快速修改编辑的功能。如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/line-marker-1.png" alt="line marker 1">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="right-click-function"><a class="anchor" href="#right-click-function"></a><a class="link" href="#right-click-function">14.4. 增强右键功能</a></h3>
<div class="literalblock">
<div class="content">
<pre>Halo ToolKit提供右键增强功能，帮助开发快速创建常用的Java类，提高开发效率。</pre>
</div>
</div>
<div class="sect3">
<h4 id="create-controller"><a class="anchor" href="#create-controller"></a><a class="link" href="#create-controller">14.4.1. 创建Controller</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>如下图所示，右键点击controller包创建Controller</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/controller-1.png" alt="controller 1">
</div>
</div>
<div class="paragraph">
<p>2.输入Controller对应的类名，下拉列表选择创建Controller</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/controller-1-1.png" alt="controller 1 1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/controller-2.png" alt="controller 2">
</div>
</div>
<div class="paragraph">
<p>3.创建完之后的Controller代码如下所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/controller-3.png" alt="controller 3">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-do"><a class="anchor" href="#create-do"></a><a class="link" href="#create-do">14.4.2. 创建Data Object(数据对象)</a></h4>
<div class="paragraph">
<p>1.右键点击dataobject包，创建数据对象</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/data-object-1.png" alt="data object 1">
</div>
</div>
<div class="paragraph">
<p>2.填写数据库连接信息，获取表信息</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/data-object-2.png" alt="data object 2">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="literalblock">
<div class="content">
<pre>所填写的DB URL中需要包含数据库信息</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>3.连接数据库获取表成功，如下所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/data-object-3.png" alt="data object 3">
</div>
</div>
<div class="paragraph">
<p>4.选择对应的表，自动转换设置Data Object的类名如下所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/data-object-4.png" alt="data object 4">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Data Object的类名必须以DO结尾，选择表之后，框架自动设置数据对象的类名。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>5.生成的Data Object的代码如下所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/data-object-5.png" alt="data object 5">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-mapper"><a class="anchor" href="#create-mapper"></a><a class="link" href="#create-mapper">14.4.3. 创建Mapper</a></h4>
<div class="paragraph">
<p>1.在基础设施层，右键点击dao包创建Mapper如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/mapper-1.png" alt="mapper 1">
</div>
</div>
<div class="paragraph">
<p>2.输入Mapper对应的类名，选择对应的数据对象创建Mapper，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/mapper-2.png" alt="mapper 2">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Mapper的类名必须用Mapper为后缀</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>3.选择数据对象之后，自动回填设置数据对象的名称</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/mapper-3.png" alt="mapper 3">
</div>
</div>
<div class="paragraph">
<p>4.创建完的Mapper代码，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/mapper-4.png" alt="mapper 4">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-cmo"><a class="anchor" href="#create-cmo"></a><a class="link" href="#create-cmo">14.4.4. 创建Command Object(命令对象)</a></h4>
<div class="paragraph">
<p>1.如下图所示，点击cmo包右键创建命令对象</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/cmo-1.png" alt="cmo 1">
</div>
</div>
<div class="paragraph">
<p>2.命令对象以Cmd结尾,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/cmo-2.png" alt="cmo 2">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-handler"><a class="anchor" href="#create-handler"></a><a class="link" href="#create-handler">14.4.5. 创建(Command Handler)命令执行器</a></h4>
<div class="paragraph">
<p>1.如下图所示，点击command包右键创建命令执行器</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/cmd-handler-1.png" alt="cmd handler 1">
</div>
</div>
<div class="paragraph">
<p>2.命令执行器以Exe结尾,选择命令对象,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/cmd-handler-2.png" alt="cmd handler 2">
</div>
</div>
<div class="paragraph">
<p>3.输入命令对象返回值的类型,可以是任意返回值的类型</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/cmd-handler-3.png" alt="cmd handler 3">
</div>
</div>
<div class="paragraph">
<p>4.生成后的命令执行器代码如下所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/cmd-handler-4.png" alt="cmd handler 4">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-phase"><a class="anchor" href="#create-phase"></a><a class="link" href="#create-phase">14.4.6. 创建阶段</a></h4>
<div class="paragraph">
<p>1.如下图所示,点击phase包右键创建阶段</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/phase-1.png" alt="phase 1">
</div>
</div>
<div class="paragraph">
<p>2.阶段以Phase结尾,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/phase-2.png" alt="phase 2">
</div>
</div>
<div class="paragraph">
<p>3.创建好的示例阶段代码,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/phase-3.png" alt="phase 3">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-step"><a class="anchor" href="#create-step"></a><a class="link" href="#create-step">14.4.7. 创建步骤</a></h4>
<div class="paragraph">
<p>1.如下图所示,点击step包右键创建阶段</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/step-1.png" alt="step 1">
</div>
</div>
<div class="paragraph">
<p>2.阶段以Step结尾,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/step-2.png" alt="step 2">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
步骤的入参和出参,可以是任意类型.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>3.创建好的示例步骤代码,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/step-3.png" alt="step 3">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-appservice"><a class="anchor" href="#create-appservice"></a><a class="link" href="#create-appservice">14.4.8. 创建应用服务</a></h4>
<div class="paragraph">
<p>1.如下图所示,点击appservice包右键应用服务</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/appservice-1.png" alt="appservice 1">
</div>
</div>
<div class="paragraph">
<p>2.应用服务以AS结尾,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/appservice-2.png" alt="appservice 2">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
应用服务的入参和出参,可以是任意类型.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>3.创建好的示例应用服务代码,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/appservice-3.png" alt="appservice 3">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-flow"><a class="anchor" href="#create-flow"></a><a class="link" href="#create-flow">14.4.9. 创建Flow流程定义</a></h4>
<div class="paragraph">
<p>1.点击flow包右键创建流程定义，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/flow-1.png" alt="flow 1">
</div>
</div>
<div class="paragraph">
<p>2.输入流程定义的的类名,流程名称和流程描述,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/flow-2.png" alt="flow 2">
</div>
</div>
<div class="paragraph">
<p>3.创建流程定义的示例代码,如下所示,需要根据实际情况修改</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/flow-3.png" alt="flow 3">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-flow-prossor"><a class="anchor" href="#create-flow-prossor"></a><a class="link" href="#create-flow-prossor">14.4.10. 创建节点执行器</a></h4>
<div class="paragraph">
<p>1.点击processor包右键创建流程节点执行器,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/processor-1.png" alt="processor 1">
</div>
</div>
<div class="paragraph">
<p>2.填写节点执行器的类名,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/processor-2.png" alt="processor 2">
</div>
</div>
<div class="paragraph">
<p>3.生成后的节点执行器的代码如下所示,需要根据实际情况修改,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/processor-3.png" alt="processor 3">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-extp"><a class="anchor" href="#create-extp"></a><a class="link" href="#create-extp">14.4.11. 创建Extension Point(扩展点）</a></h4>
<div class="paragraph">
<p>1.新建extension或者extensionpoint包，创建扩展点，如下图所示：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/extp-1.png" alt="extp 1">
</div>
</div>
<div class="paragraph">
<p>2.选择Class Kind为Extension Point开始创建扩展点</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/extp-2.png" alt="extp 2">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>扩展点的类名必须用ExtP为后缀，否则会出现约束提示信息。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>3.输入扩展点名称和扩展点描述，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/extp-3.png" alt="extp 3">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>创建完的扩展点代码如下所示:</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/extp-4.png" alt="extp 4">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-ext"><a class="anchor" href="#create-ext"></a><a class="link" href="#create-ext">14.4.12. 创建Extension（扩展）</a></h4>
<div class="paragraph">
<p>1.在extension包下面，创建扩展，如下图所示：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/extp-1.png" alt="extp 1">
</div>
</div>
<div class="paragraph">
<p>2.输入类名，选择Class Kind为Extension，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/ext-2.png" alt="ext 2">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>扩展的类名必须用Ext为后缀，否则会出现约束提示信息。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>3.输入扩展名称，和业务身份，并选择扩展点，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/ext-3.png" alt="ext 3">
</div>
</div>
<div class="paragraph">
<p>4.输入扩展点描述，如下所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/ext-4.png" alt="ext 4">
</div>
</div>
<div class="paragraph">
<p>5.创建完的扩展代码如下所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/ext-5.png" alt="ext 5">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-event-object"><a class="anchor" href="#create-event-object"></a><a class="link" href="#create-event-object">14.4.13. 创建Event Object(事件对象)</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在event的包下面，创建Event对象如下所示:</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/event-1.png" alt="event 1">
</div>
</div>
<div class="paragraph">
<p>2.选择Class类型为Event Object，事件对象需要以Event结尾。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/event-2.png" alt="event 2">
</div>
</div>
<div class="paragraph">
<p>3.创建Event对象后的代码如下所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/event-3.png" alt="event 3">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-event-handler"><a class="anchor" href="#create-event-handler"></a><a class="link" href="#create-event-handler">14.4.14. 创建 Event Handler(事件处理器)</a></h4>
<div class="paragraph">
<p>1.如下图所示，在event包下面右键创建事件处理器</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/event-handler-1.png" alt="event handler 1">
</div>
</div>
<div class="paragraph">
<p>2.选择Class类型为Event Handler，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/event-handler-2.png" alt="event handler 2">
</div>
</div>
<div class="paragraph">
<p>3.创建事件处理器，需要选择事件对象，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/event-handler-3.png" alt="event handler 3">
</div>
</div>
<div class="paragraph">
<p>4.选择事件对象之后，自动回填设置数据对象。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/event-handler-4.png" alt="event handler 4">
</div>
</div>
<div class="paragraph">
<p>5.创建完的事件处理器的代码如下所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/event-handler-5.png" alt="event handler 5">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-entity"><a class="anchor" href="#create-entity"></a><a class="link" href="#create-entity">14.4.15. 创建实体</a></h4>
<div class="paragraph">
<p>1.在entity包下面，右键创建实体，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/entity-1.png" alt="entity 1">
</div>
</div>
<div class="paragraph">
<p>2.实体的类名必须以E结尾，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/entity-2.png" alt="entity 2">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-vo"><a class="anchor" href="#create-vo"></a><a class="link" href="#create-vo">14.4.16. 创建值对象</a></h4>
<div class="paragraph">
<p>1.点击valueobject包右键，创建值对象如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/value-object-1.png" alt="value object 1">
</div>
</div>
<div class="paragraph">
<p>2.输入值对象的类名，以VO结尾，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/value-object-2.png" alt="value object 2">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-ds"><a class="anchor" href="#create-ds"></a><a class="link" href="#create-ds">14.4.17. 创建Domain Service(领域服务)</a></h4>
<div class="paragraph">
<p>1.点击service包右键，创建域服务接口如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/domain-service-1.png" alt="domain service 1">
</div>
</div>
<div class="paragraph">
<p>2.点击impl包右键,创建域服务接口的实现类,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/domain-service-2.png" alt="domain service 2">
</div>
</div>
<div class="paragraph">
<p>3.填写域服务的实现类名,点击Choose选择域服务接口,如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/domain-service-3.png" alt="domain service 3">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-factory"><a class="anchor" href="#create-factory"></a><a class="link" href="#create-factory">14.4.18. 创建工厂</a></h4>
<div class="paragraph">
<p>1.点击factory包右键，创建工厂如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/factory-1.png" alt="factory 1">
</div>
</div>
<div class="paragraph">
<p>2.输入工厂的类名，以Factory结尾，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/factory-2.png" alt="factory 2">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-respory"><a class="anchor" href="#create-respory"></a><a class="link" href="#create-respory">14.4.19. 创建资源库</a></h4>
<div class="paragraph">
<p>1.点击repository包右键，创建资源库如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/repository-1.png" alt="repository 1">
</div>
</div>
<div class="paragraph">
<p>2.输入资源库的类名，以Repository结尾，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-idea/repository-2.png" alt="repository 2">
</div>
</div>
</div>
</div>
</div>
</div>
<h1 id="halo-framework" class="sect0"><a class="anchor" href="#halo-framework"></a><a class="link" href="#halo-framework">V Halo Framework</a></h1>
<div class="sect1">
<h2 id="halo-overview"><a class="anchor" href="#halo-overview"></a><a class="link" href="#halo-overview">15. Halo Framework概述</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Halo Framework是基于`DDD+CQRS+扩展点+流程编排`的应用框架，致力于采用领域驱动的设计思想，规范控制程序员的随心所欲，从而解决软件的复杂性问题。</p>
</div>
<div class="paragraph">
<p>Halo设计原则简单，即在高内聚，低耦合，可扩展，易理解的指导思想下，尽可能的贯彻面向对象的设计思想和领域驱动设计的原则。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Halo Framework是基于DDD+CQRS+扩展点的应用框架，业务系统使用之自带光环!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Halo Framework的主要模块如下所示:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Halo主要模块</p>
<div class="ulist">
<ul>
<li>
<p>CQRS：读写分离架构-所有请求封装为命令对象，通过Command Bus分发到命令处理器执行，通过Event和Event Bus等实现读写分离。</p>
</li>
<li>
<p>halo-DDD: 根据领域驱动设计思想，自定义注解 <code>@Entity(实体)</code>，<code>@Factory(工厂)</code>, <code>@DomainService(领域服务)</code>,
<code>@ValueObject(值对象)</code>，<code>@DomainRepository(资源库)</code>，<code>@DomainAbility(域能力)</code> 等进行战术设计，落地DDD，实现 <code>业务与业务</code> 隔离。</p>
</li>
<li>
<p>halo-extension：基于扩展点的设计思想，自定义 <code>@ExtensionPoint(扩展点注解)</code> 和 <code>@Extension(扩展注解)</code>, 实现 <code>平台和插件</code> 隔离。</p>
</li>
<li>
<p>halo-flow：基于流程编排思想，开发业务组件，编排应用内部已有业务资产，快速响应前台需求，久而久之形成大量可复用的业务组件库。</p>
</li>
</ul>
</div>
</li>
<li>
<p>Halo-tools</p>
<div class="ulist">
<ul>
<li>
<p>halo-codegen: 通过设计代码生成器, 快速生成最佳实践的基础代码和规范，提高开发效率和生产力，让业务开发人员专注于业务开发。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_halo_framework设计"><a class="anchor" href="#_halo_framework设计"></a><a class="link" href="#_halo_framework设计">16. Halo Framework设计</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_halo_framework设计思想"><a class="anchor" href="#_halo_framework设计思想"></a><a class="link" href="#_halo_framework设计思想">16.1. Halo Framework设计思想</a></h3>
<div class="paragraph">
<p>Halo框架的主要思想是 <code>流程组合节点</code>,<code>节点调用域服务</code>,<code>域服务包含若干域能力</code>,<code>域能力下若干个业务扩展</code>。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>业务包与平台分离的插件化架构： 平台提供插件包注册机制，实现业务方插件包在运行期的注册。业务代码只允许存在于插件包中，
与平台代码严格分离。业务包的代码配置库也与平台的代码库分离，通过二方包的方式，提供给容器加载</p>
</li>
<li>
<p>全链路统一的业务身份：
平台需要能有按“业务身份”进行业务与业务之间逻辑隔离的能力，而不是传统SPI架构不区分业务身份，
  简单过滤的方式。如何设计这个业务身份，也成为业务间隔离架构的关键。</p>
</li>
<li>
<p>管理域与运行域分离： 业务逻辑不能依靠运行期动态计算，要能在静态期进行定义并可视化呈现。
业务定义中出现的规则叠加冲突，也在静态器进行冲突决策。在运行期，严格按照静态器定义的业务规则、冲突决策策略执行。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="halo-design"><a class="anchor" href="#halo-design"></a><a class="link" href="#halo-design">16.2. Halo Framework架构设计</a></h3>
<div class="paragraph">
<p>Halo的整体架构如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/halo-arch-2.0.svg" alt="halo arch 2.0" width="800">
</div>
<div class="title">Figure 8. Halo Framework的架构图</div>
</div>
</div>
<div class="sect2">
<h3 id="halo-cqrs"><a class="anchor" href="#halo-cqrs"></a><a class="link" href="#halo-cqrs">16.3. Halo CQRS 2.0设计</a></h3>
<div class="paragraph">
<p>Halo的整体架构如下图所示:</p>
</div>
<div class="paragraph">
<p>一切用户请求进来皆为命令，封装成命令对象通过Command Bus放送到Command Hub中路由通过命令执行器执行。</p>
</div>
<div class="paragraph">
<p>Halo CQRS 2.0架构图设计如下:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/cqrs/cqrs-2.png" alt="cqrs 2" width="800">
</div>
<div class="title">Figure 9. Halo CQRS的2.0 架构图</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Halo CQRS引入了端口和适配器模式,domain层与App层都是通过端口去访问基础设施层
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Halo CQRS 1.0架构图设计如下:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/cqrs/cqrs-1.png" alt="cqrs 1" width="800">
</div>
<div class="title">Figure 10. Halo CQRS的1.0 架构图</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Halo框架在应用启动的时候会通过扫描自定义的注解，通过高度抽象的RegisterFactory，将命令，命令拦截器，扩展点，流程编排等信息注册到
Spring容器中和应用的内存结构中。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="halo-jpfx"><a class="anchor" href="#halo-jpfx"></a><a class="link" href="#halo-jpfx">16.4. Halo竞品分析</a></h3>
<div class="paragraph">
<p>Axon Framework是国外的一款CQRS+DDD的框架，但是没有扩展点设计，流程编排，相对Halo Framework来说比较复杂，无法自主可控，
并且已经转向商业模式。而国内阿里开源Cola,源于TMF设计思想,Halo与Axon,Cola的对比表格如下所示：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/halo-jp.png" alt="halo jp" width="800">
</div>
<div class="title">Figure 11. Halo竞品分析</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
综合来讲Halo是比Axon,Cola更具有竞争力,是市面上所有产品媲美,更合适作为底层应用框架搭建业务中台。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-cqrs"><a class="anchor" href="#halo-cqrs"></a><a class="link" href="#halo-cqrs">17. Halo CQRS</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="halo-cqrs-gs"><a class="anchor" href="#halo-cqrs-gs"></a><a class="link" href="#halo-cqrs-gs">17.1. CQRS概述</a></h3>
<div class="sect3">
<h4 id="what-is-cqrs"><a class="anchor" href="#what-is-cqrs"></a><a class="link" href="#what-is-cqrs">17.1.1. 什么是CQRS</a></h4>
<div class="paragraph">
<p>CQRS（Command Query Responsibility Segregation）是一种简单的设计模式。它衍生与CQS，即 <code>命令</code> 和 <code>查询分离</code>，
CQS是由Bertrand Meyer所设计。按照这一设计概念，系统中的方法应该分为两种：<code>改变状态的命令</code> 和 <code>返回值的查询</code>。
Greg young将引入了这个设计概念，并将其应用于对象或者组件当中，即现在的CQRS。</p>
</div>
<div class="paragraph">
<p>CQRS的核心思想是将应用程序的查询部分和命令部分完全分离，这两部分可以用完全不同的模型和技术去实现。比如命令部分可以
通过领域驱动设计来实现；查询部分可以直接用最快的非面向对象的方式去实现，比如用SQL。</p>
</div>
<div class="paragraph">
<p>下面，将通一张图来说明应用程序中有关CQRS部分的组成结构：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/cqrs.jpg" alt="cqrs">
</div>
</div>
<div class="paragraph">
<p>===
下面介绍一下CQRS中主要的概念
===</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Commands（命令）—表示用户的操作意图。它们包含了与用户将要对系统执行操作的所有必要信息。</p>
</li>
<li>
<p>Command Bus（命令总线）：是一种接收命令并将命令传递给命令处理程序的队列。</p>
</li>
<li>
<p>Command Handler（命令处理程序）：包含实际的业务逻辑，用于验证和处理命令中接收到的数据。Command handler负责生成和传播域事件（Event）到事件总线（Event Bus）。</p>
</li>
<li>
<p>Event Bus（事件总线）：将事件发布给订阅特定事件类型的事件处理程序。如果存在连续的事件依赖，事件总线可以使用异步或者同步的方式将事件发布出去。</p>
</li>
<li>
<p>Event Handler（事件处理程序）：负责处理特定类型的事件。它们的职责是将应用程序的最新状态保存到读库中，并执行终端的相关操作，如发送电子邮件，存储文件等。</p>
</li>
<li>
<p>Query（查询）：表示用户实际可用的应用程序状态。获取UI的数据应该通过这些对象完成。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_halo中cqrs的实现"><a class="anchor" href="#_halo中cqrs的实现"></a><a class="link" href="#_halo中cqrs的实现">17.2. Halo中CQRS的实现</a></h3>
<div class="paragraph">
<p>CQRS的核心思想是将应用程序的查询部分和命令部分完全分离，这两部分可以用完全不同的模型和技术去实现。
比如命令部分可以通过领域驱动设计来实现；查询部分可以直接用最快的非面向对象的方式去实现，比如用SQL。</p>
</div>
<div class="paragraph">
<p>===
这样的思想有很多好处：
===</p>
</div>
<div class="ulist">
<ul>
<li>
<p>实现命令部分的领域模型不用经常为了领域对象可能会被如何查询而做一些折中处理；</p>
</li>
<li>
<p>由于命令和查询是完全分离的，所以这两部分可以用不同的技术架构实现，包括数据库设计理论上都可以分开设计，每一部分可以充分发挥其长处；</p>
</li>
<li>
<p>高性能，命令端因为没有返回值，可以像消息队列一样接受命令，放在队列中，慢慢处理；处理完后，可以通过异步的方式通知查询端，这样查询端可以做数据同步的处理。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="cqrs-command"><a class="anchor" href="#cqrs-command"></a><a class="link" href="#cqrs-command">17.3. Command命令</a></h3>
<div class="paragraph">
<p>什么是命令 (Command)?
用户界面/展现层的读取或者写入操作都将被封装为一个命令，Command中将不会带有具体的业务逻辑,业务逻辑将在领域层处理。</p>
</div>
<div class="paragraph">
<p>Command的实现涉及到三个东西,分别是 <code>命令对象</code> (Command Object,简称cmo),<code>命令执行器</code> (CommandExecutor),<code>命令总线</code> (Command Bus)。</p>
</div>
<div class="paragraph">
<p>Q:命令该怎么命名？</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
关于命令的命名问题
在给Command类命名的时候，由于Command表示的是想要执行的命令，所以Command类的类名应当是动词的形式。例如RegisterCommand, ChangePasswordCommand等。其中的Command后缀则是可选的，
只要在系统中统一规范命名即可。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Q:命令可以复用吗？</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
  在实际项目中，我们需要注意Command的类名的重要作用，每个Command类的名称都清晰地表达了一个意图，例如ChangePasswordCommand
清晰的表达了这个命令是要修改密码，所以千万不要随意"复用"Command。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>这里的复用有两层含义,分别是:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>看到某两个Command中有完全一样的属性，为了减少几行代码就觉得没有必要使用两个Command，而把它们合并成一个Command，
这样的"复用"会让系统变得越来越难以理解。</p>
</li>
<li>
<p>一个命名对应多个命令执执行器。</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Halo Framework不允许复用命令，在命令注册的时候会统一check，如果发现复用会抛出异常。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="command-fl"><a class="anchor" href="#command-fl"></a><a class="link" href="#command-fl">17.3.1. Command的分类</a></h4>
<div class="literalblock">
<div class="content">
<pre>命令分为两种命令，如下所示:</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Command命令：增加，删除，修改等操作的写命令</p>
</li>
<li>
<p>Query命令: 主要用于查询的命令，由于是读写分离的架构，所以Query命令，可以直接访问数据库层。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="command-ljq"><a class="anchor" href="#command-ljq"></a><a class="link" href="#command-ljq">17.4. Command拦截器</a></h3>
<div class="paragraph">
<p><strong>命令拦截器</strong>主要分为两种，分别是前置命令拦截器和后置命令拦截器。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>前置命令拦截器: 被@PreInterceptor注解修饰的类并实现了CommandInterceptorI接口。</p>
</li>
<li>
<p>后置命令拦截器: 被@PostInterceptor注解修饰的类并实现了CommandInterceptorI接口。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>如下所示的示例代码，通过前置命令拦截器和后置命令拦截器实现一个执行日志记录功能，</p>
</div>
<div class="paragraph">
<p>1.定义了一个前置命令拦截器</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PreInterceptor</span> # <b class="conum">(1)</b>
<span class="annotation">@Order</span>(<span class="integer">1</span>) # <b class="conum">(2)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">LoggerPreInterceptor</span> <span class="directive">implements</span> CommandInterceptorI{  # <b class="conum">(3)</b>

    <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(LoggerPreInterceptor.class);
    <span class="directive">private</span> <span class="predefined-type">ThreadLocal</span>&lt;<span class="predefined-type">Long</span>&gt; startTimeLocal=<span class="keyword">new</span> <span class="predefined-type">ThreadLocal</span>&lt;&gt;();

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> preIntercept(Command command) {

        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Begin to process %s</span><span class="delimiter">&quot;</span></span>, command);
        startTimeLocal.set(<span class="predefined-type">System</span>.currentTimeMillis());
    }

    <span class="directive">public</span> <span class="predefined-type">Long</span> getStartTime() {
        <span class="keyword">return</span> startTimeLocal.get();
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>@PreInterceptor是前置命令拦截器注解</p>
</li>
<li>
<p>@Order(1)是Spring的注解，可以指定前置拦截器的执行顺序，数字越小越优先执行。</p>
</li>
<li>
<p>LoggerPreInterceptor必须实现CommandInterceptorI接口。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>2.定义了一个后置命令拦截器</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Order</span>(<span class="integer">100</span>)
<span class="annotation">@PostInterceptor</span> # <b class="conum">(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">LoggerPostInterceptor</span> <span class="directive">implements</span> CommandInterceptorI{

    <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(LoggerPostInterceptor.class);

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> LoggerPreInterceptor logPreInterceptor;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> postIntercept(Command command, Response response) {
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Finished processing %s Response:%s</span><span class="delimiter">&quot;</span></span>, command.getClass(), response);
        <span class="comment">//记录监控日志</span>
        handleMonitorLog(command, response);
    }

    <span class="directive">private</span> <span class="type">void</span> handleMonitorLog(Command command, Response response){
        <span class="predefined-type">Thread</span> th = <span class="predefined-type">Thread</span>.currentThread();
        <span class="type">boolean</span> status = <span class="predefined-constant">false</span>;
        <span class="predefined-type">Long</span> threadId = <span class="integer">0L</span>;
        <span class="keyword">if</span>(th != <span class="predefined-constant">null</span>){
            threadId = th.getId();
        }
        <span class="comment">//操作人</span>
        <span class="predefined-type">String</span> operator = StringUtils.EMPTY;
        <span class="comment">//处理状态</span>
        <span class="keyword">if</span>(response != <span class="predefined-constant">null</span> &amp;&amp; response.isSuccess()){
            status = <span class="predefined-constant">true</span>;
        }

        <span class="predefined-type">Boolean</span> cacheEnabled = <span class="predefined-constant">false</span>;
        <span class="predefined-type">String</span> params = StringUtils.EMPTY;
        <span class="keyword">if</span>(!status){
            params = command.toString();
        }
        <span class="comment">//status=true 情况下默认关闭参数输出</span>
        <span class="keyword">else</span> <span class="keyword">if</span>(cacheEnabled != <span class="predefined-constant">null</span> &amp;&amp; cacheEnabled){
            params =  command.toString();
        }

        <span class="comment">//毫秒</span>
        <span class="type">long</span> cost = <span class="predefined-type">System</span>.currentTimeMillis() - logPreInterceptor.getStartTime();

        <span class="comment">//|threadId|Command|操作人|处理状态|耗时|ip|params</span>
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">[MonitorLog] |%s|%s|%s|%s|%s|%s</span><span class="delimiter">&quot;</span></span>, threadId, command.getClass(), operator, status, cost, params);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>@PostInterceptor是后置命令拦截器注解</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_命令拦截器filter"><a class="anchor" href="#_命令拦截器filter"></a><a class="link" href="#_命令拦截器filter">17.4.1. 命令拦截器Filter</a></h4>
<div class="paragraph">
<p>通过命令拦截器注解的cmdFilterList字段，可以配置该拦截器只拦截指定的命令类型，以便缩小拦截范围，实现对特殊类型命令的拦截。
该字段适用于@PreInterceptor，@PostInterceptor。</p>
</div>
<div class="paragraph">
<p>通过cmdFilterList字段指定的期望拦截命令类型，必须是目标命令类型及其子类。否则，Halo应用启动时会进行check出现报错提示。</p>
</div>
<div class="paragraph">
<p>指定后，只有指定的命令类型及其子类会被拦截，其它命令不会被拦截。</p>
</div>
<div class="paragraph">
<p>使用示例：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PreInterceptor</span>(
cmdFilterList = DeleteAppCmd.class # <b class="conum">(2)</b>
)
<span class="directive">public</span> <span class="type">class</span> <span class="class">LoggerPreInterceptor</span> <span class="directive">implements</span> CommandInterceptorI&lt;Command&gt; { # <b class="conum">(1)</b>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> preIntercept(Command command) {
        log.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">before process  DeleteAppCmd</span><span class="delimiter">&quot;</span></span>);
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Command：目标命令类型。</p>
</li>
<li>
<p>DeleteAppCmd.class：需要拦截的命令类型，该类型必须是需要拦截的命令类型或其子类，即DeleteAppCmd及其子类都会该拦截器被拦截。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="command-object"><a class="anchor" href="#command-object"></a><a class="link" href="#command-object">17.5. Command对象</a></h3>
<div class="sect3">
<h4 id="what-is-cmo"><a class="anchor" href="#what-is-cmo"></a><a class="link" href="#what-is-cmo">17.5.1. 什么是Command对象</a></h4>
<div class="paragraph">
<p>Command对象的作用是用来封装命令数据，所以这类对象以属性为主，少量简单方法。但注意这些方法中不能包含业务逻辑。
在Halo框架中我们高度抽象了一个Command对象继承了DTO。代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">Command</span> <span class="directive">extends</span> DTO{

        <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">long</span> serialVersionUID = <span class="integer">1L</span>;

        <span class="directive">private</span> <span class="predefined-type">Context</span> context;

        <span class="directive">public</span> <span class="predefined-type">Context</span> getContext() {
                <span class="keyword">return</span> context;
        }

        <span class="directive">public</span> <span class="type">void</span> setContext(<span class="predefined-type">Context</span> context) {
                <span class="local-variable">this</span>.context = context;
        }
}</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Halo框架中的Command继承了DTO，里面有一个属性为Context context，主要用于统一传递命令需要的上下文，比如业务身份，或者其它业务参数。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>实际项目开发中,会创建一个CommonCommand，由于承载共用的属性，示例CommonCommand如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CommonCommand</span> <span class="directive">extends</span> Command {

    <span class="directive">private</span> <span class="predefined-type">String</span> operater;
    <span class="directive">private</span> <span class="type">boolean</span> needsOperator;

    <span class="directive">public</span> <span class="predefined-type">String</span> getOperater() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.operater;
    }

    <span class="directive">public</span> <span class="type">void</span> setOperater(<span class="predefined-type">String</span> operater) {
        <span class="local-variable">this</span>.operater = operater;
        needsOperator = <span class="predefined-constant">true</span>;
    }

    <span class="directive">public</span> <span class="type">boolean</span> isNeedsOperator(){
        <span class="keyword">return</span> needsOperator;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="what-is-command-bus"><a class="anchor" href="#what-is-command-bus"></a><a class="link" href="#what-is-command-bus">17.6. Command Bus</a></h3>
<div class="paragraph">
<p><strong>Command Bus</strong> 就是一个命令执行总线。执行Command的是命令执行器，但CommandExecutor的调用不是通过在用户界面层直接依赖注入调用，
会把所有请求转变为Command对象，然后把它放入到CommandBus中即可。Command Bus的作用是将一个Command分发给对应的CommandExecutor
去执行,如下图所示。CommandBus的出现提供统一的编程入口，开发不需要关心Command会被哪个Executor执行，Commandbus屏蔽了底层的细节。
让分工协作开发更加独立明确。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/cmd-to-bus-exe.gif" alt="cmd to bus exe">
</div>
</div>
<div class="sect3">
<h4 id="_command_bus发送命令对象"><a class="anchor" href="#_command_bus发送命令对象"></a><a class="link" href="#_command_bus发送命令对象">17.6.1. Command Bus发送命令对象</a></h4>
<div class="paragraph">
<p>在Controller中Command Bus分发命令的示例代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RestController</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/admin/app</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Api</span>(description = <span class="string"><span class="delimiter">&quot;</span><span class="content">应用管理</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">AppController</span> {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> CommandBus commandBus; # <b class="conum">(1)</b>

    <span class="annotation">@PostMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@ApiOperation</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">增加应用</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> ResultData&lt;<span class="predefined-type">Long</span>&gt; addApp(<span class="annotation">@RequestBody</span> AddAppCmd addAppCmd) {
        <span class="keyword">return</span> commandBus.send(addAppCmd); # <b class="conum">(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>在应用层，依赖注入CommandBus</p>
</li>
<li>
<p>commandBus.send发送命令对象</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
在上述代码中，从Controller进来的请求统一为命令，只需讲命令扔到CommandBus中即可。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_command_bus发送命令执行器"><a class="anchor" href="#_command_bus发送命令执行器"></a><a class="link" href="#_command_bus发送命令执行器">17.6.2. Command Bus发送命令执行器</a></h4>
<div class="paragraph">
<p>在Controller中发送命令执行器的代码，如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
  * 查询域树型结构
  * @return
 */</span>
<span class="annotation">@GetMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/domain/queryAllDomain</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> ResultData&lt;<span class="predefined-type">List</span>&lt;DomainCO&gt;&gt; getAllDomain() {
    <span class="keyword">return</span> commandBus.send(QueryIdeaDomainListCmdExe.class);  # <b class="conum">(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>其中commandBus.send(QueryIdeaDomainListCmdExe.class)发送的就是命令执行器,当命令中没有入参的时候，可以直接发送命令执行器。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="what-is-command-exe"><a class="anchor" href="#what-is-command-exe"></a><a class="link" href="#what-is-command-exe">17.7. Command执行器</a></h3>
<div class="paragraph">
<p>CommandExecutor就是一个命令执行器，它的作用是执行一个命令。CommandExecutor中主要有两部分工作，分别是</p>
</div>
<div class="ulist">
<ul>
<li>
<p>一是验证传入的Command对象是否合法，</p>
</li>
<li>
<p>二是调用领域服务完成操作。Command和CommandExecutor是一一对应的。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>也就是说，一个Command只会对应一个CommandExecutor。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/cqrs-yl.gif" alt="cqrs yl">
</div>
</div>
<div class="sect3">
<h4 id="with-parameter-command-handler"><a class="anchor" href="#with-parameter-command-handler"></a><a class="link" href="#with-parameter-command-handler">17.7.1. 有入参的Command执行器</a></h4>
<div class="paragraph">
<p>下面是增加一个App的命令，代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AddAppCmdExe</span> <span class="directive">implements</span> CommandExecutorI&lt;ResultData&lt;<span class="predefined-type">Long</span>&gt;, AddAppCmd&gt;{ # <b class="conum">(1)</b>

    <span class="annotation">@Autowired</span>
    AppService appService; # <b class="conum">(2)</b>

    <span class="annotation">@Autowired</span>
    AppClientConvertor appClientConvertor; # <b class="conum">(3)</b>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ResultData&lt;<span class="predefined-type">Long</span>&gt; execute(AddAppCmd addAppCmd) {
        AppE appE = appClientConvertor.clientToEntity(addAppCmd);# <b class="conum">(4)</b>
        ResultData&lt;<span class="predefined-type">Long</span>&gt; resultData = ResultData.builder(<span class="predefined-constant">null</span>);
        <span class="keyword">if</span> (!check(appE, resultData)) {
            <span class="keyword">return</span> resultData;
        }
        <span class="keyword">try</span> {
            appE.save();
            resultData.setData(appE.getId());
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
            log.error(<span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">add app failed, appE=%s</span><span class="delimiter">&quot;</span></span>, appE), ex);
            resultData.setSuccess(<span class="predefined-constant">false</span>);
            resultData.setCode(<span class="integer">500</span>);
            resultData.setMsgContent(<span class="string"><span class="delimiter">&quot;</span><span class="content">添加失败</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="keyword">return</span> resultData;
    }

    <span class="directive">protected</span> <span class="type">boolean</span> check(AppE appE, ResultData&lt;<span class="predefined-type">Long</span>&gt; resultData) { #<b class="conum">(5)</b>
        <span class="keyword">try</span> {
            Preconditions.checkNotNull(appE, <span class="string"><span class="delimiter">&quot;</span><span class="content">appE不能为null</span><span class="delimiter">&quot;</span></span>);
            Preconditions.checkArgument(!appService.containsAppId(appE.getAppId()), <span class="string"><span class="delimiter">&quot;</span><span class="content">appId不能重复</span><span class="delimiter">&quot;</span></span>);
            Preconditions.checkArgument(StringUtils.isNotEmpty(appE.getAppId()), <span class="string"><span class="delimiter">&quot;</span><span class="content">appId不能为空</span><span class="delimiter">&quot;</span></span>);
            Preconditions.checkArgument(StringUtils.isNotEmpty(appE.getName()), <span class="string"><span class="delimiter">&quot;</span><span class="content">name不能为空</span><span class="delimiter">&quot;</span></span>);
            Preconditions.checkArgument(StringUtils.isNotEmpty(appE.getOwnerName()), <span class="string"><span class="delimiter">&quot;</span><span class="content">ownerName不能为空</span><span class="delimiter">&quot;</span></span>);
            Preconditions.checkNotNull(appE.getOwnerId(), <span class="string"><span class="delimiter">&quot;</span><span class="content">ownerId不能为空</span><span class="delimiter">&quot;</span></span>);
            Preconditions.checkArgument(StringUtils.isNotEmpty(appE.getDescription()), <span class="string"><span class="delimiter">&quot;</span><span class="content">description不能为空</span><span class="delimiter">&quot;</span></span>);
            Preconditions.checkArgument(StringUtils.isNotEmpty(appE.getSpringApplicationName()), <span class="string"><span class="delimiter">&quot;</span><span class="content">springApplicationName不能为空</span><span class="delimiter">&quot;</span></span>);
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
            resultData.setSuccess(<span class="predefined-constant">false</span>);
            resultData.setMsgContent(ex.getMessage());
            <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        }
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    }
}</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre>以下介绍命令执行器的注意事项：</pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>AddAppCmdExe需要实现CommandExecutorI接口，其中CommandExecutorI&lt;ResultData&lt;Long&gt;,
AddAppCmd&gt;的ResultData&lt;Long&gt;是命令返回的结果，AddAppCmd是命令对象。</p>
</li>
<li>
<p>appService是示例的领域服务</p>
</li>
<li>
<p>appClientConvertor是转换防腐层，从App层进入Domain层需要转换防腐。</p>
</li>
<li>
<p>把客户端对象转换为实体</p>
</li>
<li>
<p>验证传入的addAppCmd命令对象是否合法</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="without-parameter-command-handler"><a class="anchor" href="#without-parameter-command-handler"></a><a class="link" href="#without-parameter-command-handler">17.7.2. 无入参的Command执行器</a></h4>
<div class="paragraph">
<p>在Halo中一切请求皆为命令，但是有些命令没有入参，Halo提供统一的编程方式解决。命令执行器只需实现CommandExecutorWithoutInputI接口即可。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@CmdHandler</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">QueryAllMenuCmdExe</span> <span class="directive">implements</span> CommandExecutorWithoutInputI&lt;ResultData&lt;<span class="predefined-type">List</span>&lt;UserMenuCO&gt;&gt;&gt; {  # <b class="conum">(1)</b>

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> MenuMapper menuMapper;

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> MenuClientConverter menuClientConverter;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ResultData&lt;<span class="predefined-type">List</span>&lt;UserMenuCO&gt;&gt; execute() {
        <span class="predefined-type">List</span>&lt;MenuDO&gt; allMenu = menuMapper.getAllMenu();
        <span class="predefined-type">List</span>&lt;UserMenuCO&gt; allMenus = menuClientConverter.dataToClient(allMenu);
        <span class="keyword">return</span> ResultData.success(allMenus);
    }

}</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre>以下介绍无入参命令执行器的注意事项：</pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>QueryAllMenuCmdExe需要实现CommandExecutorWithoutInputI接口，
其中CommandExecutorWithoutInputI&lt;ResultData&lt;List&lt;UserMenuCO&gt;&gt;&gt;的ResultData&lt;List&lt;UserMenuCO&gt;&gt;是命令返回的结果。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_command执行结果"><a class="anchor" href="#_command执行结果"></a><a class="link" href="#_command执行结果">17.8. Command执行结果</a></h3>
<div class="paragraph">
<p>命令执行器会执行命令，经过一系列的命令处理之后，会返回的命令处理结果。Halo框架为了统一规范，对返回的命令处理结果进行封装处理，目前支持不带返回值的Response
和支持ResultData泛型支持。如果需要定义返回结果的包装类型，类似默认ResultData的实现需要继承Response。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * 统一的结果返回包装类型
 * @author xujin
 */</span>
<span class="annotation">@Builder</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ResultData</span> &lt;T&gt;  <span class="directive">extends</span> Response {

    <span class="annotation">@Tolerate</span>
    <span class="directive">public</span> ResultData(){}

    <span class="comment">/** 返回的数据 **/</span>
    <span class="directive">private</span> T data;


    <span class="directive">public</span> <span class="directive">static</span> &lt;T&gt; ResultData&lt;T&gt; builder(T data) {
        ResultData&lt;T&gt; resultData= <span class="keyword">new</span> ResultData();
        resultData.setData(data);
        <span class="keyword">return</span> resultData;
    }

    <span class="directive">public</span> T getData() {
        <span class="keyword">return</span> data;
    }

    <span class="directive">public</span> <span class="type">void</span> setData(T data) {
        <span class="local-variable">this</span>.data = data;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cqrs-event"><a class="anchor" href="#cqrs-event"></a><a class="link" href="#cqrs-event">17.9. Event</a></h3>
<div class="literalblock">
<div class="content">
<pre>  领域事件是最近几年才加入DDD生态系统的，通过领域事件的方式达到各个组件之间的数据一致性。领域事件的额外好处在于它可以记录发生
在软件系统中所有的重要修改，这样可以很好地支持程序调试和商业智能化。</pre>
</div>
</div>
<div class="paragraph">
<p>在CQRS架构的软件系统中，领域事件还用于写模型和读模型之间的数据同步,或者异步处理。</p>
</div>
<div class="sect3">
<h4 id="cqrs-event-bus"><a class="anchor" href="#cqrs-event-bus"></a><a class="link" href="#cqrs-event-bus">17.9.1. Event Bus</a></h4>
<div class="paragraph">
<p>EventBus是Java的发布/订阅事件总线。Event Bus将事件发送者和接收处理者分离。EventBus提供两个方法来发布事件。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">EventBus</span> {

    <span class="comment">/**
     * Send event to EventBus to publish all corresponding handlers synchronously
     * 同步：发送事件到事件总线，触发相应的事件处理器
     *
     * @param event 事件
     */</span>
    <span class="directive">public</span> <span class="type">void</span> publishEvent(<span class="predefined-type">Event</span> event); #<b class="conum">(1)</b>


    <span class="comment">/**
     * Send event to EventBus to publish all corresponding handlers asynchronously
     * 异步：发送事件到事件总线，触发相应的事件处理器
     *
     * @param event 事件
     */</span>
    <span class="directive">public</span> <span class="type">void</span> asyncPublishEvent(<span class="predefined-type">Event</span> event); #<b class="conum">(2)</b>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>单线程同步事件消费，</p>
</li>
<li>
<p>异步事件消费</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_同步事件处理"><a class="anchor" href="#_同步事件处理"></a><a class="link" href="#_同步事件处理">17.9.2. 同步事件处理</a></h4>
<div class="paragraph">
<p>通过EventBus的publishEvent方法，同步发送事件，EventBus会逐个遍历该事件的所有处理器，并在当前线程中执行。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
由于事件发布方只负责产生事件，并不关心事件订阅方如何处理该事件，因此，publishEvent方法不会抛出订阅方处理事件时产生的异常，
但会把异常信息记录到error日志。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>在实现事件处理器时，由开发人员自行捕获异常，以保证事件处理器执行逻辑。</p>
</div>
</div>
<div class="sect3">
<h4 id="_异步事件处理"><a class="anchor" href="#_异步事件处理"></a><a class="link" href="#_异步事件处理">17.9.3. 异步事件处理</a></h4>
<div class="paragraph">
<p>异步发送事件可以通过EventBus的asyncPublishEvent方法,EventBus会将该事件的所有处理器提交到线程池中执行，asyncPublishEvent会在调用后立即返回。
使用方如果没有定义线程池，会使用Halo框架为EventBus提供的默认线程池，也就是说所有事件处理程序都会提交到Halo Event中默认的线程池中执行，</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Halo Event默认线程池设计</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PostConstruct</span>
<span class="directive">public</span> <span class="type">void</span> init() {
    defaultHandlerExeThreadPoll = <span class="keyword">new</span> <span class="predefined-type">ThreadPoolExecutor</span>(<span class="integer">0</span>,
            <span class="predefined-type">Runtime</span>.getRuntime().availableProcessors() + <span class="integer">1</span>,
            <span class="integer">60L</span>, <span class="predefined-type">TimeUnit</span>.SECONDS,
            <span class="keyword">new</span> <span class="predefined-type">LinkedBlockingQueue</span>&lt;<span class="predefined-type">Runnable</span>&gt;(<span class="integer">1000</span>), #<b class="conum">(1)</b>
            <span class="keyword">new</span> ThreadFactoryBuilder().setNameFormat(<span class="string"><span class="delimiter">&quot;</span><span class="content">event-bus-pool-%d</span><span class="delimiter">&quot;</span></span>).build());
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>该线程池默认使用长度为1000的有界阻塞队列（BlockingQueue），如果某些事件处理程序比较耗时，在异步事件发送量比较大时，
会造成队列溢出的情况。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>在线程池满的时候，新产生的异步事件无法提交到默认线程池中，会产生RejectedExecutionException异常。
为保证业务正常执行，该异常由EventBus捕获，并把异常信息记录到error日志。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Halo Event Handler提供可定制线程池接口</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>为满足使用方线程池自定义需求以及防止出现有界队列溢出，在事件处理器接口(EventHandlerI)中增加了定制线程池方法
(org.xujin.halo.event.EventHandlerI#getExecutor),代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"> <span class="directive">public</span> <span class="type">interface</span> <span class="class">EventHandlerI</span>&lt;R <span class="directive">extends</span> Response, E <span class="directive">extends</span> <span class="predefined-type">Event</span>&gt; {

    <span class="comment">/**
     * 使用方可以根据自己的业务使用场景，可定制线程池来处理
     * @return
     */</span>
    <span class="keyword">default</span> <span class="directive">public</span> <span class="predefined-type">ExecutorService</span> getExecutor(){
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }

    <span class="directive">public</span> R execute(E e);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>通过该方法，开发人员可以为事件处理程序提供专用的线程池，以做到事件处理之间的隔离。如果开发人员为事件处理器实现了该方法，
EventBus会用指定的线程池，否则，使用默认线程池。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>需要注意的是事件对象和事件处理器之间的1对N关系，不要太多，尽量控制一定数量。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cqrs-event-object"><a class="anchor" href="#cqrs-event-object"></a><a class="link" href="#cqrs-event-object">17.9.4. Event对象</a></h4>
<div class="paragraph">
<p>在 Halo Framework中,发布事件到Event Bus时，需要构建事件对象，事件对象本质是一个DTO</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Data</span>
<span class="annotation">@Accessors</span>(chain = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CreateUserRoleEvent</span> <span class="directive">extends</span> <span class="predefined-type">Event</span> { # <b class="conum">(1)</b>

    <span class="directive">private</span> <span class="predefined-type">String</span> userName;

    <span class="directive">private</span> <span class="predefined-type">String</span> role;

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>CreateUserRoleEvent继承Event是一个创建用户角色的一个事件对象，而其中的属性就是传递的值</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="cqrs-event-exe"><a class="anchor" href="#cqrs-event-exe"></a><a class="link" href="#cqrs-event-exe">17.9.5. Event处理器</a></h4>
<div class="paragraph">
<p>事件处理器需要实现EventHandlerI接口中execute方法，EventHandlerI&lt;R extends Response, E extends Event&gt;中的R是事件处理的返回值，E是事件对象。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@EventHandler</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CreateUserRoleEventHandler</span> <span class="directive">implements</span> EventHandlerI&lt;Response, CreateUserRoleEvent&gt; {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> UserRoleService userRoleService;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Response execute(CreateUserRoleEvent event) {
        <span class="keyword">if</span> (StringUtils.isNotEmpty(event.getRole()) &amp;&amp; StringUtils.isNotEmpty(event.getUserName())) {
            userRoleService.createUserRole(event.getUserName(), event.getRole());
        }
        <span class="keyword">return</span> Response.buildSuccess();
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>在处理异步事件时，如果需要为该事件处理器提供专用线程池，需要实现EventHandlerI中提供的getExecutor方法，
如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">default</span> <span class="directive">public</span> <span class="predefined-type">ExecutorService</span> getExecutor(){
    <span class="keyword">return</span> <span class="predefined-constant">null</span>;
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>在实现getExecutor方法时，一定要小心线程池资源泄漏，EventBus在将事件处理器提交到线程池时，会调用该方法，
以确定该事件处理器是否有专用线程池。也就意味着，该方法会被反复调用，严禁在该方法中直接new线程池！</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_发送event事件到event_bus"><a class="anchor" href="#_发送event事件到event_bus"></a><a class="link" href="#_发送event事件到event_bus">17.9.6. 发送Event事件到Event Bus</a></h4>
<div class="paragraph">
<p>我们在使用过程中只需依赖注入EventBus即可，示例发送代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Autowired</span>
<span class="directive">private</span> EventBus eventBus; # <b class="conum">(1)</b>

CreateUserRoleEvent event = <span class="keyword">new</span> CreateUserRoleEvent(); # <b class="conum">(2)</b>
event.setRole(<span class="string"><span class="delimiter">&quot;</span><span class="content">USER</span><span class="delimiter">&quot;</span></span>);
event.setUserName(userName);
eventBus.asyncPublishEvent(event); # <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>依赖注入eventBus</p>
</li>
<li>
<p>构建事件对象</p>
</li>
<li>
<p>发布事件</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-ddd"><a class="anchor" href="#halo-ddd"></a><a class="link" href="#halo-ddd">18. Halo DDD</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Halo DDD是Halo框架根据领域驱动设计的思想,战略设计和战术设计等实战经验,提供的一套方法论,帮助项目或业务中台快速落地DDD.</p>
</div>
<div class="paragraph">
<p>Halo DDD的核心诉求就是将业务架构映射到系统架构上，在响应业务变化调整业务架构时，也随之变化系统架构。而业务中台或微服务追求业务层面的复用，设计出来的系统架构和业务一致；
在技术架构上则系统模块之间充分解耦，可以自由地选择合适的技术架构，去中心化地治理技术和数据。如下图所示:</p>
</div>
<div class="sect2">
<h3 id="_软件的复杂性应对之道"><a class="anchor" href="#_软件的复杂性应对之道"></a><a class="link" href="#_软件的复杂性应对之道">18.1. 软件的复杂性应对之道</a></h3>
<div class="paragraph">
<p>解决复杂和大规模软件的武器可以被粗略地归为三类：抽象、分治和知识。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>分治 把问题空间分割为规模更小且易于处理的若干子问题。分割后的问题需要足够小，以便一个人单枪匹马就能够解决他们；其次，必须考虑如何将分割后的各个部分装配为整体。分割得越合理越易于理解，在装配成整体时，所需跟踪的细节也就越少。即更容易设计各部分的协作方式。评判什么是分治得好，即高内聚低耦合。</p>
</li>
<li>
<p>抽象 使用抽象能够精简问题空间，而且问题越小越容易理解。举个例子，从北京到上海出差，可以先理解为使用交通工具前往，但不需要一开始就想清楚到底是高铁还是飞机，以及乘坐他们需要注意什么。</p>
</li>
<li>
<p>知识 顾名思义，DDD可以认为是知识的一种。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>DDD提供了这样的知识手段，让我们知道如何抽象出限界上下文以及如何去分治。</p>
</div>
</div>
<div class="sect2">
<h3 id="_企业应用开发范式"><a class="anchor" href="#_企业应用开发范式"></a><a class="link" href="#_企业应用开发范式">18.2. 企业应用开发范式</a></h3>
<div class="paragraph">
<p>在开发企业应用的时候，典型的开发范式基本上可以总结为三种：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>数据驱动：认为企业应用就是数据的存储和展示。其典型开发方式是“以数据库为中心的增删改查（CRUD）”，或者是Martin Fowler的《企业应用架构模式》中的“表模块”模式。</p>
</li>
<li>
<p>特性驱动：认为企业应用是系统功能的集合，这些功能基本上是独立实现的。其典型的开发方式是Martin Fowler的《企业应用架构模式》中的“事务脚本”模式。</p>
</li>
<li>
<p>领域驱动：认为企业应用像机器一样，由多个具有不同能力的零件（对象）组成，这些零件相互配合实现系统的功能。其典型的开发方式是Martin Fowler的《企业应用架构模式》中的“领域模型”模式。</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. 应用开发范式对比</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">数据驱动</th>
<th class="tableblock halign-left valign-top">特性驱动</th>
<th class="tableblock halign-left valign-top">领域驱动</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">软件世界观</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">软件就是数据的存储和展示	软件是功能特性的集合</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">软件是由相互协作的智能零件组成的一台能动的机器</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">核心关注点</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">数据</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">功能特性</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">领域对象</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">核心模型</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">数据模型 /关系模型</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">用例模型</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">领域模型</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">业务逻辑组织典型模式</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CRUD或表模块</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">事务脚本</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">领域模型</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">业务逻辑实现典型位置</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">数据库、表示层或缺失业务逻辑</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">应用层</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">领域层</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">重用价值</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">低</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">较低</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">高</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">扩展成本</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">极高</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">高</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">低</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">问题域/解决方案域语义距离</p></td>
</tr>
</tfoot>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
1.在三种开发范式中，数据驱动最差，领域驱动最好，特性驱动介于两者之间。
2.领域驱动的应用开发模式,能解决软件的复杂性问题.
3.很可悲的是:在当前企业应用开发中，数据驱动的CRUD方式占了统治地位。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_问题域简介"><a class="anchor" href="#_问题域简介"></a><a class="link" href="#_问题域简介">18.2.1. 问题域简介</a></h4>
<div class="paragraph">
<p>一个系统（或者一个公司）的业务范围和在这个范围里进行的活动，被称之为领域，领域是现实生活中面对的问题域，
和软件系统无关，领域可以划分为子域，比如电商领域可以划分为商品子域、订单子域、发票子域、库存子域 等，
在不同子域里，不同概念会有不同的含义，所以我们在建模的时候必须要有一个明确的边界，
这个边界在 DDD 中被称之为限界上下文，它是系统架构内部的一个边界。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
《整洁之道》这本书里提到：系统架构是由系统内部的架构边界，以及边界之间的依赖关系所定义的，与系统中组件之间的
调用方式无关。所谓的服务本身只是一种比函数调用方式成本稍高的，分割应用程序行为的一种形式，与系统架构无关。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_数据库驱动范式"><a class="anchor" href="#_数据库驱动范式"></a><a class="link" href="#_数据库驱动范式">18.2.2. 数据库驱动范式</a></h4>
<div class="paragraph">
<p>数据驱动设计范式的软件世界观认为：软件是用于处理数据的虚拟机器。软件开发的核心关注点应该是数据，软件的设计和构建应该围绕数据的存储、检索和展现来开展。</p>
</div>
<div class="paragraph">
<p>数据驱动设计范式以数据模型为核心和出发点来进行开发。如果采用关系数据库为数据存储媒介，软件的核心就是关系模型，通常表示为E-R图（实体-关系图）的形式。</p>
</div>
<div class="paragraph">
<p>数据驱动设计范式认为，对数据只有四种可能的操作：增（Create）、删（Delete）、改（Update）、查（Retrieve），简称CRUD。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_halo_ddd的目标"><a class="anchor" href="#_halo_ddd的目标"></a><a class="link" href="#_halo_ddd的目标">18.3. Halo DDD的目标</a></h3>
<div class="paragraph">
<p>采用 DDD（领域驱动设计）作为微服务设计指导思想，通过事件风暴建立领域模型，合理划分领域逻辑和物理边界，建立领域对象及服务矩阵和服务架构图，
定义符合 DDD 分层架构思想的代码结构模型，保证业务模型与代码模型的一致性。通过上述设计思想、方法和过程，指导团队按照 DDD 设计思想完成微服
务设计和开发。</p>
</div>
<div class="paragraph">
<p>通过领域模型和 DDD 的分层思想，屏蔽外部变化对领域逻辑的影响，确保交付的软件产品是边界清晰的微服务，而不是内部边界依然混乱的小单体。
在需求和设计变化时，可以轻松的完成微服务的开发、拆分和组合，确保微服务不易受外部变化的影响，并稳定运行。</p>
</div>
</div>
<div class="sect2">
<h3 id="ddd"><a class="anchor" href="#ddd"></a><a class="link" href="#ddd">18.4. 领域驱动设计</a></h3>
<div class="paragraph">
<p>微服务系统的设计自然离不开DDD（Domain-Driven Design），它由Eric Evans提出，是一种全新的系统设计和建模方法。</p>
</div>
<div class="paragraph">
<p>领域驱动设计事实上是针对面向对象的分析和设计的一个扩展和延伸，对技术架构进行了分层规划，同时对每个类进行了策略和类型的划分。</p>
</div>
<div class="paragraph">
<p>领域模型是领域驱动的核心。领域模型通过聚合（Aggregate）组织在一起，聚合间有明显的业务边界，这些边界将领域划分为一个个限界上
下文（Bounded Context）。</p>
</div>
<div class="paragraph">
<p>采用DDD的设计思想，业务逻辑不再集中在几个大型的类上，而是由大量相对小的领域对象(类)组成，这些类具
备自己的状态和行为，每个类是相对完整的独立体，并与现实领域的业务对象映射。领域模型就是由这样许多的细粒度的类组成。基于领域驱动
的设计，保证了系统的可维护 性、扩展性和复用性，在处理复杂业务逻辑方面有着先天的优势。</p>
</div>
</div>
<div class="sect2">
<h3 id="halo-add-annotation"><a class="anchor" href="#halo-add-annotation"></a><a class="link" href="#halo-add-annotation">18.5. Halo DDD中的注解</a></h3>
<div class="literalblock">
<div class="content">
<pre>Halo中的DDD,通过注解的方式对Domain层类的定义进行打标记,主要的注解如下所示:</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Halo中抽象的注解 </caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">分类</th>
<th class="tableblock halign-left valign-top">说明</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">领域</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">切分的服务。领域就是范围。范围的重点是边界。领域的核心思想是将问题逐级细分来减低业务和系统的复杂度，这也是 DDD 讨论的核心</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">子域</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">映射概念：子服务。领域可以进一步划分成子领域，即子域。这是处理高度复杂领域的设计思想，它试图分离技术实现的复杂性。</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">核心域</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">核心服务，在领域划分过程中，会不断划分子域，子域按重要程度会被划分成三类：核心域、通用域、支撑域。决定产品核心竞争力的子域就是核心域，没有太多个性化诉求</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">桃树的例子，有根、茎、叶、花、果、种子等六个子域，不同人理解的核心域不同，比如在果园里，核心域就是果是核心域，在公园里，核心域则是花。有时为了核心域的营养供应，还会剪掉通用域和支撑域（茎、叶等）。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">通用域</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">映射概念：中间件服务或第三方服务。被多个子域使用的通用功能就是通用域，没有太多企业特征，比如权限认证</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">支撑域</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">映射概念：企业公共服务。对于功能来讲是必须存在的，但它不对产品核心竞争力产生影响，也不包含通用功能，有企业特征，不具有通用性，比如数据代码类的数字字典系统。</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">统一语言</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">映射概念：统一概念。</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">限界上下文</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">映射概念：服务职责划分的边界。定义上下文的边界。领域模型存在边界之内。对于同一个概念，不同上下文会有不同的理解，比如商品，在销售阶段叫商品，在运输阶段就叫货品。</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">实体</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">被@Entity注解标记的类</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">表示实体</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">值对象</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">被@ValueObject注解标记的类</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">值对象</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">聚合根</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">被@AggregateRoot注解标记的类</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">代表是聚合根</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">聚合部分</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">被@AggregatePart注解标记的类</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">表示参与聚合的部分</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">资源库</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">被@DomainRepository注解标记的类</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">表示资源库</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">工厂</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">被@Factory标记的类</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">表示工厂</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">领域服务</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">被@DomainService标记的类</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">表示领域服务</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">领域能力</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">被@DomainAbility标记的方法</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">在实体或者值对象中被@DomainAbility标记的方法表示领域能力</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_领域对象"><a class="anchor" href="#_领域对象"></a><a class="link" href="#_领域对象">18.6. 领域对象</a></h3>
<div class="paragraph">
<p>领域对象区分实体(Entity)和值对象(Value Object),下面介绍一下实体和值对象。</p>
</div>
<div class="sect3">
<h4 id="entity"><a class="anchor" href="#entity"></a><a class="link" href="#entity">18.6.1. 实体</a></h4>
<div class="paragraph">
<p>实体（Entity）：实体就是领域中需要唯一标识的领域概念。因为我们有时需要区分是哪个实体。有两个实体，如果唯一标识不一样，
那么即便实体的其他所有属性都一样，我们也认为它们两个是不同的实体；因为实体有生命周期，实体从被创建后可能会被持久化到数
据库，然后某个时候又会被取出来。所以，如果我们不为实体定义一种可以唯一区分的标识，那我们就无法区分到底是这个实体还是那个实体。</p>
</div>
<div class="paragraph">
<p>另外，不应该给实体定义太多的属性或行为，而应该寻找关联，发现其他一些实体或值对象，将属性或行为转移到其他关联的实体或值对象上。
比如Customer实体，他有一些地址信息，由于地址信息是一个完整的有业务含义的概念，所以，我们可以定义一个Address对象，然后把
Customer的地址相关的信息转移到Address对象上。如果没有Address对象，而把这些地址信息直接放在Customer对象上，并且如果
对于一些其他的类似Address的信息也都直接放在Customer上，会导致Customer对象很混乱，结构不清晰，最终导致它难以维护和理解。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
使用@Entity注解标记一个类是一个实体。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CampaignE</span> {

    <span class="comment">/**
     * 营销渠道ID
     */</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> channelId;

    <span class="comment">/**
     * 渠道类型
     */</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> channelType;

    <span class="comment">/**
     * 活动名字
     */</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="comment">/**
     * 活动描述
     */</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> description;

    <span class="comment">/**
     * 活动开始时间
     */</span>
    <span class="directive">private</span> CampaignTimerV startTime;


    <span class="comment">/**
     * 活动选择的模板Id
     */</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> templateId;

    <span class="comment">/**
     * 活动反馈
     */</span>
    <span class="directive">private</span> CampaignFeedbackE campaignFeedback;


    <span class="directive">private</span> CampaignRepository campaignRepository;

    <span class="directive">private</span> MailChannelRepository mailChannelRepository;

    <span class="comment">/**
     * 做营销活动
     */</span>
    <span class="annotation">@DomainAbility</span>
    <span class="directive">public</span> <span class="type">void</span> doCampaign() {
        <span class="comment">//代码省略</span>
    }

    <span class="comment">/**
     * 活动开始
     */</span>
    <span class="annotation">@DomainAbility</span>
    <span class="directive">public</span> <span class="type">void</span> start(){
        <span class="keyword">if</span>(!isEnabled){
            <span class="keyword">return</span>;
        }
        <span class="local-variable">this</span>.campaignState = CampaignState.RUNNING;
        <span class="local-variable">this</span>.setModifier(<span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>);
        campaignRepository.save(<span class="local-variable">this</span>);
        <span class="comment">//更新定时器</span>
        startTime.setFire(<span class="predefined-constant">true</span>);
        startTime.setFireTime(<span class="keyword">new</span> <span class="predefined-type">Date</span>());
        campaignRepository.updateTimerMsgStatus(<span class="local-variable">this</span>.id, startTime);
    }

    <span class="comment">/**
     * 活动结束
     */</span>
    <span class="annotation">@DomainAbility</span>
    <span class="directive">public</span> <span class="type">void</span> finish(){
         <span class="comment">//省略代码</span>
    }

    <span class="comment">/**
     * 活动生效
     */</span>
    <span class="annotation">@DomainAbility</span>
    <span class="directive">public</span> <span class="type">void</span> enable(){
         <span class="comment">//省略代码</span>
    }

    <span class="comment">/**
     * 取消活动
     */</span>
    <span class="annotation">@DomainAbility</span>
    <span class="directive">public</span> <span class="type">void</span> disable(){
        <span class="comment">//省略代码</span>
    }

    <span class="comment">/**
     * 移除活动
     */</span>
    <span class="annotation">@DomainAbility</span>
    <span class="directive">public</span> <span class="type">void</span> remove(){
        <span class="comment">//省略代码</span>
    }

    <span class="comment">/**
     * 更新活动
     */</span>
    <span class="annotation">@DomainAbility</span>
    <span class="directive">public</span> <span class="type">void</span> update(){
        <span class="comment">//省略其它</span>
        campaignRepository.save(<span class="local-variable">this</span>);
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
领域对象具有了行为，对象更加丰满。同时比起将这些逻辑写在服务内（例如 Service）,领域功能的内聚性更强，
职责更加明确。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="value-object"><a class="anchor" href="#value-object"></a><a class="link" href="#value-object">18.6.2. 值对象</a></h4>
<div class="paragraph">
<p>在领域中，并不是每一个事物都必须有一个唯一标识，也就是说我们不关心对象是哪个，而只关心对象是什么。以对象Address
为例，如果有两个Customer的地址信息是一样的，我们就会认为这两个Customer的地址是同一个。也就是说只要地址信息一样，我们就认为
是同一个地址。</p>
</div>
<div class="paragraph">
<p>用程序的方式来表达就是，如果两个对象的所有的属性的值都相同，我们会认为它们是同一个对象的话，那么我们就可以把这种对象设计为值对象。
因此，值对象没有唯一标识，这是它和实体的最大不同。</p>
</div>
<div class="paragraph">
<p>实体和值对象的对比如下表所示:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3.  实体VS值对象 </caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">概念</th>
<th class="tableblock halign-left valign-top">区别</th>
<th class="tableblock halign-left valign-top">举例说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">实体</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">实体表示那些具有生命周期并且会在其生命周期中发生改变的东西</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">实体是有唯一标识的，只要唯一标识不同就是两个不同的实体</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">比如:央行发行了一些100元的钞票，每个钞票都有唯一识别的标识，此时两张100元的钞票就是不同的实体。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">值对象</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">值对象则表示起描述性作用的并且可以相互替换的概念</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">值对象是没有唯一标识的，只是数据传输的载体。描述性属性字段来实现</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">比如：我们花了100元买了一本书，我们只是关心货币的数量而已，而不是关心具体使用了哪一张100元的钞票，即两张100元的钞票是可以互换的，此时的钞票就是值对象</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>值对象带来的价值</p>
</div>
<div class="paragraph">
<p>在领域驱动设计中，我们提倡的实践是尽量定义值对象来替代基本类型，原因在于基本类型无法体现统一语言中的领域概念
。此外，在多数语言中，我们无法对基本类型做封装，意味着一个领域概念缺乏领域行为来支持。</p>
</div>
<div class="paragraph">
<p>假设一个实体定义了许多属性，如果这些属性都是基本类型，就会导致与这些属性相关的领域行为都要放到实体中，导致实体的职责变得不够单一。</p>
</div>
<div class="paragraph">
<p>引入值对象后，情况就不同了，因为我们可以利用合理的职责分配，将这些职责（领域行为）按照内聚性分配到各个值对象中，这个领域模型就能变得协作良好。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jh-jhr"><a class="anchor" href="#jh-jhr"></a><a class="link" href="#jh-jhr">18.7. 聚合与聚合根</a></h3>
<div class="paragraph">
<p>聚合中可以包含多个实体和值对象，因此聚合也被称为根实体。如下图所示,就是一个聚合，Customer是聚合根也是实体，address是值对象，
ContactInfo也是值对象。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/jh.jpg" alt="jh" width="800">
</div>
<div class="title">Figure 12. 示例聚合</div>
</div>
<div class="paragraph">
<p>聚合根（Aggregate Root）是DDD中的一个概念，是一种更大范围的封装，把一组有相同生命周期、在业务上不可分隔的实体和值对象放在一起考虑，
只有根实体可以对外暴露引用，也是一种内聚性的表现。</p>
</div>
</div>
<div class="sect2">
<h3 id="data-object"><a class="anchor" href="#data-object"></a><a class="link" href="#data-object">18.8. 数据对象</a></h3>
<div class="paragraph">
<p>数据对象(Data Object)是传统三层架构中的实体，用于和数据库中的表结构中的数据映射。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
数据对象是指仅用作数据载体，而没有行为和动作的领域对象。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="factory"><a class="anchor" href="#factory"></a><a class="link" href="#factory">18.9. 工厂</a></h3>
<div class="paragraph">
<p>DDD中的工厂也是一种体现封装思想的模式。DDD中引入工厂模式的原因是：有时创建一个领域对象是一件比较复杂的事情，不仅仅是简单的new操作。
正如对象封装了内部实现一样（我们无需知道对象的内部实现就可以使用对象的行为），工厂则是用来封装创建一个复杂对象。工厂的作用是将创建对
象的细节隐藏起来。</p>
</div>
<div class="paragraph">
<p>工厂在创建一个复杂的领域对象时，通常会知道该满足什么业务规则（它知道先怎样实例化一个对象，然后在对这个对象做哪些初始化操作，这些规则
就是创建对象的细节），如果传递进来的参数符合创建对象的业务规则，则可以顺利创建相应的对象；但是如果由于参数无效等原因不能创建出期望的
对象时，应该抛出一个异常，以确保不会创建出一个错误的对象。</p>
</div>
<div class="paragraph">
<p>当然也不是所有都需要通过工厂来创建对象，当构造器很简单或者构造对象不依赖于其他对象的创建的时候，我们只需要简单的使用构造函数创建对象就可以。
隐藏创建对象的好处是显而易见的，这样可以不会让领域层的业务逻辑泄露到应用层，同时也减轻了应用层的负担，它只需要简单的调用领域工厂创建符合期
望的对象即可。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Halo Framework中使用@Factory注解，标记一个类为工厂。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_防腐层"><a class="anchor" href="#_防腐层"></a><a class="link" href="#_防腐层">18.10. 防腐层</a></h3>
<div class="paragraph">
<p>防腐层也被称适配层或者转换层。在一个上下文中，有时需要对外部上下文进行访问，
通常会引入防腐层的概念来对外部上下文的访问进行一次转义。</p>
</div>
<div class="paragraph">
<p>有以下几种情况会考虑引入防腐层：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1.需要将外部上下文中的模型翻译成本上下文理解的模型。</p>
</li>
<li>
<p>2. 不同上下文之间的团队协作关系，如果是供奉者关系，建议引入防腐层，避免外部上下文变化对本上下文的侵蚀。</p>
</li>
<li>
<p>3. 该访问本上下文使用广泛，为了避免改动影响范围过大。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="domain-service"><a class="anchor" href="#domain-service"></a><a class="link" href="#domain-service">18.11. 领域服务</a></h3>
<div class="paragraph">
<p>领域中的一些概念不太适合建模为对象，即归类到实体对象或值对象，因为它们本质上就是一些操作，一些动作，而不是事物。这些操作或动作往往会涉及到
多个领域对象，并且需要协调这些领域对象共同完成这个操作或动作。如果强行将这些操作职责分配给任何一个对象，则被分配的对象就是承担一些不该承担的
职责，从而会导致对象的职责不明确很混乱。但是基于类的面向对象语言规定任何属性或行为都必须放在对象里面。所以我们需要寻找一种新的模式来表示这种
跨多个对象的操作，DDD认为服务是一个很自然的范式用来对应这种跨多个对象的操作，所以就有了领域服务这个模式。领域服务本来就是来处理这种场景的。
比如要对密码进行解密，可以创建一个PasswordService来专门处理加解密的问题。</p>
</div>
<div class="paragraph">
<p>领域服务还有一个很重要的功能就是可以避免领域逻辑泄露到应用层。因为如果没有领域服务，那么应用层会直接调用领域对象完成本该属于领域服务该做的操作，
这样一来，领域层可能会把一部分领域泄露到应用层。因此，引入领域服务可以有效的防止领域层的逻辑泄露到应用层。对于应用层来说，从可理解的角度来讲，
通过调用领域服务提供的简单，易懂，明确的接口肯定也要比直接操纵领域对象容易的多。</p>
</div>
<div class="paragraph">
<p>那如何去识别领域服务呢？主要看它是否满足以下三个特征：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>服务执行的操作代表了一个领域概念，这个领域概念无法自然地隶属于一个实体或者值对象。</p>
</li>
<li>
<p>被执行的操作涉及到领域中的其他的对象。</p>
</li>
<li>
<p>操作是无状态的。</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Halo Framework中使用@DomainService注解，标记一个类为领域服务。将领域行为封装到领域对象中，
将资源管理行为封装到资源库中，将外部上下文的交互行为封装到防腐层中。此时，我们再回过头来看领域服务时，
能够发现领域服务本身所承载的职责也就更加清晰了，即就是通过串联领域对象、资源库和防腐层等一系列领域内的对象的行为，
对其他上下文提供交互的接口。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="app-service"><a class="anchor" href="#app-service"></a><a class="link" href="#app-service">18.12. 应用服务</a></h3>
<div class="paragraph">
<p>应用服务：一组面向业务场景的业务外观方法，只是一个对外提供接口、对内分配职责的协作对象，属于应用层。</p>
</div>
<div class="sect3">
<h4 id="_应用服务分类"><a class="anchor" href="#_应用服务分类"></a><a class="link" href="#_应用服务分类">18.12.1. 应用服务分类</a></h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. 应用服务分类列表 </caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">分类</th>
<th class="tableblock halign-left valign-top">说明</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">命令执行器</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">被@CmdHandler注解标记的类</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">命令执行器在App层，主要做入参check和代码逻辑复用编排</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">流程</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">被@Flow注解标记的类</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">流程定义和流程编排</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">节点执行器</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">被@@Processor注解标记的类</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">节点的处理器代码，每个节点做对应的代码逻辑处理</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">阶段</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">被@Phase注解标记的类</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">代码逻辑的处理可以拆分为几个阶段，比如检验阶段，组装参数阶段，执行阶段</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">步骤</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">被@Step注解标记的类</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">每个阶段中的代码，又可以拆分为几个步骤，每个步骤可以只做单一的一件事情</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">纯应用服务</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">被@AppService注解标记的类</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">当Command Handler,阶段，步骤都满足不了的情况下，可以使用@AppService标记为一个应用服务</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_phase和step"><a class="anchor" href="#_phase和step"></a><a class="link" href="#_phase和step">18.12.2. @Phase和@Step</a></h4>
<div class="paragraph">
<p>阶段或步骤，必须实现org.xujin.halo.command.BaseAppService接口。BaseAppService的代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 *  统一的应用服务层服务编写接口
 *  I是input  输入参数
 *  O是OutPut 输出参数
 *  @author xujin
 * @param &lt;I&gt;
 */</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">BaseAppService</span>&lt;I,O&gt; {

    <span class="comment">/**
     *  唯一的方法
     * @param input
     * @return
     */</span>
    O execute(I input);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>示例的Phase如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.xujin.halo.admin.phase</span>;

<span class="keyword">import</span> <span class="include">org.xujin.halo.annotation.app.Phase</span>;
<span class="keyword">import</span> <span class="include">org.xujin.halo.command.BaseAppService</span>;

<span class="annotation">@Phase</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">OnSaleContextInitPhase</span> <span class="directive">implements</span> BaseAppService&lt;<span class="predefined-type">String</span>,<span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> execute(<span class="predefined-type">String</span> input) {
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>示例的Step如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.xujin.halo.admin.phase.step</span>;

<span class="keyword">import</span> <span class="include">org.xujin.halo.annotation.app.Step</span>;
<span class="keyword">import</span> <span class="include">org.xujin.halo.command.BaseAppService</span>;

<span class="annotation">@Step</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PublishOfferStep</span> <span class="directive">implements</span> BaseAppService&lt;<span class="predefined-type">String</span>,<span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> execute(<span class="predefined-type">String</span> input) {
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_appservice"><a class="anchor" href="#_appservice"></a><a class="link" href="#_appservice">18.12.3. @AppService</a></h4>
<div class="paragraph">
<p>当应用层中的服务不能用命令执行器,流程的节点处理器，阶段，步骤表示的时候，可以使用@AppService注解标记为一个应用层的服务，并实现BaseAppService接口。
示例代码如下:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.xujin.halo.admin.appservice</span>;

<span class="keyword">import</span> <span class="include">org.xujin.halo.annotation.app.AppService</span>;
<span class="keyword">import</span> <span class="include">org.xujin.halo.command.BaseAppService</span>;

<span class="annotation">@AppService</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UploadFileService</span> <span class="directive">implements</span> BaseAppService&lt;<span class="predefined-type">String</span>,<span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> execute(<span class="predefined-type">String</span> input) {
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_应用服务和领域服务的区别"><a class="anchor" href="#_应用服务和领域服务的区别"></a><a class="link" href="#_应用服务和领域服务的区别">18.12.4. 应用服务和领域服务的区别</a></h4>
<div class="paragraph">
<p>应用服务与领域服务的区别是什么呢？</p>
</div>
<div class="paragraph">
<p>应用服务：一组面向业务场景的业务外观方法，只是一个对外提供接口、对内分配职责的协作对象，属于应用层。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
命令执行器在这里就相当于应用服务
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>领域服务：一个领域服务对应最多一个业务场景，往往需要和聚合、Repository、甚至领域服务一起协作。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
领域服务或其他领域对象的粒度太细（便于协作、扩展和重用），不利于客户端的调用，基于“最小知识原则”，还是让客户
端少知道这些领域对象协作的知识为好。此时的应用服务更像是对领域对象的一种“编排”。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_应用能力下沉"><a class="anchor" href="#_应用能力下沉"></a><a class="link" href="#_应用能力下沉">18.12.5. 应用能力下沉</a></h4>
<div class="paragraph">
<p>所谓的能力下沉，是指我们不强求一次就能设计出Domain Service或Domain Ability，也不需要强制让把所有的业务功能都放到Domain层，而是采用实用主义的态度，
即只对那些需要在多个场景中需要被复用的能力进行抽象下沉，而不需要复用的，就暂时放在App层的Use Case里就好了。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Use Case是《架构整洁之道》里面的概念，就是一个Http请求的处理过程，在Halo中就是一个命令的处理过程。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>通过实践，应用服务,领域服务，领域能力循序渐进的下沉，更适合系统的演进进化。因为我业务模型和业务架构不是一次性设计出来的，而是迭代演化出来的。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>下沉的过程如下图所示，假设两个use case中，我们发现use case1的Phase3的step1和use case2的Phase1的step2有类似的功能，我们就可以考虑让其下沉到Domain层变为领域服务，从而增加代码的复用性。</p>
</li>
<li>
<p>领域服务，可以下沉为实体或者值对象的能力或行为,即Domain Ability</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/app-yyxc.png" alt="app yyxc" width="800">
</div>
<div class="title">Figure 13. 应用能力下沉</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
应用层的服务可以下沉到领域层成为领域服务，领域服务中方法可以继续沉淀为领域能力。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="domian-ability"><a class="anchor" href="#domian-ability"></a><a class="link" href="#domian-ability">18.13. 领域能力</a></h3>
<div class="paragraph">
<p>实体中的方法通过注解@DomainAbility，标识该方法是一个域能力。</p>
</div>
<div class="listingblock">
<div class="title">@DomainAbility的使用示例代码</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
     * 活动开始
     */</span>
<span class="annotation">@DomainAbility</span>
<span class="directive">public</span> <span class="type">void</span> start(){
    <span class="keyword">if</span>(!isEnabled){
       <span class="keyword">return</span>;
    }
    <span class="local-variable">this</span>.campaignState = CampaignState.RUNNING;
    <span class="local-variable">this</span>.setModifier(<span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>);
    campaignRepository.save(<span class="local-variable">this</span>);
    startTime.setFireTime(<span class="keyword">new</span> <span class="predefined-type">Date</span>());
    campaignRepository.updateTimerMsgStatus(<span class="local-variable">this</span>.id, startTime);
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="domian-repository"><a class="anchor" href="#domian-repository"></a><a class="link" href="#domian-repository">18.14. 资源库</a></h3>
<div class="paragraph">
<p>领域模型中的对象自从被创建出来后不会一直留在内存中活动，当它不活动时会被持久化到数据库中，然后当需要的时候我们会重建该对象；重建对象就是根据数据库
中已存储的对象的状态重新创建对象的过程。所以可见重建对象是一个和数据库打交道的过程。从更广义的角度来理解，我们经常会像集合一样从某个类似集合的地方
根据某个条件获取一个或一些对象，往集合中添加对象或移除对象。也就是说，我们需要提供一种机制，可以提供类似集合的接口来帮助我们管理对象。仓储就是基于
这样的思想被设计出来的。</p>
</div>
<div class="paragraph">
<p>仓储里面存放的对象一定是聚合，原因是领域模型中是以聚合的概念去划分边界的；聚合是我们更新对象的一个边界，事实上我们把整个聚合看成是一个整体概念，要么
一起被取出来，要么一起被删除。我们永远不会单独对某个聚合内的子对象进行单独查询或做更新操作。因此，我们只对聚合设计仓储。</p>
</div>
<div class="paragraph">
<p>仓储还有一个重要的特征就是分为仓储定义部分和仓储实现部分，在领域模型中我们定义仓储的接口，而在基础设施层实现具体的仓储。这样设计的原因是：由于仓储背
后的实现都是在和数据库打交道，但是我们又不希望调用方（如应用层）把重点放在如何从数据库获取数据的问题上，因为这样做会导致调用方（应用层）代码很混乱，
很可能会因此而忽略了领域模型的存在。所以我们需要提供一个简单明了的接口，供调用方使用，确保客户能以最简单的方式获取领域对象，从而可以让它专心的不会被什么
数据访问代码打扰的情况下协调领域对象完成业务逻辑。这种通过接口来隔离封装变化的做法其实很常见。由于对外暴露的是抽象的接口并不是具体的实现，所以可以随时替换仓储的真实实现。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Halo Framework中使用@DomainRepository注解，标记一个类为资源库。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>在DDD中，所有的领域对象应该都属于领域层。在DDD中需要将领域层和基础设施层解耦,将设计的注意力完全放在领域建模和领域设计上，
思考领域逻辑的实现时，应尽可能地不要考虑领域对象的持久化.于是定义了Repository这个抽象。经过这么一层的抽象之后，获取领域对象，
或者说管理领域对象生命周期的逻辑就应该属于领域层。</p>
</div>
</div>
<div class="sect2">
<h3 id="halo-ddd-action"><a class="anchor" href="#halo-ddd-action"></a><a class="link" href="#halo-ddd-action">18.15. halo DDD实战</a></h3>
<div class="paragraph">
<p>领域驱动设计的战略设计阶段是从下面两个方面来考量的：</p>
</div>
<div class="paragraph">
<p>问题域方面：针对问题域，引入限界上下文（Bounded Context）和上下文映射（Context Map）对问题域进行合理的分解，识别出核心领域（Core Domain）与子领域（SubDomain），并确定领域的边界以及它们之间的关系，维持模型的完整性。</p>
</div>
<div class="paragraph">
<p>架构方面：通过分层架构来隔离关注点，尤其是将领域实现独立出来，能够更利于领域模型的单一性与稳定性；</p>
</div>
<div class="paragraph">
<p>CQRS 模式则分离了查询场景和命令场景，针对不同场景选择使用同步或异步操作，来提高架构的低延迟性与高并发能力。</p>
</div>
<div class="paragraph">
<p>整个软件系统被分解为多个限界上下文（或领域）后，就可以分而治之，对每个限界上下文进行战术设计。
领域驱动设计并不牵涉到技术层面的实现细节，在战术层面，它主要应对的是领域的复杂性。</p>
</div>
<div class="sect3">
<h4 id="_halo_ddd的模型采集"><a class="anchor" href="#_halo_ddd的模型采集"></a><a class="link" href="#_halo_ddd的模型采集">18.15.1. Halo DDD的模型采集</a></h4>
<div class="paragraph">
<p>领域驱动设计的关键在于识别业务的模型，而模型又是会随着业务的发展而演进的。领域模型采集要做到代码即领域模型，领域模型即代码。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Halo框架设计了一套领域模型注解提供。用于标记@Entity(实体)，@Factory(工厂), @DomainService(领域服务), @AggregateRoot(聚合根),@AggregateRoot(聚合根), @UniqueIdentity(实体唯一标识),@AggregatePart(聚合部件),@ValueObject(值对象)，@DomainRepository(资源库)，@DomainAbility(域能力)。</p>
</li>
<li>
<p>当应用启动的时候异步生成领域模型，并上传到Halo Admin或者通过Halo Toolkit右键生成领域模型，最终实时查看战术设计中的领域模型。</p>
<div class="ulist">
<ul>
<li>
<p>第一步: 根据战略设计，设计出领域模型。</p>
</li>
<li>
<p>第二步：开发工程师或架构师按照领域设计的原则对业务代码分析并标记相应的注解(可以通过Halo Toolkit实时查看代码生成的领域模型)。</p>
</li>
<li>
<p>第三步：Halo应用启动时自动扫描生成领域模型上传到Halo Admin。</p>
</li>
<li>
<p>第四步：模型采集完毕之后进行版本跟踪，反哺战略设计。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/ddd-cj.png" alt="ddd cj" width="800">
</div>
<div class="title">Figure 14. Halo领域模型采集</div>
</div>
</div>
<div class="sect3">
<h4 id="_ddd模型要素约定"><a class="anchor" href="#_ddd模型要素约定"></a><a class="link" href="#_ddd模型要素约定">18.15.2. DDD模型要素约定</a></h4>
<div class="paragraph">
<p>领域驱动设计用以表示模型的主要要素包括：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>值对象（Value Object）</p>
</li>
<li>
<p>实体（Entity）</p>
</li>
<li>
<p>领域服务（Domain Service）</p>
</li>
<li>
<p>领域事件（Domain Event）</p>
</li>
<li>
<p>资源库（Repository）</p>
</li>
<li>
<p>工厂（Factory）</p>
</li>
<li>
<p>聚合（Aggregate）</p>
</li>
<li>
<p>应用服务（Application Service）</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Eric Evans通过下图勾勒出了战术设计要素之间的关系：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/model-relation.jpg" alt="model relation">
</div>
</div>
<div class="paragraph">
<p>领域驱动设计围绕着领域模型进行设计，</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>通过<strong>分层架构（Layered Architecture）</strong>将领域隔离。</p>
</li>
<li>
<p>表示领域模型的对象包括：<strong>实体、值对象和领域服务</strong>，领域逻辑都应该封装在这些对象中。
这一严格的设计原则可以避免业务逻辑渗透到领域层之外，导致技术实现与业务逻辑的混淆。
在领域驱动设计的演进中，又引入了领域事件来丰富领域模型。</p>
</li>
<li>
<p>聚合是一种边界，它可以封装一到多个实体与值对象，并维持该边界范围之内的业务完整性。</p>
</li>
<li>
<p>在聚合中，至少包含一个实体，且只有实体才能作为聚合根（Aggregate Root）。</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
在领域驱动设计中，没有任何一个类是单独的聚合，因为聚合代表的是边界概念，而非领域概念。在极端情况下，一个聚合可能有且只有一个实体。
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>工厂和资源库都是对领域对象生命周期的管理。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>工厂</code> 负责`领域对象的创建`，往往用于`封装复杂`或者`可能变化的创建逻辑`；</p>
</div>
<div class="paragraph">
<p>资源库则负责从存放资源的位置（数据库、内存或者其他 Web 资源）获取、添加、删除或者修改领域对象。领域模型中的资源库不应该暴露访问领域对象的技术实现细节。</p>
</div>
</div>
<div class="sect3">
<h4 id="_运用_halo_ddd改造系统"><a class="anchor" href="#_运用_halo_ddd改造系统"></a><a class="link" href="#_运用_halo_ddd改造系统">18.15.3. 运用 Halo DDD改造系统</a></h4>
<div class="paragraph">
<p>假如你是一个团队 Leader 或者架构师，当你接手一个旧系统维护及重构的任务时，你该如何改造呢？
是否觉得哪里都不对但由于业务认知的不熟悉而无从下手呢？其实这里我可以教你一套方法来应对这种窘境。</p>
</div>
<div class="paragraph">
<p>你要做的大概以下几点：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1. 通过公共平台大概梳理出系统之间的调用关系（一般中等以上公司都具备 RPC 和 HTTP 调用关系，无脑的挨个系统查询即可），
画出来的可能会很乱，也可能会比较清晰，但这就是现状。</p>
</li>
<li>
<p>2. 分配组员每个人认领几个项目，来梳理项目维度关系，这些关系包括：对外接口、交互、用例、MQ 等的详细说明。个别核心系统可以画出内部实体或者聚合根。</p>
</li>
<li>
<p>3. 小组开会，挨个 review 每个系统的业务概念，达到组内统一语言。</p>
</li>
<li>
<p>4. 根据以上资料，即可看出哪些不合理的调用关系（比如循环调用、不规范的调用等），甚至不合理的分层。</p>
</li>
<li>
<p>5. 根据主线业务自顶向下细分领域，以及限界上下文。此过程可能会颠覆之前的系统划分。</p>
</li>
<li>
<p>6. 根据业务复杂性，指定领域模型，选择贫血或者充血模型。团队内部最好实行统一习惯，以免出现交接成本过大。</p>
</li>
<li>
<p>7. 分工进行开发，并设置 deadline，注意，不要单一的设置一个 deadline，要设置中间 check 时间，比如 dealline 是 1 月 20 日，还要设置两个 check 时间，分别沟通代码风格及边界职责，以免 deadline 时延期。</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Halo-ext"><a class="anchor" href="#Halo-ext"></a><a class="link" href="#Halo-ext">19. Halo扩展点</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="ext-bg"><a class="anchor" href="#ext-bg"></a><a class="link" href="#ext-bg">19.1. 扩展点出现背景</a></h3>
<div class="paragraph">
<p>业务的不断发展、业务类型的不断增多、不断添加的业务需求使得代码出现“bad smell”——<code>平台代码和业务代码耦合严重难以分离；业务和业务之间代码交织缺少拆解</code>——这也是行业中的通病。Halo Framework出现就是为了解决此类问题</p>
</div>
<div class="paragraph">
<p>Halo Framework为扩展点提供了可视化界面,开发人员可以直观地了解当前各个扩展的的业务身份值。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
扩展点越少，越意味着“过度耦合”，可能会对后续业务变更无法适应导致主干需要大幅改动。但是扩展点数量也不是，越多越好，因此需要在数量和扩展性之间找到一个平衡。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_消灭if_else"><a class="anchor" href="#_消灭if_else"></a><a class="link" href="#_消灭if_else">19.1.1. 消灭if-else</a></h4>
<div class="ulist">
<ul>
<li>
<p>场景1:如下代码</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> process(OrderDTO orderDTO) {
    <span class="type">int</span> serviceType = orderDTO.getServiceType();
    <span class="keyword">if</span> (<span class="integer">1</span> == serviceType) {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">取消即时订单</span><span class="delimiter">&quot;</span></span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="integer">2</span> == serviceType) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">取消预约订单</span><span class="delimiter">&quot;</span></span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="integer">3</span> == serviceType) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">取消拼车订单</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>场景2: 例如:接口需要根据 p1、p2、p3、version 多个入参的不同组合按照其对应的业务策略给出结果数据。
由于该接口已经开发了三期了，每次开发新一期的需求时为了兼容老的业务逻辑，大家都倾向于不删不改只新增，
因此这块代码已经产生了一些「坏味道」，函数入口通过不断添加「卫语句」判断 version 的方式跳转到新一期的业务逻辑方法中，
而每一期的业务逻辑也是通过 p1、p2、p3 的 if-else 组合形成不同的分支逻辑。如下图所示:</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/ext/if-else.gif" alt="if else">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_多实现执行"><a class="anchor" href="#_多实现执行"></a><a class="link" href="#_多实现执行">19.1.2. 多实现执行</a></h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">if</span>(A<span class="error">类</span><span class="error">型</span>) {
    <span class="keyword">if</span>(A1<span class="error">类</span><span class="error">型</span>) {
        doSomething1();
    }<span class="keyword">else</span> <span class="keyword">if</span>(A2<span class="error">类</span><span class="error">型</span>) {
        doSomething2();
    }
} <span class="keyword">else</span> <span class="keyword">if</span>(B<span class="error">类</span><span class="error">型</span>) {
    doSomething3();
} <span class="keyword">else</span> <span class="keyword">if</span>(C<span class="error">类</span><span class="error">型</span>) {
    <span class="keyword">if</span>(C1<span class="error">类</span><span class="error">型</span>) {
        doSomething4();
    }<span class="keyword">else</span> <span class="keyword">if</span>(C2<span class="error">类</span><span class="error">型</span>) {
        doSomething5();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>类似的代码大家应该都写过不少。逻辑简单的时候写成这样无可厚非，但当逻辑开始变复杂的时候这种写法会具有较多的坏处：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>难以抽出公共的逻辑，代码块愈发臃肿。</p>
</li>
<li>
<p>有较多相同点少量异同点的新类型的实现很难复用原先的代码。</p>
</li>
<li>
<p>各个类型的代码实际上融合在一块，更改代码可能会影响到其他类型，提高上线风险和测试回归成本。</p>
</li>
<li>
<p>对于新接手的开发人员来说，理解成本高，上手难度大，无形中降低开发效率。</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
上面if else的写法可能有点low，可能大家觉得使用策略模式可以解决上面的问题，因为策略方式是将算法的使用与定义解耦，能够实现根据规则路由到不同策略类进行处理。
实践证明换成策略模式的写法依然会很Low。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_扩展点"><a class="anchor" href="#_扩展点"></a><a class="link" href="#_扩展点">19.2. 扩展点</a></h3>

</div>
<div class="sect2">
<h3 id="_扩展点设计"><a class="anchor" href="#_扩展点设计"></a><a class="link" href="#_扩展点设计">19.3. 扩展点设计</a></h3>
<div class="sect3">
<h4 id="_扩展点是什么"><a class="anchor" href="#_扩展点是什么"></a><a class="link" href="#_扩展点是什么">19.3.1. 扩展点是什么</a></h4>
<div class="paragraph">
<p>扩展（Extension）是很多可扩展项目中一个关键的机制，可以利用扩展向平台添加新功能。但是扩展不能随意地创建，必须按照扩展点（Extension Point）定义的规范进行明确的声明，平台才能识别出这些扩展。</p>
</div>
<div class="paragraph">
<p>所谓扩展点，就是系统定义出来可以让你扩展的地方，可以认为是一些扩展的契约，而扩展，这是你对这些扩展点的实现，当然你自己的插件也可以定义扩展点供别的开发人员扩展。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/p-plugin.png" alt="p plugin">
</div>
</div>
<div class="paragraph">
<p>如果开发的功能想要有多种实现方式，而且可以被随便扩展。那就需要中声明一个或一系列的扩展点。
而每个扩展点都要定义一个允许访问的类或接口，Halo框架中推荐定义一个接口。</p>
</div>
</div>
<div class="sect3">
<h4 id="_扩展是什么"><a class="anchor" href="#_扩展是什么"></a><a class="link" href="#_扩展是什么">19.3.2. 扩展是什么</a></h4>
<div class="paragraph">
<p>扩展点是一个接口，那么扩展就是接口的实现类。</p>
</div>
</div>
<div class="sect3">
<h4 id="_扩展点注解"><a class="anchor" href="#_扩展点注解"></a><a class="link" href="#_扩展点注解">19.3.3. 扩展点注解</a></h4>
<div class="paragraph">
<p>通过自定义注解@ExtensionPoint的方式，标注一个接口是一个扩展点。扩展点的注解如下代码所示。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 *  扩展点注解
 *  @author xujin
 */</span>
<span class="annotation">@Target</span>(<span class="predefined-type">ElementType</span>.TYPE)
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Documented</span>
<span class="directive">public</span> <span class="annotation">@interface</span> ExtensionPoint {

    <span class="comment">/**
     * 扩展点id
     * @return
     */</span>
    <span class="predefined-type">String</span> id() <span class="keyword">default</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;

    <span class="comment">/**
     * 扩展点名称
     * @return
     */</span>
    <span class="predefined-type">String</span> name();

    <span class="comment">/**
     * 扩展点描述
     * @return
     */</span>
    <span class="predefined-type">String</span> desc();

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
使用@ExtensionPoint时，其中的name和desc是必须填写的，因为要收集到中台Portal进行统一的管理。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_扩展注解"><a class="anchor" href="#_扩展注解"></a><a class="link" href="#_扩展注解">19.3.4. 扩展注解</a></h4>
<div class="paragraph">
<p>扩展就是接口的实现，Halo框架通过自定义注解@Extension的方式，标注一个接口的实现是一个扩展。
扩展的注解如下代码所示。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 *  扩展的注解
 * @author xujin
 */</span>
<span class="annotation">@Inherited</span>
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Documented</span>
<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.TYPE})
<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="annotation">@interface</span> Extension {

    <span class="comment">/**
     * 扩展的Id
     * @return
     */</span>
    <span class="predefined-type">String</span> id() <span class="keyword">default</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;

    <span class="comment">/**
     * 扩展的名称
     * @return
     */</span>
    <span class="predefined-type">String</span> name();

    <span class="comment">/**
     * 对应的扩展点Id
     * @return
     */</span>
    <span class="predefined-type">String</span> extensionPointId() <span class="keyword">default</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;

    <span class="comment">/**
     * 扩展对应的描述
     * @return
     */</span>
    <span class="predefined-type">String</span> desc() <span class="keyword">default</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;

    <span class="comment">/**
     * 业务身份
     * @return
     */</span>
    <span class="predefined-type">String</span> bizCode()  <span class="keyword">default</span> CoreConstant.DEFAULT_BIZ_CODE;

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
使用@Extension时，其中的name和desc是必须填写的，如果bizCode不填代表是默认扩展，如果有多个扩展，需要在扩展上面填写对应的bizCode,
因为要收集到中台Portal进行统一的管理。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_业务身份"><a class="anchor" href="#_业务身份"></a><a class="link" href="#_业务身份">19.3.5. 业务身份</a></h4>
<div class="paragraph">
<p>在扩展点中,引入了业务身份,不同的业务身份走不同的业务扩展,Halo  Admin最终会对应用中的业务身份统一管理起来,避免业务身份冲突,调整业务身份执行的优先级.
下面代码中的bizCode = "com.pay.alipay"就是业务身份.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.xujin.halo.extension</span>;

<span class="keyword">import</span> <span class="include">org.xujin.halo.annotation.extension.Extension</span>;

<span class="comment">/**
 * 支付宝支付扩展
 * @author xujin
 */</span>
<span class="annotation">@Extension</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">支付包支付扩展</span><span class="delimiter">&quot;</span></span>, bizCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">com.pay.alipay</span><span class="delimiter">&quot;</span></span>,desc = <span class="string"><span class="delimiter">&quot;</span><span class="content">支付宝支付扩展</span><span class="delimiter">&quot;</span></span>) # <b class="conum">(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AliPayExtension</span> <span class="directive">implements</span> PayExtPt {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> pay(<span class="predefined-type">Object</span> object) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">支付包支付扩展</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> pay() {
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>其中的bizCode = "com.pay.alipay"是业务身份,业务身份之间用.隔开,一般来说是:一级业务身份.二级业务身份.三级业务身份</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="halo-extract-bizCode"><a class="anchor" href="#halo-extract-bizCode"></a><a class="link" href="#halo-extract-bizCode">19.3.6. 提取业务身份</a></h4>
<div class="paragraph">
<p>Halo框架扩展点的执行,需要根据业务身份路由到对应的扩展点实现.因此需要提取业务身份.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1.上游传递到下游</p>
<div class="literalblock">
<div class="content">
<pre>通过上游调用方,或者前端,APP传递业务身份给下游,比如用户选中支付宝支付,此时传递bizCode=com.pay.alipay到调用端,示例代码如下所示:</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@GetMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/extensionExe</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="predefined-type">String</span> exeExtension(<span class="predefined-type">String</span> bizCode) {
  <span class="predefined-type">Context</span> context = <span class="keyword">new</span> <span class="predefined-type">Context</span>();
  <span class="comment">//bizCode可以是前端传递过来的com.pay.alipay</span>
  context.setBizCode(bizCode);
  <span class="predefined-type">String</span> result = extensionExecutor.exeReturnValue(PayExtPt.class, context, extension -&gt; extension.pay(<span class="predefined-constant">null</span>));
  <span class="keyword">return</span> result;
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>2.在执行扩展之前通过实现BizCodeParser接口提取</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PayMethodBizParser</span> <span class="directive">implements</span> BizCodeParser&lt;<span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Context</span> bizCodeParser(<span class="predefined-type">String</span> object) {

        <span class="predefined-type">Context</span>&lt;<span class="predefined-type">String</span>&gt; context = <span class="keyword">new</span> <span class="predefined-type">Context</span>&lt;<span class="predefined-type">String</span>&gt;();
        context.setBizCode(<span class="string"><span class="delimiter">&quot;</span><span class="content">com.pay.alipay</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> context;
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
把提取业务身份的逻辑收拢到统一的地方处理,比如提取不同业务身份写的if-else.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>在需要使用的地方@Autowired注入调用即可.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Autowired</span> PayMethodBizParser payMethodBizParser

<span class="predefined-type">Context</span> context=payMethodBizParser.bizCodeParser(<span class="string"><span class="delimiter">&quot;</span><span class="content">提前业务身份需要传递的参数</span><span class="delimiter">&quot;</span></span>);

extensionExecutor.exeReturnValue(PayExtPt.class, context, extension -&gt; extension.pay(<span class="predefined-constant">null</span>));</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>3.根据不同的应用Api入口确定,携带对应的业务身份</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_减少扩展点数量"><a class="anchor" href="#_减少扩展点数量"></a><a class="link" href="#_减少扩展点数量">19.3.7. 减少扩展点数量</a></h4>
<div class="paragraph">
<p>共用业务身份减少扩展点</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_扩展点管理"><a class="anchor" href="#_扩展点管理"></a><a class="link" href="#_扩展点管理">20. 扩展点管理</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_扩展信息采集"><a class="anchor" href="#_扩展信息采集"></a><a class="link" href="#_扩展信息采集">20.1. 扩展信息采集</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-flow"><a class="anchor" href="#halo-flow"></a><a class="link" href="#halo-flow">21. 流程编排</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_业务场景"><a class="anchor" href="#_业务场景"></a><a class="link" href="#_业务场景">21.1. 业务场景</a></h3>
<div class="sect3">
<h4 id="_仓储出库场景"><a class="anchor" href="#_仓储出库场景"></a><a class="link" href="#_仓储出库场景">21.1.1. 仓储出库场景</a></h4>
<div class="paragraph">
<p>仓储出库场景如下图所示，展示了B2C,O2O,B2B不同形态的业务节点编排:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/wl-output.png" alt="wl output" width="800">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
如上图所示,不同的业务类型，产生不同的业务流程，不同的业务流程，可能由相同的业务节点组成。
此时就需要流程编排，业务节点资产复用，快速效应不同的业务需求。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_交易订单场景"><a class="anchor" href="#_交易订单场景"></a><a class="link" href="#_交易订单场景">21.1.2. 交易订单场景</a></h4>
<div class="paragraph">
<p>在交易订单系统中，创建订单的流程如下图所示,每个流程节点，根据不同的业务也可以编排复用。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/trade-order.jpg" alt="trade order" width="800">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_流程编排"><a class="anchor" href="#_流程编排"></a><a class="link" href="#_流程编排">21.2. 流程编排</a></h3>
<div class="paragraph">
<p>当没有流程编排的时候，会出现以下问题</p>
</div>
<div class="ulist">
<ul>
<li>
<p>代码复用方式千奇百怪，无统一标准。</p>
</li>
<li>
<p>模块划分无章可循。</p>
</li>
<li>
<p>应用日趋复杂</p>
</li>
<li>
<p>流程变更过程冗繁。</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
因为没有流程编排会出现如上的问题，因此组件化需求产生，将代码形成可复用的代码资产。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>组件化需求</p>
</div>
<div class="ulist">
<ul>
<li>
<p>一套简单的复用标准。</p>
</li>
<li>
<p>一个简单的模块划分标准。</p>
</li>
<li>
<p>多么复杂多变的业务都可轻松应对。</p>
</li>
<li>
<p>轻量、敏捷、易用。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_流程编排的关键问题"><a class="anchor" href="#_流程编排的关键问题"></a><a class="link" href="#_流程编排的关键问题">21.3. 流程编排的关键问题</a></h3>
<div class="paragraph">
<p>流程由多个组件或节点组成，下面介绍一下组件或节点相关的概念。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>如何定义组件？
&gt; 我们将一个独立的计算单元称为组件。</p>
</li>
<li>
<p>组件划分的标准是什么？
&gt; 一个单一功能即可划归为一个组件。</p>
</li>
<li>
<p>如何进行组件间的数据传输？
&gt; 操作和数据分离，数据统一存储，按需存取</p>
</li>
<li>
<p>如何用一种方式标示组件编排顺序？</p>
<div class="literalblock">
<div class="content">
<pre>&gt; 所有操作从开始到结束的实际执行链路展开是一个串行无分叉的链路，但将多种情况的执行链路放在一起却是树状的。所以我们将采用树状存储结构。</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_流程编排设计"><a class="anchor" href="#_流程编排设计"></a><a class="link" href="#_流程编排设计">21.4. 流程编排设计</a></h3>
<div class="sect3">
<h4 id="_流程编排架构"><a class="anchor" href="#_流程编排架构"></a><a class="link" href="#_流程编排架构">21.4.1. 流程编排架构</a></h4>
<div class="imageblock">
<div class="content">
<img src="images/halo/flow-arch.png" alt="flow arch" width="800">
</div>
</div>
</div>
<div class="sect3">
<h4 id="halo-flow-define"><a class="anchor" href="#halo-flow-define"></a><a class="link" href="#halo-flow-define">21.4.2. 流程定义</a></h4>
<div class="paragraph">
<p>通过自定义注解@Flow实现流程定义。</p>
</div>
<div class="listingblock">
<div class="title">@Flow注解代码如下所示:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * B2C出库流程
 * @author xujin
 */</span>
<span class="annotation">@Flow</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">b2cOutPutFlow</span><span class="delimiter">&quot;</span></span>, desc = <span class="string"><span class="delimiter">&quot;</span><span class="content">B2C出库流程</span><span class="delimiter">&quot;</span></span>) # <b class="conum">(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">B2cOutPutFlow</span> {

    <span class="comment">/**
     * 开始节点，
     * 一个流程必须得有一个开始节点
     *
     * @return
     */</span>
    <span class="annotation">@StartNode</span>(nextNodeRoute = {<span class="annotation">@NextNodeRoute</span>(key = <span class="string"><span class="delimiter">&quot;</span><span class="content">succes</span><span class="delimiter">&quot;</span></span>, nodeName = <span class="string"><span class="delimiter">&quot;</span><span class="content">generateBatch</span><span class="delimiter">&quot;</span></span>)}) # <b class="conum">(2)</b>
    <span class="directive">public</span> <span class="predefined-type">String</span> start() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">succes</span><span class="delimiter">&quot;</span></span>;
    }


    <span class="comment">/**
     * 生成批次
     *
     * @param processResult
     * @return
     */</span>
    <span class="annotation">@ProcessNode</span>(nextNodeRoute = {<span class="annotation">@NextNodeRoute</span>(key = <span class="string"><span class="delimiter">&quot;</span><span class="content">succes</span><span class="delimiter">&quot;</span></span>, nodeName = <span class="string"><span class="delimiter">&quot;</span><span class="content">generateWave</span><span class="delimiter">&quot;</span></span>)},
            name = <span class="string"><span class="delimiter">&quot;</span><span class="content">generateBatch</span><span class="delimiter">&quot;</span></span>, handler = <span class="string"><span class="delimiter">&quot;</span><span class="content">generateBatchProcessor</span><span class="delimiter">&quot;</span></span>, desc = <span class="string"><span class="delimiter">&quot;</span><span class="content">该节点用于生成批次</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> generateBatch(<span class="predefined-type">Boolean</span> processResult) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">succes</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="comment">/**
     * 生成波次
     *
     * @param processResult
     * @return
     */</span>
    <span class="annotation">@ProcessNode</span>(nextNodeRoute = {
            <span class="annotation">@NextNodeRoute</span>(key = <span class="string"><span class="delimiter">&quot;</span><span class="content">succes</span><span class="delimiter">&quot;</span></span>, nodeName = <span class="string"><span class="delimiter">&quot;</span><span class="content">createPicking</span><span class="delimiter">&quot;</span></span>), # <b class="conum">(3)</b>
            <span class="annotation">@NextNodeRoute</span>(key = <span class="string"><span class="delimiter">&quot;</span><span class="content">fail</span><span class="delimiter">&quot;</span></span>, nodeName = <span class="string"><span class="delimiter">&quot;</span><span class="content">end</span><span class="delimiter">&quot;</span></span>)}, # <b class="conum">(4)</b>
            name = <span class="string"><span class="delimiter">&quot;</span><span class="content">generateWave</span><span class="delimiter">&quot;</span></span>, # <b class="conum">(5)</b>
            handler = <span class="string"><span class="delimiter">&quot;</span><span class="content">generateWaveProcessor</span><span class="delimiter">&quot;</span></span>, # <b class="conum">(6)</b>
            desc = <span class="string"><span class="delimiter">&quot;</span><span class="content">该节点用于生成波次</span><span class="delimiter">&quot;</span></span>  # <b class="conum">(7)</b>
            )
    <span class="directive">public</span> <span class="predefined-type">String</span> generateWave(<span class="predefined-type">Boolean</span> processResult) {  # <b class="conum">(8)</b>
        <span class="predefined-type">String</span> nextNodeRouteKey = <span class="predefined-constant">null</span>;
        <span class="keyword">if</span> (processResult) {
            nextNodeRouteKey = <span class="string"><span class="delimiter">&quot;</span><span class="content">succes</span><span class="delimiter">&quot;</span></span>; # <b class="conum">(9)</b>
        } <span class="keyword">else</span> {
            nextNodeRouteKey = <span class="string"><span class="delimiter">&quot;</span><span class="content">fail</span><span class="delimiter">&quot;</span></span>;  # <b class="conum">(10)</b>
        }
        <span class="keyword">return</span> nextNodeRouteKey;
    }

    <span class="comment">/**
     * 创建拣货单
     *
     * @param processResult
     * @return
     */</span>
    <span class="annotation">@ProcessNode</span>(nextNodeRoute = {<span class="annotation">@NextNodeRoute</span>(key = <span class="string"><span class="delimiter">&quot;</span><span class="content">end</span><span class="delimiter">&quot;</span></span>, nodeName = <span class="string"><span class="delimiter">&quot;</span><span class="content">end</span><span class="delimiter">&quot;</span></span>)},
            name = <span class="string"><span class="delimiter">&quot;</span><span class="content">createPicking</span><span class="delimiter">&quot;</span></span>, handler = <span class="string"><span class="delimiter">&quot;</span><span class="content">createPickingProcessor</span><span class="delimiter">&quot;</span></span>, desc = <span class="string"><span class="delimiter">&quot;</span><span class="content">该节点用于创建拣货单</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> createPicking(<span class="predefined-type">Boolean</span> processResult) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">end</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="comment">/**
     * 结束节点
     */</span>
    <span class="annotation">@EndNode</span>
    <span class="directive">public</span> <span class="type">void</span> end() {  # <b class="conum">(11)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>使用@Flow定义流程</p>
</li>
<li>
<p>定义开始节点</p>
</li>
<li>
<p>下一个节点路由映射,其中的key为String，当前节点执行完毕后的判断，nodeName为下一个节点的名称</p>
</li>
<li>
<p>当前节点名称</p>
</li>
<li>
<p>节点描述</p>
</li>
<li>
<p>handler = "generateWaveProcessor"当前节点对应的节点处理器,其中generateWaveProcessor为处理器Bean的名称，首字母小写。</p>
</li>
<li>
<p>public String generateWave(Boolean processResult)其中processResult是当前节点处理器的返回值</p>
</li>
<li>
<p>根据处理器的返回值判断返回key=succes,执行下一个节点createPicking</p>
</li>
<li>
<p>根据处理器的返回值判断返回key=fail,执行结束节点</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_节点定义"><a class="anchor" href="#_节点定义"></a><a class="link" href="#_节点定义">21.4.3. 节点定义</a></h4>
<div class="paragraph">
<p>Halo Flow中的Node分为开始节点，执行节点，结束节点，如下表所示</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<caption class="title">Table 5. 节点分类表</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">节点名称</th>
<th class="tableblock halign-left valign-top">类型</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">开始节点</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">使用@StartNode注解标记该节点是一个开始节点</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">执行节点</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">使用@ProcessNode注解标记该节点是一个执行节点</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">结束节点</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">使用@EndNode注解标记该节点是一个结束节点</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_节点异常持久化"><a class="anchor" href="#_节点异常持久化"></a><a class="link" href="#_节点异常持久化">21.4.4. 节点异常持久化</a></h4>
<div class="paragraph">
<p>当某个节点，出现异常时，需要对异常的执行节点持久化。Halo-flow模块当节点出现异常时会记录相关的数据，
但是默认不开启记录，需要使用方根据实际情况设置开启。</p>
</div>
<div class="listingblock">
<div class="title">在application.yml文件中开启的配置如下所示</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">flow</span>:
    <span class="key">persistence</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_启动流程"><a class="anchor" href="#_启动流程"></a><a class="link" href="#_启动流程">21.4.5. 启动流程</a></h4>
<div class="paragraph">
<p>Halo Flow提供以下两种接口启动流程</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">FlowEngine</span> {

    <span class="comment">/**
     * 默认从Start节点执行流程
     * @param flowName  流程名称
     * @param inputData 流程执行入参
     * @return FlowHandleContext&lt;T&gt; 流程执行的结果
     */</span>
    <span class="directive">public</span> &lt;T&gt; FlowHandleContext&lt;T&gt; start(<span class="predefined-type">String</span> flowName, T inputData); # <b class="conum">(1)</b>


    <span class="comment">/**
     * 从指定节点执行流程
     *
     * @param flowName          流程名称
     * @param flowHandleContext 流程执行上下文
     * @param nodeName          指定节点名称
     * @return FlowHandleContext&lt;T&gt; 流程执行的结果
     */</span>
    <span class="directive">public</span> &lt;T&gt; FlowHandleContext&lt;T&gt; start(<span class="predefined-type">String</span> flowName, FlowHandleContext&lt;T&gt; flowHandleContext, <span class="predefined-type">String</span> nodeName); # <b class="conum">(2)</b>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>该方法默认从开始节点执行,需要输入参数流程名称和流程执行需要的入参</p>
</li>
<li>
<p>该方法使用场景是指定节点执行,此时需要输入流程执行节点需要的上下文</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>在代码中使用示例代码如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Autowired</span>
<span class="directive">private</span> FlowEngine flowEngine;

<span class="comment">/**
* flowName是流程名称，
**/</span>
flowEngine.start(<span class="string"><span class="delimiter">&quot;</span><span class="content">flowName</span><span class="delimiter">&quot;</span></span>, inputData);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
流程名称是@Flow(name = "b2cOutPutFlow"）注解中的name，Spring Bean的名称首字母小写
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_流程执行异常处理"><a class="anchor" href="#_流程执行异常处理"></a><a class="link" href="#_流程执行异常处理">21.4.6. 流程执行异常处理</a></h4>
<div class="paragraph">
<p>流程启动后，在节点执行过程中抛出异常时，Halo Flow会在记录异常信息后，将该异常抛出，交由开发人员处理。</p>
</div>
<div class="paragraph">
<p>为提高灵活性，在Halo Flow抛出异常时，会通过Throwable.addSuppressed()的方式，把流程执行相关信息附加到原始异常中。流程执行相关信息被封到FlowExecutionException对象，包括流程名称、流程中断时执行节点、流程中断时上下文等。通过Throwable.getSuppressed()方法可以获取到FlowExecutionException对象。</p>
</div>
<div class="paragraph">
<p>FlowExecutionException代码定义：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">FlowExecutionException</span> <span class="directive">extends</span> <span class="exception">Exception</span> {

        <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> MSG_FORMAT = <span class="string"><span class="delimiter">&quot;</span><span class="content">Halo流程引擎执行流程%s的%s节点时失败</span><span class="delimiter">&quot;</span></span>;

        <span class="comment">/**
         * 流程名称
         */</span>
        <span class="directive">private</span> <span class="predefined-type">String</span> flowName;

        <span class="comment">/**
         * 当前执行节点名称
         */</span>
        <span class="directive">private</span> <span class="predefined-type">String</span> nodeName;

        <span class="comment">/**
         * 流程执行失败时的上下文信息
         */</span>
        <span class="directive">private</span> FlowHandleContext context;


        <span class="directive">public</span> FlowExecutionException(<span class="predefined-type">String</span> flowName, <span class="predefined-type">String</span> nodeName, FlowHandleContext context) {
            <span class="local-variable">super</span>(getMsg(flowName, nodeName));
            <span class="local-variable">this</span>.flowName = flowName;
            <span class="local-variable">this</span>.nodeName = nodeName;
            <span class="local-variable">this</span>.context = context;
        }

        <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">String</span> getMsg(<span class="predefined-type">String</span> flowName, <span class="predefined-type">String</span> nodeName) {
            <span class="keyword">return</span> <span class="predefined-type">String</span>.format(MSG_FORMAT, flowName, nodeName);
        }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_流程事务"><a class="anchor" href="#_流程事务"></a><a class="link" href="#_流程事务">21.4.7. 流程事务</a></h4>
<div class="paragraph">
<p>Halo Framework中的流程默认开启事务，即整个执行流程开启事务。在使用@Flow进行流程定义的时候默认为true开启事务。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
如果应用中不需要数据源，即不需要配置事务管理器，使用默认参数启动流程会报错，此时应该将@Flow中enableFlowTx属性置为false。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">@Flow注解代码如下所示:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Documented</span>
<span class="annotation">@Target</span>(<span class="predefined-type">ElementType</span>.TYPE)
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="annotation">@interface</span> Flow {

    <span class="comment">/**
     * 流程名称（默认使用被注解的类名，首字母小写）
     */</span>
    <span class="predefined-type">String</span> name(); # <b class="conum">(1)</b>

    <span class="comment">/**
     * 是否开启流程事务（默认开启）
     */</span>
    <span class="type">boolean</span> enableFlowTx() <span class="keyword">default</span> <span class="predefined-constant">true</span>;

    <span class="comment">/**
     * 指定事务管理器的bean name
     * 用于多个数据源情况下，不指定则使用默认事务管理器
     */</span>
    <span class="predefined-type">String</span> txManager() <span class="keyword">default</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;

    <span class="comment">/**
     * 当前流程的描述
     *
     * @return
     */</span>
    <span class="predefined-type">String</span> desc(); # <b class="conum">(2)</b>

    <span class="comment">/**
     * 流程的唯一Id
     *
     * @return
     */</span>
    <span class="predefined-type">String</span> id() <span class="keyword">default</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
①和②表示流程的名称和描述必填。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_节点事务"><a class="anchor" href="#_节点事务"></a><a class="link" href="#_节点事务">21.4.8. 节点事务</a></h4>
<div class="paragraph">
<p>在Halo Flow中每个节点默认都是一个独立的单元，默认每个Node执行完毕就把当前节点的事务提交，如果不需要当前节点把事务提交可以在Node上
添加enableNodeTx = false。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/nodeTx.png" alt="nodeTx" width="800">
</div>
</div>
</div>
<div class="sect3">
<h4 id="halo-flow-multi-tx"><a class="anchor" href="#halo-flow-multi-tx"></a><a class="link" href="#halo-flow-multi-tx">21.4.9. 多数据源流程事务</a></h4>
<div class="paragraph">
<p>Halo Flow采用Spring事务管理器进行事务管理，目前并不支持分布式事务。</p>
</div>
<div class="paragraph">
<p>当项目中用到多个数据源时，其中一个数据源（DataSource）必须显式的用@Primary标记。在默认情况下，Halo使用该DataSource对应的事务管理器，如果在流程中同时操作非@Primary数据源，则非@Primary数据源并不受Halo Flow事务管理。</p>
</div>
<div class="paragraph">
<p>通过@Flow的txManager属性，可以显式指定事务管理器的bean名称，与@Transactional（Spring）中transactionManager属性用法相同。</p>
</div>
<div class="paragraph">
<p>多数据源配置请参考：<a href="#halo-mybatis-hikariCP-multi">Halo Mybatis多数据源配置</a>。</p>
</div>
<div class="paragraph">
<p>Flow事务管理器配置：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/flow-txmanager-example.png" alt="flow txmanager example" width="800">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_流程编排信息采集"><a class="anchor" href="#_流程编排信息采集"></a><a class="link" href="#_流程编排信息采集">21.5. 流程编排信息采集</a></h3>
<div class="sect3">
<h4 id="_登录到中台可视化查看"><a class="anchor" href="#_登录到中台可视化查看"></a><a class="link" href="#_登录到中台可视化查看">21.5.1. 登录到中台可视化查看</a></h4>
<div class="paragraph">
<p>可以登录到Halo Admin查看中台可视化</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Layer-design"><a class="anchor" href="#Layer-design"></a><a class="link" href="#Layer-design">22. 分层设计</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_传统三层"><a class="anchor" href="#_传统三层"></a><a class="link" href="#_传统三层">22.1. 传统三层</a></h3>
<div class="paragraph">
<p>传统三层即Controller,Service,Dao,需求开发直接一杆子从Controller捅到底。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/ct-sc.png" alt="ct sc" width="800">
</div>
<div class="title">Figure 15. 传统三层</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
事实证明传统三层指导不了复杂的软件系统开发！
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_halo架构分层"><a class="anchor" href="#_halo架构分层"></a><a class="link" href="#_halo架构分层">22.2. Halo架构分层</a></h3>
<div class="paragraph">
<p>在Halo 1.0中，我们的分层是如下左图所示的是DDD的经典分层，在Halo 2.0中，还是这些层次，但是依赖关系发生了变化，Domain层不再直接依赖Infrastructure层，
而是引入了一个端口适配器模式(Port/Adapter),使用DIP（Dependency Inversion Principle，依赖倒置）反转了Domain层和Infrastructure层的依赖关系，其关系如右图所示：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/halo-arch-layer.png" alt="halo arch layer" width="800">
</div>
<div class="title">Figure 16. Halo架构分层</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Domain层不在依赖基础实施层，而是以接口的方式开放端口，让基础实施层去实现，这样设计的有点是Domain层的<strong>演变和进化完全是独立的</strong>,
<strong>向上不受App层</strong>影响，<strong>向下不受基础设施层</strong>影响。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="soft-layer"><a class="anchor" href="#soft-layer"></a><a class="link" href="#soft-layer">22.3. Halo应用分层</a></h3>
<div class="imageblock">
<div class="content">
<img src="images/halo/soft-layer.png" alt="soft layer" width="800">
</div>
<div class="title">Figure 17. 应用分层</div>
</div>
<div class="paragraph">
<p>应用分层从传统的表现层，业务逻辑层，数据库层演变为表现层，领域层,基础设施层。以halo-goods应用为例
对应的工程模块如下所示:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<caption class="title">Table 6. 示例工程模块</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">模块</th>
<th class="tableblock halign-left valign-top">描述</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-goods-app</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-goods应用的应用层</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">应用层适合做参数校验,提供简单的应用服务,还有就是流程编排</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-goods-domain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-goods应用的领域层</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">领域层主要管理领域,领域划分</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-goods-infrastructure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-goods应用的基础设施层</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-goods-start</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-goods应用的start</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-goods-client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-goods应用的二方包</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="imageblock">
<div class="content">
<img src="images/halo/project-module.png" alt="project module" width="500">
</div>
<div class="title">Figure 18. 示例工程</div>
</div>
<div class="ulist">
<ul>
<li>
<p>展现层</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>展现层负责向用户显示信息和解释用户指令。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>应用层</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>应用层是很薄的一层，主要面向用户用例操作，协调和指挥领域对象来完成业务逻辑。应用层也是与其他系统的应用层进行交互的必要渠道。应用层服务尽量简单，它不包含业务规则或知识，只为下一层的领域对象协调任务，使它们互相协作。应用层还可进行安全认证、权限校验、分布式和持久化事务控制或向外部应用发送基于事件的消息等。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>领域层</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>领域层是软件的核心所在，它实现全部业务逻辑并且通过各种校验手段保证业务正确性。它包含业务所涉及的领域对象（实体、值对象）、领域服务以及它们之间的关系。它负责表达业务概念、业务状态以及业务规则，具体表现形式就是领域模型。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>基础设施层</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>基础层为各层提供通用的技术能力，包括：为应用层传递消息、提供 API 管理，为领域层提供数据库持久化机制等。它还能通过技术框架来支持各层之间的交互。</p>
</div>
</div>
<div class="sect2">
<h3 id="_halo的组件视图"><a class="anchor" href="#_halo的组件视图"></a><a class="link" href="#_halo的组件视图">22.4. Halo的组件视图</a></h3>
<div class="paragraph">
<p>在Halo 2.0中，我们重新设计了组件，引入了一些新的组件，也去除了一些旧组件。这些变动的宗旨是为了让应用结构更加清晰，组件的职责更加明确，从而更好的提供开发指导和约束。
新的组件结构如下图所示：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/halo-zj.png" alt="halo zj" width="800">
</div>
<div class="title">Figure 19. Halo 2.0组件图</div>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<caption class="title">Table 7. Halo工程2.0组件图说明</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">模块</th>
<th class="tableblock halign-left valign-top">描述</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xxx-xxx-app</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xxx或xxx-xxx应用的应用层</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">应用层的组件有命令，事件，领域服务(包含命令，Phase(阶段)，Step(步骤)，Flow(流程),Node(节点)等)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xxx-xxx-domain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xxx或xxx-xxx应用的领域层</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">组件主要有领域对象，领域服务和领域能力，开放的Port(端口,即接口)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xxx-xxx-infrastructure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xxx或xxx-xxx应用的基础设施层</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">组件主要有Dao或Mapper,缓存操作，RPC调用，REST调用</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xxx-xxx-start</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xxx或xxx-xxx应用的start</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">标志应用的入口，主要有Controller等</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xxx-xxx-client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xxx或xxx-xxx应用的二方包</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">包含接口定义，入参返回值，枚举等</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_halo组件视图"><a class="anchor" href="#_halo组件视图"></a><a class="link" href="#_halo组件视图">22.5. Halo组件视图</a></h3>
<div class="paragraph">
<p>使用了Halo框架的组件视图如下所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/halo-component.svg" alt="halo component" width="800">
</div>
<div class="title">Figure 20. Halo 2.0工程组件依赖图</div>
</div>
</div>
<div class="sect2">
<h3 id="_halo服务视图"><a class="anchor" href="#_halo服务视图"></a><a class="link" href="#_halo服务视图">22.6. Halo服务视图</a></h3>
<div class="ulist">
<ul>
<li>
<p>应用服务</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>应用服务位于应用层。用来表述应用和用户行为，负责服务的组合、编排和转发，负责处理业务用例的执行顺序以及结果的拼装。</p>
</div>
<div class="paragraph">
<p>应用层的服务包括应用服务和领域事件相关服务。</p>
</div>
<div class="paragraph">
<p>应用服务可对微服务内的领域服务以及微服务外的应用服务进行组合和编排，或者对基础层如文件、缓存等数据直接操作形成应用服务，对外提供粗粒度的服务。</p>
</div>
<div class="paragraph">
<p>领域事件服务包括两类：领域事件的发布和订阅。通过事件总线和消息队列实现异步数据传输，实现微服务之间的解耦。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>领域服务</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>领域服务位于领域层，为完成领域中跨实体或值对象的操作转换而封装的服务，领域服务以与实体和值对象相同的方式参与实施过程。</p>
</div>
<div class="paragraph">
<p>领域服务对同一个实体的一个或多个方法进行组合和封装，或对多个不同实体的操作进行组合或编排，对外暴露成领域服务。领域服务封装了核心的业务逻辑。实体自身的行为在实体类内部实现，向上封装成领域服务暴露。</p>
</div>
<div class="paragraph">
<p>为隐藏领域层的业务逻辑实现，所有领域方法和服务等均须通过领域服务对外暴露。</p>
</div>
<div class="paragraph">
<p>为实现微服务内聚合之间的解耦，原则上禁止跨聚合的领域服务调用和跨聚合的数据相互关联。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>基础服务</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>基础服务位于基础层。为各层提供资源服务（如数据库、缓存等），实现各层的解耦，降低外部资源变化对业务逻辑的影响。</p>
</div>
<div class="paragraph">
<p>基础服务主要为仓储服务，通过依赖反转的方式为各层提供基础资源服务，领域服务和应用服务调用仓储服务接口，利用仓储实现持久化数据对象或直接访问基础资源。</p>
</div>
</div>
<div class="sect2">
<h3 id="layer-object"><a class="anchor" href="#layer-object"></a><a class="link" href="#layer-object">22.7. 分层对象</a></h3>
<div class="paragraph">
<p>传统应用分层产生VO(View Object)视图对象,DAO(data access object) 数据访问对象,PO(persistant object) 持久对象即实体.</p>
</div>
<div class="paragraph">
<p>Halo框架分层之后会产生如下对象</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<caption class="title">Table 8. Halo分层对象表</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">名称</th>
<th class="tableblock halign-left valign-top">描述</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Command Object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">命令对象</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">命令对象简单CMO</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">实体</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DDD中的实体</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">value object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">值对象</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">值对象简称VO</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data Object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">数据对象</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">数据对象简称DO,相当于传统三层中的实体和数据库表结构映射</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client Object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">客户端对象</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">所有的命令处理完毕之后,返回的对象皆为客户端对象,客户端包括前端,服务消费方等</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>CO,DO,Entity之间的转换关系如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/convert-dto.png" alt="convert dto" width="800">
</div>
<div class="title">Figure 21. 分层对象之间的转换</div>
</div>
</div>
<div class="sect2">
<h3 id="convertor-design"><a class="anchor" href="#convertor-design"></a><a class="link" href="#convertor-design">22.8. Convertor设计</a></h3>
<div class="paragraph">
<p>在Halo中有三类主要的对象：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ClientObject: 也就是二方库中的数据对象，主要承担DTO的职责。</p>
</li>
<li>
<p>Entity/ValueObject: 也就是既有属性又有行为的领域实体。</p>
</li>
<li>
<p>DataObeject：是用来获取数据用的，主要是DAO使用。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Convertor在上面三个对象之间的转换起到了至关重要的作用，然而Convertor里面的逻辑应该是简单的，大部分都是setter/getter,
如果属性重复度很高的话，也可以使用BeanUtils.copyProperties让代码变得更简洁。但事实情况是，现在系统中很多的Convertor
逻辑并没有在Convertor里面。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/convert-layer.png" alt="convert layer" width="800">
</div>
<div class="title">Figure 22. Halo转换层设计</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Halo-check"><a class="anchor" href="#Halo-check"></a><a class="link" href="#Halo-check">23. Halo Check</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Halo Framework提供代码质量检查工具,目前包含了CheckStyle和PMD代码检查.</p>
</div>
<div class="sect2">
<h3 id="Halo-codecheck-words"><a class="anchor" href="#Halo-codecheck-words"></a><a class="link" href="#Halo-codecheck-words">23.1. 名词解释</a></h3>

</div>
<div class="sect2">
<h3 id="Halo-codecheck-checkstye"><a class="anchor" href="#Halo-codecheck-checkstye"></a><a class="link" href="#Halo-codecheck-checkstye">23.2. CheckStyle</a></h3>
<div class="paragraph">
<p>checkstyle是一种静态代码分析工具,用来分析java代码是否符合定义的规则;
常用以下方面检查</p>
</div>
<div class="ulist">
<ul>
<li>
<p>属性和方法的命名约定</p>
</li>
<li>
<p>方法参数的个数</p>
</li>
<li>
<p>代码行的长度</p>
</li>
<li>
<p>强制性文件头,如copyright author</p>
</li>
<li>
<p>import和public privte protect等修饰符的使用</p>
</li>
<li>
<p>字符间空格的间隔</p>
</li>
<li>
<p>代码复杂度检查</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Halo-codecheck-pmd"><a class="anchor" href="#Halo-codecheck-pmd"></a><a class="link" href="#Halo-codecheck-pmd">23.3. PMD</a></h3>
<div class="paragraph">
<p>全称:Programming Mistake Detector;</p>
</div>
<div class="paragraph">
<p>常用以下方面检查</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Possible bugs — Empty try/catch/finally/switch blocks/eating original exception and throwing a new one</p>
</li>
<li>
<p>Dead code — Unused [local variables](<a href="https://en.wikipedia.org/wiki/Local_variable" class="bare">https://en.wikipedia.org/wiki/Local_variable</a>), [parameters](<a href="https://en.wikipedia.org/wiki/Parameter" class="bare">https://en.wikipedia.org/wiki/Parameter</a>), and [private methods](<a href="https://en.wikipedia.org/wiki/Private_method" class="bare">https://en.wikipedia.org/wiki/Private_method</a>)</p>
</li>
<li>
<p>Empty if/while statements</p>
</li>
<li>
<p>Overcomplicated expressions — Unnecessary if statements, for loops that could be while loops</p>
</li>
<li>
<p>Suboptimal code — Wasteful String/StringBuffer usage</p>
</li>
<li>
<p>Classes with high [Cyclomatic Complexity](<a href="https://en.wikipedia.org/wiki/Cyclomatic_complexity" class="bare">https://en.wikipedia.org/wiki/Cyclomatic_complexity</a>) measurements</p>
</li>
<li>
<p>Incorrect BigDecimal Usage</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Halo-codecheck-use"><a class="anchor" href="#Halo-codecheck-use"></a><a class="link" href="#Halo-codecheck-use">23.4. 使用说明</a></h3>
<div class="paragraph">
<p>目标用户:项目管理员</p>
</div>
<div class="ulist">
<ul>
<li>
<p>第一步:在项目中引入maven插件</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-maven-githook<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;executions&gt;</span>
                <span class="tag">&lt;execution&gt;</span>
                        <span class="tag">&lt;goals&gt;</span>
                                <span class="tag">&lt;goal&gt;</span>git-hooks<span class="tag">&lt;/goal&gt;</span>
                        <span class="tag">&lt;/goals&gt;</span>
                        <span class="tag">&lt;configuration&gt;</span>
                                <span class="tag">&lt;ghooks&gt;</span>
                                        <span class="tag">&lt;pre-commit&gt;</span>pre-commit-sh/pre-commit.sh<span class="tag">&lt;/pre-commit&gt;</span>
                                        <span class="tag">&lt;pre-commit-checkstyle&gt;</span>pre-commit-sh/pre-commit-checkstyle.sh<span class="tag">&lt;/pre-commit-checkstyle&gt;</span>
                                        <span class="tag">&lt;pre-commit-pmd&gt;</span>pre-commit-sh/pre-commit-pmd.sh<span class="tag">&lt;/pre-commit-pmd&gt;</span>
                                <span class="tag">&lt;/ghooks&gt;</span>
                        <span class="tag">&lt;/configuration&gt;</span>
                        <span class="tag">&lt;phase&gt;</span>compile<span class="tag">&lt;/phase&gt;</span>
                <span class="tag">&lt;/execution&gt;</span>
        <span class="tag">&lt;/executions&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>当Maven对应用进行编译时,将会触发安装,安装日志如下:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">[INFO] --- maven-compiler-plugin:3.8.1:compile (default-compile) @ halo-admin-start ---
[INFO] Changes detected - recompiling the module!
[INFO] Compiling 23 source files to /xujin/code/halo-admin/halo-admin-start/target/classes
[INFO]
[INFO] --- halo-maven-githook:1.0.0-SNAPSHOT:git-hooks (default) @ halo-admin-start ---
[INFO] ========== pre-commit ==========
[INFO] Install Halo Check Component [halo-pmd.jar]...
[INFO] Install Halo Check Component [halo-checkstyle.jar]...
[INFO] Install git hook[pre-commit]...
[INFO] Use plugin git hook file: pre-commit-sh/pre-commit.sh
[INFO] ========== pre-commit-checkstyle ==========
[INFO] Install Halo Check Component [halo-pmd.jar]...
[INFO] Install Halo Check Component [halo-checkstyle.jar]...
[INFO] Install git hook[pre-commit-checkstyle]...
[INFO] Use plugin git hook file: pre-commit-sh/pre-commit-checkstyle.sh
[INFO] ========== pre-commit-pmd ==========
[INFO] Install Halo Check Component [halo-pmd.jar]...
[INFO] Install Halo Check Component [halo-checkstyle.jar]...
[INFO] Install git hook[pre-commit-pmd]...
[INFO] Use plugin git hook file: pre-commit-sh/pre-commit-pmd.sh
[INFO]
[INFO] --- maven-resources-plugin:3.1.0:testResources (default-testResources) @ halo-admin-start ---
[INFO] Using 'UTF-8' encoding to copy filtered resources.</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二步(可跳过):去Halo-admin 定制本项目的校验规则</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>如不需要定制个性化校验规则,可以跳过本步骤,使用系统默认的规则</p>
</div>
<div class="paragraph">
<p>1) 在 代码质量管理&gt;规则文件管理  菜单下新增规则文件,然后编辑规则文件选择要check的规则</p>
</div>
<div class="paragraph">
<p>2) 在 代码质量管理&gt;项目规则管理  菜单下,找到自己的项目,然后设置上一步新建的规则文件</p>
</div>
</div>
</div>
</div>
<h1 id="halo-admin" class="sect0"><a class="anchor" href="#halo-admin"></a><a class="link" href="#halo-admin">Halo Admin</a></h1>
<div class="openblock partintro">
<div class="content">
Halo Framework对应的中台可视化管控平台，主要包括业务中台域管理，应用管理,业务流程可视化，业务身份管理等。更多请访问 <a href="http://admin.qingcloud.net/" target="_blank" rel="noopener">中台可视化管控平台查看</a>
</div>
</div>
<div class="sect1">
<h2 id="_中台登录"><a class="anchor" href="#_中台登录"></a><a class="link" href="#_中台登录">24. 中台登录</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>业务中台支持域账号进行登录, 登录界面如下图所示：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-admin/zt-0.png" alt="zt 0">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_中台可视化dashboard"><a class="anchor" href="#_中台可视化dashboard"></a><a class="link" href="#_中台可视化dashboard">25. 中台可视化DashBoard</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>业务中台DashBoard如下图所示,包括中台建设成熟模型等。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-admin/zt-1.png" alt="zt 1">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_域管理"><a class="anchor" href="#_域管理"></a><a class="link" href="#_域管理">26. 域管理</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>1.业务中台-域管理编辑模式如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-admin/zt-2.png" alt="zt 2">
</div>
</div>
<div class="paragraph">
<p>2.业务中台-域管理树形层级查看模式，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-admin/zt-3.png" alt="zt 3">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_中台成熟度模型"><a class="anchor" href="#_中台成熟度模型"></a><a class="link" href="#_中台成熟度模型">27. 中台成熟度模型</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>业务中台建设的成熟度，目前在业界没有具体的衡量标准。Halo框架提供一个衡量标准。如下图所示，用雷达图的方式进行衡量。
雷达图面积越大，说明业务中台建设越成熟。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-admin/zt-csd.png" alt="zt csd">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_域服务"><a class="anchor" href="#_域服务"></a><a class="link" href="#_域服务">28. 域服务</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>业务中台按照域划分之后，每个域由应用组成，统一对外提供域服务。比如订单域，由订单应用等统一对外提供订单域的域服务。Halo Admin增加域服务的管理。如下所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-admin/yfw.png" alt="yfw">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_域能力"><a class="anchor" href="#_域能力"></a><a class="link" href="#_域能力">29. 域能力</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>业务中台有业务域，业务域中的应用提供的服务组成域服务对外提供域服务，域服务调用多个域能力，完成整个业务操作。Halo中的域能力即领域驱动中实体或值对象的行为和能力。
Halo Admin将每个业务域的域能力统一收集上传。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-admin/ynl.png" alt="ynl">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_应用管理"><a class="anchor" href="#_应用管理"></a><a class="link" href="#_应用管理">30. 应用管理</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>1.业务中台将对业务中台的应用进行管理，包括应用所属域，职能以及应用Owner进行管理，如下图示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-admin/zt-4.png" alt="zt 4">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_流程编排管理"><a class="anchor" href="#_流程编排管理"></a><a class="link" href="#_流程编排管理">31. 流程编排管理</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>1.中台应用，业务流程代码编排图形化展示，对业务可复用资产一目了然。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-admin/zt-5.png" alt="zt 5">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_扩展管理"><a class="anchor" href="#_扩展管理"></a><a class="link" href="#_扩展管理">32. 扩展管理</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>1.中台应用的扩展能力和插件能力，展示支撑的产品线，业务线，业务活动等能力，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-admin/zt-6.png" alt="zt 6">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_业务身份管理"><a class="anchor" href="#_业务身份管理"></a><a class="link" href="#_业务身份管理">33. 业务身份管理</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>1.提供全局视角，统管全局业务身份，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-admin/zt-7.png" alt="zt 7">
</div>
</div>
<div class="sect2">
<h3 id="_业务流程与业务活动"><a class="anchor" href="#_业务流程与业务活动"></a><a class="link" href="#_业务流程与业务活动">33.1. 业务流程与业务活动</a></h3>

</div>
</div>
</div>
<h1 id="halo-boot" class="sect0"><a class="anchor" href="#halo-boot"></a><a class="link" href="#halo-boot">VI Halo Boot</a></h1>
<div class="sect1">
<h2 id="what-is-starter"><a class="anchor" href="#what-is-starter"></a><a class="link" href="#what-is-starter">34. 什么是Starter</a></h2>
<div class="sectionbody">
<div class="literalblock">
<div class="content">
<pre>何为starter? "一种服务": 预配置,依赖关系完整,自我管理.</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>预配置: 默认值应足够好,在大部分情况下不需要修改</p>
</li>
<li>
<p>依赖关系完整: pom.xml只需要加上starter的依赖,相关jar应该完整,不需要再额外添加</p>
</li>
<li>
<p>自我管理: starter应该有自己的生命周期</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-boot-overview"><a class="anchor" href="#halo-boot-overview"></a><a class="link" href="#halo-boot-overview">35. Halo Boot概述</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Halo Boot 是基于 Spring Boot 的研发框架,将开发过程中经常需要使用的组件进行封装做到开箱即用。它在 Spring Boot 的基础上，提供了诸如 Readiness Check，类隔离，日志空间隔离等能力。在增强了 Spring Boot 的同时，Halo Boot 提供了让用户可以在 Spring Boot 中非常方便地使用 Halo相关中间件以及第三方中间件的能力。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Halo Boot主要模块</p>
<div class="ulist">
<ul>
<li>
<p>DDD与CQRS: halo-basic</p>
</li>
<li>
<p>应用内部流程编排: halo-flow</p>
</li>
<li>
<p>web层：通过Halo web对Spring Web进行封装增强。</p>
</li>
<li>
<p>数据库访问层: halo-mybatis,halo-mongodb,halo-es6,halo-es7 。</p>
</li>
<li>
<p>文档调试：halo-swagger,通过对Swagger进行封装定制方便开箱即用。</p>
</li>
<li>
<p>配置中心: halo-apollo。</p>
</li>
<li>
<p>分布式缓存: halo-redis。</p>
</li>
<li>
<p>分布式定时任务: halo-job</p>
</li>
<li>
<p>消息队列: halo-alimq(商业版Mq,即ONS)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_halo_boot扩展"><a class="anchor" href="#_halo_boot扩展"></a><a class="link" href="#_halo_boot扩展">36. Halo Boot扩展</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_haloapplication注解"><a class="anchor" href="#_haloapplication注解"></a><a class="link" href="#_haloapplication注解">36.1. @HaloApplication注解</a></h3>
<div class="paragraph">
<p>Halo Boot可以通过HaloApplication去<strong>替代</strong>@SpringBootApplication注解,Halo Boot默认会获取<strong>并设置最基本的类扫描包</strong>.
<strong>@HaloApplication</strong>的代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Documented</span>
<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.TYPE})
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@SpringBootApplication</span>
<span class="directive">public</span> <span class="annotation">@interface</span> HaloApplication {
    <span class="predefined-type">String</span> appId() <span class="keyword">default</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
其中的appId用于设置当前应用在Halo应用的全局唯一ID,如果不设置将获取Spring Application Name作为唯一标识(其实唯一标识不应该具有任何服务注册与发现的含义等,只有全局唯一标识).其实大型互联网系统中都有对应的系统去管理应用的生命周期,需要唯一的标识.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_halo_parent介绍"><a class="anchor" href="#_halo_parent介绍"></a><a class="link" href="#_halo_parent介绍">37. Halo Parent介绍</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="halo-mybatis"><a class="anchor" href="#halo-mybatis"></a><a class="link" href="#halo-mybatis">38. Halo Mybatis</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Halo Mybatis是Halo框架进行选型对Mybatis,Mybatis Plus进行增强的数据库访问层组件</p>
</div>
<div class="sect2">
<h3 id="_halo_mybatis的功能"><a class="anchor" href="#_halo_mybatis的功能"></a><a class="link" href="#_halo_mybatis的功能">38.1. Halo Mybatis的功能</a></h3>
<div class="ulist">
<ul>
<li>
<p>完全兼容MyBatis-Plus，在其基础上增加支持字段加解密、JSON对象字段自动映射等功能。</p>
</li>
<li>
<p>增强MyBatis-Plus通用枚举，自动注册基础扫描包中通用枚举类型。</p>
</li>
<li>
<p>分页插件已默认启用</p>
</li>
<li>
<p>支持配置自动应用到多数据源：包括加解密字段、JSON对象字段、通用枚举字段、分页插件等。</p>
</li>
<li>
<p>对HikariCP数据源的参数进行了优化，简化配置，只需要配置（url、userName、password）三个即可。</p>
</li>
<li>
<p>jdbc默认会把查询结果集全部返回到客户端导致oom,对空where进行拦截判断</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="halo-mybatis-hikariCP"><a class="anchor" href="#halo-mybatis-hikariCP"></a><a class="link" href="#halo-mybatis-hikariCP">38.2. Halo的默认内置HikariCP</a></h3>
<div class="paragraph">
<p>Spring Boot 2.0开始推 <a href="https://github.com/brettwooldridge/HikariCP" target="_blank" rel="noopener">HikariCP</a>,将默认的数据库连接池从tomcat jdbc pool改为了hikariCp 。 HikariCP 在性能和并发方面确实表现不俗（号称最快的连接池）。</p>
</div>
<div class="paragraph">
<p>如果你使用 spring-boot-starter-jdbc 或 spring-boot-starter-data-jpa ，会自动添加对 HikariCP 的依赖，也就是说此时使用 HikariCP 。当然你也可以强制使用其它的连接池技术，可以通过在 application.properties 或 application.yml 中配置 spring.datasource.type 指定。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>必须配置的属性</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">spring</span>:
  <span class="key">datasource</span>:
    <span class="key">url</span>: <span class="string"><span class="content">jdbc:mysql://127.0.0.1:3306/alicedb?characterEncoding=UTF-8&amp;useSSL=false</span></span>
    <span class="key">username</span>: <span class="string"><span class="content">用户名</span></span>
    <span class="key">password</span>: <span class="string"><span class="content">密码</span></span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
对HikariCP数据源的参数进行了优化，简化配置，只需要配置（url、userName、password）三个即可
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>无需配置的属性</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  datasource:
    url: jdbc:mysql://127.0.0.1:3306/alicedb?characterEncoding=UTF-8&amp;useSSL=false
    username: 用户名
    password: 密码
    type: com.zaxxer.hikari.HikariDataSource  #<b class="conum">(1)</b>
    driver-class-name: com.mysql.jdbc.Driver  #<b class="conum">(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Spring Boot 2.x默认内置数据库连接池为hikariCp,因此无需配置，如果是其它数据连接池需要配置</p>
</li>
<li>
<p>无需设置Spring Boot根据数据库连接的URL可以判断出对应的数据库连接驱动的Class Name</p>
<div class="ulist">
<ul>
<li>
<p>可以定制属性</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">spring</span>:
  <span class="key">datasource</span>:
    <span class="key">url</span>: <span class="string"><span class="content">jdbc:mysql://127.0.0.1:3306/alicedb?characterEncoding=UTF-8&amp;useSSL=false</span></span>
    <span class="key">username</span>: <span class="string"><span class="content">用户名</span></span>
    <span class="key">password</span>: <span class="string"><span class="content">密码</span></span>
    <span class="key">hikari</span>:
      <span class="key">auto-commit</span>: <span class="string"><span class="content">true </span></span>#<b class="conum">(1)</b>
      <span class="key">connection-test-query</span>: <span class="string"><span class="content">SELECT 1  </span></span>#<b class="conum">(2)</b>
      <span class="key">connection-timeout</span>: <span class="string"><span class="content">30000 </span></span>#<b class="conum">(3)</b>
      <span class="key">idle-timeout</span>: <span class="string"><span class="content">180000  </span></span>#<b class="conum">(4)</b>
      <span class="key">max-lifetime</span>: <span class="string"><span class="content">1800000 </span></span>#<b class="conum">(5)</b>
      <span class="key">maximum-pool-size</span>: <span class="string"><span class="content">10 </span></span>#<b class="conum">(6)</b>
      <span class="key">minimum-idle</span>: <span class="string"><span class="content">5    </span></span>#<b class="conum">(7)</b>
      <span class="key">pool-name</span>: <span class="string"><span class="content">MyHikariCP </span></span>#<b class="conum">(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>此属性控制从池返回的连接的默认自动提交行为,默认值：true</p>
</li>
<li>
<p>连接测试的sql</p>
</li>
<li>
<p>数据库连接超时时间,默认30秒，即30000</p>
</li>
<li>
<p>空闲连接存活最大时间，默认600000（10分钟）</p>
</li>
<li>
<p>此属性控制池中连接的最长生命周期，值0表示无限生命周期，默认1800000即30分钟</p>
</li>
<li>
<p>连接池最大连接数，默认是10</p>
</li>
<li>
<p>最小空闲连接数量</p>
</li>
<li>
<p>连接池Name</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_查看hikaricp默认配置"><a class="anchor" href="#_查看hikaricp默认配置"></a><a class="link" href="#_查看hikaricp默认配置">38.2.1. 查看HikariCP默认配置</a></h4>
<div class="paragraph">
<p>HikariCP的主要配置参数是在 com.zaxxer.hikari.HikariConfig中初始化的，部分参数是在 com.zaxxer.hikari.pool.PoolBase 中初始化的。
Spring Boot在org.springframework.boot.autoconfigure.jdbc.DataSourceConfiguration.java中封装了HikariCP需要的基本配置。Spring Boot对hikariCP的配置封装如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/ds/ds-h.png" alt="ds h">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_halo中hikaricp的配置"><a class="anchor" href="#_halo中hikaricp的配置"></a><a class="link" href="#_halo中hikaricp的配置">38.2.2. Halo中HikariCP的配置</a></h4>
<div class="paragraph">
<p>Halo Mybatis基于Spring Boot进行扩展增强，因此HikariCP连接池及其在Spring Boot中的配置和官方保持一致，如下表格所示:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. HikariCP连接池及其在Spring Boot中的配置</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">配置项</th>
<th class="tableblock halign-left valign-top">描述</th>
<th class="tableblock halign-left valign-top">构造器默认值</th>
<th class="tableblock halign-left valign-top">默认配置validate之后的值</th>
<th class="tableblock halign-left valign-top">validate重置</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">autoCommit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">自动提交从池中返回的连接</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connectionTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">等待来自池的连接的最大毫秒数</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SECONDS.toMillis(30) = 30000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">如果小于250毫秒，则被重置回30秒</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">idleTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">连接允许在池中闲置的最长时间</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MINUTES.toMillis(10) = 600000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">600000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">如果idleTimeout+1秒&gt;maxLifetime 且 maxLifetime 0，则会被重置为0（代表永远不会退出）；如果idleTimeout!=0且小于10秒，则会被重置为10秒</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxLifetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">池中连接最长生命周期</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MINUTES.toMillis(30) = 1800000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1800000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">如果不等于0且小于30秒则会被重置回30分钟</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connectionTestQuery</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">如果您的驱动程序支持JDBC4，我们强烈建议您不要设置此属性</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">minimumIdle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">池中维护的最小空闲连接数</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">minIdle&lt;0或者minIdle&gt;maxPoolSize,则被重置为maxPoolSize</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maximumPoolSize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">池中最大连接数，包括闲置和使用中的连接</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">如果maxPoolSize小于1，则会被重置。当minIdle&#8656;0被重置为DEFAULT_POOL_SIZE则为10;如果minIdle&gt;0则重置为minIdle的值</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">metricRegistry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">该属性允许您指定一个 Codahale / Dropwizard MetricRegistry 的实例，供池使用以记录各种指标</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">healthCheckRegistry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">该属性允许您指定池使用的Codahale / Dropwizard HealthCheckRegistry的实例来报告当前健康信息</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">poolName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">连接池的用户定义名称，主要出现在日志记录和JMX管理控制台中以识别池和池配置</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HikariPool-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">initializationFailTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">如果池无法成功初始化连接，则此属性控制池是否将fail fast</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">isolateInternalQueries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">是否在其自己的事务中隔离内部池查询，例如连接活动测试</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowPoolSuspension</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">控制池是否可以通过JMX暂停和恢复</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">readOnly</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">从池中获取的连接是否默认处于只读模式</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">registerMbeans</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">是否注册JMX管理Bean（MBeans）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">catalog</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">为支持 catalog 概念的数据库设置默认 catalog</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">driver default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connectionInitSql</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">该属性设置一个SQL语句，在将每个新连接创建后，将其添加到池中之前执行该语句。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">driverClassName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HikariCP将尝试通过仅基于jdbcUrl的DriverManager解析驱动程序，但对于一些较旧的驱动程序，还必须指定driverClassName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactionIsolation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">控制从池返回的连接的默认事务隔离级别</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">alidationTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">连接将被测试活动的最大时间量</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SECONDS.toMillis(5) = 5000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">如果小于250毫秒，则会被重置回5秒</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">leakDetectionThreshold</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">记录消息之前连接可能离开池的时间量，表示可能的连接泄漏</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">如果大于0且不是单元测试，则进一步判断：(leakDetectionThreshold &lt; SECONDS.toMillis(2) or (leakDetectionThreshold &gt; maxLifetime &amp;&amp; maxLifetime &gt; 0)，会被重置为0 . 即如果要生效则必须&gt;0，而且不能小于2秒，而且当maxLifetime &gt; 0时不能大于maxLifetime</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dataSource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">这个属性允许你直接设置数据源的实例被池包装，而不是让HikariCP通过反射来构造它</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">schema</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">该属性为支持模式概念的数据库设置默认模式</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">driver default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">threadFactory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">此属性允许您设置将用于创建池使用的所有线程的java.util.concurrent.ThreadFactory的实例。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">scheduledExecutor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">此属性允许您设置将用于各种内部计划任务的java.util.concurrent.ScheduledExecutorService实例</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="halo-mybatis-hikariCP-multi"><a class="anchor" href="#halo-mybatis-hikariCP-multi"></a><a class="link" href="#halo-mybatis-hikariCP-multi">38.3. HikariCP多数据源配置</a></h3>
<div class="paragraph">
<p>Spring Boot中的数据源自动装配方式适用于单数据源，对于多数源的配置，可以参考 <a href="https://docs.spring.io/spring-boot/docs/2.0.8.RELEASE/reference/htmlsingle/#howto-two-datasources">SpringBoot Configure Two DataSources</a>。</p>
</div>
<div class="paragraph">
<p>Halo集成了Mybatis Plus，在配置多数据源时，需要将Mybatis Plus和数据源进行集成。</p>
</div>
<div class="paragraph">
<p>由于Halo Flow管理<a href="#halo-flow-multi-tx">流程事务</a>的需要，在配置数据源的同时，需提供对应数据源的事务管理器。</p>
</div>
<div class="paragraph">
<p>双数据源配置示例
Java：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Configuration</span>
<span class="annotation">@MapperScan</span>(basePackages = <span class="string"><span class="delimiter">&quot;</span><span class="content">org.xujin.defensor.mybatis2.mapper.halo</span><span class="delimiter">&quot;</span></span>, sqlSessionFactoryRef = <span class="string"><span class="delimiter">&quot;</span><span class="content">haloSqlSessionFactory</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@MapperScan</span>(basePackages = <span class="string"><span class="delimiter">&quot;</span><span class="content">org.xujin.defensor.mybatis2.mapper.forge</span><span class="delimiter">&quot;</span></span>, sqlSessionFactoryRef = <span class="string"><span class="delimiter">&quot;</span><span class="content">forgeSqlSessionFactory</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">DaoConfig</span> {

    <span class="comment">/**
     * halo datasource begin
     */</span>
    <span class="annotation">@Primary</span>
    <span class="annotation">@Bean</span>
    <span class="annotation">@ConfigurationProperties</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">spring.datasource.halo</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> DataSourceProperties haloDataSourceProperties() {
        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProperties();
    }

    <span class="annotation">@Primary</span>
    <span class="annotation">@Bean</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">haloDataSource</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@ConfigurationProperties</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">spring.datasource.halo.hikari</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">DataSource</span> tradeDataSource() {
        <span class="keyword">return</span> haloDataSourceProperties().initializeDataSourceBuilder().type(HikariDataSource.class).build();
    }

    <span class="annotation">@Primary</span>
    <span class="annotation">@Bean</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">haloTxManager</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> PlatformTransactionManager tradeTxManager(<span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">haloDataSource</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">DataSource</span> dataSource) {
        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource);
    }

    <span class="annotation">@Primary</span>
    <span class="annotation">@Bean</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">haloSqlSessionFactory</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> SqlSessionFactory tradeSqlSessionFactory(<span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">haloDataSource</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">DataSource</span> dataSource) <span class="directive">throws</span> <span class="exception">Exception</span> {
        MybatisSqlSessionFactoryBean sqlSessionFactoryBean = <span class="keyword">new</span> MybatisSqlSessionFactoryBean();
        sqlSessionFactoryBean.setDataSource(dataSource);
        <span class="comment">// 需要Mybatis Mapper xml配置时添加</span>
        sqlSessionFactoryBean.setMapperLocations(<span class="keyword">new</span> PathMatchingResourcePatternResolver().getResources(<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:mapper/halo/*Mapper.xml</span><span class="delimiter">&quot;</span></span>));
        <span class="keyword">return</span> sqlSessionFactoryBean.getObject();
    }

    <span class="comment">/**
     * forge datasource begin
     */</span>
    <span class="annotation">@Bean</span>
    <span class="annotation">@ConfigurationProperties</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">spring.datasource.forge</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> DataSourceProperties forgeDataSourceProperties() {
        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProperties();
    }

    <span class="annotation">@Bean</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">forgeDataSource</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@ConfigurationProperties</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">spring.datasource.forge.hikari</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">DataSource</span> forgeDataSource() {
        <span class="keyword">return</span> forgeDataSourceProperties().initializeDataSourceBuilder().type(HikariDataSource.class).build();
    }

    <span class="annotation">@Bean</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">forgeTxManager</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> PlatformTransactionManager forgeTxManager(<span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">forgeDataSource</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">DataSource</span> dataSource) {
        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource);
    }

    <span class="annotation">@Bean</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">forgeSqlSessionFactory</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> SqlSessionFactory forgeSqlSessionFactory(<span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">forgeDataSource</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">DataSource</span> dataSource) <span class="directive">throws</span> <span class="exception">Exception</span> {
        MybatisSqlSessionFactoryBean sqlSessionFactoryBean = <span class="keyword">new</span> MybatisSqlSessionFactoryBean();
        sqlSessionFactoryBean.setDataSource(dataSource);
        <span class="comment">// 需要Mybatis Mapper xml配置时添加</span>
        sqlSessionFactoryBean.setMapperLocations(<span class="keyword">new</span> PathMatchingResourcePatternResolver().getResources(<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:mapper/forge/*Mapper.xml</span><span class="delimiter">&quot;</span></span>));
        <span class="keyword">return</span> sqlSessionFactoryBean.getObject();
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>application.yml：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">spring</span>:
  <span class="key">datasource</span>:
    <span class="key">halo</span>:
      <span class="key">url</span>: <span class="string"><span class="content">jdbc:mysql://***</span></span>
      <span class="key">username</span>: <span class="error">***</span>
      <span class="key">password</span>: <span class="error">***</span>
      <span class="key">hikari</span>:
        <span class="key">maximum-pool-size</span>: <span class="string"><span class="content">20</span></span>
        <span class="key">minimum-idle</span>: <span class="string"><span class="content">10</span></span>
    <span class="key">forge</span>:
      <span class="key">url</span>: <span class="string"><span class="content">jdbc:mysql://***</span></span>
      <span class="key">username</span>: <span class="error">***</span>
      <span class="key">password</span>: <span class="error">***</span>
      <span class="key">hikari</span>:
        <span class="key">maximum-pool-size</span>: <span class="string"><span class="content">20</span></span>
        <span class="key">minimum-idle</span>: <span class="string"><span class="content">10</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>上面示例中，配置了两个数据源：trade、forge，并将数据源与Mybatis Plus进行集成，同时为每个数据源配置了对应的事务管理器。</p>
</div>
</div>
<div class="sect2">
<h3 id="_halo提供的halobasemap"><a class="anchor" href="#_halo提供的halobasemap"></a><a class="link" href="#_halo提供的halobasemap">38.4. Halo提供的HaloBaseMap</a></h3>
<div class="paragraph">
<p>HaloBaseMapper继承了com.baomidou.mybatisplus.core.mapper.BaseMapper,支持Mybatis分页查询支持传递Map,
具体的扩展代码如下所示</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">HaloBaseMapper</span>&lt;T&gt; <span class="directive">extends</span> com.baomidou.mybatisplus.core.mapper.BaseMapper&lt;T&gt; {

    <span class="comment">/**
     * 精确分页查询
     *
     * @param page：分页查询对象
     * @param param: key须是数据库字段，value是比较值
     * @return
     */</span>
    <span class="keyword">default</span> Page&lt;T&gt; selectPageAccurate(Page&lt;T&gt; page, <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; param) {
        <span class="keyword">return</span> selectPage(page, Wrappers.&lt;T&gt;query().allEq(param));
    }

    <span class="comment">/**
     * 精确总数查询
     *
     * @param param: key须是数据库字段，value是比较值
     * @return
     */</span>
    <span class="keyword">default</span> <span class="predefined-type">Integer</span> selectCountAccurate(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; param) {
        <span class="keyword">return</span> selectCount(Wrappers.&lt;T&gt;query().allEq(param));
    }

    <span class="comment">/**
     * 模糊分页查询
     *
     * @param page：分页查询对象
     * @param param: key须是数据库字段，value是比较值
     * @return
     */</span>
    <span class="keyword">default</span> Page&lt;T&gt; selectPageBlurry(Page&lt;T&gt; page, <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; param) {
        QueryWrapper&lt;T&gt; query = Wrappers.&lt;T&gt;query();
        <span class="keyword">if</span> (<span class="predefined-constant">null</span> != param) {
            param.forEach((k, v) -&gt; {
                query.like(k, v);
            });
        }
        <span class="keyword">return</span> selectPage(page, query);
    }

    <span class="comment">/**
     * 模糊总数查询
     *
     * @param param: key须是数据库字段，value是比较值
     * @return
     */</span>
    <span class="keyword">default</span> <span class="predefined-type">Integer</span> selectCountBlurry(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; param) {
        QueryWrapper&lt;T&gt; query = Wrappers.&lt;T&gt;query();
        <span class="keyword">if</span> (<span class="predefined-constant">null</span> != param) {
            param.forEach((k, v) -&gt; {
                query.like(k, v);
            });
        }
        <span class="keyword">return</span> selectCount(query);
    }

    <span class="comment">/**
     * 内部使用方法 强转Ipage对象
     *
     * @param page
     * @param queryWrapper
     * @return
     */</span>
    <span class="keyword">default</span> Page&lt;T&gt; selectPage(Page&lt;T&gt; page, <span class="annotation">@Param</span>(Constants.WRAPPER) Wrapper&lt;T&gt; queryWrapper) {
        <span class="keyword">return</span> (Page&lt;T&gt;)selectPage((IPage&lt;T&gt;)page, queryWrapper);
    }

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_halo_mybatis的使用"><a class="anchor" href="#_halo_mybatis的使用"></a><a class="link" href="#_halo_mybatis的使用">38.5. Halo Mybatis的使用</a></h3>
<div class="sect3">
<h4 id="_maven引入"><a class="anchor" href="#_maven引入"></a><a class="link" href="#_maven引入">38.5.1. Maven引入</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>引入Halo-MyBatis依赖。有两种方式</p>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在需要使用的工程模块中,引入 mybatis 模块即可</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-mybatis<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_演示代码"><a class="anchor" href="#_演示代码"></a><a class="link" href="#_演示代码">38.5.2. 演示代码</a></h4>
<div class="ulist">
<ul>
<li>
<p>数据源配置</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">spring</span>:
  <span class="key">datasource</span>:
    <span class="key">type</span>: <span class="string"><span class="content">com.alibaba.druid.pool.DruidDataSource</span></span>
    <span class="key">platform</span>: <span class="string"><span class="content">mysql</span></span>
    <span class="key">url</span>: <span class="string"><span class="content">jdbc:mysql://localhost:3306/test?useSSL=false&amp;characterEncoding=utf8</span></span>
    <span class="key">username</span>: <span class="string"><span class="content">root</span></span>
    <span class="key">password</span>: <span class="string"><span class="content">root</span></span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>实体类</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@TableName</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">city</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Data</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">City</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">long</span> serialVersionUID = <span class="integer">1L</span>;

    <span class="annotation">@TableId</span>(type=AUTO)
    <span class="directive">private</span> <span class="predefined-type">Long</span> id;

    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@TableField</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">state</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> EncryptedColumn state;

    <span class="annotation">@TableField</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">country</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> country;

 }</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
说明:如果表字段采用了例如：key, value, order作为字段,会报错org.springframework.jdbc.BadSqlGrammarException。此时需要处理关键字为‘关键字’，
   示例:@TableField(value=&#8220;key&#8221;)
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Mapper</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Mapper</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">CityMapper</span> <span class="directive">extends</span> MyBaseMapper&lt;City&gt; {

    <span class="annotation">@Select</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">select count(0) from city</span><span class="delimiter">&quot;</span></span>)
    <span class="type">int</span> test();
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Service</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Service</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CityService</span> {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> CityMapper cityMapper;

    <span class="comment">/***
     * @Description: 创建新城市。并返回插入数据的条数
     * @Param: [name]
     * @Return: int
     */</span>
    <span class="directive">public</span> <span class="type">int</span> createCity(<span class="predefined-type">String</span> name) {
        City newCity = <span class="keyword">new</span> City();
        newCity.setName(name);
        <span class="keyword">return</span> cityMapper.insert(newCity);
    }


    <span class="comment">/***
     * @Description: 创建新城市。返回city实体
     * @Param: [name]
     * @Return: boolean
     */</span>
    <span class="directive">public</span> City createCity2(<span class="predefined-type">String</span> name) {
        City newCity = <span class="keyword">new</span> City();
        newCity.setName(name);
        <span class="keyword">if</span> (cityMapper.insert(newCity)&gt;<span class="integer">0</span>) {
            <span class="keyword">return</span> newCity;
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        }
    }

    <span class="comment">/***
     * @Description: 根据id更新城市名称，返回更新成功的条数
     * @Param: [id, newName]
     * @Return: int
     */</span>
    <span class="directive">public</span> <span class="type">int</span> updateCity(<span class="type">long</span> id, <span class="predefined-type">String</span> newName) {
        City cityUpdate = <span class="keyword">new</span> City();
        cityUpdate.setId(id);
        cityUpdate.setName(newName);
        <span class="keyword">return</span> cityMapper.updateById(cityUpdate);
    }


    <span class="comment">/***
     * @Description: 根据名称查询城市
     * @Param: [name]
     */</span>
    <span class="directive">public</span> City findCityByName(<span class="predefined-type">String</span> name) {
        <span class="keyword">return</span> cityMapper.selectOne(Wrappers.&lt;City&gt;query().eq(getFieldName(City::getName), name));
    }

    <span class="comment">/***
     * @Description: 根据名称模糊查询
     * @Param: [name]
     */</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;City&gt; findManyCityByNameLike(<span class="predefined-type">String</span> name) {
        <span class="keyword">return</span> cityMapper.selectList(Wrappers.&lt;City&gt;query().like(getFieldName(City::getName), name));
    }
    <span class="comment">/***
     * @Description: 根据名称做分页排序查询，ascs是升序排列的字段。page=1 size=10 表示查询第一页，每页10条数据
     * @Param: [name, page, size, ascs]
     * @Return: com.baomidou.mybatisplus.extension.plugins.pagination.Page
     */</span>
    <span class="directive">public</span> Page findPagedCityByNameAsc(<span class="predefined-type">String</span> name, <span class="type">int</span> page, <span class="type">int</span> size, <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; ascs) {
        Page pageRequest = <span class="keyword">new</span> Page(page, size);
        pageRequest.setAscs(ascs);
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; param=<span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
        param.put(getFieldName(City::getName),name);
        <span class="keyword">return</span> cityMapper.selectPageAccurate(pageRequest,param);
    }

    <span class="comment">/***
     * @Description: 根据名称做分页排序查询(用like做模糊查询)，ascs是升序排列的字段。page=1 size=10 表示查询第一页，每页10条数据
     * @Param: [name, page, size, ascs]
     * @Return: com.baomidou.mybatisplus.extension.plugins.pagination.Page
     */</span>
    <span class="directive">public</span> Page findPagedCityByNameLikeAsc(<span class="predefined-type">String</span> name, <span class="type">int</span> page, <span class="type">int</span> size, <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; ascs) {
        Page pageRequest = <span class="keyword">new</span> Page(page, size);
        pageRequest.setAscs(ascs);
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; param=<span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
        param.put(getFieldName(City::getName),name);
        <span class="keyword">return</span> cityMapper.selectPageBlurry(pageRequest,param);
    }

    <span class="comment">/***
     * @Description: 根据ID删除
     * @Param: [id]
     * @Return: int
     */</span>
    <span class="directive">public</span> <span class="type">int</span> deleteById(<span class="type">long</span> id) {
        <span class="keyword">return</span> cityMapper.deleteById(id);
    }

    <span class="comment">/***
     * @Description: 根据id批量删除
     * @Param: [ids]
     * @Return: int
     */</span>
    <span class="directive">public</span> <span class="type">int</span> deleteByIds(<span class="predefined-type">List</span>&lt;<span class="predefined-type">Long</span>&gt; ids) {
        <span class="keyword">return</span> cityMapper.deleteBatchIds(ids);
    }

    <span class="comment">/***
     * @Description: 根据名称删除 ，返回删除的条数
     * @Param: [name]
     * @Return: int
     */</span>
    <span class="directive">public</span> <span class="type">int</span> deleteByName(<span class="predefined-type">String</span> name) {
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; columnMap = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
        columnMap.put(getFieldName(City::getName), name);
        <span class="keyword">return</span> cityMapper.deleteByMap(columnMap);
    }

    <span class="comment">/***
    * @Description: 根据name更新country，先查询出ID，然后根据ID进行更新
    * @Param: [name, country]
    * @Return: boolean
    */</span>
    <span class="directive">public</span> <span class="type">int</span> updateCountryByName(<span class="predefined-type">String</span> name, <span class="predefined-type">String</span> country) {
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>,<span class="predefined-type">Object</span>&gt; param=<span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
        param.put(getFieldName(City::getName),name);
        <span class="keyword">return</span> cityMapper.updateBatchById(cityMapper
                .selectByMap(param)
                .stream()
                .map(city -&gt; {
                    City updateCity = <span class="keyword">new</span> City();
                    updateCity.setId(city.getId());
                    updateCity.setCountry(country);
                    <span class="keyword">return</span> updateCity;
                })
                .collect(Collectors.toList()));
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_详细功能"><a class="anchor" href="#_详细功能"></a><a class="link" href="#_详细功能">38.6. 详细功能</a></h3>

</div>
<div class="sect2">
<h3 id="_字段加密"><a class="anchor" href="#_字段加密"></a><a class="link" href="#_字段加密">38.7. 字段加密</a></h3>
<div class="paragraph">
<p>利用自定义类型来实现字段的自动加解密。</p>
</div>
<div class="sect3">
<h4 id="_配置"><a class="anchor" href="#_配置"></a><a class="link" href="#_配置">38.7.1. 配置</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>mybatis.encrypt配置加解密用的密码和盐</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
 <span class="key">mybatis</span>:
  <span class="key">encrypt</span>:
    <span class="key">password</span>: <span class="string"><span class="content">password</span></span>
    <span class="key">salt</span>: <span class="string"><span class="content">salt</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_代码"><a class="anchor" href="#_代码"></a><a class="link" href="#_代码">38.7.2. 代码</a></h4>
<div class="paragraph">
<p>通过在实体中自定义类型来实现，比如下面代码表示state字段存储到数据库时加密的。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@TableField</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">state</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> EncryptedColumn state; <span class="comment">// 加密字段</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>测试用例</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> testEncrypted(){
        City city = <span class="keyword">new</span> City();
        city.setName(<span class="string"><span class="delimiter">&quot;</span><span class="content">成都</span><span class="delimiter">&quot;</span></span>);
        city.setState(EncryptedColumn.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">四川</span><span class="delimiter">&quot;</span></span>));
        city.setCountry(<span class="string"><span class="delimiter">&quot;</span><span class="content">中国</span><span class="delimiter">&quot;</span></span>);
        service.save(city);
        <span class="predefined-type">System</span>.out.println(cityMapper.selectById(city.getId()));

        Assert.assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">四川</span><span class="delimiter">&quot;</span></span>,cityMapper.selectById(city.getId()).getState().getValue());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>service.save(city);</code> 产生的SQL是</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">INSERT INTO city  ( name, state, country)  VALUES  ( '成都', '45ffd17bf74bad972a6bc45dc5c949fedacd773b5d4205f9888129d597fa6b47ae9c01054d4f', '中国')</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>System.out.println(cityMapper.selectById(city.getId()));</code> 输出的结果是</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">City{id=56, name='成都', state=EncryptedColumn{value='四川'}, country='中国'}</code></pre>
</div>
</div>
<div class="paragraph">
<p>可以看到存储 ("四川") 时已经被加密，通过mapper查询出的实体中被解密成功（可通过city.getState().getValue()`获取明文）。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_json对象字段"><a class="anchor" href="#_json对象字段"></a><a class="link" href="#_json对象字段">38.8. JSON对象字段</a></h3>
<div class="paragraph">
<p>支持自定义Java对象与数据表中字符串、JSON（MySQL&gt;=5.7.8）字段之间的相互映射。</p>
</div>
<div class="paragraph">
<p>由于Mybatis限制，目前只支持JSON对象类型，不支持JSON数组类型（对应于Java中Array、List等）。</p>
</div>
<div class="sect3">
<h4 id="_配置_2"><a class="anchor" href="#_配置_2"></a><a class="link" href="#_配置_2">38.8.1. 配置</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>根据需要，定义对象。</p>
</li>
<li>
<p>在由@TableName <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
注解的DataObject中，使用@TableJSONField <sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>声明需要使用JSON存储的字段。</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
@TableJSONField只有声明在由@TableName注解的DataObject中才生效。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_代码_2"><a class="anchor" href="#_代码_2"></a><a class="link" href="#_代码_2">38.8.2. 代码</a></h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Data</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AddressInfo</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> province;

    <span class="directive">private</span> <span class="predefined-type">String</span> city;

    <span class="directive">private</span> <span class="predefined-type">String</span> street;

    <span class="directive">private</span> <span class="predefined-type">String</span> houseNum;
}

<span class="annotation">@Data</span>
<span class="annotation">@TableName</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">t_user</span><span class="delimiter">&quot;</span></span>) <span class="comment">//MyBatis Plus提供</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UserDO</span> {

    <span class="annotation">@TableId</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, type = AUTO)
    <span class="directive">private</span> <span class="predefined-type">Long</span> id;

    <span class="annotation">@TableField</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@TableField</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">address</span><span class="delimiter">&quot;</span></span>) <span class="comment">//MyBatis Plus提供</span>
    <span class="annotation">@TableJSONField</span> <span class="comment">// Halo扩展</span>
    <span class="directive">private</span> AddressInfo address;

}

<span class="comment">// 使用</span>
<span class="directive">public</span> <span class="type">void</span> addUser() {
    UserDO userDO = <span class="keyword">new</span> UserDO();
    userDO.setName(<span class="string"><span class="delimiter">&quot;</span><span class="content">halo user</span><span class="delimiter">&quot;</span></span>);

    AddressInfo address = <span class="keyword">new</span> AddressInfo();
    address.setCity(<span class="string"><span class="delimiter">&quot;</span><span class="content">SH</span><span class="delimiter">&quot;</span></span>);
    address.setStreet(<span class="string"><span class="delimiter">&quot;</span><span class="content">HaiLun</span><span class="delimiter">&quot;</span></span>);
    userDO.setAddress(address);

    userMapper.insert(userDO);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_配置选项"><a class="anchor" href="#_配置选项"></a><a class="link" href="#_配置选项">38.8.3. 配置选项</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>halo.mybatis.enable-table-json-field: 是否启动JSON字段映射，默认启用。</p>
</li>
<li>
<p>halo.mybatis.table-json-field-package: 扫描包，默认扫描@SpringBooApplication所在包。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>示例：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">halo.mybatis.enable-table-json-field: <span class="predefined-constant">true</span>
halo.mybatis.table-json-field-<span class="keyword">package</span>: <span class="namespace">org.xujin.halo.admin.db.dataobject</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_通用枚举字段"><a class="anchor" href="#_通用枚举字段"></a><a class="link" href="#_通用枚举字段">38.9. 通用枚举字段</a></h3>
<div class="paragraph">
<p>通用枚举由MyBatis Plus提供，Halo对其进行增强，支持自动扫描、多数据源自动适配等。</p>
</div>
<div class="sect3">
<h4 id="_配置_3"><a class="anchor" href="#_配置_3"></a><a class="link" href="#_配置_3">38.9.1. 配置</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>根据需要，定义枚举对象。
该枚举对象需实现IEnum <sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>接口，或者使用@EnumValue <sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup>注解，具体使用方式，请参考 <a href="https://mp.baomidou.com/guide/enum.html#%25E4%25B8%2580%25E3%2580%2581jackson">MyBatis Plus 通用枚举</a></p>
</li>
<li>
<p>在DataObject中，使用该枚举类型声明字段。</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_代码_3"><a class="anchor" href="#_代码_3"></a><a class="link" href="#_代码_3">38.9.2. 代码</a></h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">enum</span> UserStatus {

    VALID((<span class="type">byte</span>) <span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">有效</span><span class="delimiter">&quot;</span></span>),
    INVALID((<span class="type">byte</span>) -<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">无效</span><span class="delimiter">&quot;</span></span>);

    UserStatus(<span class="predefined-type">Byte</span> value, <span class="predefined-type">String</span> desc) {
        <span class="local-variable">this</span>.value = value;
        <span class="local-variable">this</span>.desc = desc;
    }

    <span class="annotation">@Getter</span>
    <span class="annotation">@EnumValue</span> <span class="comment">// 由MyBatis Plus提供</span>
    <span class="directive">private</span> <span class="predefined-type">Byte</span> value;

    <span class="annotation">@Getter</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> desc;

}

<span class="annotation">@Data</span>
<span class="annotation">@TableName</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">t_user</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">UserDO</span> {

    <span class="annotation">@TableId</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, type = AUTO)
    <span class="directive">private</span> <span class="predefined-type">Long</span> id;

    <span class="annotation">@TableField</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@TableField</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">`status`</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> UserStatus status;

}

<span class="comment">// 使用</span>
<span class="directive">public</span> <span class="type">void</span> addUser() {
    UserDO userDO = <span class="keyword">new</span> UserDO();
    userDO.setName(<span class="string"><span class="delimiter">&quot;</span><span class="content">halo user</span><span class="delimiter">&quot;</span></span>);

    userDO.setStatus(UserStatus.VALID);

    userMapper.insert(userDO);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_配置选项_2"><a class="anchor" href="#_配置选项_2"></a><a class="link" href="#_配置选项_2">38.9.3. 配置选项</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>halo.mybatis.enable-table-enum-field: 是否启动通用枚举字段映射，默认启用。</p>
</li>
<li>
<p>mybatis-plus.type-enums-package: 扫描包，默认扫描@SpringBooApplication所在包。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>示例：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">halo.mybatis.enable-table-<span class="type">enum</span>-field: <span class="predefined-constant">true</span>
mybatis-plus.type-enums-<span class="keyword">package</span>: <span class="namespace">org.xujin.halo.admin</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mybatis空where_sql拦截"><a class="anchor" href="#_mybatis空where_sql拦截"></a><a class="link" href="#_mybatis空where_sql拦截">38.10. Mybatis空Where SQL拦截</a></h3>
<div class="paragraph">
<p>项目中经常出现因为Mybatis的动态where条件不满足导致实际sql语句的where条件为空,进而查询全表,当数据量比较大的时候,导致OOM的情况。比如当用户表的数据量为4千万时,如果load全表数据量将会导致OOM，如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-mybatis/empty-where-oom.png" alt="empty where oom" width="800">
</div>
<div class="title">Figure 23. 空Where导致OOM</div>
</div>
<div class="paragraph">
<p>Halo Mybatis从1.2.0版本开始将会，增加如下的功能:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>对空Where进行拦截判断</p>
</li>
<li>
<p>并支持开关关闭空where拦截</p>
</li>
<li>
<p>支持白名单设置,即在白名单中Mapper的方法将不会进行拦截</p>
</li>
<li>
<p>支持多数据源进行拦截check</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>开启Halo Mybatis空Where拦截的yml文件的配置如下代码所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">mybatis</span>:
    <span class="comment">#empty-where-intercept: false  </span># <b class="conum">(1)</b>
    <span class="key">empty-where-white-list</span>:
      - <span class="string"><span class="content">org.xujin.halo.admin.tunnel.db.dao.AppMapper.queryHaloVersionChart </span></span># <b class="conum">(2)</b>
      - <span class="string"><span class="content">org.xujin.halo.admin.tunnel.db.dao.AppMapper.queryApp  </span></span># <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>halo.mybatis.empty-where-intercept默认为true,即开启空Where条件判断,当为false时关闭空where拦截判断</p>
</li>
<li>
<p>表示配置白名单全限定Mapper类型.方法名</p>
</li>
<li>
<p>表示配置白名单全限定Mapper类型.方法名</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
不建议主动关闭空where拦截判断,如果需要设置白名单，可以根据配置设置白名单,白名单中的Mapper的方法将不会被拦截
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_mybatis与tk_pagehelper"><a class="anchor" href="#_mybatis与tk_pagehelper"></a><a class="link" href="#_mybatis与tk_pagehelper">38.11. Mybatis与tK PageHelper</a></h3>
<div class="paragraph">
<p>Halo Mybatis封装的是Mybatis Plus,有些老项目中用了tk的PageHelper,支持混用。Halo Mybatis自带分页,不建议集成其它的分页组件。</p>
</div>
</div>
<div class="sect2">
<h3 id="_mybatis_plus开启乐观锁"><a class="anchor" href="#_mybatis_plus开启乐观锁"></a><a class="link" href="#_mybatis_plus开启乐观锁">38.12. Mybatis Plus开启乐观锁</a></h3>
<div class="paragraph">
<p>乐观锁使用场景,当要更新一条记录的时候，希望这条记录没有被别人更新时使用。</p>
</div>
<div class="paragraph">
<p>乐观锁实现方式：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>取出记录时，获取当前version</p>
</li>
<li>
<p>更新时，带上这个version</p>
</li>
<li>
<p>执行更新时， set version = newVersion where version = oldVersion</p>
</li>
<li>
<p>如果version不对，就更新失败</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Halo Mybatis开启乐观锁yml文件的配置如下代码所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">mybatis</span>:
    <span class="key">enableOptimistLock</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>注解实体字段 @Version</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Version</span>
<span class="directive">private</span> <span class="predefined-type">Integer</span> version;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
更多内容可以访问:https://mp.baomidou.com/guide/optimistic-locker-plugin.html
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-web"><a class="anchor" href="#halo-web"></a><a class="link" href="#halo-web">39. Halo Web</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="halo-web-function"><a class="anchor" href="#halo-web-function"></a><a class="link" href="#halo-web-function">39.1. Halo Web功能</a></h3>
<div class="ulist">
<ul>
<li>
<p>统一接口返回，返回码可根据应用情况扩展</p>
</li>
<li>
<p>全局异常处理，可配置异常钉钉提醒</p>
</li>
<li>
<p>接口日志打印，可配置日志是否脱敏、扩展脱敏规则</p>
</li>
<li>
<p>接口版本控制，自动兼容接口版本</p>
</li>
<li>
<p>支持跨域功能，默认关闭，需要时开启</p>
</li>
<li>
<p>无需引入Spring web相关的jar</p>
</li>
<li>
<p>使用@RestPathController注解取代@RestController和@RequestMapping</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="halo-web-use"><a class="anchor" href="#halo-web-use"></a><a class="link" href="#halo-web-use">39.2. Halo Web的使用</a></h3>
<div class="sect3">
<h4 id="halo-web-maven"><a class="anchor" href="#halo-web-maven"></a><a class="link" href="#halo-web-maven">39.2.1. Maven引入</a></h4>
<div class="paragraph">
<p>1.引入Halo-Web依赖。有两种方式</p>
</div>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"> <span class="tag">&lt;parent&gt;</span>
<span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
<span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
 <span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>2.在需要使用的工程模块中,引入 web 模块即可</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-web<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="halo-web-config"><a class="anchor" href="#halo-web-config"></a><a class="link" href="#halo-web-config">39.2.2. 配置使用</a></h4>
<div class="paragraph">
<p>Halo Web的配置如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">web</span>:
    <span class="key">logMark</span>: <span class="string"><span class="content">defensor-web</span></span>
    <span class="key">dingTalkWebHook</span>: <span class="string"><span class="content">https://oapi.dingtalk.com/robot/send?access_token=xxx</span></span>
    <span class="key">dingTalkMessageErrorMsgCodes</span>: <span class="string"><span class="content">400,500</span></span>
    <span class="key">dingTalkAtMobiles</span>: <span class="string"><span class="content">1992113xxxx</span></span>
    <span class="key">paramValidErrorMsgCode</span>: <span class="string"><span class="content">400</span></span>
    <span class="key">paramValidErrorMsgContent</span>: <span class="string"><span class="content">参数校验失败</span></span>
    <span class="key">bindErrorMsgCode</span>: <span class="string"><span class="content">400</span></span>
    <span class="key">bindErrorMsgContent</span>: <span class="string"><span class="content">参数绑定错误</span></span>
    <span class="key">sqlErrorMsgCode</span>: <span class="string"><span class="content">500</span></span>
    <span class="key">sqlErrorMsgContent</span>: <span class="string"><span class="content">sql错误</span></span>
    <span class="key">systemErrorMsgCode</span>: <span class="string"><span class="content">500</span></span>
    <span class="key">systemErrorMsgContent</span>: <span class="string"><span class="content">系统错误</span></span>
    <span class="key">logDesensitizationEnabled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">logMobileRegularDesensitizationEnabled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">corsEnabled</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>halo.web.logMark</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>配置接口打印的日志标记，默认值为"CONTROLLER",可配合LogFilter把接口日志输出到指定文件，方便在kibana上查看</p>
</div>
<div class="ulist">
<ul>
<li>
<p>halo.web.dingTalkWebHook\halo.web.dingTalkAtMobiles\halo.web.dingTalkMessageErrorMsgCodes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>异常钉钉提醒相关配置，分别为群机器人url、提醒@人的手机号、需要提醒的错误码。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>halo.web.paramValidErrorMsgCode</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>错误码相关配置，示例的配置为默认配置。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
建议使用标准HTTP状态码，不要使用1、10001这种不标准的状态码。
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>halo.web.logDesensitizationEnabled</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>开启日志脱敏，默认为true。具体的脱敏策略需要和脱敏注解配合使用。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>halo.web.logMobileRegularDesensitizationEnabled</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>开启日志中手机号正则匹配脱敏，默认为true。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
正则表达式匹配手机号脱敏建议不要关闭，接口的入参和返回包含手机号的字段可能会遗漏脱敏注解。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_详细功能_2"><a class="anchor" href="#_详细功能_2"></a><a class="link" href="#_详细功能_2">39.3. 详细功能</a></h3>
<div class="sect3">
<h4 id="_restpathcontroller"><a class="anchor" href="#_restpathcontroller"></a><a class="link" href="#_restpathcontroller">39.3.1. @RestPathController</a></h4>
<div class="ulist">
<ul>
<li>
<p>使用@RestPathController注解取代@RestController和@RequestMapping，
示例代码如下所示:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RestPathController</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/admin/app</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Api</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">应用管理</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">AppController</span> {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> CommandBus commandBus;
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>常规Controller，如下示例代码所示:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RestController</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/admin/app</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Api</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">应用管理</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">AppController</span> {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> CommandBus commandBus;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_接口统一返回"><a class="anchor" href="#_接口统一返回"></a><a class="link" href="#_接口统一返回">39.3.2. 接口统一返回</a></h4>
<div class="listingblock">
<div class="title">使用示例:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PostMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/write-log</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> ResultData&lt;UserOutVO&gt; writeLog(<span class="annotation">@Valid</span> <span class="annotation">@RequestBody</span> TestInVO testInVO) {
    UserOutVO user = <span class="keyword">new</span> UserOutVO();
    user.setUsername(<span class="string"><span class="delimiter">&quot;</span><span class="content">张三</span><span class="delimiter">&quot;</span></span>);
    user.setPassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">123xxx</span><span class="delimiter">&quot;</span></span>);
    user.setEmail(<span class="string"><span class="delimiter">&quot;</span><span class="content">123@qq.com</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> ResultData.success(user);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">接口返回结构示例:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="integer">200</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgCode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgContent</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">张三</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">123xxx</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">123@qq.com</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_跨域处理"><a class="anchor" href="#_跨域处理"></a><a class="link" href="#_跨域处理">39.3.3. 跨域处理</a></h4>
<div class="paragraph">
<p>CORS是一种允许当前域（domain）的资源（比如html/js/web service）被其他域（domain）的脚本请求访问的机制，
通常由于同域安全策略（the same-origin security policy）浏览器会禁止这种跨域请求。</p>
</div>
<div class="paragraph">
<p>Halo Web内置跨域功能,当应用需要跨域时开启跨域即可(默认关闭跨域功能)。YML配置如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
   <span class="key">web</span>:
     <span class="comment"># CORS跨域配置，默认允许跨域</span>
    <span class="key">cors</span>:
      <span class="comment"># 是否启用跨域，默认启用</span>
      <span class="key">enable</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Halo框架内置了跨域的默认配置,如下Java代码所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ConfigurationProperties</span>(prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">halo.web.cros</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">HaloWebCorsProperties</span> {

    <span class="comment">/**
     * 是否启用跨域，默认启用
     */</span>
    <span class="directive">private</span> <span class="type">boolean</span> enable = <span class="predefined-constant">true</span>;

    <span class="comment">/**
     * CORS过滤的路径，默认：/**
     */</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> path = <span class="string"><span class="delimiter">&quot;</span><span class="content">/**</span><span class="delimiter">&quot;</span></span>;

    <span class="comment">/**
     * 允许访问的源
     */</span>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; allowedOrigins = <span class="predefined-type">Collections</span>.singletonList(CorsConfiguration.ALL);

    <span class="comment">/**
     * 允许访问的请求头
     */</span>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; allowedHeaders = <span class="predefined-type">Collections</span>.singletonList(CorsConfiguration.ALL);

    <span class="comment">/**
     * 是否允许发送cookie
     */</span>
    <span class="directive">private</span> <span class="type">boolean</span> allowCredentials = <span class="predefined-constant">true</span>;

    <span class="comment">/**
     * 允许访问的请求方式
     */</span>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; allowedMethods = <span class="predefined-type">Collections</span>.singletonList(CorsConfiguration.ALL);

    <span class="comment">/**
     * 允许响应的头
     */</span>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; exposedHeaders =  <span class="predefined-type">Arrays</span>.asList(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">X-Requested-With</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">accept</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Origin</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Access-Control-Request-Method</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Access-Control-Request-Headers</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">token</span><span class="delimiter">&quot;</span></span>);

    <span class="comment">/**
     * 该响应的有效时间默认为30分钟，在有效时间内，浏览器无须为同一请求再次发起预检请求
     */</span>
    <span class="directive">private</span> <span class="predefined-type">Long</span> maxAge = <span class="integer">1800L</span>;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>一般不需要进行特殊跨域配置,如果需要特殊跨域配置，yml文件配置如下:</p>
</div>
<div class="listingblock">
<div class="title">跨域配置</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
   <span class="key">web</span>:
     <span class="comment"># CORS跨域配置，默认允许跨域</span>
    <span class="key">cors</span>:
      <span class="comment"># 是否启用跨域，默认启用</span>
      <span class="key">enable</span>: <span class="string"><span class="content">true</span></span>
      <span class="comment"># CORS过滤的路径，默认：/**</span>
      <span class="key">path</span>: <span class="string"><span class="content">/**</span></span>
      <span class="comment"># 允许访问的源</span>
      <span class="key">allowed-origins</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="comment"># 允许访问的请求头</span>
      <span class="key">allowed-headers</span>: <span class="string"><span class="content">x-requested-with,content-type,token</span></span>
      <span class="comment"># 是否允许发送cookie</span>
      <span class="key">allow-credentials</span>: <span class="string"><span class="content">true</span></span>
      <span class="comment"># 允许访问的请求方式</span>
      <span class="key">allowed-methods</span>: <span class="string"><span class="content">OPTION,GET,POST</span></span>
      <span class="comment"># 允许响应的头</span>
      <span class="key">exposed-headers</span>: <span class="string"><span class="content">token</span></span>
      <span class="comment"># 该响应的有效时间默认为30分钟，在有效时间内，浏览器无须为同一请求再次发起预检请求</span>
      <span class="key">max-age</span>: <span class="string"><span class="content">1800</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_全局异常"><a class="anchor" href="#_全局异常"></a><a class="link" href="#_全局异常">39.3.4. 全局异常</a></h4>
<div class="paragraph">
<p>全局异常处理是整个应用统一处理异常的地方。项目中只有框架(自己的框架或第三方框架)抛出的异常，业务异常，未知异常三种异常。
业务异常需要统一的处理设置msgCode,msgContent.框架异常和未知异常，由框架统一处理。</p>
</div>
<div class="paragraph">
<p>默认提供5个全局异常拦截</p>
</div>
<div class="listingblock">
<div class="title">异常拦截示例:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ExceptionHandler</span>(MethodArgumentNotValidException.class)

<span class="annotation">@ExceptionHandler</span>(<span class="exception">BindException</span>.class)

<span class="annotation">@ExceptionHandler</span>(<span class="exception">SQLException</span>.class)

<span class="annotation">@ExceptionHandler</span>(BusinessException.class)

<span class="annotation">@ExceptionHandler</span>(<span class="predefined-type">Throwable</span>.class)</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>MethodArgumentNotValidException</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>参数校验相关异常</p>
</div>
<div class="listingblock">
<div class="title">入参定义:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Data</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">TestInVO</span> {

    <span class="annotation">@NotNull</span>(message = <span class="string"><span class="delimiter">&quot;</span><span class="content">name不能为空</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> name;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>当接口入参name属性为null的时候，参数校验失败，全局异常处理会根据当前开发环境显示具体的message或者提示参数错误。</p>
</div>
<div class="listingblock">
<div class="title">异常拦截处理示例:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="error">环</span><span class="error">境</span><span class="error">为</span><span class="error">p</span><span class="error">r</span><span class="error">o</span>
{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="integer">200</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgCode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">400</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgContent</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">参数校验失败</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>
}

<span class="error">环</span><span class="error">境</span><span class="error">为</span><span class="error">d</span><span class="error">e</span><span class="error">v</span><span class="error">\</span><span class="error">f</span><span class="error">a</span><span class="error">t</span><span class="error">\</span><span class="error">u</span><span class="error">a</span><span class="error">t</span><span class="error">，</span><span class="error">会</span><span class="error">显</span><span class="error">示</span><span class="error">具</span><span class="error">体</span><span class="error">的</span><span class="error">参</span><span class="error">数</span><span class="error">错</span><span class="error">误</span><span class="error">m</span><span class="error">e</span><span class="error">s</span><span class="error">s</span><span class="error">a</span><span class="error">g</span><span class="error">e</span><span class="error">，</span><span class="error">方</span><span class="error">便</span><span class="error">定</span><span class="error">位</span><span class="error">问</span><span class="error">题</span>
{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="integer">200</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgCode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">400</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgContent</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">parameter error：name不能为空;</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>BindException</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>msgCode和msgContent可以根据参数halo.web.bindErrorMsgCode和halo.web.bindErrorMsgContent配置</p>
</div>
<div class="listingblock">
<div class="title">springMVC绑定异常:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="integer">200</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgCode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">400</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgContent</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">参数绑定错误</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>SQLException</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>msgCode和msgContent可以根据参数halo.web.sqlErrorMsgCode和halo.web.sqlErrorMsgContent配置</p>
</div>
<div class="listingblock">
<div class="title">SQL异常:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="integer">200</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgCode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgContent</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">sql错误</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>BusinessException</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>自定义的业务异常，自定义业务异常可以通过自定义的返回码枚举来初始化，使用示例如下，</p>
</div>
<div class="listingblock">
<div class="title">自定义返回码枚举，必须实现IResultCode接口:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">enum</span> ResultCodeEnum <span class="directive">implements</span> IResultCode {
    LESSON_CLOSED(<span class="string"><span class="delimiter">&quot;</span><span class="content">211</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">课堂已关闭</span><span class="delimiter">&quot;</span></span>);

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> msgCode;
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> msgContent;
    ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">根据自定义返回码初始化业务异常:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(ResultCodeEnum.LESSON_CLOSED);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">接口返回示例:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="integer">200</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgCode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">211</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgContent</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">课堂已关闭</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Throwable</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">其他异常返回示例:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="integer">200</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgCode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgContent</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">系统错误</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_开启404_not_found_处理"><a class="anchor" href="#_开启404_not_found_处理"></a><a class="link" href="#_开启404_not_found_处理">39.3.5. 开启404 Not Found 处理</a></h4>
<div class="paragraph">
<p>默认情况下，Spring Boot是不会抛出404异常的，所以<strong>@ControllerAdvice</strong>也不能捕获到404异常。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-web/404.png" alt="404" width="800">
</div>
</div>
<div class="paragraph">
<p>但是我们可以通过如下的设置结合全局异常处理器，开启404统一由全局异常处理器处理。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>application.yml文件配置如下:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">spring</span>:
  <span class="key">mvc</span>: <span class="comment"># mvc.throw-exception-if-no-handler-found 和 resources.add-mappings设置 系统统一异常处理</span>
    <span class="key">throw-exception-if-no-handler-found</span>: <span class="string"><span class="content">true</span></span>
  <span class="key">resources</span>:
    <span class="key">add-mappings</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>application.properties配置如下所示:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">spring.mvc.throw-exception-if-no-handler-found=true
spring.resources.add-mappings=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>在Halo框架中，通过如下代码方式统一内置了404的统一处理方式：
代码查看地址: org.xujin.halo.HaloSpringApplicationRunListener.java</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="error">System.setProperty(&quot;spring.mvc.throw-exception-if-no-handler-found&quot;, &quot;true&quot;);</span>
<span class="error">System.setProperty(&quot;spring.resources.add-mappings&quot;, &quot;false&quot;);</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
上面的配置会关闭默认的静态资源路径映射,特别当前后端打包部署一起之后,默认关闭映射会让静态资源访问出现问题。如下图所示:
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-web/404-static.png" alt="404 static" width="800">
</div>
</div>
<div class="paragraph">
<p>但是可以通过扩展WebMvcConfigurer手动配置静态资源路径映射，从而能正常访问静态资源。</p>
</div>
<div class="paragraph">
<p>为了方便大家使用,Halo框架中扩展可通过属性文件的方式去根据自己实际情况进行配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">web</span>:
    <span class="key">resource-handlers</span>: <span class="string"><span class="delimiter">|</span><span class="content">
      /static/**=classpath:/static/static/
      /index.html=classpath:/static/index.html</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果使用了Halo Swagger或者自己开发的Swagger组件，还需要增加如下的配置，Swagger才可以正常使用</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">web</span>:
    <span class="key">resource-handlers</span>: <span class="string"><span class="delimiter">|</span><span class="content">
      /static/**=classpath:/static/static/
      /index.html=classpath:/static/index.html
      /swagger-ui.html=classpath:/META-INF/resources/
      /webjars/**=classpath:/META-INF/resources/webjars/</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>上面的配置相当于如下扩展代码:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Configuration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ResourceConfig</span> <span class="directive">implements</span> WebMvcConfigurer {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler(<span class="string"><span class="delimiter">&quot;</span><span class="content">/static/**</span><span class="delimiter">&quot;</span></span>).addResourceLocations(<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:/static/</span><span class="delimiter">&quot;</span></span>);
        registry.addResourceHandler(<span class="string"><span class="delimiter">&quot;</span><span class="content">/index.html</span><span class="delimiter">&quot;</span></span>).addResourceLocations(<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:/static/index.html</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_接口日志打印"><a class="anchor" href="#_接口日志打印"></a><a class="link" href="#_接口日志打印">39.3.6. 接口日志打印</a></h4>
<div class="listingblock">
<div class="title">使用注解@WriteLog:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@WriteLog</span>
<span class="annotation">@PostMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/write-log</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="predefined-type">Result</span>&lt;UserOutVO&gt; writeLog(<span class="annotation">@Valid</span> <span class="annotation">@RequestBody</span> TestInVO testInVO) {
    UserOutVO user = <span class="keyword">new</span> UserOutVO();
    user.setUsername(<span class="string"><span class="delimiter">&quot;</span><span class="content">脱敏君</span><span class="delimiter">&quot;</span></span>);
    user.setPassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">123456</span><span class="delimiter">&quot;</span></span>);
    user.setEmail(<span class="string"><span class="delimiter">&quot;</span><span class="content">12345@qq.com</span><span class="delimiter">&quot;</span></span>);
    user.setIdCard(<span class="string"><span class="delimiter">&quot;</span><span class="content">19921137705</span><span class="delimiter">&quot;</span></span>);
    user.setPhone(<span class="string"><span class="delimiter">&quot;</span><span class="content">18888888888</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> <span class="predefined-type">Result</span>.create(ResultCodeEnum.SUCCESS,user);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">UserOutVO定义:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Data</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UserOutVO</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> username;

    <span class="annotation">@Desensitization</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> idCard;

    <span class="annotation">@Desensitization</span>(strategy = PasswordStrategy.class)
    <span class="directive">private</span> <span class="predefined-type">String</span> password;

    <span class="directive">private</span> <span class="predefined-type">String</span> email;

    <span class="annotation">@Desensitization</span>(strategy = MobileStrategy.class)
    <span class="directive">private</span> <span class="predefined-type">String</span> phone;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">日志打印示例:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="error">+</span><span class="error">-</span><span class="error">-</span><span class="error">-</span><span class="error">-</span><span class="error">-</span><span class="error">-</span><span class="error">-</span><span class="error">d</span><span class="error">e</span><span class="error">f</span><span class="error">e</span><span class="error">n</span><span class="error">s</span><span class="error">o</span><span class="error">r</span><span class="error">-</span><span class="error">w</span><span class="error">e</span><span class="error">b</span><span class="error">-</span><span class="error">-</span><span class="error">-</span><span class="error">-</span><span class="error">-</span><span class="error">-</span><span class="error">-</span><span class="error">-</span><span class="error">-</span><span class="error">-</span>
<span class="error">|</span>                        <span class="error">u</span><span class="error">s</span><span class="error">e</span><span class="error">r</span><span class="error">I</span><span class="error">d</span>:<span class="value">null</span><span class="error">;</span><span class="error">执</span><span class="error">行</span><span class="error">方</span><span class="error">法</span>:<span class="error">p</span><span class="error">u</span><span class="error">b</span><span class="error">l</span><span class="error">i</span><span class="error">c</span> <span class="error">o</span><span class="error">r</span><span class="error">g</span><span class="error">.</span><span class="error">x</span><span class="error">u</span><span class="error">j</span><span class="error">i</span><span class="error">n</span><span class="error">.</span><span class="error">h</span><span class="error">a</span><span class="error">l</span><span class="error">o</span><span class="error">.</span><span class="error">d</span><span class="error">t</span><span class="error">o</span><span class="error">.</span><span class="error">R</span><span class="error">e</span><span class="error">s</span><span class="error">u</span><span class="error">l</span><span class="error">t</span><span class="error">D</span><span class="error">a</span><span class="error">t</span><span class="error">a</span><span class="error">&lt;</span><span class="error">o</span><span class="error">r</span><span class="error">g</span><span class="error">.</span><span class="error">x</span><span class="error">u</span><span class="error">j</span><span class="error">i</span><span class="error">n</span><span class="error">.</span><span class="error">h</span><span class="error">a</span><span class="error">l</span><span class="error">o</span><span class="error">.</span><span class="error">w</span><span class="error">e</span><span class="error">b</span><span class="error">.</span><span class="error">v</span><span class="error">o</span><span class="error">.</span><span class="error">U</span><span class="error">s</span><span class="error">e</span><span class="error">r</span><span class="error">O</span><span class="error">u</span><span class="error">t</span><span class="error">V</span><span class="error">O</span><span class="error">&gt;</span> <span class="error">o</span><span class="error">r</span><span class="error">g</span><span class="error">.</span><span class="error">x</span><span class="error">u</span><span class="error">j</span><span class="error">i</span><span class="error">n</span><span class="error">.</span><span class="error">h</span><span class="error">a</span><span class="error">l</span><span class="error">o</span><span class="error">.</span><span class="error">w</span><span class="error">e</span><span class="error">b</span><span class="error">.</span><span class="error">c</span><span class="error">o</span><span class="error">n</span><span class="error">t</span><span class="error">r</span><span class="error">o</span><span class="error">l</span><span class="error">l</span><span class="error">e</span><span class="error">r</span><span class="error">.</span><span class="error">L</span><span class="error">o</span><span class="error">g</span><span class="error">C</span><span class="error">o</span><span class="error">n</span><span class="error">t</span><span class="error">r</span><span class="error">o</span><span class="error">l</span><span class="error">l</span><span class="error">e</span><span class="error">r</span><span class="error">.</span><span class="error">w</span><span class="error">r</span><span class="error">i</span><span class="error">t</span><span class="error">e</span><span class="error">L</span><span class="error">o</span><span class="error">g</span><span class="error">(</span><span class="error">o</span><span class="error">r</span><span class="error">g</span><span class="error">.</span><span class="error">x</span><span class="error">u</span><span class="error">j</span><span class="error">i</span><span class="error">n</span><span class="error">.</span><span class="error">h</span><span class="error">a</span><span class="error">l</span><span class="error">o</span><span class="error">.</span><span class="error">w</span><span class="error">e</span><span class="error">b</span><span class="error">.</span><span class="error">v</span><span class="error">o</span><span class="error">.</span><span class="error">T</span><span class="error">e</span><span class="error">s</span><span class="error">t</span><span class="error">I</span><span class="error">n</span><span class="error">V</span><span class="error">O</span><span class="error">)</span>
<span class="error">|</span>                        <span class="error">参</span><span class="error">数</span><span class="error">依</span><span class="error">次</span><span class="error">为</span>:
<span class="error">|</span>                                        <span class="integer">0</span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">*******7706</span><span class="delimiter">&quot;</span></span>}
<span class="error">|</span>                        <span class="error">返</span><span class="error">回</span><span class="error">值</span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>:<span class="integer">200</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">12345@qq.com</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">idCard</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">****</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">phone</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">*******8888</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">脱敏君</span><span class="delimiter">&quot;</span></span>},<span class="key"><span class="delimiter">&quot;</span><span class="content">msgCode</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">msgContent</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>}
<span class="error">|</span>                        <span class="error">耗</span><span class="error">时</span><span class="error">(</span><span class="error">毫</span><span class="error">秒</span><span class="error">)</span>:<span class="integer">93</span>
<span class="error">\</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span><span class="error">_</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>系统默认开启日志脱敏以及手机号正则匹配脱敏。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>如何使用脱敏</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>使用@Desensitization注解，该注解默认使用的脱敏策略为NonPrint策略，系统还包括邮箱、手机号脱敏策略。</p>
</div>
<div class="paragraph">
<p>也可以自定义脱敏策略。实现IDesensitizationStrategy接口即可。</p>
</div>
<div class="listingblock">
<div class="title">自定义脱敏策略:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">PasswordStrategy</span> <span class="directive">implements</span> IDesensitizationStrategy {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Object</span> handleDesensitization(<span class="predefined-type">Object</span> value) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">****</span><span class="delimiter">&quot;</span></span>;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">使用自定义脱敏:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Desensitization</span>(strategy = PasswordStrategy.class)
<span class="directive">private</span> <span class="predefined-type">String</span> password;</code></pre>
</div>
</div>
<div class="paragraph">
<p>以上关于日志脱敏，是通过fastjson的ValueFilter实现，对象转换为json字符串，再打印，就脱敏了。</p>
</div>
<div class="listingblock">
<div class="title">打印脱敏对象:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">UserOutVO user = <span class="keyword">new</span> UserOutVO();
user.set...
LOGGER.info(JsonUtils.toJSONStringWithDesensitize(user));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_接口版本控制"><a class="anchor" href="#_接口版本控制"></a><a class="link" href="#_接口版本控制">39.3.7. 接口版本控制</a></h4>
<div class="paragraph">
<p>在前后端分离、rest接口盛行的当下，接口的版本控制是一个成熟的系统所应该拥有的。 web模块提供的版本控制，可以方便我们快速构建一个基于版本的api接口。</p>
</div>
<div class="listingblock">
<div class="title">Controller定义:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RestController</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/version/{version}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Version1Controller</span> {

    <span class="annotation">@ApiVersion</span>(<span class="integer">1</span>)
    <span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/test</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> test1(){
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="annotation">@ApiVersion</span>(<span class="integer">4</span>)
    <span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/test</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> test4(){
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">v4</span><span class="delimiter">&quot;</span></span>;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Controller定义:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ApiVersion</span>(<span class="integer">2</span>)
<span class="annotation">@RestController</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/version/{version}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Version2Controller</span> {

    <span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/test</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> test2(){
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">v2</span><span class="delimiter">&quot;</span></span>;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">验证:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="error">/</span><span class="error">v</span><span class="error">e</span><span class="error">r</span><span class="error">s</span><span class="error">i</span><span class="error">o</span><span class="error">n</span><span class="error">/</span><span class="error">v</span><span class="integer">0</span><span class="error">/</span><span class="error">t</span><span class="error">e</span><span class="error">s</span><span class="error">t</span>
<span class="error">不</span><span class="error">存</span><span class="error">在</span>

<span class="error">/</span><span class="error">v</span><span class="error">e</span><span class="error">r</span><span class="error">s</span><span class="error">i</span><span class="error">o</span><span class="error">n</span><span class="error">/</span><span class="error">v</span><span class="integer">1</span><span class="error">/</span><span class="error">t</span><span class="error">e</span><span class="error">s</span><span class="error">t</span>
<span class="error">返</span><span class="error">回</span><span class="error">v</span><span class="integer">1</span>

<span class="error">/</span><span class="error">v</span><span class="error">e</span><span class="error">r</span><span class="error">s</span><span class="error">i</span><span class="error">o</span><span class="error">n</span><span class="error">/</span><span class="error">v</span><span class="integer">2</span><span class="error">/</span><span class="error">t</span><span class="error">e</span><span class="error">s</span><span class="error">t</span>
<span class="error">返</span><span class="error">回</span><span class="error">v</span><span class="integer">2</span>

<span class="error">/</span><span class="error">v</span><span class="error">e</span><span class="error">r</span><span class="error">s</span><span class="error">i</span><span class="error">o</span><span class="error">n</span><span class="error">/</span><span class="error">v</span><span class="integer">3</span><span class="error">/</span><span class="error">t</span><span class="error">e</span><span class="error">s</span><span class="error">t</span>
<span class="error">返</span><span class="error">回</span><span class="error">v</span><span class="integer">2</span>

<span class="error">/</span><span class="error">v</span><span class="error">e</span><span class="error">r</span><span class="error">s</span><span class="error">i</span><span class="error">o</span><span class="error">n</span><span class="error">/</span><span class="error">v</span><span class="integer">4</span><span class="error">/</span><span class="error">t</span><span class="error">e</span><span class="error">s</span><span class="error">t</span>
<span class="error">返</span><span class="error">回</span><span class="error">v</span><span class="integer">4</span>

<span class="error">/</span><span class="error">v</span><span class="error">e</span><span class="error">r</span><span class="error">s</span><span class="error">i</span><span class="error">o</span><span class="error">n</span><span class="error">/</span><span class="error">v</span><span class="integer">6</span><span class="error">/</span><span class="error">t</span><span class="error">e</span><span class="error">s</span><span class="error">t</span>
<span class="error">返</span><span class="error">回</span><span class="error">v</span><span class="integer">4</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
请配合使用注解@ApiVersion和url中{version}；默认自动向下兼容最大的接口版本；
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_halo_assert"><a class="anchor" href="#_halo_assert"></a><a class="link" href="#_halo_assert">39.4. Halo Assert</a></h3>
<div class="paragraph">
<p>以优雅的 Assert(断言) 方式来校验业务的异常情况，只关注业务逻辑，而不用花费大量精力写冗余的
try catch 代码块。</p>
</div>
<div class="paragraph">
<p>想必 Assert(断言) 大家都很熟悉，比如 Spring框架中的org.springframework.util.Assert，在我们写测试用例的时候经常会用到，例如如下代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> test1() {
      User user = userDao.selectById(userId);
      Assert.notNull(user, <span class="string"><span class="delimiter">&quot;</span><span class="content">用户不存在.</span><span class="delimiter">&quot;</span></span>);

}

<span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> test2() {
    <span class="comment">// 另一种写法</span>
    User user = userDao.selectById(userId);
    <span class="keyword">if</span> (user == <span class="predefined-constant">null</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">用户不存在.</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
如上述代码所示，第一种判定非空的写法很优雅，第二种写法 if {&#8230;&#8203;} 代码块相对丑陋的。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Assert.notNull()底层实现代码如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">Assert</span> {
    <span class="directive">public</span> Assert() {
    }

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> notNull(<span class="annotation">@Nullable</span> <span class="predefined-type">Object</span> object, <span class="predefined-type">String</span> message) {
        <span class="keyword">if</span> (object == <span class="predefined-constant">null</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(message);
        }
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
从上述代码Assert代码本质就是把if {&#8230;&#8203;} 封装了一下，虽然是很简单的封装，但不可否认的是代码整洁度至少提升了一个档次。那Halo框架是否能模仿org.springframework.util.Assert也写一个断言类，
不过断言失败后抛出的异常不是IllegalArgumentException 这些内置异常，而是Halo框架自己定义的异常。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_halo_assert的实现"><a class="anchor" href="#_halo_assert的实现"></a><a class="link" href="#_halo_assert的实现">39.4.1. Halo Assert的实现</a></h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Getter</span>
<span class="annotation">@AllArgsConstructor</span>
<span class="directive">public</span> <span class="type">enum</span> CommonResponseEnum <span class="directive">implements</span> BusinessExceptionAssert {

    <span class="comment">/**
     *
     */</span>
    CMD_NOT_NULL(<span class="string"><span class="delimiter">&quot;</span><span class="content">7001</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">cmd不能为null</span><span class="delimiter">&quot;</span></span>),
    <span class="comment">/**
     *
     */</span>
    LICENCE_NOT_FOUND(<span class="string"><span class="delimiter">&quot;</span><span class="content">7002</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Licence not found.</span><span class="delimiter">&quot;</span></span>)

    ;

    <span class="comment">/**
     * 返回码
     */</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> code;
    <span class="comment">/**
     * 返回消息
     */</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> message;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getMsgCode() {
        <span class="keyword">return</span> <span class="predefined-type">String</span>.valueOf(code);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getMsgContent() {
        <span class="keyword">return</span> message;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上面的Assert断言方法是使用接口的默认方法定义的，然后有没有发现当断言失败后，抛出的异常不是具体的某个异常，
而是交由2个newException接口方法提供。因为业务逻辑中出现的异常基本都是对应特定的场景，比如根据用户id获取用户信息，
查询结果为null，此时抛出的异常可能为UserNotFoundException，并且有特定的异常码（比如7001）和异常信息“用户不存在”。
所以具体抛出什么异常，有Assert的实现类决定。</p>
</div>
</div>
<div class="sect3">
<h4 id="_enum_和_halo_assert结合"><a class="anchor" href="#_enum_和_halo_assert结合"></a><a class="link" href="#_enum_和_halo_assert结合">39.4.2. Enum 和 Halo Assert结合</a></h4>
<div class="paragraph">
<p>不使用Enume和Halo Assert的代码如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> checkNotNull(Licence licence) {
    <span class="keyword">if</span> (licence == <span class="predefined-constant">null</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> LicenceNotFoundException();
        <span class="comment">// 或者这样</span>
        <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(<span class="integer">7001</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bad licence type.</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>使用了Halo Assert之后的代码如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
    * 校验{@link Licence}存在
    * @param licence
    */</span>
<span class="directive">private</span> <span class="type">void</span> checkNotNull(Licence licence) {
       ResponseEnum.LICENCE_NOT_FOUND.assertNotNull(licence);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>使用枚举类结合(继承)Assert，只需根据特定的异常情况定义不同的枚举实例，
如上面的BAD_LICENCE_TYPE、LICENCE_NOT_FOUND，就能够针对不同情况抛出特定的异常（这里指携带特定的异常码和异常消息），
这样既不用定义大量的异常类，同时还具备了断言的良好可读性。</p>
</div>
</div>
<div class="sect3">
<h4 id="_统一404返回"><a class="anchor" href="#_统一404返回"></a><a class="link" href="#_统一404返回">39.4.3. 统一404返回</a></h4>
<div class="paragraph">
<p>当请求没有匹配到控制器的情况下，会抛出NoHandlerFoundException异常，但其实默认情况下不是这样，默认情况下会出现类似如下页面：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-web/404.png" alt="404" width="800">
</div>
<div class="title">Figure 24. 404</div>
</div>
<div class="paragraph">
<p>这个页面是如何出现的呢？实际上，当出现404的时候，默认是不抛异常的，而是 forward跳转到/error控制器，spring也提供了默认的error控制器。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">spring.mvc.throw-exception-if-no-handler-found=true
spring.resources.add-mappings=false</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_使用halo_assert"><a class="anchor" href="#_使用halo_assert"></a><a class="link" href="#_使用halo_assert">39.4.4. 使用Halo Assert</a></h4>
<div class="paragraph">
<p>下面的代码示例通过定义枚举快速Assert。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CommonResponseEnum.CMD_NOT_NULL.assertNotNull(cmd);</code></pre>
</div>
</div>
<div class="paragraph">
<p>CommonResponseEnum代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Getter</span>
<span class="annotation">@AllArgsConstructor</span>
<span class="directive">public</span> <span class="type">enum</span> CommonResponseEnum <span class="directive">implements</span> BusinessExceptionAssert {

    <span class="comment">/**
     *
     */</span>
    CMD_NOT_NULL(<span class="string"><span class="delimiter">&quot;</span><span class="content">7001</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">cmd不能为null</span><span class="delimiter">&quot;</span></span>),
    <span class="comment">/**
     *
     */</span>
    LICENCE_NOT_FOUND(<span class="string"><span class="delimiter">&quot;</span><span class="content">7002</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Licence not found.</span><span class="delimiter">&quot;</span></span>)

    ;

    <span class="comment">/**
     * 返回码
     */</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> code;
    <span class="comment">/**
     * 返回消息
     */</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> message;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getMsgCode() {
        <span class="keyword">return</span> <span class="predefined-type">String</span>.valueOf(code);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getMsgContent() {
        <span class="keyword">return</span> message;
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-swagger"><a class="anchor" href="#halo-swagger"></a><a class="link" href="#halo-swagger">40. Halo Swagger</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="halo-swagger-function"><a class="anchor" href="#halo-swagger-function"></a><a class="link" href="#halo-swagger-function">40.1. Halo Swagger的功能</a></h3>
<div class="ulist">
<ul>
<li>
<p>兼容swagger功能，常见swagger文档描述可配置</p>
</li>
<li>
<p>可手动配置关闭swagger。在生产环境下，默认就会关闭swagger</p>
</li>
<li>
<p>可配置多包扫描，也支持默认包扫描功能</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="halo-swagger-use"><a class="anchor" href="#halo-swagger-use"></a><a class="link" href="#halo-swagger-use">40.2. Halo Swagger的使用</a></h3>
<div class="sect3">
<h4 id="halo-swagger-maven"><a class="anchor" href="#halo-swagger-maven"></a><a class="link" href="#halo-swagger-maven">40.2.1. Maven引入</a></h4>
<div class="paragraph">
<p>1.引入Halo-Swagger依赖。有两种方式</p>
</div>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>2.在需要使用的工程模块中,引入 swagger 模块即可</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-swagger<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="halo-swagger-config"><a class="anchor" href="#halo-swagger-config"></a><a class="link" href="#halo-swagger-config">40.2.2. 配置使用</a></h4>
<div class="paragraph">
<p>1.Halo Swagger的基本配置如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">swagger</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">api</span>:
      <span class="key">name</span>: <span class="string"><span class="content">Halo Admin</span></span>
      <span class="key">title</span>: <span class="string"><span class="content">Halo Admin</span></span>
      <span class="key">description</span>: <span class="string"><span class="content">中台管控平台</span></span>
      <span class="key">version</span>: <span class="string"><span class="content">2.0.8</span></span>
      <span class="key">conractUser</span>: <span class="string"><span class="content">jin.xu</span></span>
      <span class="key">conractUrl</span>: <span class="string"><span class="content">http://xujin.org</span></span>
      <span class="key">conractEmail</span>: <span class="string"><span class="content">Software_King@qq.com</span></span>
      <span class="key">basePackages</span>: <span class="string"><span class="content">org.xujin.halo.admin.controller</span></span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>halo.swagger.enabled</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>配置的值为是否激活swagger，true为激活，false为关闭。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
考虑到API安全性，当spring.profiles.active（或者java启动属性env）配置为pro或者product时，不管halo.swagger.enabled为true或者false，swagger功能都会关闭。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>使用Halo Swagger后，请勿再使用Swagger原生注解@EnableSwagger2，否则，halo.swagger.enabled将不受控制。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>halo.swagger.api.basePackages</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
接口扫描包配置。默认不配置的情况下，系统会扫描标注@SpringBootApplication启动类所在包路径下的所有接口。
也可以手动指定只扫描哪些包，多个包名用英文逗号隔开，例如:org.xujin.openapi,net.qingcloud.admin
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>如果配置错误，应用启动会出现提示:配置&#8594;halo.swagger.api.basePackages格式有误，请配置正确的包路径，多个用英文逗号隔开</p>
</div>
<div class="paragraph">
<p>2.下面是增加了全局的操作参数配置</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">swagger</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">api</span>:
      <span class="key">name</span>: <span class="string"><span class="content">Halo Admin</span></span>
      <span class="key">title</span>: <span class="string"><span class="content">Halo Admin</span></span>
      <span class="key">description</span>: <span class="string"><span class="content">中台管控平台</span></span>
      <span class="key">version</span>: <span class="string"><span class="content">2.0.8</span></span>
      <span class="key">conractUser</span>: <span class="string"><span class="content">jin.xu</span></span>
      <span class="key">conractUrl</span>: <span class="string"><span class="content">http://xujin.org</span></span>
      <span class="key">conractEmail</span>: <span class="string"><span class="content">Software_King@qq.com</span></span>
      <span class="key">basePackages</span>: <span class="string"><span class="content">org.xujin.halo.admin.controller</span></span>
      <span class="key">globalOperationParameters</span>:
        - <span class="string"><span class="content">name: XAuthorization</span></span>  <span class="comment">#参数名</span>
          <span class="key">description</span>: <span class="string"><span class="content">Token Request Header</span></span>   <span class="comment">#描述信息</span>
          <span class="key">parameterType</span>: <span class="string"><span class="content">header</span></span>  <span class="comment">#指定参数存放位置,参考ParamType:(header,query,path,body,form)</span>
          <span class="key">dataType</span>: <span class="string"><span class="content">String</span></span>   <span class="comment">#数据类型</span>
          <span class="key">required</span>: <span class="string"><span class="content">false</span></span>
          <span class="comment"># 测试接口时，自动填充token的值</span>
          <span class="key">defaultValue</span>:</code></pre>
</div>
</div>
<div class="paragraph">
<p>当应用启动之后,输入网址 <a href="http://ip:端口/swagger-ui.html" class="bare">http://ip:端口/swagger-ui.html</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-MapStruct"><a class="anchor" href="#halo-MapStruct"></a><a class="link" href="#halo-MapStruct">41. Halo MapStruct</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Halo框架中有DO，CO,Entity,Value Object等POJO,为了代码防腐和架构治理各种XO之间会相互转换。。
Spring BeanUtils进行类复制时，每次进行反射查询对象的属性列表, 非常缓慢。在MapStruct没有出来之前Orika时最佳可选方案。
在Halo Util中内置了org.xujin.halo.utils.reflect.BeanMapper，简单封装orika, 实现深度Bean Copy。</p>
</div>
<div class="paragraph">
<p>MapStruct问世时候,从各方面对比,都相当优秀。因此Halo框架对其进行定制，作为统一的Bean Copy工具。</p>
</div>
<div class="sect2">
<h3 id="_什么是halo_mapstruct"><a class="anchor" href="#_什么是halo_mapstruct"></a><a class="link" href="#_什么是halo_mapstruct">41.1. 什么是Halo MapStruct</a></h3>
<div class="paragraph">
<p>MapStruct 是一个自动生成 bean mapper 类的代码生成器。MapStruct 还能够在不同的数据类型之间进行转换。
Github 地址：https://github.com/mapstruct</p>
</div>
<div class="paragraph">
<p>性能对比：https://segmentfault.com/a/1190000021004596</p>
</div>
<div class="paragraph">
<p><a href="https://www.baeldung.com/java-performance-mapping-frameworks" class="bare">https://www.baeldung.com/java-performance-mapping-frameworks</a></p>
</div>
<div class="paragraph">
<p>文档地址:https://mapstruct.org/documentation/stable/reference/html/</p>
</div>
</div>
<div class="sect2">
<h3 id="_halo_mapstruct的使用"><a class="anchor" href="#_halo_mapstruct的使用"></a><a class="link" href="#_halo_mapstruct的使用">41.2. halo MapStruct的使用</a></h3>
<div class="sect3">
<h4 id="_maven引入_2"><a class="anchor" href="#_maven引入_2"></a><a class="link" href="#_maven引入_2">41.2.1. Maven引入</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>引入Halo-job依赖。有两种方式</p>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在需要使用的工程模块中,引入 halo job 模块即可</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-mapstruct<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mapstruct使用"><a class="anchor" href="#_mapstruct使用"></a><a class="link" href="#_mapstruct使用">41.2.2. MapStruct使用</a></h4>

</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_halo_excel"><a class="anchor" href="#_halo_excel"></a><a class="link" href="#_halo_excel">42. Halo Excel</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="halo-test"><a class="anchor" href="#halo-test"></a><a class="link" href="#halo-test">43. Halo Test</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="halo-test-function"><a class="anchor" href="#halo-test-function"></a><a class="link" href="#halo-test-function">43.1. Halo Test的功能</a></h3>
<div class="paragraph">
<p>为了减少单元测试的工作量，Halo Test下对Spring Boot单元测试的所需的依赖统一管理和提供一些Base层的功能.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>无需引入Spring Test相关的jar</p>
</li>
<li>
<p>引入halo-starter-test即可</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
halo-starter-test只引入了spring-test和spring-boot-starter-test(依赖于Junit4).
由于Halo基于Spring Boot 2.x开发,因此默认包含Junit4.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="halo-test-use"><a class="anchor" href="#halo-test-use"></a><a class="link" href="#halo-test-use">43.2. Halo Test的使用</a></h3>
<div class="sect3">
<h4 id="halo-Test-maven"><a class="anchor" href="#halo-Test-maven"></a><a class="link" href="#halo-Test-maven">43.2.1. Maven引入</a></h4>
<div class="paragraph">
<p>1.引入Halo-Test依赖。有两种方式</p>
</div>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>2.在需要使用的工程模块中,引入halo-starter-test模块即可</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"> <span class="tag">&lt;dependency&gt;</span>
     <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
     <span class="tag">&lt;artifactId&gt;</span>halo-starter-test<span class="tag">&lt;/artifactId&gt;</span>
     <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>业务应用不需要引入如下的jar</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
         <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
         <span class="tag">&lt;artifactId&gt;</span>spring-test<span class="tag">&lt;/artifactId&gt;</span>
         <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
     <span class="tag">&lt;/dependency&gt;</span>

     <span class="tag">&lt;dependency&gt;</span>
         <span class="tag">&lt;groupId&gt;</span>org.springframework.boot<span class="tag">&lt;/groupId&gt;</span>
         <span class="tag">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="tag">&lt;/artifactId&gt;</span>
         <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
     <span class="tag">&lt;/dependency&gt;</span>

     <span class="tag">&lt;dependency&gt;</span>
         <span class="tag">&lt;groupId&gt;</span>junit<span class="tag">&lt;/groupId&gt;</span>
         <span class="tag">&lt;artifactId&gt;</span>junit<span class="tag">&lt;/artifactId&gt;</span>
         <span class="tag">&lt;version&gt;</span>4.12<span class="tag">&lt;/version&gt;</span>
         <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
     <span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="halo-test-use"><a class="anchor" href="#halo-test-use"></a><a class="link" href="#halo-test-use">43.2.2. Halo Test使用</a></h4>
<div class="paragraph">
<p>1.如下所示,编写CommonTest.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">@SpringBootTest(classes = HaloBasicApplication.class)
@RunWith(SpringRunner.class)
public abstract class CommonTest {

}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
其中classes = HaloBasicApplication.class是Spring Boot主入口程序Java类.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>2.编写对应的测试类继承CommonTest</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">public class CmdTest extends CommonTest {

    @Autowired
    private CommandBus commandBus;

    /**
     * 测试写命令
     */
    @Test
    public void testCmdWrite() {
        AddAppCmd addAppCmd=new AddAppCmd();
        addAppCmd.setAppId(&quot;111&quot;);
        ResultData<span class="tag">&lt;Long&gt;</span> resultData=commandBus.send(addAppCmd);
        Assert.assertEquals((long)resultData.getData(),1L);

    }

    /**
     * 测试读命令
     */
    @Test
    public void testCmdRead() {
        QueryAppCmd queryAppCmd=new QueryAppCmd();
        queryAppCmd.setId(1L);
        ResultData<span class="tag">&lt;AppCO&gt;</span>  resultData= commandBus.send(queryAppCmd);
        Assert.assertEquals(resultData.getData().getAppId(),&quot;defensor&quot;);

    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-Mongodb"><a class="anchor" href="#halo-Mongodb"></a><a class="link" href="#halo-Mongodb">44. Halo MongoDB</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_什么是halo_mongodb"><a class="anchor" href="#_什么是halo_mongodb"></a><a class="link" href="#_什么是halo_mongodb">44.1. 什么是Halo MongoDB</a></h3>
<div class="paragraph">
<p>Spring Data MongoDB为面向 MongoDB 的开发提供了一套基于 Spring 的编程模型，在 Spring Boot 中使用 spring-boot-starter-data-mongodb 可以很方便的引入 Spring Data MongoDB 以及MongoDB Java Driver。</p>
</div>
<div class="paragraph">
<p>然而，Spring Data MongoDB 只提供了最简单的 MongoDB 客户端选项，不支持使用连接池，多数据源配置，集群等MongoDB高级特性。</p>
</div>
<div class="paragraph">
<p>Halo MongoDB是基于spring-boot-starter-data-mongodb封装的定制的Starter，底层使用的是http://mongodb.github.io/mongo-java-driver/3.6[MongoDB Java Driver 3.6.4^]</p>
</div>
<div class="paragraph">
<p>功能如下:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>无缝支持Spring Boot中MongoDB的使用,无需显示引入spring-boot-starter-data-mongodb.</p>
</li>
<li>
<p>可以通过Halo MongoDB设置相关的连接池信息(Spring Boot对MongoDB的封装没有提供连接池相关的选项设置)</p>
</li>
<li>
<p>支持多数据源配置（Halo: 2.0.0-SNAPSHOT）</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_使用halo_mongodb"><a class="anchor" href="#_使用halo_mongodb"></a><a class="link" href="#_使用halo_mongodb">44.2. 使用Halo MongoDB</a></h3>
<div class="sect3">
<h4 id="_maven引入halo_mongodb"><a class="anchor" href="#_maven引入halo_mongodb"></a><a class="link" href="#_maven引入halo_mongodb">44.2.1. Maven引入Halo MongoDB</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>引入Halo MongoDB依赖。有两种方式</p>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在需要使用的工程模块中,引入 Halo MongoDB模块即可</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-mongodb<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_在属性文件yml或properties配置halo_mongodb"><a class="anchor" href="#_在属性文件yml或properties配置halo_mongodb"></a><a class="link" href="#_在属性文件yml或properties配置halo_mongodb">44.2.2. 在属性文件yml或properties配置Halo MongoDB</a></h4>
<div class="ulist">
<ul>
<li>
<p>单数据源模式（默认）</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>在yml文件中配置如下信息,使用Halo MongoDB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">spring</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">defensor-mongodb</span></span>
  <span class="key">data</span>:
    <span class="key">mongodb</span>:
      <span class="key">host</span>: <span class="string"><span class="content">10.84.23.71:27017</span></span>
      <span class="key">database</span>: <span class="string"><span class="content">halo-mongodb</span></span>
      <span class="key">username</span>: <span class="string"><span class="content">用户名</span></span>
      <span class="key">password</span>: <span class="string"><span class="content">密码</span></span>
      <span class="comment">#uri: mongodb://用户名:密码@ip:端口/数据库 </span># <b class="conum">(1)</b>

<span class="key">halo</span>:
  <span class="key">mongodb</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">true </span></span><b class="conum">(2)</b>
    <span class="key">heartbeat-connect-timeout</span>: <span class="string"><span class="content">30000 </span></span># <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>多数据源模式</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">mongodb</span>:
    <span class="key">multi</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span> <span class="comment">#启用多数据源模式，默认不开启</span>
      <span class="key">dbs</span>:
        <span class="key">customDb1</span>: <span class="comment"># 自定义数据源名称示例</span>
          <span class="key">uri</span>: <span class="string"><span class="content">mongodb://127.0.0.1:27017/db1</span></span>
          <span class="key">connectTimeout</span>: <span class="string"><span class="content">10000 </span></span># <b class="conum">(3)</b>
        <span class="key">customDb2</span>: <span class="comment"># 自定义数据源名称示例</span>
          <span class="key">uri</span>: <span class="string"><span class="content">mongodb://127.0.0.1:27017/db2</span></span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>单、多数据源模式不能同时启用，否则会启动报错。</p>
</div>
<div class="paragraph">
<p>即halo.mongodb.enabled与halo.mongodb.multi.enabled不能同时为true。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="colist arabic">
<ol>
<li>
<p>MongoDB 的连接字符串，当配置了 <code>uri</code> 时，将忽略 <code>addresses</code>、<code>database</code>、<code>username</code> 等连接相关的配置项，而直接使用 <code>uri</code> 建立连接。</p>
</li>
<li>
<p>只有当halo.mongodb.enabled=true才开启Halo MongoDB,否则使用Spring Boot默认对MongoDB的封装,如下图所示:</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/mongodb/1.png" alt="1">
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>关于 MongoDB Java Driver 客户端选项的详细说明可以参考下面汇总的表格。</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p><strong>注：由于官方已对 socket-keep-alive 选项废弃，因此 Halo MongoDB不建议也不提供配置选型。</strong></p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">参数名</th>
<th class="tableblock halign-left valign-top">默认参数值</th>
<th class="tableblock halign-left valign-top">参数说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ConnectionsPerHost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置每台主机的最大连接数</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RequiredReplicaSetName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置群集所需的副本集名称</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ConnectTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置连接超时</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HeartbeatConnectTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置用于群集心跳的连接的连接超时</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HeartbeatFrequency</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置心跳频率。这是驱动程序尝试确定群集中每个服务器当前状态的频率。默认值为10，000毫秒</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HeartbeatSocketTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置用于群集心跳的连接的套接字超时</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LocalThreshold</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置本地阈值</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxConnectionIdleTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置池连接的最大空闲时间</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxConnectionLifeTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置池连接的最长生存期</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxWaitTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">120000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置线程阻塞等待连接的最长时间</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MinConnectionsPerHost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置每台主机的最小连接数</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MinHeartbeatFrequency</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置最小心跳频率。如果驱动程序必须频繁地重新检查服务器的可用性，它至少会在上次检查后等待这么长时间，以避免浪费精力。默认值为500毫秒</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServerSelectionTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">以毫秒为单位设置服务器选择超时，这定义了驱动程序在引发异常之前等待服务器选择成功的时间。 值0表示如果没有服务器可用，它将立即超时。负值意味着无限期等待。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SocketTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置socket超时</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">threadsAllowedToBlockForConnectionMultiplier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置允许阻塞等待连接的线程数的乘数。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">socketKeepAlive</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置是否启用套接字保持活动</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sslEnabled</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置是否使用SSL。将此设置为true也会将SocketFactory设置为sLSocketFactory。GetDefault ( )并将此设置为false会将SocketFactory设置为SocketFactory。GetDefault ( )</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sslInvalidHostNameAllowed</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定义是否允许无效主机名。默认为false。在将此设置为真之前要小心，因为这会使应用程序容易受到中间人攻击</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">readPreference</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置读取首选项</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">writeConcern</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置写入关注点。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">readConcern</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置读取关注点。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">codecRegistry</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置编解码器注册表请注意，DB和DBCollection的实例不使用注册表，因此无需在注册表中包含DBObject的编解码器。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">addCommandListener</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">添加给定的命令侦听器。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">socketFactory</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置socket工厂。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cursorFinalizerEnabled</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置是否启用游标终结器</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">alwaysUseMBeans</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置驱动程序注册的JMX Beans是否应该始终是MBean，而不管VM是Java 6还是更高版本。如果为false，如果虚拟机为Java 6或更高版本，驱动程序将使用MXBeans，如果虚拟机为Java 5，则使用mbean。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dbDecoderFactory</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置解码器工厂</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dbEncoderFactory</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置编码器工厂</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">legacyDefaults</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">将默认值设置为MongoOptions中的值</p></td>
</tr>
</tfoot>
</table>
</div>
<div class="sect3">
<h4 id="_使用mongotemplate操作mongodb"><a class="anchor" href="#_使用mongotemplate操作mongodb"></a><a class="link" href="#_使用mongotemplate操作mongodb">44.2.3. 使用MongoTemplate操作MongoDB</a></h4>
<div class="ulist">
<ul>
<li>
<p>单数据源模式</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Autowired</span>
<span class="directive">private</span> MongoTemplate mongoTemplate;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>多数据源模式</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>多数据源模式下，halo mongoDB会根据配置的数据源信息，自动在Spring容器中，注册MongoTemplate bean，只需在代码中注入对应的bean即可使用。</p>
</div>
<div class="paragraph">
<p>多个数据源中，第一个声明的数据源对应的MongoTemplate为@Primary。</p>
</div>
<div class="paragraph">
<p>MongoTemplate bean 命名规则：数据源名称 + MongoTemplate，例 customDb1MongoTemplate，customDb2MongoTemplate。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Autowired</span>
<span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">customDb1MongoTemplate</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> MongoTemplate customDb1MongoTemplate;

<span class="annotation">@Autowired</span>
<span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">customDb2MongoTemplate</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> MongoTemplate customDb2MongoTemplate;</code></pre>
</div>
</div>
<div class="paragraph">
<p>由于Halo框架基于Spring Boot 2.0.8版本开发,更多MongoTemplate的使用细节可以查看
<a href="https://docs.spring.io/spring-data/mongodb/docs/2.1.3.RELEASE/reference/html/#reference" target="_blank" rel="noopener">Spring Data 2.1.3.RELEASE</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-es-6"><a class="anchor" href="#halo-es-6"></a><a class="link" href="#halo-es-6">45. Halo ElasticSearch 6.3.2</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_什么是halo_es_6"><a class="anchor" href="#_什么是halo_es_6"></a><a class="link" href="#_什么是halo_es_6">45.1. 什么是Halo ES 6</a></h3>
<div class="paragraph">
<p>Halo ES6是基于ES 6.3.2封装的Spring Boot Starter。并提供了HaloEsTemplate并封装了常用的操作API,从而简化ES的使用方式。</p>
</div>
</div>
<div class="sect2">
<h3 id="_使用halo_es_6"><a class="anchor" href="#_使用halo_es_6"></a><a class="link" href="#_使用halo_es_6">45.2. 使用Halo ES 6</a></h3>
<div class="sect3">
<h4 id="_maven引入halo_es_6"><a class="anchor" href="#_maven引入halo_es_6"></a><a class="link" href="#_maven引入halo_es_6">45.2.1. Maven引入Halo ES 6</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>引入Halo ES 6依赖。有两种方式</p>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
    <span class="tag">&lt;dependencies&gt;</span>
         <span class="tag">&lt;dependency&gt;</span>
             <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
             <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
             <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
             <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
             <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
          <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在需要使用的工程模块中,引入 Halo ES6 模块即可,如下所示:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-es6<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_在yml文件中配置halo_es6"><a class="anchor" href="#_在yml文件中配置halo_es6"></a><a class="link" href="#_在yml文件中配置halo_es6">45.2.2. 在yml文件中配置Halo ES6</a></h4>
<div class="ulist">
<ul>
<li>
<p>精简版yml配置,不需要修改默认配置:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">es</span>:
    <span class="key">host</span>: <span class="string"><span class="content">10.31.53.185</span></span>
    <span class="key">port</span>: <span class="string"><span class="content">9300</span></span>
    <span class="key">cluster-name</span>: <span class="string"><span class="content">zm-elk-test</span></span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>使用Halo ES6,在yml文件中完整的配置如下所示</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">es</span>:
    <span class="key">host</span>: <span class="string"><span class="content">10.31.53.185 </span></span>#<b class="conum">(1)</b>
    <span class="key">port</span>: <span class="string"><span class="content">9300  </span></span>#<b class="conum">(2)</b>
    <span class="key">cluster-name</span>: <span class="string"><span class="content">zm-elk-test  </span></span>#<b class="conum">(3)</b>
    <span class="key">transport</span>:
      <span class="key">ignore-cluster-name</span>: <span class="string"><span class="content">false  </span></span>#<b class="conum">(4)</b>
      <span class="key">nodes-sampler-interval</span>: <span class="string"><span class="content">5s </span></span>#<b class="conum">(5)</b>
      <span class="key">ping-timeout</span>: <span class="string"><span class="content">5s </span></span>#<b class="conum">(6)</b>
      <span class="key">sniff</span>: <span class="string"><span class="content">true </span></span>#<b class="conum">(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>es主机 必填</p>
</li>
<li>
<p>port的端口，默认为9300,必填</p>
</li>
<li>
<p>集群名称,必填</p>
</li>
<li>
<p>是否忽略集群名称,非必填</p>
</li>
<li>
<p>嗅探集群节点的间隔时间,默认5秒,非必填可自定义</p>
</li>
<li>
<p>Ping节点的超时时间,默认是5秒,非必填可自定义</p>
</li>
<li>
<p>是否开启集群嗅探,在Halo ES6中默认开启,非必填可自定义</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>在org.elasticsearch.client.transport.TransportClient.java文件中有4个重要参数,如下代码所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">TransportClient</span> <span class="directive">extends</span> AbstractClient {

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> Setting&lt;TimeValue&gt; CLIENT_TRANSPORT_NODES_SAMPLER_INTERVAL =
        Setting.positiveTimeSetting(<span class="string"><span class="delimiter">&quot;</span><span class="content">client.transport.nodes_sampler_interval</span><span class="delimiter">&quot;</span></span>, timeValueSeconds(<span class="integer">5</span>), Setting.Property.NodeScope);
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> Setting&lt;TimeValue&gt; CLIENT_TRANSPORT_PING_TIMEOUT =
        Setting.positiveTimeSetting(<span class="string"><span class="delimiter">&quot;</span><span class="content">client.transport.ping_timeout</span><span class="delimiter">&quot;</span></span>, timeValueSeconds(<span class="integer">5</span>), Setting.Property.NodeScope);
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> Setting&lt;<span class="predefined-type">Boolean</span>&gt; CLIENT_TRANSPORT_IGNORE_CLUSTER_NAME =
        Setting.boolSetting(<span class="string"><span class="delimiter">&quot;</span><span class="content">client.transport.ignore_cluster_name</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span>, Setting.Property.NodeScope);
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> Setting&lt;<span class="predefined-type">Boolean</span>&gt; CLIENT_TRANSPORT_SNIFF =
        Setting.boolSetting(<span class="string"><span class="delimiter">&quot;</span><span class="content">client.transport.sniff</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span>, Setting.Property.NodeScope);
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
在上述代码中可以看到,client.transport.nodes_sampler_interval和client.transport.ping_timeout默认值均为5s,client.transport.ignore_cluster_name和client.transport.sniff均为false,
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_使用haloestemplate操作es"><a class="anchor" href="#_使用haloestemplate操作es"></a><a class="link" href="#_使用haloestemplate操作es">45.2.3. 使用HaloEsTemplate操作ES</a></h4>
<div class="paragraph">
<p>1.使用HaloEsTemplate非常简单，如下代码所示，依赖注入即可:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Autowired</span>
<span class="directive">private</span> HaloEsTemplate haloEsTemplate; #<b class="conum">(1)</b>

<span class="annotation">@Autowired</span>
<span class="directive">private</span> TransportClient transportClient;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>依赖注入haloEsTemplate可以使用HaloEs6的功能.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>&lt;2&gt;如果觉得haloEsTemplate提供的API满足不了需求,可以通过transportClient使用底层的接口操作ES。</p>
</div>
<div class="paragraph">
<p>2.HaloEsTemplate提供的方法如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * 批量插入数据
 * @param esBasicInfo
 * @param object
 * @return
 * @throws IOException
 */</span>
<span class="directive">public</span> <span class="type">int</span> addBatchData(ESBasicInfo esBasicInfo, <span class="predefined-type">Object</span> object) <span class="directive">throws</span> <span class="exception">IOException</span>;

<span class="comment">/**
 * 增加数据
 * @param esBasicInfo
 * @param object
 * @return
 * @throws IOException
 */</span>
<span class="directive">public</span> <span class="type">boolean</span> addData(ESBasicInfo esBasicInfo, <span class="predefined-type">Object</span> object) <span class="directive">throws</span> <span class="exception">IOException</span>;

<span class="comment">/**
 * 分析搜索
 * @param clazz
 * @param response
 * @param &lt;T&gt;
 * @return
 * @throws IOException
 */</span>
<span class="directive">public</span> &lt;T&gt; <span class="predefined-type">List</span>&lt;T&gt; analyzeSearchResponse(<span class="predefined-type">Class</span>&lt;T&gt; clazz, SearchResponse response) <span class="directive">throws</span> <span class="exception">IOException</span>;

<span class="comment">/**
 * 创建索引
 * @param index
 * @return
 */</span>
<span class="directive">public</span> <span class="type">boolean</span> createIndex(<span class="predefined-type">String</span> index);

<span class="comment">/**
 * 创建Mapping
 * @param index
 * @param type
 * @param mapping
 * @return
 * @throws IOException
 */</span>
<span class="directive">public</span> <span class="type">boolean</span> createMapping(<span class="predefined-type">String</span> index, <span class="predefined-type">String</span> type, XContentBuilder mapping) <span class="directive">throws</span> <span class="exception">IOException</span>;


<span class="comment">/**
 * 批量删除数据
 * @param esBasicInfo
 * @return
 */</span>
<span class="directive">public</span> <span class="type">int</span> deleteBatchData(ESBasicInfo esBasicInfo);


<span class="comment">/**
 * 删除数据
 * @param esBasicInfo
 * @return
 */</span>
<span class="directive">public</span> <span class="type">boolean</span> deleteData(ESBasicInfo esBasicInfo);

<span class="comment">/**
 * 删除索引
 * @param index
 * @return
 */</span>
<span class="directive">public</span> <span class="type">boolean</span> deleteIndex(<span class="predefined-type">String</span> index);

<span class="comment">/**
 * 查询
 * @param index
 * @param queryCondition
 * @param type
 * @return
 */</span>
<span class="directive">public</span> SearchResponse executeQuery(<span class="predefined-type">String</span> index, QueryCondition queryCondition, <span class="predefined-type">String</span>... type);

<span class="comment">/**
 * 查询所有的Mapping
 * @param index
 * @return
 * @throws IOException
 */</span>
<span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt; getAllMapping(<span class="predefined-type">String</span> index) <span class="directive">throws</span> <span class="exception">IOException</span>;

<span class="comment">/**
 *
 * Mapping 是定义文档及其包含的字段是如何存储和索引的过程
 * @param index
 * @param type
 * @return
 * @throws IOException
 */</span>
<span class="directive">public</span> <span class="predefined-type">String</span> getMapping(<span class="predefined-type">String</span> index, <span class="predefined-type">String</span> type) <span class="directive">throws</span> <span class="exception">IOException</span>;

<span class="comment">/**
 * 返回高亮结果
 * @param esBasicInfo
 * @param queryCondition
 * @param highLight
 * @return
 */</span>
<span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt; highLightResultSet(ESBasicInfo esBasicInfo, QueryCondition queryCondition,
    HighLight highLight);

<span class="comment">/**
 * 是否存在索引
 * @param index
 * @return
 */</span>
<span class="directive">public</span> <span class="type">boolean</span> isExistedIndex(<span class="predefined-type">String</span> index);

<span class="comment">/**
 * 查询返回泛型
 * @param esBasicInfo
 * @param clazz
 * @param &lt;T&gt;
 * @return
 * @throws IOException
 */</span>
<span class="directive">public</span> &lt;T&gt; T query(ESBasicInfo esBasicInfo, <span class="predefined-type">Class</span>&lt;T&gt; clazz) <span class="directive">throws</span> <span class="exception">IOException</span>;

<span class="comment">/**
 * 批量更新数据
 * @param esBasicInfo
 * @param object
 * @return
 * @throws IOException
 */</span>
<span class="directive">public</span> <span class="type">int</span> updateBatchData(ESBasicInfo esBasicInfo, <span class="predefined-type">Object</span> object) <span class="directive">throws</span> <span class="exception">IOException</span>;

<span class="comment">/**
 * 更新数据
 * @param esBasicInfo
 * @param object
 * @return
 * @throws IOException
 */</span>
<span class="directive">public</span> <span class="type">boolean</span> updateData(ESBasicInfo esBasicInfo, <span class="predefined-type">Object</span> object) <span class="directive">throws</span> <span class="exception">IOException</span>;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-es-7"><a class="anchor" href="#halo-es-7"></a><a class="link" href="#halo-es-7">46. Halo ElasticSearch 7.2.1</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_什么是halo_es7"><a class="anchor" href="#_什么是halo_es7"></a><a class="link" href="#_什么是halo_es7">46.1. 什么是Halo ES7</a></h3>
<div class="literalblock">
<div class="content">
<pre>Halo ES7是基于ES的7.2.1版本封装的Spring Boot Starter。支持设置多个ES Server的地址，可以设置timeout和socket timeout,开箱即用,通过依赖注入RestHighLevelClient即可操作ES7.</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_使用halo_es7"><a class="anchor" href="#_使用halo_es7"></a><a class="link" href="#_使用halo_es7">46.2. 使用Halo ES7</a></h3>
<div class="sect3">
<h4 id="_maven引入halo_es7"><a class="anchor" href="#_maven引入halo_es7"></a><a class="link" href="#_maven引入halo_es7">46.2.1. Maven引入Halo ES7</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>引入Halo ElasticSearch依赖。有两种方式</p>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在需要使用的工程模块中,引入 Halo Elastic Search6 模块即可</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>halo-starter-es7<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>

<span class="comment">&lt;!-- 显示引入elasticsearch 7.2.1 --&gt;</span> # <b class="conum">(1)</b>
<span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.elasticsearch<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>elasticsearch<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>7.2.1<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>由于Halo Framework基于Spring Boot 2.0.8版本开发，spring-boot-dependencies中内置了elasticsearch的version为5.1.64因此需要强制引入排除低版本,可以查看 <a href="https://github.com/spring-projects/spring-boot/blob/v2.0.8.RELEASE/spring-boot-project/spring-boot-dependencies/pom.xml" target="_blank" rel="noopener">spring-boot-dependencies 2.0.8中的ES版本</a></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_在属性文件yml或properties配置halo_es"><a class="anchor" href="#_在属性文件yml或properties配置halo_es"></a><a class="link" href="#_在属性文件yml或properties配置halo_es">46.2.2. 在属性文件yml或properties配置Halo ES</a></h4>
<div class="paragraph">
<p>在yml文件中配置如下信息,使用Halo ES7</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">es</span>:
    <span class="key">hosts</span>:
      - <span class="string"><span class="content">10.81.164.95:9200  </span></span># <b class="conum">(1)</b>
      - <span class="string"><span class="content">10.81.164.95:9200</span></span>  # <b class="conum">(2)</b>
    <span class="comment">#time-out: 1000         </span># <b class="conum">(3)</b>
    <span class="comment">#socket-timeout: 30000  </span># <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Elastic Search 7.2.1 机器1</p>
</li>
<li>
<p>Elastic Search 7.2.1 机器2</p>
</li>
<li>
<p>Elastic Search连接超时时间默认1s,非必填,可自定义设置</p>
</li>
<li>
<p>Elastic Search Socket超时时间默认30s,非必填,可以自定义设置</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>[NOTE]ES 7.2.1 更多自定义设置可以参考如下文档链接。
<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.2/_timeouts.html" class="bare">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.2/_timeouts.html</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_使用resthighlevelclient操作es7"><a class="anchor" href="#_使用resthighlevelclient操作es7"></a><a class="link" href="#_使用resthighlevelclient操作es7">46.2.3. 使用RestHighLevelClient操作ES7</a></h4>
<div class="paragraph">
<p>使用RestHighLevelClient操作ES7,具体可以看官方API文档，文档地址如下所示:</p>
</div>
<div class="paragraph">
<p><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.2/java-rest-high.html" class="bare">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.2/java-rest-high.html</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-job"><a class="anchor" href="#halo-job"></a><a class="link" href="#halo-job">47. Halo Job</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_halo_job的功能"><a class="anchor" href="#_halo_job的功能"></a><a class="link" href="#_halo_job的功能">47.1. Halo Job的功能</a></h3>
<div class="paragraph">
<p>halo job主要对xxl-job-core包简单封装成spring boot starter，方便通过Spring Boot方式开发xxl-job的executor</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Halo Job基于xxl-job的2.0.2封装，使用的时候，请注意check对应的Server端版本。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_halo_job的使用"><a class="anchor" href="#_halo_job的使用"></a><a class="link" href="#_halo_job的使用">47.2. halo job的使用</a></h3>
<div class="sect3">
<h4 id="_maven引入_3"><a class="anchor" href="#_maven引入_3"></a><a class="link" href="#_maven引入_3">47.2.1. Maven引入</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>引入Halo-job依赖。有两种方式</p>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在需要使用的工程模块中,引入 halo job 模块即可</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-job<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_halo_job的使用_2"><a class="anchor" href="#_halo_job的使用_2"></a><a class="link" href="#_halo_job的使用_2">47.3. halo job的使用</a></h3>
<div class="sect3">
<h4 id="_xxl_job可用环境"><a class="anchor" href="#_xxl_job可用环境"></a><a class="link" href="#_xxl_job可用环境">47.3.1. xxl-job可用环境</a></h4>
<div class="literalblock">
<div class="content">
<pre>xxl-job的可用环境填写对应的即可，示例如下所示:</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>UAT环境:</p>
<div class="literalblock">
<div class="content">
<pre>http://localhost:8080/xxl-job-admin/</pre>
</div>
</div>
</li>
<li>
<p>生产环境:</p>
<div class="literalblock">
<div class="content">
<pre>http://localhost:8080/xxl-job-admin</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_修改xxl_job配置"><a class="anchor" href="#_修改xxl_job配置"></a><a class="link" href="#_修改xxl_job配置">47.3.2. 修改xxl-job配置</a></h4>
<div class="paragraph">
<p>添加以下xxl-job配置，也可不配置，不配置则使用默认值。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo.job</span>:
  <span class="key">admin</span>:
    <span class="key">admin-addresses</span>: <span class="string"><span class="content">http://localhost:8080/xxl-job-admin</span></span>
  <span class="key">executor</span>:
    <span class="key">app-name</span>: <span class="string"><span class="content">xxl-job-spring-boot-starter-example</span></span> <span class="comment">#默认为 xxl-job-executor</span>
    <span class="key">access-token</span>: <span class="comment">#默认为空</span>
    <span class="key">log-path</span>: <span class="string"><span class="content">logs/applogs/xxl-job/jobhandler</span></span> <span class="comment">#默认为 logs/applogs/xxl-job/jobhandler</span>
    <span class="key">log-retention-days</span>: <span class="string"><span class="content">10</span></span> <span class="comment">#默认为 10</span>
    <span class="key">ip</span>: <span class="comment">#默认为空</span>
    <span class="key">port</span>: <span class="string"><span class="content">9999</span></span> <span class="comment">#默认为 9999</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_定义job执行器"><a class="anchor" href="#_定义job执行器"></a><a class="link" href="#_定义job执行器">47.3.3. 定义Job执行器</a></h4>
<div class="paragraph">
<p>示例Job执行器代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JobHandler</span>(value=<span class="string"><span class="delimiter">&quot;</span><span class="content">haloJobHandler</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">HaloJobHandler</span> <span class="directive">extends</span> IJobHandler {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ReturnT&lt;<span class="predefined-type">String</span>&gt; execute(<span class="predefined-type">String</span> param) <span class="directive">throws</span> <span class="exception">Exception</span> {
        XxlJobLogger.log(<span class="string"><span class="delimiter">&quot;</span><span class="content">XXL-JOB, Hello World.</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">5</span>; i++) {
            XxlJobLogger.log(<span class="string"><span class="delimiter">&quot;</span><span class="content">beat at:</span><span class="delimiter">&quot;</span></span> + i);
            <span class="predefined-type">TimeUnit</span>.SECONDS.sleep(<span class="integer">2</span>);
        }
        <span class="keyword">return</span> SUCCESS;
    }

}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-alimq"><a class="anchor" href="#halo-alimq"></a><a class="link" href="#halo-alimq">48. Halo AliMQ</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_halo_alimq的功能"><a class="anchor" href="#_halo_alimq的功能"></a><a class="link" href="#_halo_alimq的功能">48.1. Halo AliMQ的功能</a></h3>
<div class="paragraph">
<p>Halo AliMQ对阿里的RocketMQ进行封装，通过配置化的方式和Spring Boot进行集成。为RocketMQ提供的消息类型提供全面支持，</p>
</div>
<div class="paragraph">
<p>包括：普通消息、定时和延时消息、顺序消息、事务消息。</p>
</div>
</div>
<div class="sect2">
<h3 id="_rocketmq介绍"><a class="anchor" href="#_rocketmq介绍"></a><a class="link" href="#_rocketmq介绍">48.2. RocketMQ介绍</a></h3>
<div class="paragraph">
<p>请参考 <a href="https://help.aliyun.com/document_detail/29532.html?spm=5176.234368.1277512.1.821fdb257qi9J8&amp;aly_as=1HUb9GNE">阿里云官方文档</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_halo_alimq的使用"><a class="anchor" href="#_halo_alimq的使用"></a><a class="link" href="#_halo_alimq的使用">48.3. Halo AliMQ的使用</a></h3>
<div class="sect3">
<h4 id="_maven引入_4"><a class="anchor" href="#_maven引入_4"></a><a class="link" href="#_maven引入_4">48.3.1. Maven引入</a></h4>
<div class="paragraph">
<p>1、 引入halo-alimq依赖。有两种方式</p>
</div>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>2、 在需要使用的工程模块中,引入 halo-alimq 模块即可</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-alimq<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_配置_4"><a class="anchor" href="#_配置_4"></a><a class="link" href="#_配置_4">48.3.2. 配置</a></h4>
<div class="paragraph">
<p>Halo AliMQ相关配置属性在halo.alimq命名空间下。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>生产者配置</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>halo:
  alimq:
    enabled: true # 启用Halo AliMQ总开关，默认启用
    namesrv-addr: http://onsaddr.xxxx.mq-internal.aliyuncs.com:8080 # 公共配置
    access-key: LTAI4FofsQVbk # 公共配置
    secret-key: EOMlH59FGBHVz # 公共配置
    group-id: GID_PRODUCER_XUJIN_TEST # 公共配置
    producer: # 普通消息、定时和延时消息 生产者
      enabled: true # 普通消息、定时和延时消息 生产者开关，默认不启用
      access-key: LTAI4FofXsQVbk # 配置则覆盖公共配置，未配则用公共配置
      secret-key: EOMlHeFbMm159 # 配置则覆盖公共配置，未配则用公共配置
      group-id: GID_PRODUCER_XUJIN_TEST # 配置则覆盖公共配置，未配则用公共配置
    orderproducer: # 顺序消息生产者
          enabled: true # 顺序消息生产者开关，默认不启用
          access-key: LTAI4Vbk # 配置则覆盖公共配置，未配则用公共配置
          secret-key: EOMl59HVz # 配置则覆盖公共配置，未配则用公共配置
          group-id: GID_PRODUCER_XUJIN_TEST # 配置则覆盖公共配置，未配则用公共配置
    transactionproducer: #事务消息生产者
      enabled: true # 事务消息生产者开关，默认不启用
      access-key: LTAIQVbk # 配置则覆盖公共配置，未配则用公共配置
      secret-key: EOMlHeF3 # 配置则覆盖公共配置，未配则用公共配置
      group-id: GID_PRODUCER_XUJIN_TEST # 配置则覆盖公共配置，未配则用公共配置
      local-transaction-checker: org.xujin.alimq.provider.producer.LocalTransactionCheckerImpl # 回查本地事务接口实现，由Broker回调Producer</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>消费者配置</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">alimq</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span> <span class="comment"># 启用Halo AliMQ总开关，默认启用</span>
    <span class="key">namesrv-addr</span>: <span class="string"><span class="content">http://onsaddr.xxxxxxxx.aliyuncs.com:8080</span></span> <span class="comment"># 公共配置</span>
    <span class="key">access-key</span>: <span class="string"><span class="content">LTAI4Fs</span></span> <span class="comment"># 公共配置</span>
    <span class="key">secret-key</span>: <span class="string"><span class="content">f1gpL4</span></span> <span class="comment"># 公共配置</span>
    <span class="key">group-id</span>: <span class="string"><span class="content">GID_CONSUMER_XUJIN_TEST</span></span> <span class="comment"># 公共配置</span>
    <span class="key">consumer</span>: <span class="comment"># 普通消息、定时和延时消息、事务消息 消费者</span>
      <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span> <span class="comment"># 普通消息、定时和延时消息、事务消息 消费者开关，默认不开启</span>
      <span class="key">access-key</span>: <span class="string"><span class="content">LTAI4F</span></span> <span class="comment"># 配置则覆盖公共配置，未配则用公共配置</span>
      <span class="key">secret-key</span>: <span class="string"><span class="content">f1gpL4</span></span> <span class="comment"># 配置则覆盖公共配置，未配则用公共配置</span>
      <span class="key">group-id</span>: <span class="string"><span class="content">GID_CONSUMER_XUJIN_TEST</span></span> <span class="comment"># 配置则覆盖公共配置，未配则用公共配置</span>
    <span class="key">orderconsumer</span>: <span class="comment"># 顺序消息消费者</span>
      <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span> <span class="comment"># 顺序消息消费者开关，默认不开启</span>
      <span class="key">access-key</span>: <span class="string"><span class="content">LTAI4Fs</span></span> <span class="comment"># 配置则覆盖公共配置，未配则用公共配置</span>
      <span class="key">secret-key</span>: <span class="string"><span class="content">f1gpL4U</span></span> <span class="comment"># 配置则覆盖公共配置，未配则用公共配置</span>
      <span class="key">group-id</span>: <span class="string"><span class="content">GID_CONSUMER_XUJIN_TEST</span></span> <span class="comment"># 配置则覆盖公共配置，未配则用公共配置</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
按需配置：用到哪种类型的消息，配置该消息类型对应的生产者、消费者，不用的不要开启，以免发生意想不到的错误。
对同一个topic，普通消息（包含定时和延时消息）、顺序消息、事务消息不要混用，以免发生意想不到的错误。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_使用"><a class="anchor" href="#_使用"></a><a class="link" href="#_使用">48.3.3. 使用</a></h4>
<div class="sect4">
<h5 id="_生产者"><a class="anchor" href="#_生产者"></a><a class="link" href="#_生产者">48.3.3.1. 生产者</a></h5>
<div class="paragraph">
<p>配置后，对应消息类型的生产者bean会自动装配。使用时，只需在代码中注入对应的bean即可。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>普通消息、定时和延时消息生产者</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Autowired</span>
<span class="directive">private</span> com.aliyun.openservices.ons.api.Producer producer;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>顺序消息生产者</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Autowired</span>
<span class="directive">private</span> com.aliyun.openservices.ons.api.order.OrderProducer orderProducer;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>事务消息生产者</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Autowired</span>
<span class="directive">private</span> com.aliyun.openservices.ons.api.transaction.TransactionProducer transactionProducer;</code></pre>
</div>
</div>
<div class="paragraph">
<p>注入生产者bean之后，组装Message实例，通过生产者bean的send方法即可发送消息。</p>
</div>
</div>
<div class="sect4">
<h5 id="_消费者"><a class="anchor" href="#_消费者"></a><a class="link" href="#_消费者">48.3.3.2. 消费者</a></h5>
<div class="paragraph">
<p>消费消息时，普通消息、定时和延时消息、事务消息消费者需实现MessageListener，</p>
</div>
<div class="paragraph">
<p>顺序消息消费者需实现MessageOrderListener。</p>
</div>
<div class="paragraph">
<p>并在Listener实现类加上@AliMqMessageListener注解，通过该注解可以指定Topic和Tag。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>普通消息、定时和延时消息、事务消息消费者</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.aliyun.openservices.ons.api.Action</span>;
<span class="keyword">import</span> <span class="include">com.aliyun.openservices.ons.api.ConsumeContext</span>;
<span class="keyword">import</span> <span class="include">com.aliyun.openservices.ons.api.Message</span>;
<span class="keyword">import</span> <span class="include">com.aliyun.openservices.ons.api.MessageListener</span>;

<span class="annotation">@AliMqMessageListener</span>(topic = <span class="string"><span class="delimiter">&quot;</span><span class="content">HALO_XUJIN_TEST</span><span class="delimiter">&quot;</span></span>, tags = {<span class="string"><span class="delimiter">&quot;</span><span class="content">tag1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">tag2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">tag3</span><span class="delimiter">&quot;</span></span>})
<span class="directive">public</span> <span class="type">class</span> <span class="class">ConsumerTest</span> <span class="directive">implements</span> MessageListener {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Action</span> consume(Message message, ConsumeContext context) {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Receive: </span><span class="delimiter">&quot;</span></span> + message.getTopic() + <span class="string"><span class="delimiter">&quot;</span><span class="content">, </span><span class="delimiter">&quot;</span></span> + <span class="keyword">new</span> <span class="predefined-type">String</span>(message.getBody()));
        <span class="keyword">return</span> <span class="predefined-type">Action</span>.CommitMessage;
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>顺序消息消费者</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.aliyun.openservices.ons.api.Message</span>;
<span class="keyword">import</span> <span class="include">com.aliyun.openservices.ons.api.order.ConsumeOrderContext</span>;
<span class="keyword">import</span> <span class="include">com.aliyun.openservices.ons.api.order.MessageOrderListener</span>;
<span class="keyword">import</span> <span class="include">com.aliyun.openservices.ons.api.order.OrderAction</span>;

<span class="annotation">@AliMqMessageListener</span>(topic = <span class="string"><span class="delimiter">&quot;</span><span class="content">HALO_XUJIN_TEST</span><span class="delimiter">&quot;</span></span>, tags = {<span class="string"><span class="delimiter">&quot;</span><span class="content">tag1</span><span class="delimiter">&quot;</span></span>})
<span class="directive">public</span> <span class="type">class</span> <span class="class">OrderConsumerTest</span> <span class="directive">implements</span> MessageOrderListener {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> OrderAction consume(Message message, ConsumeOrderContext context) {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Receive order msg: </span><span class="delimiter">&quot;</span></span> + message.getTopic() + <span class="string"><span class="delimiter">&quot;</span><span class="content">, </span><span class="delimiter">&quot;</span></span> + <span class="keyword">new</span> <span class="predefined-type">String</span>(message.getBody()));
        <span class="keyword">return</span> OrderAction.Success;
    }

}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-redis"><a class="anchor" href="#halo-redis"></a><a class="link" href="#halo-redis">49. Halo Redis</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_halo_redis的功能"><a class="anchor" href="#_halo_redis的功能"></a><a class="link" href="#_halo_redis的功能">49.1. Halo Redis的功能</a></h3>
<div class="paragraph">
<p>Halo Redis基于spring-data-redis，并集成了Redisson，简单封装成spring boot starter。</p>
</div>
<div class="paragraph">
<p>在方便使用RedisTemplate/StringRedisTemplate的同时，可以直接使用由RedissonClient提供的强大分布式对象、分布式服务等功能。</p>
</div>
</div>
<div class="sect2">
<h3 id="_redisson介绍"><a class="anchor" href="#_redisson介绍"></a><a class="link" href="#_redisson介绍">49.2. Redisson介绍</a></h3>
<div class="paragraph">
<p>Redisson是Redis官网推荐的一款Java Redis客户端，相关文档请参考 <a href="https://github.com/redisson/redisson/wiki/1.-%E6%A6%82%E8%BF%B0">Redisson Wiki</a>。</p>
</div>
<div class="paragraph">
<p>鉴于Redisson提供的强大功能，Halo Redis并没有选择Jedis、Lettuce这两款由Spring直接支持的Redis客户端。</p>
</div>
<div class="paragraph">
<p>通过Redisson，可以方便的使用队列、分布式锁、限流器等基于Redis的分布式组件。</p>
</div>
</div>
<div class="sect2">
<h3 id="_halo_redis的使用"><a class="anchor" href="#_halo_redis的使用"></a><a class="link" href="#_halo_redis的使用">49.3. Halo Redis的使用</a></h3>
<div class="sect3">
<h4 id="_maven引入_5"><a class="anchor" href="#_maven引入_5"></a><a class="link" href="#_maven引入_5">49.3.1. Maven引入</a></h4>
<div class="paragraph">
<p>1、 引入halo-redis依赖。有两种方式</p>
</div>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>2、 在需要使用的工程模块中,引入 halo-redis 模块即可</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-redis<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_配置_5"><a class="anchor" href="#_配置_5"></a><a class="link" href="#_配置_5">49.3.2. 配置</a></h4>
<div class="paragraph">
<p>Halo Redis的配置方式与 <a href="https://docs.spring.io/spring-boot/docs/2.0.8.RELEASE/reference/htmlsingle/#boot-features-redis">Spring</a>官方的配置方式保持一致，目前支持
单节点模式、哨兵模式和集群模式。</p>
</div>
<div class="paragraph">
<p>在Spring Redis配置的基础上，提供了Redisson的扩展配置。这些扩展属性在halo.redis.redisson命名空间下。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>单节点模式配置示例</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">spring</span>:
  <span class="key">redis</span>:
    <span class="key">host</span>: <span class="string"><span class="content">10.168.29.11</span></span>
    <span class="key">database</span>: <span class="string"><span class="content">5</span></span>
    <span class="key">port</span>: <span class="string"><span class="content">6379</span></span>
    <span class="key">password</span>: <span class="error">***</span>
    <span class="key">timeout</span>: <span class="string"><span class="content">5000</span></span>
<span class="key">halo</span>:
  <span class="key">redis</span>:
    <span class="key">redisson</span>:
      <span class="key">single-server-config</span>: <span class="comment">#单节点模式相关配置</span>
        <span class="key">connection-minimum-idle-size</span>: <span class="string"><span class="content">10</span></span>
        <span class="key">connection-pool-size</span>: <span class="string"><span class="content">64</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_halo_redis工具类"><a class="anchor" href="#_halo_redis工具类"></a><a class="link" href="#_halo_redis工具类">49.4. Halo Redis工具类</a></h3>
<div class="sect3">
<h4 id="_防重复提交验证器"><a class="anchor" href="#_防重复提交验证器"></a><a class="link" href="#_防重复提交验证器">49.4.1. 防重复提交验证器</a></h4>
<div class="paragraph">
<p>Web层应用在和浏览器交互时，由于网络抖动、用户重复点击提交等原因，应用会在短时间内收到多条重复请求，
如果接口没有做幂等处理，或者接口比较耗时，会造成业务重复处理、服务性能下降等相关问题。</p>
</div>
<div class="paragraph">
<p>鉴于该需求比较普遍，Halo Redis提供了开箱即用的防重复提交验证器组件（本质上是一种特殊的限流器）。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>配置：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>halo:
  redis:
    submitvalidator:
      enabled: true #默认开启</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>使用</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@Autowired
private SubmitValidator submitValidator;

//验证
boolean resubmit = submitValidator.isResubmit("业务key", "业务唯一ID", 20);
if(resubmit){
    return ResultData.fail("400", "提交太频繁");
}
//todo 正常业务逻辑</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>接口说明</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>/**
 * Desc: 防重复提交校验器
 *
 * @author yage.luan
 * @date 2019/10/28 19:48
 **/
public interface SubmitValidator {

    /**
     * 是否在指定时间内重复提交
     *
     * @param bizKey 业务key
     * @param uid    同类业务中的唯一id标识符
     * @return 在过期时间内该请求是否重复提交
     * @see SubmitValidatorProperties#getExpireTime()
     * @see SubmitValidatorProperties#DEFAULT_EXPIRE_TIME
     */
    boolean isResubmit(String bizKey, String uid);


    /**
     * 是否在指定时间内重复提交
     *
     * @param bizKey     业务key
     * @param uid        同类业务中的唯一id标识符
     * @param expireTime 过期时间 单位：秒
     * @return 在过期时间内该请求是否重复提交
     * @see SubmitValidatorProperties#getExpireTime()
     * @see SubmitValidatorProperties#DEFAULT_EXPIRE_TIME
     */
    boolean isResubmit(String bizKey, String uid, Integer expireTime);
}</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-apollo"><a class="anchor" href="#halo-apollo"></a><a class="link" href="#halo-apollo">50. Halo Apollo</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_什么是halo_apollo"><a class="anchor" href="#_什么是halo_apollo"></a><a class="link" href="#_什么是halo_apollo">50.1. 什么是Halo Apollo</a></h3>
<div class="literalblock">
<div class="content">
<pre>Halo Apollo是对携程配置中心增量的封装处理,把Apollo的app.id,env等环境参数与Spring Boot参数统一.</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_halo_apollo的功能"><a class="anchor" href="#_halo_apollo的功能"></a><a class="link" href="#_halo_apollo的功能">50.2. Halo Apollo的功能</a></h3>
<div class="literalblock">
<div class="content">
<pre>Halo Apollo的功能如下所示:</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>为项目开发提供配置管理服务</p>
</li>
<li>
<p>使用标准的spring.profiles.active来区分环境，自动为ConfigCenter客户端设置env和meta地址</p>
</li>
<li>
<p>开发人员主要引入包就可以从配置中心读取配置(默认访问开发环境)，不用关心Apollo的环境设置问题.</p>
</li>
<li>
<p>统一Apollo中的AppId,当没有设置AppId时,默认取Spring Application Name作为Appid,设置了AppId则使用Appid.</p>
</li>
<li>
<p>内置基础架构或者中间件团队的namespace</p>
<div class="ulist">
<ul>
<li>
<p>Apollo Namespace 有三种类型，私有类型，公共类型，关联类型（继承类型）.关联类型又可称为继承类型，
关联类型具有 private 权限。关联类型的 Namespace 继承于公共类型的 Namespace，用于覆盖公共 Namespace 的某些配置。
 使用建议如下:</p>
</li>
<li>
<p>基础框架部分的统一配置，如 DAL 的常用配置</p>
</li>
<li>
<p>基础架构的公共组件的配置，如监控，熔断等公共组件配置</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
spring.profiles.active有DEV、FAT、UAT、PRO四个选项，通过-D传入，如果不传入，默认为DEV
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_使用halo_apollo"><a class="anchor" href="#_使用halo_apollo"></a><a class="link" href="#_使用halo_apollo">50.3. 使用Halo Apollo</a></h3>
<div class="sect3">
<h4 id="_maven引入_6"><a class="anchor" href="#_maven引入_6"></a><a class="link" href="#_maven引入_6">50.3.1. Maven引入</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>引入Halo Apollo依赖。有两种方式</p>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在需要使用的工程模块中,引入 Apollo 模块即可</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-apollo<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_halo_apollo的最佳实践"><a class="anchor" href="#_halo_apollo的最佳实践"></a><a class="link" href="#_halo_apollo的最佳实践">50.4. Halo Apollo的最佳实践</a></h3>
<div class="paragraph">
<p>支持 Apollo 配置自动刷新类型，支持 @Value @RefreshScope @ConfigurationProperties 以及日志级别的动态刷新.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@Value: Apollo 本身就支持了动态刷新.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">${simple.xxx}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">String</span> simpleXxx;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
上述代码刷新没有问题
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{'${simple.xxx}'.split(',')}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; simpleXxxs;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
需要注意的是如果@Value 使用了 SpEL 表达式，动态刷新会失效。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>更多参考内容:
<a href="https://mp.weixin.qq.com/s?__biz=MzIwMDY0Nzk2Mw==&amp;mid=2650320780&amp;idx=1&amp;sn=097e8d8cac2426489efaa11f613a2bf5" class="bare">https://mp.weixin.qq.com/s?__biz=MzIwMDY0Nzk2Mw==&amp;mid=2650320780&amp;idx=1&amp;sn=097e8d8cac2426489efaa11f613a2bf5</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-shiro"><a class="anchor" href="#halo-shiro"></a><a class="link" href="#halo-shiro">51. Halo Shiro</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_什么是halo_shiro"><a class="anchor" href="#_什么是halo_shiro"></a><a class="link" href="#_什么是halo_shiro">51.1. 什么是Halo Shiro</a></h3>
<div class="paragraph">
<p>Spring boot中使用shiro大都是通过shiro-spring.jar进行的整合的,虽然不是太复杂，但是也无法做到spring-boot-starter风格的开箱即用。项目中经常用到的功能比如：验证码、密码错误次数限制、账号唯一用户登陆、动态URL过滤规则、无状态鉴权等等，shiro还没有直接提供支持。</p>
</div>
<div class="paragraph">
<p>Halo Shiro对这些常用的功能进行了封装和自动导入实现开箱即用。</p>
</div>
</div>
<div class="sect2">
<h3 id="_halo_shiro的功能"><a class="anchor" href="#_halo_shiro的功能"></a><a class="link" href="#_halo_shiro的功能">51.2. Halo Shiro的功能</a></h3>
<div class="literalblock">
<div class="content">
<pre>Halo Shiro的功能如下所示:</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>spring-boot-starter风格的开箱即用。</p>
</li>
<li>
<p>区分ajax请求和普通请求，普通请求通过跳转来响应未登陆和未授权，AJAX请求通过状态码和消息响应未登陆和未授权。</p>
</li>
<li>
<p>集成jcaptcha验证码。</p>
</li>
<li>
<p>密码输入错误，重试次数限制。</p>
</li>
<li>
<p>账号唯一用户登陆，一个账号只允许一个用户登陆。</p>
</li>
<li>
<p>与SpringCache无缝对接，支持guava、ehcache、redis等。</p>
</li>
<li>
<p>提供认证\授权缓存数据同步接口，即时生效。</p>
</li>
<li>
<p>支持动态URL过滤规则。</p>
</li>
<li>
<p>无状态认证授权支持，共存有状态和无状态两种鉴权方式，无状态鉴权支持JWT(JSON WEB TOKEN)、HMAC(哈希消息认证码)两种协议。</p>
</li>
<li>
<p>在线session管理，强制用户下线功能。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_使用halo_shiro"><a class="anchor" href="#_使用halo_shiro"></a><a class="link" href="#_使用halo_shiro">51.3. 使用Halo Shiro</a></h3>
<div class="sect3">
<h4 id="_maven引入_7"><a class="anchor" href="#_maven引入_7"></a><a class="link" href="#_maven引入_7">51.3.1. Maven引入</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>引入Halo Shiro依赖。有两种方式</p>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"> <span class="tag">&lt;parent&gt;</span>
<span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
<span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
 <span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在需要使用的工程模块中,引入 Apollo 模块即可</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-shiro<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_功能使用"><a class="anchor" href="#_功能使用"></a><a class="link" href="#_功能使用">51.4. 功能使用</a></h3>
<div class="sect3">
<h4 id="_对接ldap"><a class="anchor" href="#_对接ldap"></a><a class="link" href="#_对接ldap">51.4.1. 对接LDAP</a></h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">shiro</span>:
    <span class="key">ldapRealmEnabled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">apiUrl</span>: <span class="string"><span class="content">/api/**</span></span>
    <span class="key">loginUrl</span>: <span class="string"><span class="content">/admin/login</span></span>
    <span class="key">unauthorizedUrl</span>: <span class="string"><span class="content">/403</span></span>
    <span class="key">ldapUrl</span>: <span class="string"><span class="content">ldap://ldap.xxx.com</span></span>
    <span class="key">ldap-dn-template</span>: <span class="string"><span class="content">uid={0},ou=staff,dc=xxoxs,dc=cc</span></span>
    <span class="key">jwt-filter-url</span>: <span class="string"><span class="content">/admin/**</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_对接db通过用户名和密码"><a class="anchor" href="#_对接db通过用户名和密码"></a><a class="link" href="#_对接db通过用户名和密码">51.4.2. 对接DB(通过用户名和密码)</a></h4>
<div class="paragraph">
<p>1.开启Shiro对接DbRealm,如下面yml文件所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">shiro</span>:
    <span class="key">apiUrl</span>: <span class="string"><span class="content">/api/**</span></span>
    <span class="key">loginUrl</span>: <span class="string"><span class="content">/admin/login</span></span>
    <span class="key">unauthorizedUrl</span>: <span class="string"><span class="content">/403</span></span>
    <span class="key">jwt-filter-url</span>: <span class="string"><span class="content">/admin/**</span></span>
    <span class="key">d-b-realm-enabled</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>2.实现ShiroAccountProvider接口对接当前系统,查询用户,权限,角色,示例代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Service</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AccountProviderImpl</span> <span class="directive">implements</span> ShiroAccountProvider {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> RoleMapper roleMapper;

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> UserRolesMapper userRolesMapper;

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> PermissionMapper permissionMapper;

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> RolePermissionMapper rolePermissionMapper;

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> UserMapper userMapper;


    <span class="annotation">@Override</span>
    <span class="directive">public</span> Account loadAccount(<span class="predefined-type">String</span> account) <span class="directive">throws</span> <span class="exception">AuthenticationException</span> {
        UserDO userDO=userMapper.findUserByUserName(account);
        <span class="keyword">if</span>(<span class="predefined-constant">null</span> == userDO){
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">AuthenticationException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">账号或密码错误</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="keyword">return</span> userDO;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; loadRoles(<span class="predefined-type">String</span> account) {
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; userRoles = userRolesMapper.findUserRoles(account);
        <span class="keyword">if</span> (CollectionUtils.isEmpty(userRoles)) {
            userRoles = Lists.newArrayList(UserRoleEnum.USER.getRole());
        }
        <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; validRoles = roleMapper.findValidRoles(userRoles)
                .stream()
                .map(RoleDO::getKey)
                .collect(Collectors.toSet());

        <span class="keyword">if</span> (inBlackList(validRoles)) {
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        }
        <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">HashSet</span>(validRoles);
    }

    <span class="directive">protected</span> <span class="type">boolean</span> inBlackList(<span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; roles) {
        <span class="keyword">return</span> roles.contains(UserRoleEnum.BLACK.getRole());
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; loadPermissions(<span class="predefined-type">String</span> account) {
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; loadPermissions(<span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; validRoles) {
        <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Long</span>&gt; permissionIds = rolePermissionMapper.findPermissionByRoles(validRoles)
                .stream().map(RolePermissionDO::getPermissionId).collect(Collectors.toSet());

        <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; permissions = permissionMapper.findValidPermissions(permissionIds)
                .stream().map(PermissionDO::getPermission).collect(Collectors.toSet());
        <span class="keyword">return</span> permissions;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>3.登录Controller代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RestController</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/admin</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Api</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">用户登录</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">LoginController</span> {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> CommandBus commandBus;

    <span class="annotation">@PostMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/login</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> ResultData&lt;LogInCO&gt; login(<span class="annotation">@RequestBody</span> LoginUserCmd loginUserCmd) {
        <span class="keyword">return</span> commandBus.send(loginUserCmd);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>4.登录命令执行代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@CmdHandler</span>
<span class="annotation">@Slf4j</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">LoginUserCmdExe</span> <span class="directive">implements</span> CommandExecutorI&lt;ResultData&lt;LogInCO&gt;, LoginUserCmd&gt; {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> EventBus eventBus;


    <span class="annotation">@Override</span>
    <span class="directive">public</span> ResultData&lt;LogInCO&gt; execute(LoginUserCmd loginUserCmd) {
        ResultData&lt;LogInCO&gt; resultData = <span class="keyword">new</span> ResultData&lt;&gt;();
        <span class="keyword">if</span> (<span class="predefined-constant">null</span>==loginUserCmd) {
            resultData.setMsgCode(<span class="string"><span class="delimiter">&quot;</span><span class="content">401</span><span class="delimiter">&quot;</span></span>);
            resultData.setMsgContent(<span class="string"><span class="delimiter">&quot;</span><span class="content">login failed</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">return</span> resultData;
        }
        <span class="predefined-type">String</span> username=loginUserCmd.getUsername();
        <span class="predefined-type">String</span> password=loginUserCmd.getPassword();
        <span class="keyword">if</span> (StringUtils.isBlank(username) || StringUtils.isBlank(password)) {
            resultData.setMsgCode(<span class="string"><span class="delimiter">&quot;</span><span class="content">401</span><span class="delimiter">&quot;</span></span>);
            resultData.setMsgContent(<span class="string"><span class="delimiter">&quot;</span><span class="content">login failed</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">return</span> resultData;
        }
        username = username.trim();
        <span class="keyword">try</span> {
            UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(username, password);
            <span class="predefined-type">Subject</span> subject = SecurityUtils.getSubject();
            subject.login(token);
            LogInCO logInCO = <span class="keyword">new</span> LogInCO().setUsername(username).setToken(JwtUtil.createToken(username));
            resultData.setData(logInCO);
            <span class="keyword">try</span> {
                createUserByEvent(username,password);
            } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
               log.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">create user by event fail:{}</span><span class="delimiter">&quot;</span></span>,e);
            }
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
            resultData.setMsgCode(<span class="string"><span class="delimiter">&quot;</span><span class="content">401</span><span class="delimiter">&quot;</span></span>);
            resultData.setMsgContent(<span class="string"><span class="delimiter">&quot;</span><span class="content">login failed</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">return</span> resultData;
        }
        <span class="keyword">return</span> resultData;
    }

    <span class="directive">private</span> <span class="type">void</span> createUserByEvent(<span class="predefined-type">String</span> username,<span class="predefined-type">String</span> password) {
        CreateUserEvent createUserEvent=<span class="keyword">new</span> CreateUserEvent();
        createUserEvent.setUserName(username);
        createUserEvent.setPassword(password);
        createUserEvent.setRole(<span class="string"><span class="delimiter">&quot;</span><span class="content">USER</span><span class="delimiter">&quot;</span></span>);
        eventBus.asyncPublishEvent(createUserEvent);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_关闭halo_shiro"><a class="anchor" href="#_关闭halo_shiro"></a><a class="link" href="#_关闭halo_shiro">51.4.3. 关闭Halo Shiro</a></h4>
<div class="paragraph">
<p>当引入Halo Shiro的Starter之后,可以通过yml文件相关配置关闭Halo Shiro的功能,如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">shiro</span>:
    <span class="key">apiUrl</span>: <span class="string"><span class="content">/api/**</span></span>
    <span class="key">loginUrl</span>: <span class="string"><span class="content">/admin/login</span></span>
    <span class="key">unauthorizedUrl</span>: <span class="string"><span class="content">/403</span></span>
    <span class="key">jwt-filter-url</span>: <span class="string"><span class="content">/admin/**</span></span>
    <span class="key">d-b-realm-enabled</span>: <span class="string"><span class="content">false </span></span># <b class="conum">(1)</b>
    <span class="key">jwt-filter-url</span>: <span class="string"><span class="content">/admin/**</span></span>
    <span class="key">jwt-filter-enabled</span>: <span class="string"><span class="content">false </span></span># <b class="conum">(2)</b>
    <span class="key">shiroAnnoEnabled</span>: <span class="string"><span class="content">false  </span></span># <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>关闭dbRealm</p>
</li>
<li>
<p>关闭JwtFilter</p>
</li>
<li>
<p>关闭shiro中的注解</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-influxDB"><a class="anchor" href="#halo-influxDB"></a><a class="link" href="#halo-influxDB">52. Halo influxDB</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_halo_influxdb的功能"><a class="anchor" href="#_halo_influxdb的功能"></a><a class="link" href="#_halo_influxdb的功能">52.1. Halo influxDB的功能</a></h3>
<div class="paragraph">
<p>halo influxDB主要对influxDB-java进行封装，功能如下所示:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>支持是否开启okhttpClient作为底层的查询客户端</p>
</li>
<li>
<p>当开启okHttpClient时，支持自定义配置连接参数</p>
</li>
<li>
<p>提供InfluxDBTemplate并封装常用的操作</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_halo_influxdb的使用"><a class="anchor" href="#_halo_influxdb的使用"></a><a class="link" href="#_halo_influxdb的使用">52.2. halo influxdb的使用</a></h3>
<div class="sect3">
<h4 id="_maven引入_8"><a class="anchor" href="#_maven引入_8"></a><a class="link" href="#_maven引入_8">52.2.1. Maven引入</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>引入halo-influxdb依赖。有两种方式</p>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在需要使用的工程模块中,引入 halo influxdb 模块即可</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-influxdb<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_halo_influxdb的使用_2"><a class="anchor" href="#_halo_influxdb的使用_2"></a><a class="link" href="#_halo_influxdb的使用_2">52.3. halo influxdb的使用</a></h3>
<div class="sect3">
<h4 id="_配置influxdb的连接信息"><a class="anchor" href="#_配置influxdb的连接信息"></a><a class="link" href="#_配置influxdb的连接信息">52.3.1. 配置influxdb的连接信息</a></h4>
<div class="paragraph">
<p>通过yml文件方式配置连接influxdb的配置信息如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">halo</span>:
  <span class="key">influxdb</span>:
    <span class="key">enable</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">enableOkHttpClient</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">url</span>: <span class="string"><span class="content">http://localhost:8086</span></span>
    <span class="key">username</span>: <span class="string"><span class="content">admin</span></span>
    <span class="key">database</span>: <span class="string"><span class="content">janus</span></span>
    <span class="key">retention-policy</span>: <span class="string"><span class="content">autogen</span></span>
    <span class="key">okhttp</span>:
      <span class="key">connectTimeout</span>: <span class="string"><span class="content">10</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_示例java使用代码"><a class="anchor" href="#_示例java使用代码"></a><a class="link" href="#_示例java使用代码">52.3.2. 示例Java使用代码</a></h4>
<div class="paragraph">
<p>依赖InfluxDBTemplate操作InfluxDB的示例代码，如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">InfluxDBService</span> {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> InfluxDBTemplate&lt;<span class="predefined-type">Point</span>&gt; influxDBTemplate;

    <span class="directive">public</span> <span class="type">void</span>  queryJVM(){
        influxDBTemplate.createDatabase();
        <span class="directive">final</span> <span class="predefined-type">Point</span> p = <span class="predefined-type">Point</span>.measurement(<span class="string"><span class="delimiter">&quot;</span><span class="content">disk</span><span class="delimiter">&quot;</span></span>)
                .time(<span class="predefined-type">System</span>.currentTimeMillis(), <span class="predefined-type">TimeUnit</span>.MILLISECONDS)
                .tag(<span class="string"><span class="delimiter">&quot;</span><span class="content">tenant</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span>)
                .addField(<span class="string"><span class="delimiter">&quot;</span><span class="content">used</span><span class="delimiter">&quot;</span></span>, <span class="integer">80L</span>)
                .addField(<span class="string"><span class="delimiter">&quot;</span><span class="content">free</span><span class="delimiter">&quot;</span></span>, <span class="integer">1L</span>)
                .build();
        influxDBTemplate.write(p);
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<h1 id="halo-cloud" class="sect0"><a class="anchor" href="#halo-cloud"></a><a class="link" href="#halo-cloud">VII Halo Cloud</a></h1>
<div class="openblock partintro">
<div class="content">
Halo Cloud是对Spring Cloud的增强和扩展
</div>
</div>
<div class="sect1">
<h2 id="halo-eureka"><a class="anchor" href="#halo-eureka"></a><a class="link" href="#halo-eureka">53. Halo Eureka</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_什么是halo_eureka"><a class="anchor" href="#_什么是halo_eureka"></a><a class="link" href="#_什么是halo_eureka">53.1. 什么是Halo Eureka</a></h3>
<div class="ulist">
<ul>
<li>
<p>Eureka starter是一个针对eureka服务注册发现的增强插件</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>功能</p>
</div>
<div class="ulist">
<ul>
<li>
<p>增加服务注册及发现的维度选择，而不仅仅依赖于服务ID来进行注册与发现；（这个功能是为了适应集团子公司及BU部门比较多的情况，有可能出现应用名重复的情况）</p>
</li>
<li>
<p>可以屏蔽某一些IP，不让流量进入这些IP，达到类似金丝雀部署的效果；</p>
</li>
<li>
<p>对ribbon的默认负载均衡机制进行增强，动态根据服务节点负载情况来路由。为每个节点打分（包括cpu和内存；cpu权重为0.7，内存权重为0.3），分值越高，被选中的概率越大。</p>
</li>
<li>
<p>消费者可以指定服务提供者的的group和version</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_使用halo_eureka"><a class="anchor" href="#_使用halo_eureka"></a><a class="link" href="#_使用halo_eureka">53.2. 使用Halo Eureka</a></h3>
<div class="sect3">
<h4 id="_maven引入_9"><a class="anchor" href="#_maven引入_9"></a><a class="link" href="#_maven引入_9">53.2.1. Maven引入</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>引入Halo-Feign依赖。有两种方式</p>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在需要使用的工程模块中,引入 eureka 模块即可</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-eureka<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_演示代码_2"><a class="anchor" href="#_演示代码_2"></a><a class="link" href="#_演示代码_2">53.3. 演示代码</a></h3>
<div class="ulist">
<ul>
<li>
<p>服务提供端</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>bootstrap.yml配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">spring:
  application:
    name: defensor-openfeign-provider
    group: qingcloud     #group建议以部门作为一个分组
    version: 1.0.1    #version建议1.0.1,可以随意定制</code></pre>
</div>
</div>
<div class="paragraph">
<p>添加Group和Version进行服务注册，这两个字段将会注册在Eureka的Meta-Data，其中Group建议为部门名，Version可以1.0.1-DEV等等</p>
</div>
<div class="ulist">
<ul>
<li>
<p>服务消费端，如果希望消费指定的group和version，则启用如下配置。否则不需要做下面的配置</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>application.yml配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">eureka</span>:
  <span class="key">client</span>:
    <span class="key">serviceUrl</span>:
      <span class="key">defaultZone</span>: <span class="string"><span class="content">http://eureka.springcloud.cn/eureka/</span></span>
    <span class="key">reference</span>: <span class="string"><span class="content">META-INF/refercen.json</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>在META-INF目录下新建refercen.json，对于服务user-service只消费group：qingcloud且version：1.0.1的服务，内容如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[
        {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">serviceId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">user-service</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">group</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">qingcloud</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">version</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.1</span><span class="delimiter">&quot;</span></span>
        }
]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_详细功能示例代码和测试用例"><a class="anchor" href="#_详细功能示例代码和测试用例"></a><a class="link" href="#_详细功能示例代码和测试用例">53.4. 详细功能示例代码和测试用例</a></h3>
<div class="sect3">
<h4 id="_默认配置"><a class="anchor" href="#_默认配置"></a><a class="link" href="#_默认配置">53.4.1. 默认配置</a></h4>
<div class="paragraph">
<p>框架添加了如下默认配置，之所以添加这些，是因为在线上出现过未配置它们导致的问题</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="error">eureka.instance.prefer-ip-address:true</span>
<span class="key">ribbon.MaxAutoRetries</span>: <span class="string"><span class="content">0</span></span>
<span class="key">ribbon.MaxAutoRetriesNextServer</span>: <span class="string"><span class="content">0</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_屏蔽一些ip"><a class="anchor" href="#_屏蔽一些ip"></a><a class="link" href="#_屏蔽一些ip">53.4.2. 屏蔽一些IP</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>开启actuator并开启管理端口</p>
</li>
<li>
<p>访问http://ip:managerPort/eurekamgmt/dynamicsroute?serviceId=<strong>&amp;routeIp=</strong>，其中routeIp是需要屏蔽的IP列表，以","分割</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/eureka-dt-route.png" alt="eureka dt route">
</div>
</div>
<div class="paragraph">
<p>示例访问URL:http://localhost:8081/actuator/eurekamgmt/dynamicsroute?serviceId=defensor-openfeign-provider&amp;routeIp=192.168.47.171</p>
</div>
<div class="paragraph">
<p>屏蔽成功之后,访问已屏蔽的实例IP,出现如下的错误:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">timestamp</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2019-06-13T07:37:28.419+0000</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>: <span class="integer">500</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Internal Server Error</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">com.netflix.client.ClientException: Load balancer does not have available server for client: defensor-openfeign-provider</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">path</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">/user/add</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
建议在开发和测试环境使用,屏蔽影响测试的实例
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_清除路由"><a class="anchor" href="#_清除路由"></a><a class="link" href="#_清除路由">53.4.3. 清除路由</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>开启actuator并开启管理端口</p>
</li>
<li>
<p>访问http://ip:managerPort/eurekamgmt/clearRoute？serviceId=**, 清除步骤2的规则</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>示例URL:http://localhost:8081/actuator/eurekamgmt/clearRoute?serviceId=defensor-openfeign-provider</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/eureka-dt-route.png" alt="eureka dt route">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
建议在开发和测试环境使用,直接清除某个服务的所有实例
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_负载均衡机制"><a class="anchor" href="#_负载均衡机制"></a><a class="link" href="#_负载均衡机制">53.4.4. 负载均衡机制</a></h4>
<div class="paragraph">
<p>原理是：CPU和内存等可用资源越多，得分越高，节点被选中的概率也就越大</p>
</div>
<div class="paragraph">
<p>大多数情况，我们只考虑CPU就可以，因为得益于强大的GC，同一个JAVA应用的多个节点的内存使用率基本差不多，除非发生了内存泄漏。故在判断节点资源时，最好给CPU和内存不同的权重。</p>
</div>
<div class="paragraph">
<p>下面举个栗子来描述如何选择节点，这个例子中不考虑内存</p>
</div>
<div class="paragraph">
<p>cpuScore =(max( coreSize - load), 0)/coreSize</p>
</div>
<div class="paragraph">
<p>memScore  = (max(maxHeap - usedHeap), 0)/maxheap</p>
</div>
<div class="ulist">
<ul>
<li>
<p>以cpu为例（内存同理）</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">Node1：8核心，load等于2时得分(8 -2 )/8 = 0.75

Node2：8核心，load等于6时得分(8 -6) /8 = 0.25

Node3：8核心，load等于4时得分(8 -4) /8 = 0.5

Node4：8核心，load等于10时得分(8 -10) /8 = 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>totalScore= 0.75+0.25+0.5+0 = 1.5</p>
</div>
<div class="ulist">
<ul>
<li>
<p>按CPU的分值将节点分散在[0-1]之间</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">R1 = 0.75/1.5=0.5

R2 = 0.25/1.5 = 0.1667 。0.1667+ 0.5 = 0.6667

R3 = 0.5/1.5= 0.3333 。0.3333+0.6667 = 1.0

R4 = 1+0 = 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>结果是：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[0,0.5) 选Node1

[0.5,0.6667) 选Node2

[0.6667,1) 选Node3

[1,1)选Node4</code></pre>
</div>
</div>
<div class="paragraph">
<p>取一个0-1之间的随机值，这个值分布到哪个区间，就选择对应那个区间的Node。</p>
</div>
<div class="paragraph">
<p>rollScore = Random(0,1)</p>
</div>
</div>
<div class="sect3">
<h4 id="_指定本地ip测试"><a class="anchor" href="#_指定本地ip测试"></a><a class="link" href="#_指定本地ip测试">53.4.5. 指定本地IP测试</a></h4>
<div class="paragraph">
<p>在开发项目的过程中，通过注册中心走服务注册和发现，本地开发调试的时候会出现，服务会调用到其它服务，而不是自己本地的服务。
服务之间联调，非常不方便。在dubbo里面，提供指定IP调用服务的方式。
在spring cloud里面，当然也有类似的解决方式，如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">## 禁用注册中心
ribbon.eureka.enabled: false
service-name1.ribbon.listOfServers: http://127.0.0.1:7710
service-name2.ribbon.listOfServers: http://127.0.0.1:7720</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
原理是禁用注册中心（这里使用了eureka），为每个服务指定请求路径即可！
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="halo-feign"><a class="anchor" href="#halo-feign"></a><a class="link" href="#halo-feign">54. Halo Feign</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_halo_feign的功能"><a class="anchor" href="#_halo_feign的功能"></a><a class="link" href="#_halo_feign的功能">54.1. Halo Feign的功能</a></h3>
<div class="paragraph">
<p>halo feign主要对Spring Cloud Open Feign进行扩展和增强,主要扩展了两点:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open Feign不支持Spring MVC的所有注解</p>
</li>
<li>
<p>解决Open Feign不支持解决Get请求多参数传递的问题</p>
</li>
<li>
<p>支持提供两个版本的Open Feign封装,分别支持Spring Cloud E版和Spring Cloud F版</p>
</li>
<li>
<p>支持OkHttpClient</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_halo_feign的使用"><a class="anchor" href="#_halo_feign的使用"></a><a class="link" href="#_halo_feign的使用">54.2. halo feign的使用</a></h3>

</div>
<div class="sect2">
<h3 id="_使用feign开发二方包"><a class="anchor" href="#_使用feign开发二方包"></a><a class="link" href="#_使用feign开发二方包">54.3. 使用Feign开发二方包</a></h3>
<div class="ulist">
<ul>
<li>
<p>由于Spring Cloud从F版开始Open Feign部分类移动到新的包名下，并且底层的Spring Boot的版本从1.x变为2.x存在不兼容。</p>
</li>
<li>
<p>由于历史原因,公司老业务系统基于Spring Cloud Edgware.SR5开发,目前新系统基于Spring Cloud Finchley.SR3版本开发，新旧系统之间的相互调用存在问题。</p>
<div class="literalblock">
<div class="content">
<pre>因此,需要编写两个版本的二方包。因此Halo Framework提供两个版本的Open Feign封装。</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>由服务消费方编写服务提供者的该提供的二方包，这种方式也可以解决不同Spring Cloud版本服务之间的调用问题,但是不建议这么做。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_halo封装的feign"><a class="anchor" href="#_halo封装的feign"></a><a class="link" href="#_halo封装的feign">54.3.1. Halo封装的Feign</a></h4>
<div class="paragraph">
<p>1.Halo封装两个版本的Open feign,说明如下所示:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Open Feign starter</th>
<th class="tableblock halign-left valign-top">version</th>
<th class="tableblock halign-left valign-top">Spring Cloud</th>
<th class="tableblock halign-left valign-top">Spring Boot</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-openfeign</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0.1.RELEASE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finchley.SR3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.0.8.RELEASE</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-starter-openfeign-1.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0.0.RELEASE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Edgware.SR5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.5.16.RELEASE</p></td>
</tr>
</tfoot>
</table>
<div class="paragraph">
<p>2.二方包工程目录结构示例</p>
</div>
<div class="ulist">
<ul>
<li>
<p>在开发两个版本的二方包时，推荐示例Maven模块如下所示:</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">模块</th>
<th class="tableblock halign-left valign-top">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-goods-client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">二方包父模块</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">用于聚合1.x和2.x的二方包</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-goods-client-1.x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">针对Spring Cloud E版本的二方包</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-goods-client-2.x</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">针对Spring Cloud F版本的二方包</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">halo-goods-client-core</p></td>
</tr>
</tfoot>
</table>
</div>
<div class="sect3">
<h4 id="_支持spring_cloud_finchley_sr3版本"><a class="anchor" href="#_支持spring_cloud_finchley_sr3版本"></a><a class="link" href="#_支持spring_cloud_finchley_sr3版本">54.3.2. 支持Spring Cloud Finchley.SR3版本</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>引入Halo-Feign依赖。有两种方式</p>
<div class="ulist">
<ul>
<li>
<p>第一种是将halo-starter-parent作为工程的parent,maven依赖如下所示:</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;parent&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>第二中是利用dependencyManagement引入依赖</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>halo-dependencies<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
                <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
         <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在需要使用的工程模块中,引入 halo-starter-openfeign 模块即可</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>halo-starter-openfeign<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_支持spring_cloud_edgware_sr5版本"><a class="anchor" href="#_支持spring_cloud_edgware_sr5版本"></a><a class="link" href="#_支持spring_cloud_edgware_sr5版本">54.3.3. 支持Spring Cloud Edgware.SR5版本</a></h4>
<div class="paragraph">
<p>1.在需要使用的工程模块中,引入halo-starter-openfeign-1.x模块即可</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"> <span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.xujin.halo<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>halo-starter-openfeign-1.x<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>1.0.0.RELEASE<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_使用okhttpclient"><a class="anchor" href="#_使用okhttpclient"></a><a class="link" href="#_使用okhttpclient">54.3.4. 使用OkHttpClient</a></h4>
<div class="paragraph">
<p>OpenFeign默认使用JDK的HttpURLConnection作为底层连接，效率较低。</p>
</div>
<div class="paragraph">
<p>OpenFeign官方提供两种连接池实现，分别为ApacheHttpClient、OkHttpClient。</p>
</div>
<div class="paragraph">
<p>halo-openfeign从1.3.0.RELEASE开始，已经引入OkHttpClient相关包，通过简单配置即可使用。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">feign</span>:
  <span class="key">httpclient</span>:
    <span class="key">connection-timeout</span>: <span class="string"><span class="content">10000</span></span> <span class="comment"># 连接超时时间</span>
  <span class="key">okhttp</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span> <span class="comment"># 启用OkHttpClient</span>
    <span class="key">readTimeout</span>: <span class="string"><span class="content">10000</span></span> <span class="comment"># halo扩展配置：OkHttpClient read超时时间</span>
    <span class="key">write-timeout</span>: <span class="string"><span class="content">10000</span></span> <span class="comment"># halo扩展配置：OkHttpClient write超时时间</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<h1 id="Halo-tools" class="sect0"><a class="anchor" href="#Halo-tools"></a><a class="link" href="#Halo-tools">VIII Tools</a></h1>
<div class="openblock partintro">
<div class="content">
Halo framework提供各种工具来提高开发的效率
</div>
</div>
<div class="sect1">
<h2 id="halo-codegen"><a class="anchor" href="#halo-codegen"></a><a class="link" href="#halo-codegen">55. 代码生成器</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Codegen 是一款用来生成Halo framework代码风格和项目结构的代码生成器工具，可以利用它去生成指定类型的项目.</p>
</div>
<div class="paragraph">
<p>目前codegen只支持生成Maven项目，不支持生成Gradle项目。</p>
</div>
<div class="paragraph">
<p>codegen可以生成xxx-App，xxx-inst</p>
</div>
<div class="paragraph">
<p>目前halo codegen有网页版。</p>
</div>
<div class="sect2">
<h3 id="halo-codegen-arch"><a class="anchor" href="#halo-codegen-arch"></a><a class="link" href="#halo-codegen-arch">55.1. CodeGen架构</a></h3>
<div class="paragraph">
<p>如下图所示，代码生成器的生成的工程，由元数据+模板(工程模板或代码模板)动态组装而成。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo/codegen-arch.png" alt="codegen arch" width="800">
</div>
<div class="title">Figure 25. 代码生成器架构</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_halo_plugin"><a class="anchor" href="#_halo_plugin"></a><a class="link" href="#_halo_plugin">56. Halo Plugin</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_halo_gradle_plugin"><a class="anchor" href="#_halo_gradle_plugin"></a><a class="link" href="#_halo_gradle_plugin">56.1. Halo Gradle Plugin</a></h3>
<div class="sect3">
<h4 id="_halo_reference_plugin"><a class="anchor" href="#_halo_reference_plugin"></a><a class="link" href="#_halo_reference_plugin">56.1.1. Halo Reference Plugin</a></h4>
<div class="paragraph">
<p>halo-reference-plugin是Halo Team专为Halo框架文档的编写定制的Gradle插件.通过此插件可以生成目前你看到的文档.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
halo-reference-plugin是对https://github.com/spring-gradle-plugins/docbook-reference-plugin[docbook-reference-plugin增强和定制]
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="gradle"> dependencies {
    //Provides additional optional and provided dependency configurations for Gradle along with Maven POM generation support
    classpath(&quot;org.springframework.build.gradle:propdeps-plugin:0.0.7&quot;)
    classpath(&quot;org.asciidoctor:asciidoctor-gradle-plugin:1.5.0&quot;)
    classpath(&quot;org.xujin.gradleplugin:halo-reference-plugin:0.0.4-SNAPSHOT&quot;)
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_halo_maven_plugin"><a class="anchor" href="#_halo_maven_plugin"></a><a class="link" href="#_halo_maven_plugin">56.2. Halo Maven Plugin</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="Halo-standard"><a class="anchor" href="#Halo-standard"></a><a class="link" href="#Halo-standard">57. 开发规范</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="return-value-speci"><a class="anchor" href="#return-value-speci"></a><a class="link" href="#return-value-speci">57.1. 返回值规范</a></h3>
<div class="sect3">
<h4 id="common-return-value"><a class="anchor" href="#common-return-value"></a><a class="link" href="#common-return-value">57.1.1. 常规返回约定</a></h4>
<div class="paragraph">
<p>Halo框架提供统一的返回值约定,可以直接使用org.xujin.halo.dto.ResultData.java</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">字段</th>
<th class="tableblock halign-left valign-top">描述</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">表示http请求成功</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">值为200</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">msgCode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">表示业务处理返回的状态码</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">msgContent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">表示业务处理返回的内容提示信息</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">表示业务处理返回的任意结构的泛型数据</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tfoot>
</table>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="integer">200</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgCode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgContent</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">张三</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">idCard</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">19921137705</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">123XXX</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">123@qq.com</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">phone</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">186163656XX</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>msgCode只所以设计为String而不是int类型,是因为考虑到状态码分组扩展,比如msgCode="U201"等,可以设置模块前缀或其它分组前缀</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="page-return-value"><a class="anchor" href="#page-return-value"></a><a class="link" href="#page-return-value">57.1.2. 分页返回约定</a></h4>
<div class="paragraph">
<p>在Halo框架中内置了分页的返回值,详细查看org.xujin.halo.dto.PageResult.java,代码如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.xujin.halo.dto</span>;

<span class="keyword">import</span> <span class="include">lombok.Builder</span>;
<span class="keyword">import</span> <span class="include">lombok.Getter</span>;
<span class="keyword">import</span> <span class="include">lombok.Setter</span>;

<span class="keyword">import</span> <span class="include">java.util.List</span>;


<span class="comment">/**
 * 统一的分页返回数据
 * @author xujin
 * @param &lt;T&gt;
 */</span>
<span class="annotation">@Getter</span>
<span class="annotation">@Setter</span>
<span class="annotation">@Builder</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PageResult</span>&lt;T&gt; {

        <span class="comment">/**
         * 分页的数据
         */</span>
        <span class="directive">private</span> <span class="predefined-type">List</span>&lt;T&gt; list;

        <span class="comment">/**
         * 总的记录数
         */</span>
        <span class="directive">private</span> <span class="type">long</span> totalCount;

        <span class="comment">/**
         * 总页数
         */</span>
        <span class="directive">private</span> <span class="type">long</span> totalPage;

        <span class="comment">/**
         * 当前页数
         */</span>
        <span class="directive">private</span> <span class="type">long</span> currentPage;

        <span class="directive">public</span> PageResult() {
        }

        <span class="directive">public</span> <span class="directive">static</span> &lt;T&gt; PageResultBuilder builder(<span class="predefined-type">List</span>&lt;T&gt; list){
                <span class="keyword">return</span> <span class="keyword">new</span> PageResultBuilder().list(list);
        }

        <span class="directive">public</span> PageResult(<span class="predefined-type">List</span>&lt;T&gt; list, <span class="type">long</span> totalCount, <span class="type">long</span> totalPage, <span class="type">long</span> currentPage) {
                <span class="local-variable">this</span>.list = list;
                <span class="local-variable">this</span>.totalCount = totalCount;
                <span class="local-variable">this</span>.totalPage = totalPage;
                <span class="local-variable">this</span>.currentPage = currentPage;
        }


}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="integer">200</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgCode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">msgContent</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">list</span><span class="delimiter">&quot;</span></span>: [
            {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="integer">2</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">appId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">halo-order</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">domainID</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">springApplicationName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">halo-order</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">gitUrl</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">xxxx</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">haloStatus</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">isDeleted</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">gmtCreate</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2019-08-02 14:01:14</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">gmtModified</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2019-08-02 14:01:14</span><span class="delimiter">&quot;</span></span>
            },
            {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="integer">3</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">appId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">halo-goods</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">domainID</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">7</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">gitUrl</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">xxx</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">haloStatus</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">isDeleted</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">gmtCreate</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2019-08-02 14:17:10</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">gmtModified</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2019-08-05 10:32:54</span><span class="delimiter">&quot;</span></span>
            },
            {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="integer">16</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">appId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">halo-pay</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">domainID</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">6</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">springApplicationName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">halo-pay</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">gitUrl</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">xxxx</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">haloStatus</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">isDeleted</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">gmtCreate</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2019-08-05 10:54:43</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">gmtModified</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2019-08-05 10:54:43</span><span class="delimiter">&quot;</span></span>
            }
        ],
        <span class="key"><span class="delimiter">&quot;</span><span class="content">totalCount</span><span class="delimiter">&quot;</span></span>: <span class="integer">17</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">totalPage</span><span class="delimiter">&quot;</span></span>: <span class="integer">2</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">currentPage</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="log-speci"><a class="anchor" href="#log-speci"></a><a class="link" href="#log-speci">57.2. 日志规范</a></h3>
<div class="paragraph">
<p>系统上线之后，一旦发生异常或生产事故，首当其冲的是快速止损(最大降低损失)，同时要弄清楚当时发生了什么，
用户当时做了什么操作，环境有无影响，数据有什么变化，是不是反复发生等，然后再进一步的确定大致出现的是什么问题。
此时，关键日志信息起到至关重要的作用。因此对日志的使用进行规范。</p>
</div>
<div class="sect3">
<h4 id="_日志使用原则"><a class="anchor" href="#_日志使用原则"></a><a class="link" href="#_日志使用原则">57.2.1. 日志使用原则</a></h4>
<div class="ulist">
<ul>
<li>
<p>不能影响系统正常运行；</p>
</li>
<li>
<p>不允许产生数据安全问题，重要数据脱敏。</p>
</li>
<li>
<p>不允许输出机密或敏感信息；</p>
</li>
<li>
<p>日志可供开发人员定位问题的真正原因；</p>
</li>
<li>
<p>日志可供监控系统自动监控与分析；</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_日志打点"><a class="anchor" href="#_日志打点"></a><a class="link" href="#_日志打点">57.2.2. 日志打点</a></h4>
<div class="paragraph">
<p>       
* 系统初始化：系统初始化时会依赖一些关键配置，根据参数不同会提供不一样的服务。将系统的启动参数记录INFO日志，打印出参数以及启动完成态服务表述。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>业务流程与预期不符：项目代码中结果与期望不符时也是日志场景之一，简单来说所有流程分支都可以加入考虑。取决于开发人员判断能否容忍情形发生。常见的合适场景包括外部参数不正确，数据处理问题导致返回码不在合理范围内等等。</p>
</li>
<li>
<p>系统核心的关键动作：系统中核心角色触发的业务动作是需要多加关注的，是衡量系统正常运行的重要指标，建议记录INFO级别日志，比如电商系统用户从登录到下单的整个流程；微服务各服务节点交互；核心数据表增删改等等。</p>
</li>
<li>
<p>系统异常：这类捕获的异常是系统告知开发人员需要加以关注的，是质量非常高的报错。应当适当记录日志，根据实际结合业务的情况使用warn或者error级别。</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_记日志场景"><a class="anchor" href="#_记日志场景"></a><a class="link" href="#_记日志场景">57.2.3. 记日志场景</a></h4>
<div class="paragraph">
<p>什么时候应该打日志</p>
</div>
<div class="ulist">
<ul>
<li>
<p>当你遇到问题的时候，只能通过debug功能来确定问题，你应该考虑打日志，良好的应用，是可以通过日志进行问题定位分析的。</p>
</li>
<li>
<p>当你碰到if…else 或者 switch这样的分支时，要在分支的入口打印日志，用来确定进入了哪个分支</p>
</li>
<li>
<p>经常以功能为核心进行开发，你应该在提交代码前，可以确定通过日志可以看到整个流程</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_日志打印规范"><a class="anchor" href="#_日志打印规范"></a><a class="link" href="#_日志打印规范">57.2.4. 日志打印规范</a></h4>
<div class="paragraph">
<p>1.使用slf4j</p>
</div>
<div class="ulist">
<ul>
<li>
<p>使用门面模式的日志框架，有利于维护和各个类的日志处理方式统一。</p>
</li>
<li>
<p>实现方式统一使用: Logback框架</p>
</li>
<li>
<p>统一使用 slf4j，它本质是Facade, 便于我们后期随时切换日志实现。避免在代码中直接使用log4j或java logging 等实现类</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>2.对象声明</p>
</div>
<div class="paragraph">
<p>建议使用private static final。声明为private可防止logger对象被其他类非法使用。声明为static可防止重复new出logger对象，还可以防止
logger被序列化，造成安全风险。声明为final是因为在类的生命周期内无需变更logger。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(Xxx.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>3.必须使用参数化信息的方式:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Processing trade with id:[{}] and symbol : [{}] </span><span class="delimiter">&quot;</span></span>, id, symbol);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
不推荐使用字符串拼接的方式打印日志，可读性和可维护性都比较差。建议使用占位符
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>4.对于debug日志，必须判断是否为debug级别后，才进行使用:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">if</span> (logger.isDebugEnabled()) {
    logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Processing trade with id: </span><span class="delimiter">&quot;</span></span> +id + <span class="string"><span class="delimiter">&quot;</span><span class="content"> symbol: </span><span class="delimiter">&quot;</span></span> + symbol);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>5.不要进行字符串拼接,那样会产生很多String对象，占用空间，影响性能。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Processing trade with id: </span><span class="delimiter">&quot;</span></span> + id + <span class="string"><span class="delimiter">&quot;</span><span class="content"> symbol: </span><span class="delimiter">&quot;</span></span> + symbol);</code></pre>
</div>
</div>
<div class="paragraph">
<p>6.使用[]进行参数变量隔离</p>
</div>
<div class="paragraph">
<p>如有参数变量，应该写成如下写法:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Processing trade with id:[{}] and symbol : [{}] </span><span class="delimiter">&quot;</span></span>, id, symbol);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
这样的格式写法，可读性更好，对于排查问题更有帮助。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>7.语言</p>
</div>
<div class="paragraph">
<p>最好在打印日志时输出英文，防止中文不支持，导致落盘出现日志乱码的情况。</p>
</div>
<div class="paragraph">
<p>8.禁用System输出</p>
</div>
<div class="paragraph">
<p>9.不打印无意义日志</p>
</div>
<div class="paragraph">
<p>10.打印日志的代码不能出现任何异常</p>
</div>
<div class="paragraph">
<p>11.catch中的异常记录必须打印堆栈信息，不要用e.printStackTrace()。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">xxx fail </span><span class="delimiter">&quot;</span></span>,e);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
不要记录日志后又抛出异常。抛出去的异常，一般外层会处理。
如果不处理，那为什么还要抛出去？另外一个原则是，无论是否发生异常，都不要在不同地方重复记录针对同一事件的日志信息
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_不同日志级别的使用"><a class="anchor" href="#_不同日志级别的使用"></a><a class="link" href="#_不同日志级别的使用">57.2.5. 不同日志级别的使用</a></h4>
<div class="paragraph">
<p>1.ERROR日志:影响到程序正常运行需要记录error日志，系统需要将错误或异常细节记录ERROR日志中，方便后续人工回溯解决。</p>
</div>
<div class="paragraph">
<p>当前请求正常运行的异常情况,例如:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>打开配置文件失败</p>
</li>
<li>
<p>所有第三方对接的异常(包括第三方返回错误码)</p>
</li>
<li>
<p>所有影响功能使用的异常，包括:SQLException和除了业务异常之外的所有异常(RuntimeException和Exception)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>比如往ES，MongoDB等写数据失败,如果有Throwable信息，需要记录完成的堆栈信息:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span>{
    ....
}<span class="keyword">catch</span>(<span class="exception">Exception</span> ex){
  <span class="predefined-type">String</span> errorMessage=<span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">Error while reading information of user [%s]</span><span class="delimiter">&quot;</span></span>,userName);
  logger.error(errorMessage,ex); # <b class="conum">(1)</b>
  <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(errorMessage,ex);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>如果进行了异常抛出操作，如果没有全局异常解析器统一记录日志或者相应代码捕获处理，需要记录error日志，否则不需要。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>2.WARN:不应该出现但是不影响程序时，需要记录warn日志。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>当前请求正常运行的异常情况:</p>
<div class="ulist">
<ul>
<li>
<p>有容错机制的时候出现的错误情况</p>
</li>
<li>
<p>找不到配置文件，但是系统能自动创建配置文件</p>
</li>
<li>
<p>程序调用了一个旧版本的接口，可选参数不合法，非业务预期的状态但仍可继续处理等</p>
</li>
</ul>
</div>
</li>
<li>
<p>即将接近临界值的时候:</p>
<div class="ulist">
<ul>
<li>
<p>缓存池占用达到警告线</p>
</li>
</ul>
</div>
</li>
<li>
<p>业务异常的记录:</p>
<div class="ulist">
<ul>
<li>
<p>当接口抛出业务异常时，应该记录此异常</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>3.INFO:记录系统关键信息，旨在保留系统正常工作期间关键运行指标，
开发人员可以将初始化系统配置、业务状态变化信息，或者用户业务流程中的核心处理记录到INFO日志中，
方便日常运维工作以及错误回溯时上下文场景复现</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Service方法中对于系统/业务状态的变更
-主要逻辑中的分步骤</p>
</li>
<li>
<p>外部接口部分</p>
</li>
<li>
<p>客户端请求参数(REST/WS)</p>
</li>
<li>
<p>调用第三方时的调用参数和调用结果</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
1.并不是所有的service都进行出入口打点记录,单一、简单service是没有意义的(job除外,job需要记录开始和结束,)。
2.对于复杂的业务逻辑，需要进行日志打点，以及埋点记录，比如电商系统中的下订单逻辑，以及OrderAction操作(业务状态变更)。
3.对于整个系统的提供出去的接口(REST/RPC)，使用info记录入参
4.服务外部接口提供方，需要记录入参。
5.调用其他第三方服务时，所有的出参和入参是必须要记录的(否则出现问题很难追溯)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>4.DEBUG:可以填写所有的想知道的相关信息(但不代表可以随便写，debug信息要有意义,最好有相关参数)用于Debug调试</p>
</div>
<div class="paragraph">
<p>生产环境需要关闭Debug日志，如果在生产环境下需要开启DEBUG,需要使用开关进行管理，不能一直开启。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">开始获取员工[{}] [{}]年[{}]月休假情况</span><span class="delimiter">&quot;</span></span>,employee,year,month);

logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">员工[{}][{}]年[{}]月年假/病假/事假为[{}]/[{}]/[{}]</span><span class="delimiter">&quot;</span></span>,employee,year,month,annualLeaveDays,sickLeaveDays,noPayLeaveDays);</code></pre>
</div>
</div>
<div class="paragraph">
<p>5.TRACE：特别详细的系统运行完整信息，业务代码中，不要使用.(除非有特殊用意，否则请使用DEBUG级别替代)</p>
</div>
<div class="paragraph">
<p>规范示例说明</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="annotation">@Transactional</span>
<span class="directive">public</span> <span class="type">void</span> createUserAndBindMobile(<span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> mobile, <span class="annotation">@NotNull</span> User user) <span class="directive">throws</span> CreateConflictException{
    <span class="type">boolean</span> debug = log.isDebugEnabled();
    <span class="keyword">if</span>(debug){
        log.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">开始创建用户并绑定手机号. args[mobile=[{}],user=[{}]]</span><span class="delimiter">&quot;</span></span>, mobile, LogObjects.toString(user));
    }
    <span class="keyword">try</span> {
        user.setCreateTime(<span class="keyword">new</span> <span class="predefined-type">Date</span>());
        user.setUpdateTime(<span class="keyword">new</span> <span class="predefined-type">Date</span>());
        userRepository.insertSelective(user);
        <span class="keyword">if</span>(debug){
            log.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">创建用户信息成功. insertedUser=[{}]</span><span class="delimiter">&quot;</span></span>,LogObjects.toString(user));
        }
        UserMobileRelationship relationship = <span class="keyword">new</span> UserMobileRelationship();
        relationship.setMobile(mobile);
        relationship.setOpenId(user.getOpenId());
        relationship.setCreateTime(<span class="keyword">new</span> <span class="predefined-type">Date</span>());
        relationship.setUpdateTime(<span class="keyword">new</span> <span class="predefined-type">Date</span>());
        userMobileRelationshipRepository.insertOnDuplicateKey(relationship);
        <span class="keyword">if</span>(debug){
            log.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">绑定手机成功. relationship=[{}]</span><span class="delimiter">&quot;</span></span>,LogObjects.toString(relationship));
        }
        log.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">创建用户并绑定手机号. userId=[{}],openId=[{}],mobile=[{}]</span><span class="delimiter">&quot;</span></span>,user.getId(),user.getOpenId(),mobile);
    }<span class="keyword">catch</span>(DuplicateKeyException e){
        log.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">创建用户并绑定手机号失败,已存在相同的用户. openId=[{}],mobile=[{}]</span><span class="delimiter">&quot;</span></span>,user.getOpenId(),mobile);
        <span class="keyword">throw</span> <span class="keyword">new</span> CreateConflictException(<span class="string"><span class="delimiter">&quot;</span><span class="content">创建用户发生冲突, openid=[%s]</span><span class="delimiter">&quot;</span></span>,user.getOpenId());
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
上述日志级别从高到低排列，是开发中最常用的五种。生产系统一般只打印INFO 级别以上的日志，对于 DEBUG 级别的日志，只在测试环境中打印。
打印错误日志时，需要区分是业务异常(如:用户名不能为空)还是系统异常(如:调用 会员核心异常)，业务异常使用 warn 级别记录，
系统异常使用 error 记录。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="futakata-jar-speci"><a class="anchor" href="#futakata-jar-speci"></a><a class="link" href="#futakata-jar-speci">57.3. 二方包规范</a></h3>
<div class="sect3">
<h4 id="dev-futakata-jar"><a class="anchor" href="#dev-futakata-jar"></a><a class="link" href="#dev-futakata-jar">57.3.1. 二方包原则</a></h4>
<div class="paragraph">
<p>1.提供方原则:谁提供的二方包，需要对其负责，由快照版本变为正式版本，有通知修改的义务和责任</p>
</div>
<div class="paragraph">
<p>2.使用方原则:不管是谁提供的二方包，如果是快照版，要么不要用，要么对方给出发布正式版本的时间，
上线前必须修改为正式版本</p>
</div>
<div class="paragraph">
<p>3.二方包中只允许存在接口定义，入参，出参，枚举等不含有影响其它应用启动，正常运行的功能存在</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_错误码设计"><a class="anchor" href="#_错误码设计"></a><a class="link" href="#_错误码设计">57.4. 错误码设计</a></h3>
<div class="sect3">
<h4 id="_为什么需要错误码"><a class="anchor" href="#_为什么需要错误码"></a><a class="link" href="#_为什么需要错误码">57.4.1. 为什么需要错误码</a></h4>
<div class="ulist">
<ul>
<li>
<p>输出到日志的错误码: 用来快速溯源找到问题和形成监控大盘。</p>
</li>
<li>
<p>错误码是用来做沟通的：系统与系统间的沟通，人与人间的沟通，人与系统间的沟通。</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_什么是错误码"><a class="anchor" href="#_什么是错误码"></a><a class="link" href="#_什么是错误码">57.4.2. 什么是错误码</a></h4>
<div class="paragraph">
<p>错误码的出现就是为了快速定位系统的问题从而快速解决问题和故障，止损。比如系统整个链路，应用内部错在哪，谁的错，如何快速应对。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>好的错误码必须能够快速知晓错误来源。</p>
</li>
<li>
<p>好的错误码必须易于记忆和对比。</p>
</li>
<li>
<p>好的错误码必须能够脱离文档和系统平台达到线下轻量沟通的目的（这个要求比较高）。</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_错误码规范"><a class="anchor" href="#_错误码规范"></a><a class="link" href="#_错误码规范">57.4.3. 错误码规范</a></h4>
<div class="paragraph">
<p>按照《阿里Java开发手册》的建议设计出的面向日志的错误码定义共十三位（十位有意义，三位连接符），并且应该具有如下分类：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>应用标识，表示错误属于哪个应用，三位数字。</p>
</li>
<li>
<p>功能域标识，表示错误属于应用中的哪个功能模块，三位数字。</p>
</li>
<li>
<p>错误类型，表示错误属于那种类型，一位字母。</p>
</li>
<li>
<p>错误编码，错误类型下的具体错误，三位数字。</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/halo-web/error-design.jpg" alt="error design" width="800">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>不用枚举定义错误码</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>国际化支持是一个不使用枚举定义错误码很重要的理由。
我们通过 i18n 的支持可以做到错误码、错误状态、错误描述的管理。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>错误码定义要有字母也要有数字.</p>
</li>
<li>
<p>快速溯源|简单易记 | 沟通标准化</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>怎么能达到这个效果呢？ 首先要有一套标准并且在域内各个业务都在用同样的标准。 其次要求错误码有自我解释的能力是有信息含量的有意义。 最后在域内要传递错误码。</p>
</div>
</div>
<div class="sect3">
<h4 id="_异常码使用建议"><a class="anchor" href="#_异常码使用建议"></a><a class="link" href="#_异常码使用建议">57.4.4. 异常码使用建议</a></h4>
<div class="paragraph">
<p>异常码使用参考建议,如下:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><strong>成功</strong>
- 200: 完全成功
- 201-209:  HTTP 规范值
－－－－－－－－－－－－－－－－－－－－－
<strong>业务异常</strong>
非监控中心必须立刻告警解决的异常
- 220-249:  应用自定义业务异常分组。可用于调用成功但发生业务异常的情况，如购物车超限购。
- 250-259:  自定义，如降级，熔断，限流等主动行为，通过埋点事件告警。
- 260-299:  保留分组，可用于Halo Framework。
－－－－－－－－－－－－－－－－－－－－－
<strong>客户端系统异常</strong>
- 400: 通用的客户端异常
- 401-419: HTTP 规范值，如401，403代表认证、授权的失效。
- 420-449: 应用自定义分组
- 450-469: 客户端抛出异常
- 470-499: 保留分组，可用于Halo Framework
－－－－－－－－－－－－－－－－－－－－－
<strong>服务端系统异常</strong>
- 500: 通用的服务端异常，应用抛出的，未设置分组时的默认异常
- 501-509: HTTP 规范值，如503代表服务忙
- 520-559:  应用自定义分组
- 560-599: 保留分组，可用于Halo Framework
－－－－－－－－－－－－－－－－－－－－－

<strong>使用建议</strong>
应用可使用通用的400，500状态码，也可以根据Http规范含义，使用类似401，403，503这样的有意义状态码，也可以使用规范中留给应用自定义的分组。
Halo框架固定使用规范中定义的分组。</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="feign-speci"><a class="anchor" href="#feign-speci"></a><a class="link" href="#feign-speci">57.4.5. Feign接口定义规范</a></h4>
<div class="paragraph">
<p>Feign接口开发目前出现五花八门的开发方式，特做此约定。</p>
</div>
<div class="paragraph">
<p>1.@FeignClient中使用name=Spring Application Name明确服务提供者,不允许使用value，示例代码如下</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@FeignClient</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">defensor-openfeign-provider</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserService</span> {

    <span class="annotation">@RequestMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">/user/add</span><span class="delimiter">&quot;</span></span>, method = RequestMethod.GET)
    <span class="directive">public</span> <span class="predefined-type">String</span> addUser(User user);

    <span class="annotation">@RequestMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">/user/update</span><span class="delimiter">&quot;</span></span>, method = RequestMethod.POST)
    <span class="directive">public</span> <span class="predefined-type">String</span> updateUser(<span class="annotation">@RequestBody</span> User user);

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
不允许使用@FeignClient(value="ZM-ECONTRACT-SERVICE")方式,代码review关注点。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>2.只能使用@RequestMapping或 @PostMapping, @GetMapping定义接口中的方法。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>使用@RequestMapping</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@FeignClient</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">defensor-openfeign-provider</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserService</span> {

    <span class="annotation">@RequestMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">/user/add</span><span class="delimiter">&quot;</span></span>, method = RequestMethod.GET)
    <span class="directive">public</span> <span class="predefined-type">String</span> addUser(User user);

    <span class="annotation">@RequestMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">/user/update</span><span class="delimiter">&quot;</span></span>, method = RequestMethod.POST)
    <span class="directive">public</span> <span class="predefined-type">String</span> updateUser(<span class="annotation">@RequestBody</span> User user);

}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>使用@PostMapping和 @GetMapping</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@FeignClient</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">defensor-openfeign-provider</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserService</span> {

    <span class="annotation">@GetMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">/user/add</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> addUser(User user);

    <span class="annotation">@PostMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">/user/update</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> updateUser(<span class="annotation">@RequestBody</span> User user);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>3.不允许使用Netflix底层的@RequestLine去定义接口中的方法,如下所示。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@FeignClient</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">CRM-SERVICE</span><span class="delimiter">&quot;</span></span>, configuration = FeignConfiguration.class, fallbackFactory = CrmFeignClientFallbackFactory.class)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">CrmFeignClient</span> {

    <span class="annotation">@RequestLine</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">POST /giveUpReason/saveGiveUpReason</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">Result</span> saveGiveUpReason(<span class="annotation">@RequestBody</span> GiveUpReason GiveUpReason);

    <span class="annotation">@RequestLine</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">GET /giveUpReason/queryGiveUpReasonIdByStuId?studentId={studentId}</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">Result</span>&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt;&gt; queryGiveUpReasonIdByStuId(<span class="annotation">@Param</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">studentId</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">Integer</span> studentId);
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
@RequestLine("POST /giveUpReason/saveGiveUpReason")其中POST /giveUpReason中的空格，多一个或少一个会报错，可编码差。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>4.不允许使用@PathVariable("xxx") 绑定到操作方法的入参中定义方法，列如:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RequestMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">/getUser/{id}</span><span class="delimiter">&quot;</span></span>, method = RequestMethod.GET)
<span class="directive">public</span> <span class="predefined-type">String</span> getUser( <span class="annotation">@PathVariable</span> <span class="predefined-type">Long</span> id);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
主要是Cat进行调用链分析时，/getUser/{id}URL参数丢失。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="git-flow"><a class="anchor" href="#git-flow"></a><a class="link" href="#git-flow">57.5. Git Flow规范</a></h3>
<div class="paragraph">
<p>Git流程借鉴AoneFlow模式。主要思想就是如下所示:</p>
</div>
<div class="paragraph">
<p>1.从maser拉出Feature分支进行功能开发，可以多个Feature分支并行存在。</p>
</div>
<div class="paragraph">
<p>2.当需要发布时，由测试负责人或发布负责人，从maser拉出最新的发布分支，需要发布的功能合并到发布分支进行测试(如果突然有功能需要搭车进行一起发布，需要严格把握，因为合并的Feature分支越多，需要回归测试的功能点就越多，不控制很容易翻车)</p>
</div>
<div class="paragraph">
<p>3.测试完毕之后进行发布，发布完毕之后，把发布分支合并到master分支(原有发布分支可以删除也可以保留）</p>
</div>
<div class="paragraph">
<p>4.紧急Hotfix原则从Master分支拉出hotfix分支，例如:/hotfix/20190728_fix某某某，HotFix之后合并到Master分支。</p>
</div>
<div class="sect3">
<h4 id="git-branch"><a class="anchor" href="#git-branch"></a><a class="link" href="#git-branch">57.5.1. 分支说明</a></h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">分支</th>
<th class="tableblock halign-left valign-top">说明</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">特性分支</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">特定功能版本分支</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">个人或者开发小组，开发团队从master拉出feature分支，最终开发完毕合并到发布分支</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">主干分支</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">主干分支即Master分支</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">生产最新最稳定的分支，必要时对master分支打Tag</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">开发分支</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">开发分支即develop分支</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">开发主线分支</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">发布分支</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">发布分支，主要用于发布，也可以称之为realese分支，也可以叫publish分支。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">发布分支一般由测试，或者发布负责人，从Master拉出，比如周三要上线，测试或者发布负责人拉出发布分支为/publish_20190724_xxx</p></td>
</tr>
</tfoot>
</table>
</div>
<div class="sect3">
<h4 id="master-to-feature"><a class="anchor" href="#master-to-feature"></a><a class="link" href="#master-to-feature">57.5.2. 从Master拉出Feature分支</a></h4>
<div class="paragraph">
<p>每当开始一件新的工作项（比如新的功能或是待解决的问题）的时候，从代表最新已发布版本的主干上创建一个通常以feature/前缀命名的特性分支，然后在这个分支上提交代码修改。也就是说，每个工作项（可以是一个人完成，或是多个人协作完成）对应一个特性分支，所有的修改都不允许直接提交到主干。如下图所示:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/gitflow/git-flow-1.png" alt="git flow 1">
</div>
</div>
</div>
<div class="sect3">
<h4 id="feature-to-release"><a class="anchor" href="#feature-to-release"></a><a class="link" href="#feature-to-release">57.5.3. 通过合并特性分支，形成发布分支</a></h4>
<div class="paragraph">
<p>AoneFlow的思路是，从主干上拉出一条新分支，将所有本次要集成或发布的特性分支依次合并过去，从而得到发布分支。发布分支通常以release/前缀命名或者/publish为前缀。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/gitflow/git-flow-2.png" alt="git flow 2">
</div>
</div>
</div>
<div class="sect3">
<h4 id="release-to-master"><a class="anchor" href="#release-to-master"></a><a class="link" href="#release-to-master">57.5.4. 发布分支发布完毕之后，合并到主干</a></h4>
<div class="paragraph">
<p>发布到线上正式环境后，合并相应的发布分支到主干，在主干添加标签，同时删除该发布分支关联的特性分支。 当一条发布分支上的流水线完成了一次线上正式环境的部署，就意味着相应的功能真正地发布了，此时应该将这条发布分支合并到主干。为了避免在代码仓库里堆积大量历史上的特性分支，还应该清理掉已经上线部分特性分支。与 GitFlow 相似，主干分支上的最新版本始终与线上版本一致，如果要回溯历史版本，只需在主干分支上找到相应的版本标签即可。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/gitflow/git-flow-3.png" alt="git flow 3">
</div>
</div>
</div>
<div class="sect3">
<h4 id="git-hotfix"><a class="anchor" href="#git-hotfix"></a><a class="link" href="#git-hotfix">57.5.5. Hotfix原则</a></h4>
<div class="paragraph">
<p>如果出现bug，需要紧急HotFix，原则也是从Master分支，拉出分支，修改发布，然后合并到Maser。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="idea-setting"><a class="anchor" href="#idea-setting"></a><a class="link" href="#idea-setting">57.6. IDEA常用设置</a></h3>
<div class="sect3">
<h4 id="fix-import-package"><a class="anchor" href="#fix-import-package"></a><a class="link" href="#fix-import-package">57.6.1. 无效导入包自动整理设置</a></h4>
<div class="paragraph">
<p>Add unambiguous imports on the fly：快速添加明确的导入。</p>
</div>
<div class="paragraph">
<p>Optimize imports on the fly：快速优化导入，优化的意思即自动帮助删除无用的导入。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/idea-set/zldr-package.png" alt="zldr package">
</div>
</div>
</div>
<div class="sect3">
<h4 id="maven-setting"><a class="anchor" href="#maven-setting"></a><a class="link" href="#maven-setting">57.6.2. maven插件设置</a></h4>
<div class="paragraph">
<p>Maven插件设置，始终更新快照包</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/idea-set/maven-update-snapshot.png" alt="maven update snapshot">
</div>
</div>
</div>
<div class="sect3">
<h4 id="p3c-install"><a class="anchor" href="#p3c-install"></a><a class="link" href="#p3c-install">57.6.3. Alibaba P3C插件安装</a></h4>
<div class="paragraph">
<p>按照开发公约,安装P3C代表扫描插件,提高代码开发质量</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/idea-set/install-p3c.png" alt="install p3c">
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. @TableName: com.baomidou.mybatisplus.annotation.TableName，由MyBatis Plus提供。
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. @TableJSONField: org.xujin.halo.mybatis.annotation.TableJSONField，由Halo提供。
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. IEnum: com.baomidou.mybatisplus.core.enums.IEnum，由MyBatis Plus提供。
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. @EnumValue: com.baomidou.mybatisplus.annotation.EnumValue，由MyBatis Plus提供。
</div>
</div>
<div id="footer">
<div id="footer-text">
version: 2.0.0.REALESE<br>
Last updated 2020-08-16 02:36:41 UTC
</div>
</div>
</body>
</html>